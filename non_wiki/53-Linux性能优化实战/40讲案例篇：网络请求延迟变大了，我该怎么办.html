<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <style type="text/css">

#watermark {

  position: relative;
  overflow: hidden;
}

#watermark .x {
  position: absolute;
  top: 800;
  left: 400;
  color: #3300ff;
  font-size: 50px;
  pointer-events: none;
  opacity:0.3;
  filter:Alpha(opacity=50);
  
  
}
    </style>


    <style type="text/css">
 html{color:#333;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;text-rendering:optimizelegibility;font-family:Helvetica Neue,PingFang SC,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif}html.borderbox *,html.borderbox :after,html.borderbox :before{box-sizing:border-box}article,aside,blockquote,body,button,code,dd,details,dl,dt,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hr,input,legend,li,menu,nav,ol,p,pre,section,td,textarea,th,ul{margin:0;padding:0}article,aside,details,figcaption,figure,footer,header,menu,nav,section{display:block}audio,canvas,video{display:inline-block}body,button,input,select,textarea{font:300 1em/1.8 PingFang SC,Lantinghei SC,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,Helvetica,sans-serif}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}table{border-collapse:collapse;border-spacing:0}fieldset,img{border:0}blockquote{position:relative;color:#999;font-weight:400;border-left:1px solid #1abc9c;padding-left:1em;margin:1em 3em 1em 2em}@media only screen and (max-width:640px){blockquote{margin:1em 0}}abbr,acronym{border-bottom:1px dotted;font-variant:normal}abbr{cursor:help}del{text-decoration:line-through}address,caption,cite,code,dfn,em,th,var{font-style:normal;font-weight:400}ol,ul{list-style:none}caption,th{text-align:left}q:after,q:before{content:""}sub,sup{font-size:75%;line-height:0;position:relative}:root sub,:root sup{vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}a{color:#1abc9c}a:hover{text-decoration:underline}.typo a{border-bottom:1px solid #1abc9c}.typo a:hover{border-bottom-color:#555;color:#555}.typo a:hover,a,ins{text-decoration:none}.typo-u,u{text-decoration:underline}mark{background:#fffdd1;border-bottom:1px solid #ffedce;padding:2px;margin:0 5px}code,pre,pre tt{font-family:Courier,Courier New,monospace}pre{background:hsla(0,0%,97%,.7);border:1px solid #ddd;padding:1em 1.5em;display:block;-webkit-overflow-scrolling:touch}hr{border:none;border-bottom:1px solid #cfcfcf;margin-bottom:.8em;height:10px}.typo-small,figcaption,small{font-size:.9em;color:#888}b,strong{font-weight:700;color:#000}[draggable]{cursor:move}.clearfix:after,.clearfix:before{content:"";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.textwrap,.textwrap td,.textwrap th{word-wrap:break-word;word-break:break-all}.textwrap-table{table-layout:fixed}.serif{font-family:Palatino,Optima,Georgia,serif}.typo-dl,.typo-form,.typo-hr,.typo-ol,.typo-p,.typo-pre,.typo-table,.typo-ul,.typo dl,.typo form,.typo hr,.typo ol,.typo p,.typo pre,.typo table,.typo ul,blockquote{margin-bottom:1rem}h1,h2,h3,h4,h5,h6{font-family:PingFang SC,Helvetica Neue,Verdana,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;line-height:1.35}.typo-h1,.typo-h2,.typo-h3,.typo-h4,.typo-h5,.typo-h6,.typo h1,.typo h2,.typo h3,.typo h4,.typo h5,.typo h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}.typo-h1,.typo h1{font-size:2em}.typo-h2,.typo h2{font-size:1.8em}.typo-h3,.typo h3{font-size:1.6em}.typo-h4,.typo h4{font-size:1.4em}.typo-h5,.typo-h6,.typo h5,.typo h6{font-size:1.2em}.typo-ul,.typo ul{margin-left:1.3em;list-style:disc}.typo-ol,.typo ol{list-style:decimal;margin-left:1.9em}.typo-ol ol,.typo-ol ul,.typo-ul ol,.typo-ul ul,.typo li ol,.typo li ul{margin-bottom:.8em;margin-left:2em}.typo-ol ul,.typo-ul ul,.typo li ul{list-style:circle}.typo-table td,.typo-table th,.typo table caption,.typo table td,.typo table th{border:1px solid #ddd;padding:.5em 1em;color:#666}.typo-table th,.typo table th{background:#fbfbfb}.typo-table thead th,.typo table thead th{background:hsla(0,0%,95%,.7)}.typo table caption{border-bottom:none}.typo-input,.typo-textarea{-webkit-appearance:none;border-radius:0}.typo-em,.typo em,caption,legend{color:#000;font-weight:inherit}.typo-em{position:relative}.typo-em:after{position:absolute;top:.65em;left:0;width:100%;overflow:hidden;white-space:nowrap;content:"\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"}.typo img{max-width:100%}.common-content{font-weight:400;color:#353535;line-height:1.75rem;white-space:normal;word-break:normal;font-size:1rem}.common-content img{display:block;max-width:100%;background-color:#eee}.common-content audio,.common-content video{width:100%;background-color:#eee}.common-content center,.common-content font{margin-top:1rem;display:inline-block}.common-content center{width:100%}.common-content pre{margin-top:1rem;padding-left:0;padding-right:0;position:relative;overflow:hidden}.common-content pre code{font-size:.8rem;font-family:Consolas,Liberation Mono,Menlo,monospace,Courier;display:block;width:100%;box-sizing:border-box;padding-left:1rem;padding-right:1rem;overflow-x:auto}.common-content hr{border:none;margin-top:1.5rem;margin-bottom:1.5rem;border-top:1px solid #f5f5f5;height:1px;background:none}.common-content b,.common-content h1,.common-content h2,.common-content h3,.common-content h4,.common-content h5,.common-content strong{font-weight:700}.common-content h1,.common-content h2{font-size:1.125rem;margin-bottom:.45rem}.common-content h3,.common-content h4,.common-content h5{font-size:1rem;margin-bottom:.45rem}.common-content p{font-weight:400;color:#353535;margin-top:.15rem}.common-content .orange{color:#ff5a05}.common-content .reference{font-size:1rem;color:#888}.custom-rich-content h1{margin-top:0;font-weight:400;font-size:15.25px;border-bottom:1px solid #eee;line-height:2.8}.custom-rich-content li,.custom-rich-content p{font-size:14px;color:#888;line-height:1.6}table.hljs-ln{margin-bottom:0;border-spacing:0;border-collapse:collapse}table.hljs-ln,table.hljs-ln tbody,table.hljs-ln td,table.hljs-ln tr{box-sizing:border-box}table.hljs-ln td{padding:0;border:0}table.hljs-ln td.hljs-ln-numbers{min-width:15px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;cursor:pointer;user-select:none}table.hljs-ln td.hljs-ln-code,table.hljs-ln td.hljs-ln-numbers{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:12px;line-height:20px;vertical-align:top}table.hljs-ln td.hljs-ln-code{position:relative;padding-right:10px;padding-left:10px;overflow:visible;color:#24292e;word-wrap:normal;white-space:pre}video::-webkit-media-controls{overflow:hidden!important}video::-webkit-media-controls-enclosure{width:calc(100% + 32px);margin-left:auto}.button-cancel{color:#888;border:1px solid #888;border-radius:3px;margin-right:12px}.button-cancel,.button-primary{-ms-flex-positive:1;flex-grow:1;height:35px;display:inline-block;font-size:15px;text-align:center;line-height:36px}.button-primary{color:#fff;background-color:#ff5a05;border-radius:3px}@font-face{font-family:iconfont;src:url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot);src:url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.woff) format("woff"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.ttf) format("truetype"),url(//at.alicdn.com/t/font_372689_bwwwtosxtzp.svg#iconfont) format("svg")}@font-face{font-family:player-font;src:url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot);src:url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.eot#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.woff) format("woff"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.ttf) format("truetype"),url(//at.alicdn.com/t/font_509397_1cyjv4o90qiod2t9.svg#player-font) format("svg")}.iconfont{font-family:iconfont!important;font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-webkit-text-stroke-width:.2px;-moz-osx-font-smoothing:grayscale}html{background:#fff;min-height:100%;-webkit-tap-highlight-color:rgba(0,0,0,0)}body{width:100%}body.fixed{overflow:hidden;position:fixed;width:100vw;height:100vh}i{font-style:normal}a{word-wrap:break-word;-webkit-tap-highlight-color:rgba(0,0,0,0)}a:hover{text-decoration:none}.fade-enter-active,.fade-leave-active{transition:opacity .3s}.fade-enter,.fade-leave-to{opacity:0}.MathJax,.MathJax_CHTML,.MathJax_MathContainer,.MathJax_MathML,.MathJax_PHTML,.MathJax_PlainSource,.MathJax_SVG{outline:0}.ios-app-switch .js-audit{display:none}._loading_wrap_{position:fixed;width:100vw;height:100vh;top:50%;left:50%;transform:translate(-50%,-50%);z-index:999}._loading_div_class_,._loading_wrap_{display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center}._loading_div_class_{word-wrap:break-word;padding:.5rem .75rem;text-align:center;z-index:9999;font-size:.6rem;max-width:60%;color:#fff;border-radius:.25rem;-ms-flex-direction:column;flex-direction:column}._loading_div_class_ .message{color:#353535;font-size:16px;line-height:3}.spinner{animation:circle-rotator 1.4s linear infinite}.spinner *{line-height:0;box-sizing:border-box}@keyframes circle-rotator{0%{transform:rotate(0deg)}to{transform:rotate(270deg)}}.path{stroke-dasharray:187;stroke-dashoffset:0;transform-origin:center;animation:circle-dash 1.4s ease-in-out infinite,circle-colors 5.6s ease-in-out infinite}@keyframes circle-colors{0%{stroke:#ff5a05}to{stroke:#ff5a05}}@keyframes circle-dash{0%{stroke-dashoffset:187}50%{stroke-dashoffset:46.75;transform:rotate(135deg)}to{stroke-dashoffset:187;transform:rotate(450deg)}}.confirm-box-wrapper,.confirm-box-wrapper .mask{position:absolute;top:0;left:0;right:0;bottom:0}.confirm-box-wrapper .mask{background:rgba(0,0,0,.6)}.confirm-box-wrapper .confirm-box{position:fixed;top:50%;left:50%;width:267px;background:#fff;transform:translate(-50%,-50%);border-radius:7px}.confirm-box-wrapper .confirm-box .head{margin:0 18px;font-size:18px;text-align:center;line-height:65px;border-bottom:1px solid #d9d9d9}.confirm-box-wrapper .confirm-box .body{padding:18px;padding-bottom:0;color:#353535;font-size:12.5px;max-height:150px;overflow:auto}.confirm-box-wrapper .confirm-box .foot{display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row;padding:18px}.confirm-box-wrapper .confirm-box .foot .button-cancel{border:1px solid #d9d9d9}.hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}




    </style>
    <style type="text/css">
        .button-cancel[data-v-87ffcada]{color:#888;border:1px solid #888;border-radius:3px;margin-right:12px}.button-cancel[data-v-87ffcada],.button-primary[data-v-87ffcada]{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;height:35px;display:inline-block;font-size:15px;text-align:center;line-height:36px}.button-primary[data-v-87ffcada]{color:#fff;background-color:#ff5a05;border-radius:3px}.pd[data-v-87ffcada]{padding-left:1.375rem;padding-right:1.375rem}.article[data-v-87ffcada]{max-width:70rem;margin:0 auto}.article .article-unavailable[data-v-87ffcada]{color:#fa8919;font-size:15px;font-weight:600;line-height:24px;border-radius:5px;padding:12px;background-color:#f6f7fb;margin-top:20px}.article .article-unavailable .iconfont[data-v-87ffcada]{font-size:12px}.article .main[data-v-87ffcada]{padding:1.25rem 0;margin-bottom:52px}.article-title[data-v-87ffcada]{color:#353535;font-weight:400;line-height:1.65rem;font-size:1.34375rem}.article-info[data-v-87ffcada]{color:#888;font-size:.9375rem;margin-top:1.0625rem}.article-content[data-v-87ffcada]{margin-top:1.0625rem}.article-content.android video[data-v-87ffcada]::-webkit-media-controls-fullscreen-button{display:none}.copyright[data-v-87ffcada]{color:#b2b2b2;padding-bottom:20px;margin-top:20px;font-size:13px}.audio-player[data-v-87ffcada]{width:100%;margin:20px 0}.to-comment[data-v-87ffcada]{overflow:hidden;padding-top:10px;margin-bottom:-30px}.to-comment a.button-primary[data-v-87ffcada]{float:right;height:20px;font-size:12px;line-height:20px;padding:4px 8px;cursor:pointer}.article-comments[data-v-87ffcada]{margin-top:2rem}.article-comments h2[data-v-87ffcada]{text-align:center;color:#888;position:relative;z-index:1;margin-bottom:1rem}.article-comments h2[data-v-87ffcada]:before{border-top:1px dotted #888;content:"";position:absolute;top:56%;left:0;width:100%;z-index:-1}.article-comments h2 span[data-v-87ffcada]{font-size:15.25px;font-weight:400;padding:0 1rem;background:#fff;display:inline-block}.article-sub-bottom[data-v-87ffcada]{z-index:10;cursor:pointer}.switch-btns[data-v-87ffcada]{height:76px;cursor:pointer;padding-top:24px;padding-bottom:24px;border-bottom:10px solid #f6f7fb;position:relative}.switch-btns[data-v-87ffcada]:before{content:" ";height:1px;background:#e8e8e8;position:absolute;top:0;left:0;-webkit-box-sizing:border-box;box-sizing:border-box;left:1.375rem;right:1.375rem}.switch-btns .btn[data-v-87ffcada]{height:38px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.switch-btns .btn .tag[data-v-87ffcada]{-webkit-box-flex:0;-ms-flex:0 0 62px;flex:0 0 62px;text-align:center;color:#888;font-size:14px;border-radius:10px;height:22px;line-height:22px;background:#f6f7fb;font-weight:400}.switch-btns .btn .txt[data-v-87ffcada]{margin-left:10px;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;color:#888;font-size:15px;height:22px;line-height:22px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:400}@media (max-width:769px){.article .breadcrumb[data-v-87ffcada]{padding-top:10px;padding-bottom:10px}}





    </style>

    <style type="text/css">
        .comment-item{list-style-position:inside;width:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:1rem}.comment-item a{border-bottom:none}.comment-item .avatar{width:2.625rem;height:2.625rem;-ms-flex-negative:0;flex-shrink:0;border-radius:50%}.comment-item .info{margin-left:.5rem;-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1}.comment-item .info .hd{width:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.comment-item .info .hd .username{color:#888;font-size:15.25px;font-weight:400;line-height:1.2}.comment-item .info .hd .control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.comment-item .info .hd .control .btn-share{color:#888;font-size:.75rem;margin-right:1rem}.comment-item .info .hd .control .btn-praise{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;font-size:15.25px;text-decoration:none}.comment-item .info .hd .control .btn-praise i{color:#888;display:inline-block;font-size:.75rem;margin-right:.3rem;margin-top:-.01rem}.comment-item .info .hd .control .btn-praise i.on,.comment-item .info .hd .control .btn-praise span{color:#ff5a05}.comment-item .info .bd{color:#353535;font-size:15.25px;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6}.comment-item .info .time{color:#888;font-size:9px;line-height:1}.comment-item .info .reply .reply-hd{font-size:15.25px}.comment-item .info .reply .reply-hd span{margin-left:-12px;color:#888;font-weight:400}.comment-item .info .reply .reply-hd i{color:#ff5a05;font-size:15.25px}.comment-item .info .reply .reply-content{color:#353535;font-size:15.25px;font-weight:400;white-space:normal;word-break:break-all}.comment-item .info .reply .reply-time{color:#888;font-size:9px}




    </style>
</head>
<body>
<div id="app">


    <div data-v-87ffcada="" class="article" id="watermark">
        <p class="x">åŠ å¾®ä¿¡heibaifkï¼Œç½‘ç›˜åœæ­¢æ›´æ–°</p>
        <div data-v-87ffcada="" class="main main-app">
            <h1 data-v-87ffcada="" class="article-title pd">
                40è®²æ¡ˆä¾‹ç¯‡ï¼šç½‘ç»œè¯·æ±‚å»¶è¿Ÿå˜å¤§äº†ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠ
            </h1>
            <div data-v-87ffcada="" class="article-content typo common-content pd"><img data-v-87ffcada=""
                                                                                        src="https://static001.geekbang.org/resource/image/a5/95/a5ec3f1882c980fb31d6b84be8bded95.jpg">


                <div data-v-87ffcada="" id="article-content" class="">
                    <div class="text">
                        <p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ç¢°åˆ°åˆ†å¸ƒå¼æ‹’ç»æœåŠ¡ï¼ˆDDoSï¼‰çš„ç¼“è§£æ–¹æ³•ã€‚ç®€å•å›é¡¾ä¸€ä¸‹ï¼ŒDDoS åˆ©ç”¨å¤§é‡çš„ä¼ªé€ è¯·æ±‚ï¼Œå¯¼è‡´ç›®æ ‡æœåŠ¡è¦è€—è´¹å¤§é‡èµ„æºï¼Œæ¥å¤„ç†è¿™äº›æ— æ•ˆè¯·æ±‚ï¼Œè¿›è€Œæ— æ³•æ­£å¸¸å“åº”æ­£å¸¸ç”¨æˆ·çš„è¯·æ±‚ã€‚</p><p>ç”±äº DDoS çš„åˆ†å¸ƒå¼ã€å¤§æµé‡ã€éš¾è¿½è¸ªç­‰ç‰¹ç‚¹ï¼Œç›®å‰ç¡®å®è¿˜æ²¡æœ‰æ–¹æ³•ï¼Œèƒ½å¤Ÿå®Œå…¨é˜²å¾¡ DDoS å¸¦æ¥çš„é—®é¢˜ï¼Œæˆ‘ä»¬åªèƒ½è®¾æ³•ç¼“è§£ DDoS å¸¦æ¥çš„å½±å“ã€‚</p><p>æ¯”å¦‚ï¼Œä½ å¯ä»¥è´­ä¹°ä¸“ä¸šçš„æµé‡æ¸…æ´—è®¾å¤‡å’Œç½‘ç»œé˜²ç«å¢™ï¼Œåœ¨ç½‘ç»œå…¥å£å¤„é˜»æ–­æ¶æ„æµé‡ï¼Œåªä¿ç•™æ­£å¸¸æµé‡è¿›å…¥æ•°æ®ä¸­å¿ƒçš„æœåŠ¡å™¨ã€‚</p><p>åœ¨ Linux æœåŠ¡å™¨ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡å†…æ ¸è°ƒä¼˜ã€DPDKã€XDP ç­‰å¤šç§æ–¹æ³•ï¼Œå¢å¤§æœåŠ¡å™¨çš„æŠ—æ”»å‡»èƒ½åŠ›ï¼Œé™ä½ DDoS å¯¹æ­£å¸¸æœåŠ¡çš„å½±å“ã€‚è€Œåœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œä½ å¯ä»¥åˆ©ç”¨å„çº§ç¼“å­˜ã€ WAFã€CDN ç­‰æ–¹å¼ï¼Œç¼“è§£ DDoS å¯¹åº”ç”¨ç¨‹åºçš„å½±å“ã€‚</p><p>ä¸è¿‡è¦æ³¨æ„ï¼Œå¦‚æœ DDoS çš„æµé‡ï¼Œå·²ç»åˆ°äº† Linux æœåŠ¡å™¨ä¸­ï¼Œé‚£ä¹ˆï¼Œå³ä½¿åº”ç”¨å±‚åšäº†å„ç§ä¼˜åŒ–ï¼Œç½‘ç»œæœåŠ¡çš„å»¶è¿Ÿä¸€èˆ¬è¿˜æ˜¯ä¼šæ¯”æ­£å¸¸æƒ…å†µå¤§å¾ˆå¤šã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸è¦è®© Linux æœåŠ¡å™¨ï¼Œé…åˆä¸“ä¸šçš„æµé‡æ¸…æ´—ä»¥åŠç½‘ç»œé˜²ç«å¢™è®¾å¤‡ï¼Œä¸€èµ·æ¥ç¼“è§£è¿™ä¸€é—®é¢˜ã€‚</p><p>é™¤äº† DDoS ä¼šå¸¦æ¥ç½‘ç»œå»¶è¿Ÿå¢å¤§å¤–ï¼Œæˆ‘æƒ³ï¼Œä½ è‚¯å®šè§åˆ°è¿‡ä¸å°‘å…¶ä»–åŸå› å¯¼è‡´çš„ç½‘ç»œå»¶è¿Ÿï¼Œæ¯”å¦‚</p><ul>
<li>
<p>ç½‘ç»œä¼ è¾“æ…¢ï¼Œå¯¼è‡´å»¶è¿Ÿï¼›</p>
</li>
<li>
<p>Linux å†…æ ¸åè®®æ ˆæŠ¥æ–‡å¤„ç†æ…¢ï¼Œå¯¼è‡´å»¶è¿Ÿï¼›</p>
</li>
<li>
<p>åº”ç”¨ç¨‹åºæ•°æ®å¤„ç†æ…¢ï¼Œå¯¼è‡´å»¶è¿Ÿç­‰ç­‰ã€‚</p>
</li>
</ul><!-- [[[read_end]]] --><p>é‚£ä¹ˆï¼Œå½“ç¢°åˆ°è¿™äº›åŸå› çš„å»¶è¿Ÿæ—¶ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿåˆè¯¥å¦‚ä½•å®šä½ç½‘ç»œå»¶è¿Ÿçš„æ ¹æºå‘¢ï¼Ÿä»Šå¤©ï¼Œæˆ‘å°±é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå¸¦ä½ ä¸€èµ·çœ‹çœ‹è¿™äº›é—®é¢˜ã€‚</p><h2>ç½‘ç»œå»¶è¿Ÿ</h2><p>æˆ‘ç›¸ä¿¡ï¼Œæåˆ°<strong>ç½‘ç»œå»¶è¿Ÿ</strong>æ—¶ï¼Œä½ å¯èƒ½è½»æ¾æƒ³èµ·å®ƒçš„å«ä¹‰â€”â€”ç½‘ç»œæ•°æ®ä¼ è¾“æ‰€ç”¨çš„æ—¶é—´ã€‚ä¸è¿‡è¦æ³¨æ„ï¼Œè¿™ä¸ªæ—¶é—´å¯èƒ½æ˜¯å•å‘çš„ï¼ŒæŒ‡ä»æºåœ°å€å‘é€åˆ°ç›®çš„åœ°å€çš„å•ç¨‹æ—¶é—´ï¼›ä¹Ÿå¯èƒ½æ˜¯åŒå‘çš„ï¼Œå³ä»æºåœ°å€å‘é€åˆ°ç›®çš„åœ°å€ï¼Œç„¶ååˆä»ç›®çš„åœ°å€å‘å›å“åº”ï¼Œè¿™ä¸ªå¾€è¿”å…¨ç¨‹æ‰€ç”¨çš„æ—¶é—´ã€‚</p><p>é€šå¸¸ï¼Œæˆ‘ä»¬æ›´å¸¸ç”¨çš„æ˜¯åŒå‘çš„å¾€è¿”é€šä¿¡å»¶è¿Ÿï¼Œæ¯”å¦‚ ping æµ‹è¯•çš„ç»“æœï¼Œå°±æ˜¯å¾€è¿”å»¶æ—¶ RTTï¼ˆRound-Trip Timeï¼‰ã€‚</p><p>é™¤äº†ç½‘ç»œå»¶è¿Ÿå¤–ï¼Œå¦ä¸€ä¸ªå¸¸ç”¨çš„æŒ‡æ ‡æ˜¯<strong>åº”ç”¨ç¨‹åºå»¶è¿Ÿ</strong>ï¼Œå®ƒæ˜¯æŒ‡ï¼Œä»åº”ç”¨ç¨‹åºæ¥æ”¶åˆ°è¯·æ±‚ï¼Œå†åˆ°å‘å›å“åº”ï¼Œå…¨ç¨‹æ‰€ç”¨çš„æ—¶é—´ã€‚é€šå¸¸ï¼Œåº”ç”¨ç¨‹åºå»¶è¿Ÿä¹ŸæŒ‡çš„æ˜¯å¾€è¿”å»¶è¿Ÿï¼Œæ˜¯ç½‘ç»œæ•°æ®ä¼ è¾“æ—¶é—´åŠ ä¸Šæ•°æ®å¤„ç†æ—¶é—´çš„å’Œã€‚</p><p>åœ¨ <a href="https://time.geekbang.org/column/article/81057">Linux ç½‘ç»œåŸºç¡€ç¯‡</a> ä¸­ï¼Œæˆ‘æ›¾ç»ä»‹ç»åˆ°ï¼Œä½ å¯ä»¥ç”¨ ping æ¥æµ‹è¯•ç½‘ç»œå»¶è¿Ÿã€‚ping åŸºäº ICMP åè®®ï¼Œå®ƒé€šè¿‡è®¡ç®— ICMP å›æ˜¾å“åº”æŠ¥æ–‡ä¸ ICMP å›æ˜¾è¯·æ±‚æŠ¥æ–‡çš„æ—¶é—´å·®ï¼Œæ¥è·å¾—å¾€è¿”å»¶æ—¶ã€‚è¿™ä¸ªè¿‡ç¨‹å¹¶ä¸éœ€è¦ç‰¹æ®Šè®¤è¯ï¼Œå¸¸è¢«å¾ˆå¤šç½‘ç»œæ”»å‡»åˆ©ç”¨ï¼Œæ¯”å¦‚ç«¯å£æ‰«æå·¥å…· nmapã€ç»„åŒ…å·¥å…· hping3 ç­‰ç­‰ã€‚</p><p>æ‰€ä»¥ï¼Œä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œå¾ˆå¤šç½‘ç»œæœåŠ¡ä¼šæŠŠ ICMP ç¦æ­¢æ‰ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´æˆ‘ä»¬æ— æ³•ç”¨ ping ï¼Œæ¥æµ‹è¯•ç½‘ç»œæœåŠ¡çš„å¯ç”¨æ€§å’Œå¾€è¿”å»¶æ—¶ã€‚è¿™æ—¶ï¼Œä½ å¯ä»¥ç”¨ traceroute æˆ– hping3 çš„ TCP å’Œ UDP æ¨¡å¼ï¼Œæ¥è·å–ç½‘ç»œå»¶è¿Ÿã€‚</p><p>æ¯”å¦‚ï¼Œä»¥ baidu.com ä¸ºä¾‹ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„ hping3 å‘½ä»¤ï¼Œæµ‹è¯•ä½ çš„æœºå™¨åˆ°ç™¾åº¦æœç´¢æœåŠ¡å™¨çš„ç½‘ç»œå»¶è¿Ÿï¼š</p><pre><code># -cè¡¨ç¤ºå‘é€3æ¬¡è¯·æ±‚ï¼Œ-Sè¡¨ç¤ºè®¾ç½®TCP SYNï¼Œ-pè¡¨ç¤ºç«¯å£å·ä¸º80
$ hping3 -c 3 -S -p 80 baidu.com
HPING baidu.com (eth0 123.125.115.110): S set, 40 headers + 0 data bytes
len=46 ip=123.125.115.110 ttl=51 id=47908 sport=80 flags=SA seq=0 win=8192 rtt=20.9 ms
len=46 ip=123.125.115.110 ttl=51 id=6788  sport=80 flags=SA seq=1 win=8192 rtt=20.9 ms
len=46 ip=123.125.115.110 ttl=51 id=37699 sport=80 flags=SA seq=2 win=8192 rtt=20.9 ms

--- baidu.com hping statistic ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 20.9/20.9/20.9 ms
</code></pre><p>ä» hping3 çš„ç»“æœä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œå¾€è¿”å»¶è¿Ÿ RTT ä¸º 20.9msã€‚</p><p>å½“ç„¶ï¼Œæˆ‘ä»¬ç”¨ traceroute ï¼Œä¹Ÿå¯ä»¥å¾—åˆ°ç±»ä¼¼ç»“æœï¼š</p><pre><code># --tcpè¡¨ç¤ºä½¿ç”¨TCPåè®®ï¼Œ-pè¡¨ç¤ºç«¯å£å·ï¼Œ-nè¡¨ç¤ºä¸å¯¹ç»“æœä¸­çš„IPåœ°å€æ‰§è¡Œåå‘åŸŸåè§£æ
$ traceroute --tcp -p 80 -n baidu.com
traceroute to baidu.com (123.125.115.110), 30 hops max, 60 byte packets
 1  * * *
 2  * * *
 3  * * *
 4  * * *
 5  * * *
 6  * * *
 7  * * *
 8  * * *
 9  * * *
10  * * *
11  * * *
12  * * *
13  * * *
14  123.125.115.110  20.684 ms *  20.798 ms
</code></pre><p>traceroute ä¼šåœ¨è·¯ç”±çš„æ¯ä¸€è·³å‘é€ä¸‰ä¸ªåŒ…ï¼Œå¹¶åœ¨æ”¶åˆ°å“åº”åï¼Œè¾“å‡ºå¾€è¿”å»¶æ—¶ã€‚å¦‚æœæ— å“åº”æˆ–è€…å“åº”è¶…æ—¶ï¼ˆé»˜è®¤5sï¼‰ï¼Œå°±ä¼šè¾“å‡ºä¸€ä¸ªæ˜Ÿå·ã€‚</p><p>çŸ¥é“äº†åŸºäº TCP æµ‹è¯•ç½‘ç»œæœåŠ¡å»¶è¿Ÿçš„æ–¹æ³•åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹ï¼Œæ¥å­¦ä¹ ç½‘ç»œå»¶è¿Ÿå‡é«˜æ—¶çš„åˆ†ææ€è·¯ã€‚</p><h2>æ¡ˆä¾‹å‡†å¤‡</h2><p>ä¸‹é¢çš„æ¡ˆä¾‹ä»ç„¶åŸºäº Ubuntu 18.04ï¼ŒåŒæ ·é€‚ç”¨äºå…¶ä»–çš„ Linux ç³»ç»Ÿã€‚æˆ‘ä½¿ç”¨çš„æ¡ˆä¾‹ç¯å¢ƒæ˜¯è¿™æ ·çš„ï¼š</p><ul>
<li>
<p>æœºå™¨é…ç½®ï¼š2 CPUï¼Œ8GB å†…å­˜ã€‚</p>
</li>
<li>
<p>é¢„å…ˆå®‰è£… dockerã€hping3ã€tcpdumpã€curlã€wrkã€Wireshark ç­‰å·¥å…·ï¼Œæ¯”å¦‚ apt-get install docker.io hping3 tcpdump curlã€‚</p>
</li>
</ul><p>è¿™é‡Œçš„å·¥å…·ä½ åº”è¯¥éƒ½æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œå…¶ä¸­ wrk çš„å®‰è£…å’Œä½¿ç”¨æ–¹æ³•åœ¨ <a href="https://time.geekbang.org/column/article/81497">æ€ä¹ˆè¯„ä¼°ç³»ç»Ÿçš„ç½‘ç»œæ€§èƒ½</a> ä¸­æ›¾ç»ä»‹ç»è¿‡ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£…ï¼Œè¯·æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥å®‰è£…å®ƒï¼š</p><pre><code>$ https://github.com/wg/wrk
$ cd wrk
$ apt-get install build-essential -y
$ make
$ sudo cp wrk /usr/local/bin/
</code></pre><p>ç”±äºWireshark éœ€è¦å›¾å½¢ç•Œé¢ï¼Œå¦‚æœä½ çš„è™šæ‹Ÿæœºæ²¡æœ‰å›¾å½¢ç•Œé¢ï¼Œå°±å¯ä»¥æŠŠ Wireshark å®‰è£…åˆ°å…¶ä»–çš„æœºå™¨ä¸­ï¼ˆæ¯”å¦‚ Windows ç¬”è®°æœ¬ï¼‰ã€‚</p><p>æœ¬æ¬¡æ¡ˆä¾‹ç”¨åˆ°ä¸¤å°è™šæ‹Ÿæœºï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾æ¥è¡¨ç¤ºå®ƒä»¬çš„å…³ç³»ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/55/63/55347dc1ec78688da5673f29b60aa863.png" alt=""></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œåˆ†åˆ« SSH ç™»å½•åˆ°ä¸¤å°æœºå™¨ä¸Šï¼ˆä»¥ä¸‹æ­¥éª¤ï¼Œå‡è®¾ç»ˆç«¯ç¼–å·ä¸å›¾ç¤ºVM ç¼–å·ä¸€è‡´ï¼‰ï¼Œå¹¶å®‰è£…ä¸Šé¢æåˆ°çš„è¿™äº›å·¥å…·ã€‚æ³¨æ„ï¼Œ curl å’Œ wrk åªéœ€è¦å®‰è£…åœ¨å®¢æˆ·ç«¯ VMï¼ˆå³ VM2ï¼‰ä¸­ã€‚</p><p>åŒä»¥å‰çš„æ¡ˆä¾‹ä¸€æ ·ï¼Œä¸‹é¢çš„æ‰€æœ‰å‘½ä»¤éƒ½é»˜è®¤ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œå¦‚æœä½ æ˜¯ç”¨æ™®é€šç”¨æˆ·èº«ä»½ç™»é™†ç³»ç»Ÿï¼Œè¯·è¿è¡Œ sudo su root å‘½ä»¤åˆ‡æ¢åˆ° root ç”¨æˆ·ã€‚</p><blockquote>
<p>å¦‚æœå®‰è£…è¿‡ç¨‹ä¸­æœ‰ä»€ä¹ˆé—®é¢˜ï¼ŒåŒæ ·é¼“åŠ±ä½ å…ˆè‡ªå·±æœç´¢è§£å†³ï¼Œè§£å†³ä¸äº†çš„ï¼Œå¯ä»¥åœ¨ç•™è¨€åŒºå‘æˆ‘æé—®ã€‚å¦‚æœä½ ä»¥å‰å·²ç»å®‰è£…è¿‡äº†ï¼Œå°±å¯ä»¥å¿½ç•¥è¿™ä¸€ç‚¹äº†ã€‚</p>
</blockquote><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¿›å…¥åˆ°æ¡ˆä¾‹æ“ä½œçš„ç¯èŠ‚ã€‚</p><h2>æ¡ˆä¾‹åˆ†æ</h2><p>ä¸ºäº†å¯¹æ¯”å¾—å‡ºå»¶è¿Ÿå¢å¤§çš„å½±å“ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬æ¥è¿è¡Œä¸€ä¸ªæœ€ç®€å•çš„ Nginxï¼Œä¹Ÿå°±æ˜¯ç”¨å®˜æ–¹çš„ Nginx é•œåƒå¯åŠ¨ä¸€ä¸ªå®¹å™¨ã€‚åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œè¿è¡Œå®˜æ–¹ Nginxï¼Œå®ƒä¼šåœ¨ 80 ç«¯å£ç›‘å¬ï¼š</p><pre><code>$ docker run --network=host --name=good -itd nginx
fb4ed7cb9177d10e270f8320a7fb64717eac3451114c9fab3c50e02be2e88ba2
</code></pre><p>ç»§ç»­åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œè¿è¡Œæ¡ˆä¾‹åº”ç”¨ï¼Œå®ƒä¼šç›‘å¬ 8080 ç«¯å£ï¼š</p><pre><code>$ docker run --name nginx --network=host -itd feisky/nginx:latency
b99bd136dcfd907747d9c803fdc0255e578bad6d66f4e9c32b826d75b6812724
</code></pre><p>ç„¶åï¼Œåœ¨ç»ˆç«¯äºŒä¸­æ‰§è¡Œ curl å‘½ä»¤ï¼ŒéªŒè¯ä¸¤ä¸ªå®¹å™¨å·²ç»æ­£å¸¸å¯åŠ¨ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ å°†çœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code># 80ç«¯å£æ­£å¸¸
$ curl http://192.168.0.30
&lt;!DOCTYPE html&gt;
&lt;html&gt;
...
&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

# 8080ç«¯å£æ­£å¸¸
$ curl http://192.168.0.30:8080
...
&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>æ¥ç€ï¼Œæˆ‘ä»¬å†ç”¨ä¸Šé¢æåˆ°çš„ hping3 ï¼Œæ¥æµ‹è¯•å®ƒä»¬çš„å»¶è¿Ÿï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚è¿˜æ˜¯åœ¨ç»ˆç«¯äºŒï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ†åˆ«æµ‹è¯•æ¡ˆä¾‹æœºå™¨ 80 ç«¯å£å’Œ 8080 ç«¯å£çš„å»¶è¿Ÿï¼š</p><pre><code># æµ‹è¯•80ç«¯å£å»¶è¿Ÿ
$ hping3 -c 3 -S -p 80 192.168.0.30
HPING 192.168.0.30 (eth0 192.168.0.30): S set, 40 headers + 0 data bytes
len=44 ip=192.168.0.30 ttl=64 DF id=0 sport=80 flags=SA seq=0 win=29200 rtt=7.8 ms
len=44 ip=192.168.0.30 ttl=64 DF id=0 sport=80 flags=SA seq=1 win=29200 rtt=7.7 ms
len=44 ip=192.168.0.30 ttl=64 DF id=0 sport=80 flags=SA seq=2 win=29200 rtt=7.6 ms

--- 192.168.0.30 hping statistic ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 7.6/7.7/7.8 ms
</code></pre><pre><code># æµ‹è¯•8080ç«¯å£å»¶è¿Ÿ
$ hping3 -c 3 -S -p 8080 192.168.0.30
HPING 192.168.0.30 (eth0 192.168.0.30): S set, 40 headers + 0 data bytes
len=44 ip=192.168.0.30 ttl=64 DF id=0 sport=8080 flags=SA seq=0 win=29200 rtt=7.7 ms
len=44 ip=192.168.0.30 ttl=64 DF id=0 sport=8080 flags=SA seq=1 win=29200 rtt=7.6 ms
len=44 ip=192.168.0.30 ttl=64 DF id=0 sport=8080 flags=SA seq=2 win=29200 rtt=7.3 ms

--- 192.168.0.30 hping statistic ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 7.3/7.6/7.7 ms
</code></pre><p>ä»è¿™ä¸ªè¾“å‡ºä½ å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªç«¯å£çš„å»¶è¿Ÿå·®ä¸å¤šï¼Œéƒ½æ˜¯ 7msã€‚ä¸è¿‡ï¼Œè¿™åªæ˜¯å•ä¸ªè¯·æ±‚çš„æƒ…å†µã€‚æ¢æˆå¹¶å‘è¯·æ±‚çš„è¯ï¼Œåˆä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ç”¨ wrk è¯•è¯•ã€‚</p><p>è¿™æ¬¡åœ¨ç»ˆç«¯äºŒä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„æ–°å‘½ä»¤ï¼Œåˆ†åˆ«æµ‹è¯•æ¡ˆä¾‹æœºå™¨å¹¶å‘ 100 æ—¶ï¼Œ 80 ç«¯å£å’Œ 8080 ç«¯å£çš„æ€§èƒ½ï¼š</p><pre><code># æµ‹è¯•80ç«¯å£æ€§èƒ½
$ # wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30/
Running 10s test @ http://192.168.0.30/
  2 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     9.19ms   12.32ms 319.61ms   97.80%
    Req/Sec     6.20k   426.80     8.25k    85.50%
  Latency Distribution
     50%    7.78ms
     75%    8.22ms
     90%    9.14ms
     99%   50.53ms
  123558 requests in 10.01s, 100.15MB read
Requests/sec:  12340.91
Transfer/sec:     10.00MB
</code></pre><pre><code># æµ‹è¯•8080ç«¯å£æ€§èƒ½
$ wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30:8080/
Running 10s test @ http://192.168.0.30:8080/
  2 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    43.60ms    6.41ms  56.58ms   97.06%
    Req/Sec     1.15k   120.29     1.92k    88.50%
  Latency Distribution
     50%   44.02ms
     75%   44.33ms
     90%   47.62ms
     99%   48.88ms
  22853 requests in 10.01s, 18.55MB read
Requests/sec:   2283.31
Transfer/sec:      1.85MB
</code></pre><p>ä»ä¸Šé¢ä¸¤ä¸ªè¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œå®˜æ–¹Nginxï¼ˆç›‘å¬åœ¨80ç«¯å£ï¼‰çš„å¹³å‡å»¶è¿Ÿæ˜¯ 9.19msï¼Œè€Œæ¡ˆä¾‹ Nginx çš„å¹³å‡å»¶è¿Ÿï¼ˆç›‘å¬åœ¨ 8080 ç«¯å£ï¼‰åˆ™æ˜¯ 43.6msã€‚ä»å»¶è¿Ÿçš„åˆ†å¸ƒä¸Šæ¥çœ‹ï¼Œå®˜æ–¹ Nginx 90% çš„è¯·æ±‚ï¼Œéƒ½å¯ä»¥åœ¨ 9msä»¥å†…å®Œæˆï¼›è€Œæ¡ˆä¾‹ Nginx 50% çš„è¯·æ±‚ï¼Œå°±å·²ç»è¾¾åˆ°äº† 44 msã€‚</p><p>å†ç»“åˆä¸Šé¢ hping3 çš„è¾“å‡ºï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å‘ç°ï¼Œæ¡ˆä¾‹ Nginx åœ¨å¹¶å‘è¯·æ±‚ä¸‹çš„å»¶è¿Ÿå¢å¤§äº†å¾ˆå¤šï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ</p><p>åˆ†ææ–¹æ³•æˆ‘æƒ³ä½ å·²ç»æƒ³åˆ°äº†ï¼Œä¸ŠèŠ‚è¯¾å­¦è¿‡çš„ï¼Œä½¿ç”¨ tcpdump æŠ“å–æ”¶å‘çš„ç½‘ç»œåŒ…ï¼Œåˆ†æç½‘ç»œçš„æ”¶å‘è¿‡ç¨‹æœ‰æ²¡æœ‰é—®é¢˜ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„ tcpdump å‘½ä»¤ï¼ŒæŠ“å– 8080 ç«¯å£ä¸Šæ”¶å‘çš„ç½‘ç»œåŒ…ï¼Œå¹¶ä¿å­˜åˆ° nginx.pcap æ–‡ä»¶ï¼š</p><pre><code>$ tcpdump -nn tcp port 8080 -w nginx.pcap
</code></pre><p>ç„¶ååˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­ï¼Œé‡æ–°æ‰§è¡Œ wrk å‘½ä»¤ï¼š</p><pre><code># æµ‹è¯•8080ç«¯å£æ€§èƒ½
$ wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30:8080/
</code></pre><p>å½“ wrk å‘½ä»¤ç»“æŸåï¼Œå†æ¬¡åˆ‡æ¢å›ç»ˆç«¯ä¸€ï¼Œå¹¶æŒ‰ä¸‹ Ctrl+C ç»“æŸ tcpdump å‘½ä»¤ã€‚ç„¶åï¼Œå†æŠŠæŠ“å–åˆ°çš„ nginx.pcap ï¼Œå¤åˆ¶åˆ°è£…æœ‰ Wireshark çš„æœºå™¨ä¸­ï¼ˆå¦‚æœ VM1 å·²ç»å¸¦æœ‰å›¾å½¢ç•Œé¢ï¼Œé‚£ä¹ˆå¯ä»¥è·³è¿‡å¤åˆ¶æ­¥éª¤ï¼‰ï¼Œå¹¶ç”¨ Wireshark æ‰“å¼€å®ƒã€‚</p><p>ç”±äºç½‘ç»œåŒ…çš„æ•°é‡æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å¯ä»¥å…ˆè¿‡æ»¤ä¸€ä¸‹ã€‚æ¯”å¦‚ï¼Œåœ¨é€‰æ‹©ä¸€ä¸ªåŒ…åï¼Œä½ å¯ä»¥å•å‡»å³é”®å¹¶é€‰æ‹© â€œFollowâ€ -&gt; â€œTCP Streamâ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/45/98/4590d2477d54bf9aa3d2881ff3296498.png" alt=""></p><p>ç„¶åï¼Œå…³é—­å¼¹å‡ºæ¥çš„å¯¹è¯æ¡†ï¼Œå›åˆ° Wireshark ä¸»çª—å£ã€‚è¿™æ—¶å€™ï¼Œä½ ä¼šå‘ç° Wireshark å·²ç»è‡ªåŠ¨å¸®ä½ è®¾ç½®äº†ä¸€ä¸ªè¿‡æ»¤è¡¨è¾¾å¼ tcp.stream eq 24ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆå›¾ä¸­çœå»äº†æºå’Œç›®çš„IPåœ°å€ï¼‰ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/f9/6e/f9fa457f95276ae4904a91619501376e.png" alt=""></p><p>ä»è¿™é‡Œï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ª TCP è¿æ¥ä»ä¸‰æ¬¡æ¡æ‰‹å¼€å§‹çš„æ¯ä¸ªè¯·æ±‚å’Œå“åº”æƒ…å†µã€‚å½“ç„¶ï¼Œè¿™å¯èƒ½è¿˜ä¸å¤Ÿç›´è§‚ï¼Œä½ å¯ä»¥ç»§ç»­ç‚¹å‡»èœå•æ é‡Œçš„ Statics -&gt; Flow Graphï¼Œé€‰ä¸­ â€œLimit to display filterâ€ å¹¶è®¾ç½® Flow type ä¸º â€œTCP Flowsâ€ï¼š</p><p><img src="https://static001.geekbang.org/resource/image/ff/cc/ff498170eb58abcdd841709fb4c036cc.png" alt=""></p><p>æ³¨æ„ï¼Œè¿™ä¸ªå›¾çš„å·¦è¾¹æ˜¯å®¢æˆ·ç«¯ï¼Œè€Œå³è¾¹æ˜¯ Nginx æœåŠ¡å™¨ã€‚é€šè¿‡è¿™ä¸ªå›¾å°±å¯ä»¥çœ‹å‡ºï¼Œå‰é¢ä¸‰æ¬¡æ¡æ‰‹ï¼Œä»¥åŠç¬¬ä¸€æ¬¡ HTTP è¯·æ±‚å’Œå“åº”è¿˜æ˜¯æŒºå¿«çš„ï¼Œä½†ç¬¬äºŒæ¬¡ HTTP è¯·æ±‚å°±æ¯”è¾ƒæ…¢äº†ï¼Œç‰¹åˆ«æ˜¯å®¢æˆ·ç«¯åœ¨æ”¶åˆ°æœåŠ¡å™¨ç¬¬ä¸€ä¸ªåˆ†ç»„åï¼Œ40ms åæ‰å‘å‡ºäº† ACK å“åº”ï¼ˆå›¾ä¸­è“è‰²è¡Œï¼‰ã€‚</p><p>çœ‹åˆ° 40ms è¿™ä¸ªå€¼ï¼Œä½ æœ‰æ²¡æœ‰æƒ³èµ·ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿå®é™…ä¸Šï¼Œè¿™æ˜¯ TCP å»¶è¿Ÿç¡®è®¤ï¼ˆDelayed ACKï¼‰çš„æœ€å°è¶…æ—¶æ—¶é—´ã€‚</p><p>è¿™é‡Œæˆ‘è§£é‡Šä¸€ä¸‹å»¶è¿Ÿç¡®è®¤ã€‚è¿™æ˜¯é’ˆå¯¹ TCP ACK çš„ä¸€ç§ä¼˜åŒ–æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç”¨æ¯æ¬¡è¯·æ±‚éƒ½å‘é€ä¸€ä¸ª ACKï¼Œè€Œæ˜¯å…ˆç­‰ä¸€ä¼šå„¿ï¼ˆæ¯”å¦‚ 40msï¼‰ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰â€œé¡ºé£è½¦â€ã€‚å¦‚æœè¿™æ®µæ—¶é—´å†…ï¼Œæ­£å¥½æœ‰å…¶ä»–åŒ…éœ€è¦å‘é€ï¼Œé‚£å°±æå¸¦ç€ ACK ä¸€èµ·å‘é€è¿‡å»ã€‚å½“ç„¶ï¼Œå¦‚æœä¸€ç›´ç­‰ä¸åˆ°å…¶ä»–åŒ…ï¼Œé‚£å°±è¶…æ—¶åå•ç‹¬å‘é€ ACKã€‚</p><p>å› ä¸ºæ¡ˆä¾‹ä¸­ 40ms å‘ç”Ÿåœ¨å®¢æˆ·ç«¯ä¸Šï¼Œæˆ‘ä»¬æœ‰ç†ç”±æ€€ç–‘ï¼Œæ˜¯å®¢æˆ·ç«¯å¼€å¯äº†å»¶è¿Ÿç¡®è®¤æœºåˆ¶ã€‚è€Œè¿™å„¿çš„å®¢æˆ·ç«¯ï¼Œå®é™…ä¸Šå°±æ˜¯å‰é¢è¿è¡Œçš„ wrkã€‚</p><p>æŸ¥è¯¢ TCP æ–‡æ¡£ï¼ˆæ‰§è¡Œ man tcpï¼‰ï¼Œä½ å°±ä¼šå‘ç°ï¼Œåªæœ‰ TCP å¥—æ¥å­—ä¸“é—¨è®¾ç½®äº† TCP_QUICKACK ï¼Œæ‰ä¼šå¼€å¯å¿«é€Ÿç¡®è®¤æ¨¡å¼ï¼›å¦åˆ™ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé‡‡ç”¨çš„å°±æ˜¯å»¶è¿Ÿç¡®è®¤æœºåˆ¶ï¼š</p><pre><code>TCP_QUICKACK (since Linux 2.4.4)
              Enable  quickack mode if set or disable quickack mode if cleared.  In quickack mode, acks are sent immeâ€
              diately, rather than delayed if needed in accordance to normal TCP operation.  This flag is  not  permaâ€
              nent,  it only enables a switch to or from quickack mode.  Subsequent operation of the TCP protocol will
              once again enter/leave quickack mode depending on internal  protocol  processing  and  factors  such  as
              delayed ack timeouts occurring and data transfer.  This option should not be used in code intended to be
              portable.
</code></pre><p>ä¸ºäº†éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ï¼Œç¡®è®¤ wrk çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ strace ï¼Œæ¥è§‚å¯Ÿ wrk ä¸ºå¥—æ¥å­—è®¾ç½®äº†å“ªäº› TCP é€‰é¡¹ã€‚</p><p>æ¯”å¦‚ï¼Œä½ å¯ä»¥åˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><pre><code>$ strace -f wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30:8080/
...
setsockopt(52, SOL_TCP, TCP_NODELAY, [1], 4) = 0
...
</code></pre><p>è¿™æ ·ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œwrk åªè®¾ç½®äº† TCP_NODELAY é€‰é¡¹ï¼Œè€Œæ²¡æœ‰è®¾ç½® TCP_QUICKACKã€‚è¿™è¯´æ˜ wrk é‡‡ç”¨çš„æ­£æ˜¯å»¶è¿Ÿç¡®è®¤ï¼Œä¹Ÿå°±è§£é‡Šäº†ä¸Šé¢è¿™ä¸ª40ms çš„é—®é¢˜ã€‚</p><p>ä¸è¿‡ï¼Œåˆ«å¿˜äº†ï¼Œè¿™åªæ˜¯å®¢æˆ·ç«¯çš„è¡Œä¸ºï¼ŒæŒ‰ç†æ¥è¯´ï¼ŒNginx æœåŠ¡å™¨ä¸åº”è¯¥å—åˆ°è¿™ä¸ªè¡Œä¸ºçš„å½±å“ã€‚é‚£æ˜¯ä¸æ˜¯æˆ‘ä»¬åˆ†æç½‘ç»œåŒ…æ—¶ï¼Œæ¼æ‰äº†ä»€ä¹ˆçº¿ç´¢å‘¢ï¼Ÿè®©æˆ‘ä»¬å›åˆ° Wireshark é‡æ–°è§‚å¯Ÿä¸€ä¸‹ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/72/8a/72eb14e8996147a458aa6523110c938a.png" alt=""></p><p>ä»”ç»†è§‚å¯Ÿ Wireshark çš„ç•Œé¢ï¼Œå…¶ä¸­ï¼Œ 1173 å·åŒ…ï¼Œå°±æ˜¯åˆšæ‰è¯´åˆ°çš„å»¶è¿Ÿ ACK åŒ…ï¼›ä¸‹ä¸€è¡Œçš„ 1175 ï¼Œåˆ™æ˜¯ Nginx å‘é€çš„ç¬¬äºŒä¸ªåˆ†ç»„åŒ…ï¼Œå®ƒè·Ÿ 697 å·åŒ…ç»„åˆèµ·æ¥ï¼Œæ„æˆä¸€ä¸ªå®Œæ•´çš„ HTTP å“åº”ï¼ˆACK å·éƒ½æ˜¯ 85ï¼‰ã€‚</p><p>ç¬¬äºŒä¸ªåˆ†ç»„æ²¡è·Ÿå‰ä¸€ä¸ªåˆ†ç»„ï¼ˆ697 å·ï¼‰ä¸€èµ·å‘é€ï¼Œè€Œæ˜¯ç­‰åˆ°å®¢æˆ·ç«¯å¯¹ç¬¬ä¸€ä¸ªåˆ†ç»„çš„ ACK åï¼ˆ1173 å·ï¼‰æ‰å‘é€ï¼Œè¿™çœ‹èµ·æ¥è·Ÿå»¶è¿Ÿç¡®è®¤æœ‰ç‚¹åƒï¼Œåªä¸è¿‡ï¼Œè¿™å„¿ä¸å†æ˜¯ ACKï¼Œè€Œæ˜¯å‘é€æ•°æ®ã€‚</p><p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä¼°è®¡ä½ æƒ³èµ·äº†ä¸€ä¸ªä¸œè¥¿â€”â€” Nagle ç®—æ³•ï¼ˆçº³æ ¼ç®—æ³•ï¼‰ã€‚è¿›ä¸€æ­¥åˆ†ææ¡ˆä¾‹å‰ï¼Œæˆ‘å…ˆç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªç®—æ³•ã€‚</p><p>Nagle ç®—æ³•ï¼Œæ˜¯ TCP åè®®ä¸­ç”¨äºå‡å°‘å°åŒ…å‘é€æ•°é‡çš„ä¸€ç§ä¼˜åŒ–ç®—æ³•ï¼Œç›®çš„æ˜¯ä¸ºäº†æé«˜å®é™…å¸¦å®½çš„åˆ©ç”¨ç‡ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå½“æœ‰æ•ˆè´Ÿè½½åªæœ‰ 1 å­—èŠ‚æ—¶ï¼Œå†åŠ ä¸Š TCP å¤´éƒ¨å’Œ IP å¤´éƒ¨åˆ†åˆ«å ç”¨çš„ 20 å­—èŠ‚ï¼Œæ•´ä¸ªç½‘ç»œåŒ…å°±æ˜¯ 41 å­—èŠ‚ï¼Œè¿™æ ·å®é™…å¸¦å®½çš„åˆ©ç”¨ç‡åªæœ‰ 2.4%ï¼ˆ1/41ï¼‰ã€‚å¾€å¤§äº†è¯´ï¼Œå¦‚æœæ•´ä¸ªç½‘ç»œå¸¦å®½éƒ½è¢«è¿™ç§å°åŒ…å æ»¡ï¼Œé‚£æ•´ä¸ªç½‘ç»œçš„æœ‰æ•ˆåˆ©ç”¨ç‡å°±å¤ªä½äº†ã€‚</p><p>Nagle ç®—æ³•æ­£æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒé€šè¿‡åˆå¹¶ TCP å°åŒ…ï¼Œæé«˜ç½‘ç»œå¸¦å®½çš„åˆ©ç”¨ç‡ã€‚Nagle ç®—æ³•è§„å®šï¼Œä¸€ä¸ª TCP è¿æ¥ä¸Šï¼Œæœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªæœªè¢«ç¡®è®¤çš„æœªå®Œæˆåˆ†ç»„ï¼›åœ¨æ”¶åˆ°è¿™ä¸ªåˆ†ç»„çš„ ACK å‰ï¼Œä¸å‘é€å…¶ä»–åˆ†ç»„ã€‚è¿™äº›å°åˆ†ç»„ä¼šè¢«ç»„åˆèµ·æ¥ï¼Œå¹¶åœ¨æ”¶åˆ° ACK åï¼Œç”¨åŒä¸€ä¸ªåˆ†ç»„å‘é€å‡ºå»ã€‚</p><p>æ˜¾ç„¶ï¼ŒNagle ç®—æ³•æœ¬èº«çš„æƒ³æ³•è¿˜æ˜¯æŒºå¥½çš„ï¼Œä½†æ˜¯çŸ¥é“ Linux é»˜è®¤çš„å»¶è¿Ÿç¡®è®¤æœºåˆ¶åï¼Œä½ åº”è¯¥å°±ä¸è¿™ä¹ˆæƒ³äº†ã€‚å› ä¸ºå®ƒä»¬ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œç½‘ç»œå»¶è¿Ÿä¼šæ˜æ˜¾ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static001.geekbang.org/resource/image/c5/c6/c51439692921cbf67b746a45fded2ec6.png" alt=""></p><ul>
<li>
<p>å½“ Sever å‘é€äº†ç¬¬ä¸€ä¸ªåˆ†ç»„åï¼Œç”±äº Client å¼€å¯äº†å»¶è¿Ÿç¡®è®¤ï¼Œå°±éœ€è¦ç­‰å¾… 40ms åæ‰ä¼šå›å¤ ACKã€‚</p>
</li>
<li>
<p>åŒæ—¶ï¼Œç”±äº Server ç«¯å¼€å¯äº† Nagleï¼Œè€Œè¿™æ—¶è¿˜æ²¡æ”¶åˆ°ç¬¬ä¸€ä¸ªåˆ†ç»„çš„ ACKï¼ŒServer ä¹Ÿä¼šåœ¨è¿™é‡Œä¸€ç›´ç­‰ç€ã€‚</p>
</li>
<li>
<p>ç›´åˆ° 40ms è¶…æ—¶åï¼ŒClient æ‰ä¼šå›å¤ACKï¼Œç„¶åï¼ŒServer æ‰ä¼šç»§ç»­å‘é€ç¬¬äºŒä¸ªåˆ†ç»„ã€‚</p>
</li>
</ul><p>æ—¢ç„¶å¯èƒ½æ˜¯ Nagle çš„é—®é¢˜ï¼Œé‚£è¯¥æ€ä¹ˆçŸ¥é“ï¼Œæ¡ˆä¾‹ Nginx æœ‰æ²¡æœ‰å¼€å¯ Nagle å‘¢ï¼Ÿ</p><p>æŸ¥è¯¢ tcp çš„æ–‡æ¡£ï¼Œä½ å°±ä¼šçŸ¥é“ï¼Œåªæœ‰è®¾ç½®äº† TCP_NODELAY åï¼ŒNagle ç®—æ³•æ‰ä¼šç¦ç”¨ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦æŸ¥çœ‹ Nginx çš„ tcp_nodelay é€‰é¡¹å°±å¯ä»¥äº†ã€‚</p><pre><code>TCP_NODELAY
              If set, disable the Nagle algorithm.  This means that segments are always sent as soon as possible, even
              if there is only a small amount of data.  When not set, data is buffered until  there  is  a  sufficient
              amount  to  send out, thereby avoiding the frequent sending of small packets, which results in poor utiâ€
              lization of the network.  This option is overridden by TCP_CORK; however, setting this option forces  an
              explicit flush of pending output, even if TCP_CORK is currently set.
</code></pre><p>æˆ‘ä»¬å›åˆ°ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒæŸ¥çœ‹æ¡ˆä¾‹ Nginx çš„é…ç½®:</p><pre><code>$ docker exec nginx cat /etc/nginx/nginx.conf | grep tcp_nodelay
    tcp_nodelay    off;
</code></pre><p>æœç„¶ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œæ¡ˆä¾‹ Nginx çš„ tcp_nodelay æ˜¯å…³é—­çš„ï¼Œå°†å…¶è®¾ç½®ä¸º on ï¼Œåº”è¯¥å°±å¯ä»¥è§£å†³äº†ã€‚</p><p>æ”¹å®Œåï¼Œé—®é¢˜æ˜¯å¦å°±è§£å†³äº†å‘¢ï¼Ÿè‡ªç„¶éœ€è¦éªŒè¯æˆ‘ä»¬ä¸€ä¸‹ã€‚ä¿®æ”¹åçš„åº”ç”¨ï¼Œæˆ‘å·²ç»æ‰“åŒ…åˆ°äº†Docker é•œåƒä¸­ï¼Œåœ¨ç»ˆç«¯ä¸€ä¸­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä½ å°±å¯ä»¥å¯åŠ¨å®ƒï¼š</p><pre><code># åˆ é™¤æ¡ˆä¾‹åº”ç”¨
$ docker rm -f nginx

# å¯åŠ¨ä¼˜åŒ–åçš„åº”ç”¨
$ docker run --name nginx --network=host -itd feisky/nginx:nodelay
</code></pre><p>æ¥ç€ï¼Œåˆ‡æ¢åˆ°ç»ˆç«¯äºŒï¼Œé‡æ–°æ‰§è¡Œ wrk æµ‹è¯•å»¶è¿Ÿï¼š</p><pre><code>$ wrk --latency -c 100 -t 2 --timeout 2 http://192.168.0.30:8080/
Running 10s test @ http://192.168.0.30:8080/
  2 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     9.58ms   14.98ms 350.08ms   97.91%
    Req/Sec     6.22k   282.13     6.93k    68.50%
  Latency Distribution
     50%    7.78ms
     75%    8.20ms
     90%    9.02ms
     99%   73.14ms
  123990 requests in 10.01s, 100.50MB read
Requests/sec:  12384.04
Transfer/sec:     10.04MB
</code></pre><p>æœç„¶ï¼Œç°åœ¨å»¶è¿Ÿå·²ç»ç¼©çŸ­æˆäº† 9msï¼Œè·Ÿæˆ‘ä»¬æµ‹è¯•çš„å®˜æ–¹ Nginx é•œåƒæ˜¯ä¸€æ ·çš„ï¼ˆNginx é»˜è®¤å°±æ˜¯å¼€å¯ tcp_nodelay çš„ï¼‰ ã€‚</p><p>ä½œä¸ºå¯¹æ¯”ï¼Œæˆ‘ä»¬ç”¨ tcpdump ï¼ŒæŠ“å–ä¼˜åŒ–åçš„ç½‘ç»œåŒ…ï¼ˆè¿™å„¿å®é™…ä¸ŠæŠ“å–çš„æ˜¯å®˜æ–¹ Nginx ç›‘å¬çš„ 80 ç«¯å£ï¼‰ã€‚ä½ å¯ä»¥å¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p><p><img src="https://static001.geekbang.org/resource/image/b5/ba/b5f1643cdca33f29408881542fca4eba.png" alt=""></p><p>ä»å›¾ä¸­ä½ å¯ä»¥å‘ç°ï¼Œç”±äº Nginx ä¸ç”¨å†ç­‰ ACKï¼Œ536 å’Œ 540 ä¸¤ä¸ªåˆ†ç»„æ˜¯è¿ç»­å‘é€çš„ï¼›è€Œå®¢æˆ·ç«¯å‘¢ï¼Œè™½ç„¶ä»å¼€å¯äº†å»¶è¿Ÿç¡®è®¤ï¼Œä½†è¿™æ—¶æ”¶åˆ°äº†ä¸¤ä¸ªéœ€è¦å›å¤ ACK çš„åŒ…ï¼Œæ‰€ä»¥ä¹Ÿä¸ç”¨ç­‰ 40msï¼Œå¯ä»¥ç›´æ¥åˆå¹¶å›å¤ ACKã€‚</p><p>æ¡ˆä¾‹æœ€åï¼Œä¸è¦å¿˜è®°åœæ­¢è¿™ä¸¤ä¸ªå®¹å™¨åº”ç”¨ã€‚åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°±å¯ä»¥åˆ é™¤æ¡ˆä¾‹åº”ç”¨ï¼š</p><pre><code>$ docker rm -f nginx good
</code></pre><h2>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ç½‘ç»œå»¶è¿Ÿå¢å¤§åçš„åˆ†ææ–¹æ³•ã€‚ç½‘ç»œå»¶è¿Ÿï¼Œæ˜¯æœ€æ ¸å¿ƒçš„ç½‘ç»œæ€§èƒ½æŒ‡æ ‡ã€‚ç”±äºç½‘ç»œä¼ è¾“ã€ç½‘ç»œåŒ…å¤„ç†ç­‰å„ç§å› ç´ çš„å½±å“ï¼Œç½‘ç»œå»¶è¿Ÿä¸å¯é¿å…ã€‚ä½†è¿‡å¤§çš„ç½‘ç»œå»¶è¿Ÿï¼Œä¼šç›´æ¥å½±å“ç”¨æˆ·çš„ä½“éªŒã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨å‘ç°ç½‘ç»œå»¶è¿Ÿå¢å¤§åï¼Œä½ å¯ä»¥ç”¨ tracerouteã€hping3ã€tcpdumpã€Wiresharkã€strace ç­‰å¤šç§å·¥å…·ï¼Œæ¥å®šä½ç½‘ç»œä¸­çš„æ½œåœ¨é—®é¢˜ã€‚æ¯”å¦‚ï¼Œ</p><ul>
<li>
<p>ä½¿ç”¨ hping3 ä»¥åŠ wrk ç­‰å·¥å…·ï¼Œç¡®è®¤å•æ¬¡è¯·æ±‚å’Œå¹¶å‘è¯·æ±‚æƒ…å†µçš„ç½‘ç»œå»¶è¿Ÿæ˜¯å¦æ­£å¸¸ã€‚</p>
</li>
<li>
<p>ä½¿ç”¨ tracerouteï¼Œç¡®è®¤è·¯ç”±æ˜¯å¦æ­£ç¡®ï¼Œå¹¶æŸ¥çœ‹è·¯ç”±ä¸­æ¯ä¸€è·³ç½‘å…³çš„å»¶è¿Ÿã€‚</p>
</li>
<li>
<p>ä½¿ç”¨ tcpdump å’Œ Wiresharkï¼Œç¡®è®¤ç½‘ç»œåŒ…çš„æ”¶å‘æ˜¯å¦æ­£å¸¸ã€‚</p>
</li>
<li>
<p>ä½¿ç”¨ strace ç­‰ï¼Œè§‚å¯Ÿåº”ç”¨ç¨‹åºå¯¹ç½‘ç»œå¥—æ¥å­—çš„è°ƒç”¨æƒ…å†µæ˜¯å¦æ­£å¸¸ã€‚</p>
</li>
</ul><p>è¿™æ ·ï¼Œä½ å°±å¯ä»¥ä¾æ¬¡ä»è·¯ç”±ã€ç½‘ç»œåŒ…çš„æ”¶å‘ã€å†åˆ°åº”ç”¨ç¨‹åºç­‰ï¼Œé€å±‚æ’æŸ¥ï¼Œç›´åˆ°å®šä½é—®é¢˜æ ¹æºã€‚</p><h2>æ€è€ƒ</h2><p>æœ€åï¼Œæˆ‘æƒ³é‚€è¯·ä½ ä¸€èµ·æ¥èŠèŠï¼Œä½ æ‰€ç†è§£çš„ç½‘ç»œå»¶è¿Ÿï¼Œä»¥åŠåœ¨å‘ç°ç½‘ç»œå»¶è¿Ÿå¢å¤§æ—¶ï¼Œä½ åˆæ˜¯æ€ä¹ˆåˆ†æçš„å‘¢ï¼Ÿä½ å¯ä»¥ç»“åˆä»Šå¤©çš„å†…å®¹ï¼Œå’Œä½ è‡ªå·±çš„æ“ä½œè®°å½•ï¼Œæ¥æ€»ç»“æ€è·¯ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/a3/e9/a396aed4116c2c989771c1295736abe9.jpg" alt=""></p>
                    </div>
                </div>

            </div>
            <div data-v-87ffcada="" class="article-comments pd"><h2 data-v-87ffcada=""><span
                    data-v-87ffcada="">ç²¾é€‰ç•™è¨€</span></h2>
                <ul data-v-87ffcada="">
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">è…¾è¾¾</span>
                            </div>
                            <div class="bd">$ docker run --name nginx --network=host -itd feisky&#47;nginx:latency<br>Unable to find image &#39;feisky&#47;nginx:latency&#39; locally<br>latency: Pulling from feisky&#47;nginx<br>5e6ec7f28fb7: Already exists <br>ab804f9bbcbe: Pulling fs layer <br>052b395f16bc: Pulling fs layer <br>56e01c98ad9d: Pulling fs layer <br>6f031ef539d7: Waiting <br>docker: error pulling image configuration: Get https:&#47;&#47;production.cloudflare.docker.com&#47;registry-v2&#47;docker&#47;registry&#47;v2&#47;blobs&#47;sha256&#47;ff&#47;fffd3cdd85b7a78c3b093b15601bf9762700b7410bea85b2bef4be785e0eec78&#47;data?verify=1550896895-4OAdDyJDSHuscVzPjISQp%2FwoqNo%3D: dial tcp 104.18.122.25:443: i&#47;o timeout.<br><br>æ— æ³•æ‹‰ä¸‹æ¥ã€‚åç»­è¯¾ç¨‹å¯å¦ç®€å•ä»‹ç»ä¸€ä¸‹é…ç½®ï¼Œè¿™æ ·å³ä½¿æ— æ³•æ‹‰ä¸‹æ¥ï¼Œä¹Ÿå¯ä»¥è‡ªå·±é…ä¸€ä¸ª <br></div>
                            <span class="time">2019-02-23 11:54</span>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Linuxer</span>
                            </div>
                            <div class="bd">åŒä¸€å¥—ç¯å¢ƒç¢°åˆ°ä¸€ä¸ªä½å¹¶å‘é«˜å»¶æ—¶ï¼Œé«˜å¹¶å‘ä½å»¶æ—¶å¾—çš„é—®é¢˜ï¼Œè¯·é—®å€ªè€å¸ˆåƒè¿™ç§é—®é¢˜è¯¥å¦‚ä½•æ’æŸ¥? <br></div>
                            <span class="time">2019-02-22 11:20</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">æ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯åœ¨æŠ“åŒ…åè¦æŒ‰åº”ç”¨è¿‡æ»¤ï¼ˆæ¯”å¦‚ç«¯å£å·ï¼‰ï¼Œç„¶åå†åˆ†åˆ«è¿›è¡Œåˆ†æ</p>
                                <p class="reply-time">2019-02-23 00:10</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/10/5c/cb/3ebdcc49.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æ€€ç‰¹</span>
                            </div>
                            <div class="bd">traceroute ä¼šåœ¨è·¯ç”±çš„æ¯ä¸€è·³å‘é€ä¸‰ä¸ªåŒ…ï¼Œå¹¶åœ¨æ”¶åˆ°å“åº”åï¼Œè¾“å‡ºå¾€è¿”å»¶æ—¶ã€‚å¦‚æœæ— å“åº”æˆ–è€…å“åº”è¶…æ—¶ï¼ˆé»˜è®¤ 5sï¼‰ï¼Œå°±ä¼šè¾“å‡ºä¸€ä¸ªæ˜Ÿå·ã€‚<br>----è¿™ä¸ªåœ°æ–¹ï¼Œè¿˜æœ‰äº›ä¸æ˜ç™½ï¼Œå¸Œæœ›è€å¸ˆèƒ½åœ¨è¿™é‡Œå†è§£é‡Šå‡ å¥<br> <br></div>
                            <span class="time">2019-02-22 11:13</span>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/0f/57/d8/abb7bfe3.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Andylee</span>
                            </div>
                            <div class="bd">æˆ‘è®°å¾—ä¹‹å‰ç¢°åˆ°çš„å»¶è¿Ÿackæ˜¯200msï¼Œè¿™ä¸ªæ˜¯å¯ä»¥é…ç½®çš„å—ï¼Ÿ <br></div>
                            <span class="time">2019-02-22 08:28</span>
                            
                            <div class="reply">
                                <div class="reply-hd"><span>ä½œè€…å›å¤</span></div>
                                <p class="reply-content">çœ‹ç³»ç»Ÿçš„ï¼Œæ®æˆ‘æ‰€çŸ¥ï¼Œåªæœ‰RHELå¯ä»¥é€šè¿‡&#47;proc&#47;sys&#47;net&#47;ipv4&#47;tcp_delack_minä¿®æ”¹ï¼ˆé»˜è®¤40msï¼‰ï¼Œè€Œå…¶ä»–å‘è¡Œç‰ˆéƒ½ä¸æ”¯æŒã€‚</p>
                                <p class="reply-time">2019-02-23 00:08</p>
                            </div>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Linuxer</span>
                            </div>
                            <div class="bd">æ¡ˆä¾‹ä¸­èƒ½è®¾ç½®å®¢æˆ·ç«¯çš„TCP_QUICKACKè§£å†³å—ï¼Ÿ <br></div>
                            <span class="time">2019-02-22 08:26</span>
                            
                        </div>
                    </li>
                    
                    <li data-v-87ffcada="" class="comment-item"><img
                            src="https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">æˆ‘æ¥ä¹Ÿ</span>
                            </div>
                            <div class="bd">[D40æ‰“å¡]<br>æˆ‘ä¹‹å‰ç†è§£çš„ç½‘ç»œå»¶è¿Ÿåˆ†ä¸‰éƒ¨åˆ†ï¼šå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯é€»è¾‘å¤„ç†ï¼ŒæœåŠ¡ç«¯åˆ°å®¢æˆ·ç«¯åˆ°è€—æ—¶ã€‚<br><br>å…¶ä¸­æœåŠ¡ç«¯é€»è¾‘å¤„ç†çš„è€—æ—¶æ˜¯è·Ÿè‡ªèº«ç¨‹åºæœ‰å…³çš„ï¼Œå¦å¤–ä¸¤ä¸ªè€—æ—¶è·Ÿå®½å¸¦æœåŠ¡æä¾›å•†æœ‰å…³ï¼Œæƒ³æ›´çŸ­çš„è€—æ—¶å°±å¾—åŠ é’±ï¼šé€‰æ›´ä¼˜çš„çº¿è·¯æˆ–è€…åœ¨é è¿‘å®¢æˆ·ç«¯çš„åœ°æ–¹åŠ å…¥å£ã€‚<br><br>ç›®å‰æˆ‘ä»¬çº¿ä¸Šç¨‹åºæ˜¯å¯ä»¥æ¨ç®—å‡ºå•æ¬¡å“åº”çš„æ—¶é—´çš„ï¼Œå› ä¸ºåœ¨å‡ºå…¥å£çš„åœ°æ–¹æœ‰è®°å½•ã€‚ä¸ç®¡ä¸­é—´ç»è¿‡äº†å¤šå°‘æœåŠ¡çš„å¤„ç†ï¼Œéƒ½å¯ä»¥ç®—å‡ºæ€»çš„è€—æ—¶ã€‚<br><br>æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ä¸­ä¹ŸåŠ äº†æ±‡æŠ¥åŠŸèƒ½ï¼Œåœ¨å®¢æˆ·ç«¯çš„æŸäº›æ¶ˆæ¯ä¸­ä¼šæ±‡æŠ¥ å®¢æˆ·ç«¯å®é™…å‘é€è¯·æ±‚-&gt;æ”¶åˆ°æœåŠ¡ç«¯å“åº” çš„æ—¶é—´å·®ã€‚è¿™æ ·ä¾¿äºæˆ‘ä»¬ç¡®è®¤å®¢æˆ·ç«¯çš„ç½‘ç»œçŠ¶å†µã€‚<br><br>ä»æœ¬æ–‡ä¸­ï¼Œç¬¬ä¸€æ¬¡è§åˆ°äº† Nagle ç®—æ³•ã€‚ä¹ŸçŸ¥é“äº†æœåŠ¡ç«¯å…³é—­icmpæ—¶æ€ä¹ˆç”¨tcp&#47;udpæµ‹è¯•ç½‘ç»œå»¶è¿Ÿã€‚<br><br>æ–‡ä¸­çš„å†…å®¹ä¹Ÿæ˜¯è·Œå®•èµ·ä¼ï¼Œåˆ†æç€æ€ä¹ˆè¿˜æ˜¯å®¢æˆ·ç«¯çš„é—®é¢˜ï¼Œå®¢æˆ·ç«¯è®¿é—®å¦å¤–ä¸€ä¸ªæœåŠ¡è¿˜æ˜¯å¥½çš„ã€‚åŸæ¥æ˜¯æœåŠ¡ç«¯ç¨‹åºä¹Ÿæœ‰é—®é¢˜ï¼Œä¸€ä¸ªå·´æŒæ‹ä¸å“ã€‚ğŸ˜‚<br> <br></div>
                            <span class="time">2019-02-22 08:15</span>
                            
                        </div>
                    </li>
                    


                </ul>
            </div>
        </div>
    </div>
</div>
</body>
</html>