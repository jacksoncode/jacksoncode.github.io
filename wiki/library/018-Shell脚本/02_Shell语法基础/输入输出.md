# 输入输出

## Shell输入输出基础

在Shell脚本编程中，输入输出（I/O）是与用户交互和处理数据的重要方式。Shell提供了多种机制来处理输入输出，包括标准输入、标准输出、标准错误输出，以及重定向和管道等功能。

## 标准输入输出流

在Unix/Linux系统中，每个进程都有三个默认的文件描述符：

1. **标准输入（stdin）**：文件描述符为0，默认连接到键盘
2. **标准输出（stdout）**：文件描述符为1，默认连接到屏幕
3. **标准错误（stderr）**：文件描述符为2，默认连接到屏幕

### 标准输出

标准输出用于输出正常的信息。在Shell中，可以使用`echo`和`printf`命令输出信息。

#### echo命令

`echo`是最常用的输出命令，用于在终端显示文本：

```bash
#!/bin/bash

# 基本输出
echo "Hello World"

# 输出变量
name="张三"
echo "你好, $name"

# 输出不换行
echo -n "这是不换行的输出 "
echo "这会接在上一行后面"

# 输出带颜色的文本
echo -e "\033[31m这是红色文本\033[0m"
echo -e "\033[32m这是绿色文本\033[0m"
echo -e "\033[34m这是蓝色文本\033[0m"

# 输出特殊字符
echo -e "第一行\n第二行"  # \n表示换行
echo -e "列1\t列2\t列3"   # \t表示制表符
```

#### printf命令

`printf`提供了更精确的格式化输出控制，类似于C语言中的printf函数：

```bash
#!/bin/bash

name="张三"
age=25
height=175.5

# 基本格式化输出
printf "姓名: %s\n" "$name"
printf "年龄: %d\n" "$age"
printf "身高: %.1f cm\n" "$height"

# 对齐输出
printf "%-10s %5d %8.1f\n" "$name" "$age" "$height"
printf "%-10s %5d %8.1f\n" "李四" 30 180.0

# 格式化数字
printf "十六进制: %x\n" 255
printf "八进制: %o\n" 255
printf "科学计数法: %e\n" 123456
```

### 标准输入

标准输入用于接收用户输入的数据。在Shell中最常用的命令是`read`。

#### read命令

```bash
#!/bin/bash

# 基本读取
echo "请输入您的姓名:"
read name
echo "您好, $name!"

# 读取多个值
echo "请输入您的姓名和年龄（用空格分隔）:"
read name age
echo "姓名: $name, 年龄: $age"

# 指定提示符
read -p "请输入您的邮箱: " email
echo "邮箱: $email"

# 隐藏输入（如密码）
read -s -p "请输入密码: " password
echo  # 换行
echo "密码已输入"

# 设置超时时间
if read -t 5 -p "请在5秒内输入内容: " input; then
    echo "您输入了: $input"
else
    echo "超时未输入"
fi

# 限制输入字符数
read -n 1 -p "按任意键继续..." key
echo  # 换行

# 读取整行（包括空格）
read -p "请输入完整地址: " address
echo "地址: $address"
```

## 重定向

重定向允许我们将输入输出流指向文件或其他位置，而不是默认的终端。

### 输出重定向

#### 覆盖重定向（>）

将输出写入文件，如果文件存在则覆盖：

```bash
#!/bin/bash

# 将输出重定向到文件
echo "这是第一行" > output.txt
echo "这是第二行" > output.txt  # 这会覆盖第一行

# 将命令输出重定向到文件
ls -l > file_list.txt
date > current_time.txt
```

#### 追加重定向（>>）

将输出追加到文件末尾：

```bash
#!/bin/bash

# 追加内容到文件
echo "第一条日志" >> log.txt
echo "第二条日志" >> log.txt
echo "第三条日志" >> log.txt

# 创建日志记录脚本
echo "$(date): 脚本开始执行" >> script.log
# ... 执行一些操作 ...
echo "$(date): 操作完成" >> script.log
```

### 输入重定向

使用`<`可以从文件读取输入：

```bash
#!/bin/bash

# 从文件读取内容
wc -l < /etc/passwd  # 统计文件行数

# 使用read从文件读取
read first_line < input.txt
echo "文件第一行: $first_line"

# 从文件读取多行
while read line; do
    echo "读取到: $line"
done < input.txt
```

### 错误输出重定向

标准错误输出（文件描述符2）可以单独重定向：

```bash
#!/bin/bash

# 将错误输出重定向到文件
ls /nonexistent 2> error.log

# 将标准输出和错误输出分别重定向
ls /etc/passwd /nonexistent > output.log 2> error.log

# 将标准输出和错误输出都重定向到同一文件
ls /etc/passwd /nonexistent > all_output.log 2>&1

# 或者使用简写方式
ls /etc/passwd /nonexistent &> all_output.log

# 丢弃输出（重定向到/dev/null）
ls /etc/passwd > /dev/null 2>&1
# 或者
ls /etc/passwd &> /dev/null
```

## 管道

管道（`|`）允许将一个命令的输出作为另一个命令的输入：

```bash
#!/bin/bash

# 基本管道使用
ls -l | grep ".txt"  # 列出包含.txt的文件

# 多级管道
ps aux | grep bash | grep -v grep  # 查找bash进程

# 统计文件行数
cat /etc/passwd | wc -l

# 排序并去重
cat names.txt | sort | uniq

# 查找并统计
find . -name "*.sh" | wc -l
```

## Here文档

Here文档允许将多行文本作为命令的输入：

```bash
#!/bin/bash

# 基本Here文档
cat << EOF
这是多行文本
可以包含变量: $USER
可以包含命令: $(date)
EOF

# 将Here文档内容写入文件
cat > message.txt << EOF
收件人: 张三
主题: 通知

这是一封通知邮件。
发送时间: $(date)
EOF

# 使用变量作为结束标记
delimiter="END"
cat << $delimiter
这是使用变量作为结束标记的Here文档
$delimiter

# 忽略前导制表符（使用 <<-）
cat <<- EOF
	这行前面的制表符会被忽略
	而这些文本会正常显示
EOF
```

## Here字符串

Here字符串是Here文档的简化版本，用于传递单行字符串：

```bash
#!/bin/bash

# 基本Here字符串
wc -w <<< "这是要统计字数的字符串"

# 传递变量
text="Hello World"
grep "World" <<< "$text"

# 传递命令输出
sort <<< $(ls)
```

## 实际应用示例

### 日志处理脚本

```bash
#!/bin/bash

# 日志处理示例脚本
log_file="app.log"

# 创建示例日志
cat > $log_file << EOF
2023-01-01 10:00:01 INFO  Application started
2023-01-01 10:05:23 ERROR Database connection failed
2023-01-01 10:10:45 INFO  Retry connection
2023-01-01 10:15:12 WARN  High memory usage
2023-01-01 10:20:33 INFO  Application running normally
EOF

# 分析日志
echo "=== 日志分析报告 ===" > analysis_report.txt
echo "生成时间: $(date)" >> analysis_report.txt
echo "总日志条数: $(wc -l < $log_file)" >> analysis_report.txt
echo "错误条数: $(grep -c "ERROR" $log_file)" >> analysis_report.txt
echo "警告条数: $(grep -c "WARN" $log_file)" >> analysis_report.txt
echo "信息条数: $(grep -c "INFO" $log_file)" >> analysis_report.txt

# 提取错误信息
echo -e "\n=== 错误详情 ===" >> analysis_report.txt
grep "ERROR" $log_file >> analysis_report.txt

echo "分析报告已生成: analysis_report.txt"
cat analysis_report.txt
```

### 交互式菜单脚本

```bash
#!/bin/bash

# 交互式菜单示例
show_menu() {
    echo "========== 系统管理菜单 =========="
    echo "1. 查看系统信息"
    echo "2. 查看磁盘使用情况"
    echo "3. 查看内存使用情况"
    echo "4. 查看网络连接"
    echo "5. 退出"
    echo "================================"
}

get_system_info() {
    echo "=== 系统信息 ==="
    uname -a
    echo "当前用户: $(whoami)"
    echo "系统时间: $(date)"
}

get_disk_usage() {
    echo "=== 磁盘使用情况 ==="
    df -h
}

get_memory_usage() {
    echo "=== 内存使用情况 ==="
    free -h
}

get_network_connections() {
    echo "=== 网络连接 ==="
    netstat -an | head -10
}

# 主循环
while true; do
    show_menu
    read -p "请选择操作 (1-5): " choice
    
    case $choice in
        1)
            get_system_info
            read -p "按回车键继续..."
            ;;
        2)
            get_disk_usage
            read -p "按回车键继续..."
            ;;
        3)
            get_memory_usage
            read -p "按回车键继续..."
            ;;
        4)
            get_network_connections
            read -p "按回车键继续..."
            ;;
        5)
            echo "再见！"
            exit 0
            ;;
        *)
            echo "无效选择，请重新输入"
            read -p "按回车键继续..."
            ;;
    esac
done
```

## 高级输入输出技巧

### 文件描述符操作

```bash
#!/bin/bash

# 打开自定义文件描述符
exec 3< input.txt    # 打开文件用于读取
exec 4> output.txt   # 打开文件用于写入

# 使用自定义文件描述符
read line <&3
echo "从文件描述符3读取: $line"

echo "写入到文件描述符4" >&4

# 关闭文件描述符
exec 3<&-
exec 4>&-
```

### tee命令

`tee`命令可以同时将输出显示在终端和写入文件：

```bash
#!/bin/bash

# 同时输出到终端和文件
echo "这条信息会同时显示和保存" | tee output.txt

# 追加到文件
echo "这条信息会追加到文件" | tee -a output.txt

# 输出到多个文件
echo "这条信息会保存到多个文件" | tee file1.txt file2.txt file3.txt
```

## 最佳实践

1. **合理使用重定向**：将输出重定向到适当的位置，避免混乱
2. **区分标准输出和错误输出**：正确处理正常输出和错误信息
3. **使用Here文档处理多行文本**：比多次echo更清晰
4. **注意输入验证**：对用户输入进行验证和处理
5. **使用tee命令记录过程**：在调试时很有用
6. **避免硬编码文件名**：使用变量存储文件名，便于维护

## 总结

输入输出是Shell脚本与外界交互的核心机制。通过本章的学习，你应该掌握了：

1. 标准输入输出流的概念和使用
2. echo和printf命令的使用方法
3. read命令读取用户输入
4. 重定向操作控制输入输出流向
5. 管道连接多个命令
6. Here文档和Here字符串处理多行文本
7. 实际应用示例

这些技能将帮助你编写更加强大和用户友好的Shell脚本。在下一章中，我们将学习条件语句，让脚本能够根据不同的条件执行不同的操作。