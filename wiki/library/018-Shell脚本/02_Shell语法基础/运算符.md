# 运算符

## 什么是运算符

运算符是用于执行程序代码运算的符号。在Shell脚本中，运算符可以用于执行算术运算、比较运算、逻辑运算等操作。Shell提供了丰富的运算符来处理各种数据类型和操作需求。

## 算术运算符

Shell支持多种算术运算符，用于执行基本的数学运算。

### 基本算术运算符

| 运算符 | 说明     | 示例           | 结果  |
|--------|----------|----------------|-------|
| +      | 加法     | `expr 2 + 3`   | 5     |
| -      | 减法     | `expr 5 - 2`   | 3     |
| *      | 乘法     | `expr 3 \* 4`  | 12    |
| /      | 除法     | `expr 10 / 2`  | 5     |
| %      | 取余     | `expr 10 % 3`  | 1     |
| =      | 赋值     | `a=10`         | 将10赋值给a |
| ==     | 相等比较 | `[ $a == $b ]` | 比较a和b是否相等 |
| !=     | 不等比较 | `[ $a != $b ]` | 比较a和b是否不等 |

注意：在使用`*`时需要用反斜杠`\`转义，或者使用双引号。

### 算术运算示例

```bash
#!/bin/bash

a=10
b=20

echo "a = $a, b = $b"
echo "a + b = `expr $a + $b`"
echo "a - b = `expr $a - $b`"
echo "a * b = `expr $a \* $b`"
echo "b / a = `expr $b / $a`"
echo "b % a = `expr $b % $a`"

# 使用方括号进行算术运算（推荐方式）
echo "使用方括号的算术运算:"
echo "a + b = $((a + b))"
echo "a - b = $((a - b))"
echo "a * b = $((a * b))"
echo "b / a = $((b / a))"
echo "b % a = $((b % a))"

# 自增和自减运算符
echo "自增和自减运算:"
echo "a = $a"
echo "a++ = $((a++))"  # 先使用后增加
echo "a = $a"
echo "++a = $((++a))"  # 先增加后使用
echo "a = $a"
echo "a-- = $((a--))"  # 先使用后减少
echo "a = $a"
echo "--a = $((--a))"  # 先减少后使用
echo "a = $a"
```

## 关系运算符

关系运算符用于数字比较，主要用于条件判断。

| 运算符 | 说明              | 示例              |
|--------|-------------------|-------------------|
| -eq    | 相等 (equal)      | `[ $a -eq $b ]`   |
| -ne    | 不等 (not equal)  | `[ $a -ne $b ]`   |
| -gt    | 大于 (greater than)| `[ $a -gt $b ]`   |
| -lt    | 小于 (less than)  | `[ $a -lt $b ]`   |
| -ge    | 大于等于          | `[ $a -ge $b ]`   |
| -le    | 小于等于          | `[ $a -le $b ]`   |

### 关系运算示例

```bash
#!/bin/bash

a=10
b=20

if [ $a -eq $b ]
then
   echo "$a -eq $b : a 等于 b"
else
   echo "$a -eq $b: a 不等于 b"
fi

if [ $a -ne $b ]
then
   echo "$a -ne $b: a 不等于 b"
else
   echo "$a -ne $b : a 等于 b"
fi

if [ $a -gt $b ]
then
   echo "$a -gt $b: a 大于 b"
else
   echo "$a -gt $b: a 不大于 b"
fi

if [ $a -lt $b ]
then
   echo "$a -lt $b: a 小于 b"
else
   echo "$a -lt $b: a 不小于 b"
fi

if [ $a -ge $b ]
then
   echo "$a -ge $b: a 大于或等于 b"
else
   echo "$a -ge $b: a 小于 b"
fi

if [ $a -le $b ]
then
   echo "$a -le $b: a 小于或等于 b"
else
   echo "$a -le $b: a 大于 b"
fi
```

## 布尔运算符

布尔运算符用于逻辑判断。

| 运算符 | 说明     | 示例                     |
|--------|----------|--------------------------|
| !      | 非运算   | `[ ! false ]` 返回true   |
| -o     | 或运算   | `[ $a -lt 20 -o $b -gt 100 ]` |
| -a     | 与运算   | `[ $a -lt 20 -a $b -gt 100 ]` |

### 现代布尔运算符（推荐使用）

| 运算符 | 说明 | 示例                          |
|--------|------|-------------------------------|
| &&     | 与   | `[[ $a -lt 100 && $b -gt 10 ]]` |
| \|\|   | 或   | `[[ $a -lt 100 \|\| $b -gt 10 ]]` |

### 布尔运算示例

```bash
#!/bin/bash

a=10
b=20

# 使用传统布尔运算符
if [ $a -lt 100 -a $b -gt 5 ]
then
   echo "返回 true"
else
   echo "返回 false"
fi

if [ $a -lt 100 -o $b -gt 100 ]
then
   echo "返回 true"
else
   echo "返回 false"
fi

if [ $a -lt 5 -o $b -gt 100 ]
then
   echo "返回 true"
else
   echo "返回 false"
fi

# 使用现代布尔运算符（推荐）
if [[ $a -lt 100 && $b -gt 5 ]]
then
   echo "现代运算符: 返回 true"
else
   echo "现代运算符: 返回 false"
fi

if [[ $a -lt 100 || $b -gt 100 ]]
then
   echo "现代运算符: 返回 true"
else
   echo "现代运算符: 返回 false"
fi
```

## 字符串运算符

字符串运算符用于字符串的比较和检查。

| 运算符 | 说明                     | 示例                    |
|--------|--------------------------|-------------------------|
| =      | 相等                     | `[ $a = $b ]`           |
| !=     | 不等                     | `[ $a != $b ]`          |
| -z     | 字符串长度为0则为真      | `[ -z $a ]`             |
| -n     | 字符串长度不为0则为真    | `[ -n $a ]`             |
| $      | 字符串不为空则为真       | `[ $a ]`                |

### 字符串运算示例

```bash
#!/bin/bash

a="abc"
b="def"
c=""

if [ $a = $b ]
then
   echo "$a = $b : a 等于 b"
else
   echo "$a = $b: a 不等于 b"
fi

if [ $a != $b ]
then
   echo "$a != $b : a 不等于 b"
else
   echo "$a != $b: a 等于 b"
fi

if [ -z $c ]
then
   echo "-z $c : 字符串长度为 0"
else
   echo "-z $c : 字符串长度不为 0"
fi

if [ -n $a ]
then
   echo "-n $a : 字符串长度不为 0"
else
   echo "-n $a : 字符串长度为 0"
fi

if [ $c ]
then
   echo "$c : 字符串不为空"
else
   echo "$c : 字符串为空"
fi
```

## 文件测试运算符

文件测试运算符用于检测Unix文件的各种属性。

| 运算符 | 说明                                                |
|--------|-----------------------------------------------------|
| -b file| 检测文件是否是块设备文件                            |
| -c file| 检测文件是否是字符设备文件                          |
| -d file| 检测文件是否是目录                                  |
| -f file| 检测文件是否是普通文件（既不是目录，也不是设备文件）|
| -g file| 检测文件是否设置了SGID位                            |
| -k file| 检测文件是否设置了粘着位(Sticky Bit)                |
| -p file| 检测文件是否是有名管道                              |
| -u file| 检测文件是否设置了SUID位                            |
| -r file| 检测文件是否可读                                    |
| -w file| 检测文件是否可写                                    |
| -x file| 检测文件是否可执行                                  |
| -s file| 检测文件是否为空（文件大小是否大于0）              |
| -e file| 检测文件（包括目录）是否存在                        |

### 文件测试示例

```bash
#!/bin/bash

file="/etc/hosts"

if [ -r $file ]
then
   echo "文件可读"
else
   echo "文件不可读"
fi

if [ -w $file ]
then
   echo "文件可写"
else
   echo "文件不可写"
fi

if [ -x $file ]
then
   echo "文件可执行"
else
   echo "文件不可执行"
fi

if [ -f $file ]
then
   echo "文件为普通文件"
else
   echo "文件为特殊文件"
fi

if [ -d $file ]
then
   echo "文件是个目录"
else
   echo "文件不是个目录"
fi

if [ -s $file ]
then
   echo "文件不为空"
else
   echo "文件为空"
fi

if [ -e $file ]
then
   echo "文件存在"
else
   echo "文件不存在"
fi
```

## 实际应用示例

下面是一个综合使用各种运算符的示例脚本`system_check.sh`：

```bash
#!/bin/bash

# 系统检查脚本

# 检查是否有足够的参数
if [ $# -lt 1 ]; then
    echo "用法: $0 <目录路径>"
    exit 1
fi

directory=$1

# 检查目录是否存在
if [ ! -d "$directory" ]; then
    echo "错误: $directory 不是一个有效的目录"
    exit 1
fi

# 检查目录是否可读
if [ ! -r "$directory" ]; then
    echo "错误: 目录 $directory 不可读"
    exit 1
fi

# 获取目录中的文件数量
file_count=$(ls -1 "$directory" | wc -l)

echo "目录 $directory 中有 $file_count 个文件"

# 根据文件数量给出建议
if [ $file_count -lt 10 ]; then
    echo "这是一个较小的目录"
elif [ $file_count -lt 100 ]; then
    echo "这是一个中等大小的目录"
else
    echo "这是一个较大的目录"
fi

# 检查系统负载
load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')

# 将负载平均值转换为整数进行比较（乘以100）
load_int=$(echo "$load_avg * 100" | bc | cut -d. -f1)

if [ $load_int -gt 100 ]; then
    echo "警告: 系统负载较高 ($load_avg)"
elif [ $load_int -gt 50 ]; then
    echo "提示: 系统负载中等 ($load_avg)"
else
    echo "信息: 系统负载较低 ($load_avg)"
fi

# 检查可用内存
free_mem=$(free | grep Mem | awk '{print $7}')

if [ $free_mem -lt 100000 ]; then
    echo "警告: 可用内存较少 (${free_mem}KB)"
else
    echo "信息: 可用内存充足 (${free_mem}KB)"
fi

echo "系统检查完成"
```

## 运算符优先级

Shell运算符有特定的优先级顺序，从高到低如下：

1. `!` 非运算符
2. `*`、`/`、`%` 算术运算符
3. `+`、`-` 算术运算符
4. `<`、`<=`、`>`、`>=` 比较运算符
5. `==`、`!=` 相等运算符
6. `&&` 逻辑与
7. `||` 逻辑或

可以通过使用括号来改变运算顺序：

```bash
#!/bin/bash

a=10
b=20
c=30

# 不使用括号
result1=$((a + b * c))
echo "不使用括号: $result1"  # 输出: 610

# 使用括号改变优先级
result2=$(( (a + b) * c ))
echo "使用括号: $result2"    # 输出: 900
```

## 最佳实践

1. **使用双括号进行算术运算**：`$((expression))`比`expr`更简洁高效
2. **使用双方括号进行条件判断**：`[[ condition ]]`比`[ condition ]`更安全
3. **注意引号的使用**：在处理包含空格的字符串时使用引号
4. **优先使用现代运算符**：使用`&&`和`||`而不是`-a`和`-o`
5. **明确运算符优先级**：使用括号明确表达式计算顺序

## 总结

运算符是Shell脚本中进行各种操作的基础工具。通过本章的学习，你应该掌握了：

1. 算术运算符的使用方法
2. 关系运算符进行数值比较
3. 布尔运算符进行逻辑判断
4. 字符串运算符处理文本数据
5. 文件测试运算符检查文件属性
6. 运算符的优先级规则

这些运算符将帮助你编写更加强大和灵活的Shell脚本。在下一章中，我们将学习输入输出操作，进一步增强脚本的交互能力。