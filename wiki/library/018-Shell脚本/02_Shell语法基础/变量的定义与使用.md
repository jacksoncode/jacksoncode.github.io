# 变量的定义与使用

## 什么是变量

变量是Shell脚本中用来存储数据的容器。通过变量，我们可以存储各种类型的信息，如字符串、数字等，并在脚本的其他部分使用这些信息。

## 变量的命名规则

在Shell中，变量名需要遵循以下规则：

1. 变量名只能包含字母、数字和下划线
2. 变量名不能以数字开头
3. 变量名区分大小写
4. 变量名不应该包含空格或其他特殊字符

合法的变量名示例：
```bash
name
user_name
USER_NAME
_name
name123
```

非法的变量名示例：
```bash
123name    # 以数字开头
user-name  # 包含连字符
user name  # 包含空格
```

## 变量的定义

在Shell中定义变量非常简单，语法如下：
```bash
variable_name=value
```

注意：在等号`=`的两边不能有空格。

### 定义字符串变量

```bash
# 定义简单的字符串变量
name="张三"
city="北京"

# 包含空格的字符串需要用引号括起来
full_name="张 三"

# 单引号和双引号的区别
message1='Hello World'  # 单引号中的内容不会被替换
message2="Hello $name"  # 双引号中的变量会被替换
message3='Hello $name'  # 单引号中的变量不会被替换

echo $message1  # 输出: Hello World
echo $message2  # 输出: Hello 张三
echo $message3  # 输出: Hello $name
```

### 定义数字变量

```bash
# 定义整数变量
age=25
count=100

# 定义浮点数变量（以字符串形式存储）
price="99.99"
```

### 定义数组变量

```bash
# 定义数组
fruits=("苹果" "香蕉" "橙子")

# 定义关联数组（需要先声明）
declare -A person
person[name]="张三"
person[age]=25
```

## 变量的使用

使用变量时，需要在变量名前加上`$`符号：

```bash
name="张三"
echo $name        # 输出: 张三
echo ${name}      # 输出: 张三（推荐使用花括号）

# 在字符串中使用变量
echo "你好, $name"     # 输出: 你好, 张三
echo "你好, ${name}"   # 输出: 你好, 张三（更安全的写法）
```

## 变量的类型

### 局部变量

局部变量只在当前Shell会话中有效：

```bash
#!/bin/bash
local_var="局部变量"
echo $local_var
```

### 环境变量

环境变量对所有子进程都有效，使用`export`命令定义：

```bash
#!/bin/bash
export ENV_VAR="环境变量"
echo $ENV_VAR
```

### 只读变量

使用`readonly`命令可以定义只读变量：

```bash
#!/bin/bash
readonly PI=3.14159
echo $PI

# 尝试修改只读变量会报错
# PI=3.14  # 这会报错
```

## 特殊变量

Shell提供了一些特殊的内置变量：

```bash
$0     # 脚本名称
$1-$9  # 传递给脚本的第1-9个参数
$#     # 传递给脚本的参数个数
$*     # 所有参数作为一个字符串
$@     # 所有参数作为独立的字符串
$$     # 当前Shell进程的PID
$!     # 最后运行的后台进程的PID
$?     # 最后运行命令的退出状态码
```

示例脚本`special_vars.sh`：

```bash
#!/bin/bash

echo "脚本名称: $0"
echo "参数个数: $#"
echo "所有参数: $@"
echo "第一个参数: $1"
echo "第二个参数: $2"
echo "当前进程ID: $$"
echo "最后命令退出码: $?"

# 演示$*和$@的区别
echo "使用\$*: $*"
echo "使用\$@: $@"
```

运行示例：
```bash
chmod +x special_vars.sh
./special_vars.sh 参数1 "参数2 包含空格" 参数3
```

## 变量替换

Shell提供了多种变量替换的方式：

### 基本替换

```bash
name="张三"
echo $name
echo ${name}
```

### 默认值替换

当变量未定义或为空时，可以指定默认值：

```bash
# 如果variable未定义或为空，使用默认值
echo ${variable:-默认值}

# 如果variable未定义，使用默认值并赋值给variable
echo ${variable:=默认值}

# 如果variable已定义且非空，使用其值，否则输出错误信息
echo ${variable:?错误信息}

# 如果variable已定义且非空，使用其值，否则使用默认值（但不改变variable的值）
echo ${variable:+替代值}
```

示例：
```bash
#!/bin/bash

# 变量未定义的情况
echo "未定义变量的默认值: ${undefined_var:-默认值}"

# 设置默认值并赋值
echo "设置默认值: ${undefined_var:=默认值}"
echo "现在变量值为: $undefined_var"

# 条件替换
defined_var="已定义"
echo "变量已定义: ${defined_var:+变量有值}"
unset defined_var
echo "变量未定义: ${defined_var:+变量有值}"
```

### 字符串操作

```bash
filename="document.pdf"

# 获取变量值的长度
echo "文件名长度: ${#filename}"

# 字符串截取
echo "从第9个字符开始: ${filename:8}"
echo "从第0个字符开始取8个字符: ${filename:0:8}"

# 字符串删除
echo "删除最小匹配的后缀: ${filename%.*}"     # 删除最后一个点及其后的字符
echo "删除最大匹配的后缀: ${filename%%.*}"     # 删除第一个点及其后的字符
echo "删除最小匹配的前缀: ${filename#*.}"      # 删除最后一个点及其前的字符
echo "删除最大匹配的前缀: ${filename##*.}"     # 删除第一个点及其前的字符
```

## 变量的作用域

### 全局变量和局部变量

在函数中定义的变量默认是全局的，除非使用`local`关键字：

```bash
#!/bin/bash

global_var="全局变量"

test_function() {
    local local_var="局部变量"
    global_var_in_function="在函数中定义的全局变量"
    
    echo "函数内部:"
    echo "  全局变量: $global_var"
    echo "  局部变量: $local_var"
    echo "  函数中的全局变量: $global_var_in_function"
}

test_function

echo "函数外部:"
echo "  全局变量: $global_var"
echo "  函数中的全局变量: $global_var_in_function"
# echo "  局部变量: $local_var"  # 这会报错，因为局部变量在函数外部不可访问
```

## 实际应用示例

下面是一个实际应用变量的示例脚本`user_manager.sh`：

```bash
#!/bin/bash

# 用户管理脚本示例

# 定义常量
readonly SCRIPT_NAME="用户管理脚本"
readonly VERSION="1.0"

# 定义变量
username=""
action=""

# 显示脚本信息
show_info() {
    echo "================================"
    echo "  $SCRIPT_NAME v$VERSION"
    echo "================================"
}

# 获取用户输入
get_user_input() {
    read -p "请输入用户名: " username
    echo "选择操作:"
    echo "1) 添加用户"
    echo "2) 删除用户"
    echo "3) 查看用户信息"
    read -p "请选择操作 (1-3): " action
}

# 根据操作执行相应功能
perform_action() {
    case $action in
        1)
            echo "正在添加用户: $username"
            # 实际添加用户的命令
            ;;
        2)
            echo "正在删除用户: $username"
            # 实际删除用户的命令
            ;;
        3)
            echo "正在查看用户信息: $username"
            id $username
            ;;
        *)
            echo "无效的操作选择"
            exit 1
            ;;
    esac
}

# 主程序
main() {
    show_info
    get_user_input
    perform_action
}

# 执行主程序
main "$@"
```

## 最佳实践

1. **使用花括号包围变量名**：`${variable}`比`$variable`更安全
2. **使用引号包围变量值**：避免空格引起的问题
3. **为只读变量使用readonly**：防止意外修改
4. **使用局部变量**：在函数中尽量使用local关键字
5. **变量命名要有意义**：使用描述性的变量名
6. **初始化变量**：在使用前确保变量已初始化

## 总结

变量是Shell脚本编程的基础，掌握变量的定义、使用和操作对于编写有效的Shell脚本至关重要。通过本章的学习，你应该能够：

1. 正确地定义和使用变量
2. 理解不同类型的变量及其作用域
3. 使用特殊变量获取脚本运行信息
4. 进行字符串操作和变量替换
5. 应用最佳实践编写更可靠的脚本

在下一章中，我们将学习Shell中的运算符，进一步增强脚本的处理能力。