# 网络相关命令

## 网络命令概述

网络是现代计算机系统的重要组成部分，Linux/Unix系统提供了丰富的网络命令来管理、监控和诊断网络连接。掌握这些命令对于网络管理员、系统管理员和开发人员都至关重要。

## 网络接口管理

### ip命令

ip命令是现代Linux系统中用于网络接口配置和管理的主要工具。

```bash
#!/bin/bash

echo "=== ip命令示例 ==="

echo "显示所有网络接口:"
ip addr show

echo -e "\n显示特定网络接口:"
ip addr show eth0 2>/dev/null || ip addr show ens33 2>/dev/null || echo "接口不存在"

echo -e "\n显示网络接口统计信息:"
ip -s link show

echo -e "\n启用网络接口:"
# ip link set eth0 up

echo -e "\n禁用网络接口:"
# ip link set eth0 down

echo -e "\n配置IP地址:"
# ip addr add 192.168.1.100/24 dev eth0

echo -e "\n删除IP地址:"
# ip addr del 192.168.1.100/24 dev eth0

echo -e "\n显示路由表:"
ip route show

echo -e "\n添加默认路由:"
# ip route add default via 192.168.1.1

echo -e "\n显示邻居表 (ARP表):"
ip neigh show
```

### ifconfig命令

ifconfig是传统的网络接口配置工具，在一些新系统中已被ip命令取代。

```bash
#!/bin/bash

echo "=== ifconfig命令示例 ==="

echo "显示所有网络接口:"
ifconfig

echo -e "\n显示特定网络接口:"
ifconfig eth0 2>/dev/null || echo "接口eth0不存在"

echo -e "\n配置IP地址:"
# ifconfig eth0 192.168.1.100 netmask 255.255.255.0

echo -e "\n启用网络接口:"
# ifconfig eth0 up

echo -e "\n禁用网络接口:"
# ifconfig eth0 down

echo -e "\n显示网络统计:"
ifconfig -s
```

## 网络连接诊断

### ping命令

ping命令用于测试网络连接。

```bash
#!/bin/bash

echo "=== ping命令示例 ==="

echo "基本ping测试:"
ping -c 4 google.com

echo -e "\n指定包大小:"
ping -c 2 -s 1024 google.com

echo -e "\n指定间隔时间:"
ping -c 5 -i 2 google.com

echo -e "\n设置超时时间:"
ping -c 3 -W 5 google.com

echo -e "\n洪水ping (需要root权限):"
# ping -f google.com

echo -e "\nIPv6 ping:"
ping6 -c 3 ipv6.google.com
```

### traceroute命令

traceroute命令用于跟踪数据包到目标主机的路由路径。

```bash
#!/bin/bash

echo "=== traceroute命令示例 ==="

echo "基本路由跟踪:"
traceroute google.com

echo -e "\n指定最大跳数:"
traceroute -m 15 google.com

echo -e "\n指定协议:"
traceroute -4 google.com  # IPv4
traceroute -6 google.com  # IPv6

echo -e "\n指定端口:"
traceroute -p 80 google.com

echo -e "\n使用TCP探测:"
traceroute --tcp google.com

echo -e "\n使用UDP探测:"
traceroute --udp google.com

echo -e "\n使用ICMP探测:"
traceroute --icmp google.com
```

### tracepath命令

tracepath是traceroute的现代替代品，不需要特殊权限。

```bash
#!/bin/bash

echo "=== tracepath命令示例 ==="

echo "基本路径跟踪:"
tracepath google.com

echo -e "\n指定端口:"
tracepath -p 80 google.com

echo -e "\nIPv6路径跟踪:"
tracepath6 ipv6.google.com
```

## 端口和连接检查

### netstat命令

netstat命令显示网络连接、监听端口、路由表等信息。

```bash
#!/bin/bash

echo "=== netstat命令示例 ==="

echo "显示所有连接:"
netstat -a

echo -e "\n显示TCP连接:"
netstat -t

echo -e "\n显示UDP连接:"
netstat -u

echo -e "\n显示监听端口:"
netstat -l

echo -e "\n显示监听的TCP端口:"
netstat -lt

echo -e "\n显示监听的UDP端口:"
netstat -lu

echo -e "\n显示进程ID:"
netstat -p

echo -e "\n显示网络统计:"
netstat -s

echo -e "\n显示路由表:"
netstat -r

echo -e "\n显示扩展信息:"
netstat -e
```

### ss命令

ss是netstat的现代替代品，性能更好。

```bash
#!/bin/bash

echo "=== ss命令示例 ==="

echo "显示所有套接字:"
ss

echo -e "\n显示TCP套接字:"
ss -t

echo -e "\n显示UDP套接字:"
ss -u

echo -e "\n显示监听套接字:"
ss -l

echo -e "\n显示监听的TCP端口:"
ss -lt

echo -e "\n显示监听的UDP端口:"
ss -lu

echo -e "\n显示进程信息:"
ss -p

echo -e "\n显示所有TCP监听端口:"
ss -t -l

echo -e "\n显示所有UDP监听端口:"
ss -u -l

echo -e "\n显示统计信息:"
ss -s
```

### lsof命令

lsof命令列出打开的文件，包括网络连接。

```bash
#!/bin/bash

echo "=== lsof命令示例 ==="

echo "显示网络连接:"
lsof -i

echo -e "\n显示特定端口:"
lsof -i :80

echo -e "\n显示TCP连接:"
lsof -i tcp

echo -e "\n显示UDP连接:"
lsof -i udp

echo -e "\n显示特定主机的连接:"
lsof -i@github.com

echo -e "\n显示特定用户的网络连接:"
lsof -i -u $USER

echo -e "\n显示监听端口:"
lsof -i -P | grep LISTEN
```

## DNS查询命令

### nslookup命令

nslookup命令用于查询DNS记录。

```bash
#!/bin/bash

echo "=== nslookup命令示例 ==="

echo "基本DNS查询:"
nslookup google.com

echo -e "\n指定DNS服务器:"
nslookup google.com 8.8.8.8

echo -e "\n交互模式:"
echo -e "nslookup\nserver 8.8.8.8\ngoogle.com\nexit"

echo -e "\n查询MX记录:"
nslookup -type=mx google.com

echo -e "\n查询NS记录:"
nslookup -type=ns google.com

echo -e "\n查询TXT记录:"
nslookup -type=txt google.com
```

### dig命令

dig命令是更强大的DNS查询工具。

```bash
#!/bin/bash

echo "=== dig命令示例 ==="

echo "基本DNS查询:"
dig google.com

echo -e "\n只显示答案部分:"
dig google.com +short

echo -e "\n指定DNS服务器:"
dig @8.8.8.8 google.com

echo -e "\n查询MX记录:"
dig google.com MX

echo -e "\n查询NS记录:"
dig google.com NS

echo -e "\n查询TXT记录:"
dig google.com TXT

echo -e "\n反向DNS查询:"
dig -x 8.8.8.8

echo -e "\n查询所有记录类型:"
dig google.com ANY

echo -e "\n显示详细统计信息:"
dig google.com +stats
```

### host命令

host命令是简单的DNS查询工具。

```bash
#!/bin/bash

echo "=== host命令示例 ==="

echo "基本DNS查询:"
host google.com

echo -e "\n指定DNS服务器:"
host google.com 8.8.8.8

echo -e "\n查询MX记录:"
host -t mx google.com

echo -e "\n查询NS记录:"
host -t ns google.com

echo -e "\n反向DNS查询:"
host 8.8.8.8
```

## 网络文件传输

### scp命令

scp命令用于安全复制文件。

```bash
#!/bin/bash

echo "=== scp命令示例 ==="

echo "从本地复制文件到远程:"
# scp file.txt user@remote:/path/to/destination/

echo -e "\n从远程复制文件到本地:"
# scp user@remote:/path/to/file.txt ./local_directory/

echo -e "\n复制整个目录:"
# scp -r directory/ user@remote:/path/to/destination/

echo -e "\n指定端口:"
# scp -P 2222 file.txt user@remote:/path/to/destination/

echo -e "\n保持文件属性:"
# scp -p file.txt user@remote:/path/to/destination/

echo -e "\n显示详细过程:"
# scp -v file.txt user@remote:/path/to/destination/
```

### rsync命令

rsync命令用于同步文件和目录。

```bash
#!/bin/bash

echo "=== rsync命令示例 ==="

echo "基本同步:"
# rsync source/ destination/

echo -e "\n递归同步:"
rsync -r source/ destination/

echo -e "\n保持文件属性:"
rsync -a source/ destination/

echo -e "\n显示进度:"
rsync -av --progress source/ destination/

echo -e "\n压缩传输:"
rsync -avz source/ destination/

echo -e "\n删除目标中多余的文件:"
rsync -av --delete source/ destination/

echo -e "\n通过SSH同步:"
# rsync -av -e ssh source/ user@remote:/path/to/destination/

echo -e "\n排除特定文件:"
rsync -av --exclude='*.log' source/ destination/

echo -e "\n包含特定文件:"
rsync -av --include='*.txt' --exclude='*' source/ destination/
```

## 网络监控和测试

### telnet命令

telnet命令用于测试TCP连接。

```bash
#!/bin/bash

echo "=== telnet命令示例 ==="

echo "测试HTTP连接:"
# telnet google.com 80

echo -e "\n测试SSH连接:"
# telnet localhost 22

echo -e "\n测试SMTP连接:"
# telnet mail.server.com 25

echo -e "\n注意: telnet传输是明文的，不安全"
```

### nc (netcat)命令

nc命令是网络工具的瑞士军刀。

```bash
#!/bin/bash

echo "=== nc (netcat)命令示例 ==="

echo "端口扫描:"
# nc -zv google.com 80

echo -e "\n扫描端口范围:"
# nc -zv google.com 1-100

echo -e "\n监听端口:"
# nc -l 1234

echo -e "\n发送文件:"
# nc -l 1234 < file.txt  # 服务器端
# nc remote_host 1234 > received_file.txt  # 客户端

echo -e "\n接收文件:"
# nc -l 1234 > received_file.txt  # 服务器端
# nc remote_host 1234 < file.txt  # 客户端

echo -e "\n测试UDP连接:"
# nc -u google.com 53

echo -e "\n端口转发:"
# nc -l 8080 | nc google.com 80
```

### curl命令

curl命令用于传输数据。

```bash
#!/bin/bash

echo "=== curl命令示例 ==="

echo "基本HTTP请求:"
curl https://httpbin.org/get

echo -e "\n发送POST请求:"
curl -X POST -d "key=value" https://httpbin.org/post

echo -e "\n包含请求头:"
curl -H "User-Agent: MyClient/1.0" https://httpbin.org/get

echo -e "\n跟随重定向:"
curl -L https://httpbin.org/redirect/1

echo -e "\n显示响应头:"
curl -I https://httpbin.org/get

echo -e "\n显示详细信息:"
curl -v https://httpbin.org/get

echo -e "\n下载文件:"
curl -O https://httpbin.org/image/png

echo -e "\n指定保存文件名:"
curl -o myimage.png https://httpbin.org/image/png

echo -e "\n限制下载速度:"
curl --limit-rate 100K https://httpbin.org/image/png

echo -e "\n恢复断点续传:"
# curl -C - -O https://example.com/largefile.zip
```

### wget命令

wget命令用于从网络下载文件。

```bash
#!/bin/bash

echo "=== wget命令示例 ==="

echo "下载文件:"
# wget https://httpbin.org/image/png

echo -e "\n指定保存文件名:"
# wget -O myimage.png https://httpbin.org/image/png

echo -e "\n递归下载网站:"
# wget -r https://example.com

echo -e "\n限制下载速度:"
# wget --limit-rate=200k https://example.com/largefile.zip

echo -e "\n后台下载:"
# wget -b https://example.com/largefile.zip

echo -e "\n断点续传:"
# wget -c https://example.com/largefile.zip

echo -e "\n下载多个URL:"
# wget -i urls.txt

echo -e "\n镜像网站:"
# wget --mirror --convert-links --adjust-extension --page-requisites --no-parent https://example.com
```

## 实际应用示例

### 网络连接测试脚本

```bash
#!/bin/bash

# 网络连接测试脚本
test_network_connectivity() {
    local hosts=("8.8.8.8" "google.com" "github.com")
    local timeout=5
    
    echo "=== 网络连接测试 ==="
    echo "测试时间: $(date)"
    echo "超时时间: ${timeout}秒"
    echo "==================="
    
    for host in "${hosts[@]}"
    do
        echo -n "测试 $host ... "
        if ping -c 1 -W $timeout "$host" >/dev/null 2>&1
        then
            echo "✅ 连接正常"
        else
            echo "❌ 连接失败"
        fi
    done
    
    echo ""
    echo "=== DNS解析测试 ==="
    for host in "${hosts[@]}"
    do
        echo -n "解析 $host ... "
        if host "$host" >/dev/null 2>&1
        then
            echo "✅ 解析成功"
        else
            echo "❌ 解析失败"
        fi
    done
}

# 运行网络连接测试
# test_network_connectivity
```

### 端口扫描脚本

```bash
#!/bin/bash

# 简单端口扫描脚本
port_scan() {
    local host=${1:-"localhost"}
    local start_port=${2:-1}
    local end_port=${3:-1000}
    
    echo "=== 端口扫描结果 ==="
    echo "目标主机: $host"
    echo "扫描端口: $start_port-$end_port"
    echo "开始时间: $(date)"
    echo "=================="
    
    for port in $(seq $start_port $end_port)
    do
        # 使用bash内置功能测试端口连接
        if timeout 1 bash -c "echo >/dev/tcp/$host/$port" 2>/dev/null
        then
            echo "端口 $port 开放"
        fi
    done
    
    echo "扫描完成: $(date)"
}

# 使用nc进行端口扫描（如果有nc命令）
port_scan_with_nc() {
    local host=${1:-"localhost"}
    local start_port=${2:-1}
    local end_port=${3:-1000}
    
    echo "=== 端口扫描结果 (使用nc) ==="
    echo "目标主机: $host"
    echo "扫描端口: $start_port-$end_port"
    echo "开始时间: $(date)"
    echo "============================"
    
    if command -v nc &>/dev/null
    then
        for port in $(seq $start_port $end_port)
        do
            if echo "QUIT" | nc -w 1 "$host" "$port" 2>/dev/null | grep -q "SSH\|HTTP\|FTP\|SMTP\|POP\|IMAP"
            then
                echo "端口 $port 开放 ($(echo "QUIT" | nc -w 1 "$host" "$port" 2>/dev/null | head -1))"
            elif timeout 1 bash -c "echo >/dev/tcp/$host/$port" 2>/dev/null
            then
                echo "端口 $port 开放"
            fi
        done
    else
        echo "nc命令不可用，使用内置方法"
        port_scan "$host" "$start_port" "$end_port"
    fi
    
    echo "扫描完成: $(date)"
}

# 运行端口扫描
# port_scan_with_nc "localhost" 1 100
```

### 网络性能监控脚本

```bash
#!/bin/bash

# 网络性能监控脚本
monitor_network_performance() {
    local interface=${1:-"eth0"}
    local duration=${2:-60}  # 监控时长（秒）
    local interval=${3:-5}   # 采样间隔（秒）
    
    echo "=== 网络性能监控 ==="
    echo "网络接口: $interface"
    echo "监控时长: ${duration}秒"
    echo "采样间隔: ${interval}秒"
    echo "开始时间: $(date)"
    echo "=================="
    
    # 检查接口是否存在
    if ! ip link show "$interface" >/dev/null 2>&1
    then
        echo "错误: 网络接口 $interface 不存在"
        # 尝试获取默认接口
        interface=$(ip route | grep default | awk '{print $5}' | head -1)
        if [ -n "$interface" ]
        then
            echo "使用默认接口: $interface"
        else
            echo "无法确定网络接口"
            return 1
        fi
    fi
    
    local start_time=$(date +%s)
    local end_time=$((start_time + duration))
    
    echo "时间,接收字节,发送字节,接收包数,发送包数"
    
    local last_rx=0
    local last_tx=0
    local last_rx_packets=0
    local last_tx_packets=0
    
    # 获取初始统计值
    if [ -f "/sys/class/net/$interface/statistics/rx_bytes" ]
    then
        last_rx=$(cat "/sys/class/net/$interface/statistics/rx_bytes")
        last_tx=$(cat "/sys/class/net/$interface/statistics/tx_bytes")
        last_rx_packets=$(cat "/sys/class/net/$interface/statistics/rx_packets")
        last_tx_packets=$(cat "/sys/class/net/$interface/statistics/tx_packets")
    fi
    
    while [ $(date +%s) -lt $end_time ]
    do
        sleep $interval
        
        local current_time=$(date +%H:%M:%S)
        local rx=0
        local tx=0
        local rx_packets=0
        local tx_packets=0
        
        if [ -f "/sys/class/net/$interface/statistics/rx_bytes" ]
        then
            rx=$(cat "/sys/class/net/$interface/statistics/rx_bytes")
            tx=$(cat "/sys/class/net/$interface/statistics/tx_bytes")
            rx_packets=$(cat "/sys/class/net/$interface/statistics/rx_packets")
            tx_packets=$(cat "/sys/class/net/$interface/statistics/tx_packets")
            
            local rx_rate=$(( (rx - last_rx) / interval ))
            local tx_rate=$(( (tx - last_tx) / interval ))
            local rx_packets_rate=$(( (rx_packets - last_rx_packets) / interval ))
            local tx_packets_rate=$(( (tx_packets - last_tx_packets) / interval ))
            
            echo "$current_time,$rx_rate,$tx_rate,$rx_packets_rate,$tx_packets_rate"
            
            last_rx=$rx
            last_tx=$tx
            last_rx_packets=$rx_packets
            last_tx_packets=$tx_packets
        fi
    done
    
    echo "监控结束: $(date)"
}

# 运行网络性能监控
# monitor_network_performance "lo" 30 2
```

## 最佳实践

1. **安全考虑**：使用安全的网络工具（如scp替代ftp）
2. **防火墙配置**：确保防火墙规则允许必要的网络连接
3. **定期测试**：建立定期网络连接测试机制
4. **性能监控**：监控网络性能指标，及时发现瓶颈
5. **日志记录**：记录网络操作和异常事件
6. **备份配置**：备份网络配置文件
7. **权限管理**：限制网络命令的使用权限
8. **加密传输**：使用加密协议传输敏感数据

## 总结

网络相关命令是Linux/Unix系统管理的重要组成部分。通过本章的学习，你应该掌握了：

1. 网络接口管理命令（ip、ifconfig）
2. 网络连接诊断命令（ping、traceroute、tracepath）
3. 端口和连接检查命令（netstat、ss、lsof）
4. DNS查询命令（nslookup、dig、host）
5. 网络文件传输命令（scp、rsync）
6. 网络监控和测试命令（telnet、nc、curl、wget）
7. 实际应用场景和最佳实践

熟练掌握这些网络命令，将帮助你更好地管理和诊断网络问题。在下一章中，我们将学习Shell脚本实例，综合运用前面学到的知识。