# 撤销与回退操作

## 撤销操作概述

在Git中，撤销操作是日常开发中经常需要的功能。Git提供了多种撤销操作的方式，每种方式适用于不同的场景：

- **工作区撤销**：撤销工作区的修改
- **暂存区撤销**：撤销暂存区的修改
- **提交撤销**：撤销已提交的修改
- **历史重写**：重写提交历史

## 工作区撤销

### git restore命令

`git restore`命令用于恢复工作区文件到之前的状态。

#### 基本语法

```bash
git restore <文件路径>
```

#### 常用选项

- `--staged`：从暂存区恢复文件
- `--source=<提交>`：从指定提交恢复文件
- `--worktree`：恢复工作区文件
- `--overlay`：不创建新文件

#### 使用示例

##### 1. 恢复单个文件

```bash
# 恢复单个文件到最新提交状态
git restore filename.txt

# 恢复多个文件
git restore file1.txt file2.txt
```

##### 2. 恢复所有文件

```bash
# 恢复所有文件到最新提交状态
git restore .

# 恢复当前目录所有文件
git restore *
```

##### 3. 从指定提交恢复

```bash
# 从指定提交恢复文件
git restore --source=HEAD~1 filename.txt

# 从特定提交恢复
git restore --source=abc1234 filename.txt
```

### git checkout命令（旧版本）

在旧版本的Git中，使用`git checkout`来恢复文件。

#### 使用示例

```bash
# 恢复单个文件（旧方法）
git checkout -- filename.txt

# 恢复所有文件（旧方法）
git checkout -- .
```

## 暂存区撤销

### git restore --staged命令

`git restore --staged`命令用于从暂存区恢复文件。

#### 使用示例

```bash
# 从暂存区恢复单个文件
git restore --staged filename.txt

# 从暂存区恢复所有文件
git restore --staged .

# 从暂存区恢复多个文件
git restore --staged file1.txt file2.txt
```

### git reset HEAD命令（旧版本）

在旧版本的Git中，使用`git reset HEAD`来取消暂存。

#### 使用示例

```bash
# 取消暂存单个文件（旧方法）
git reset HEAD filename.txt

# 取消暂存所有文件（旧方法）
git reset HEAD .
```

## 提交撤销

### git revert命令

`git revert`命令用于创建一个新的提交来撤销之前的提交。

#### 基本语法

```bash
git revert <提交ID>
```

#### 常用选项

- `--no-commit`：不自动提交撤销
- `--edit`：编辑提交消息
- `--no-edit`：使用默认提交消息
- `-m`：指定父提交编号（用于合并提交）

#### 使用示例

##### 1. 撤销最新提交

```bash
# 撤销最新提交
git revert HEAD

# 撤销并编辑提交消息
git revert HEAD --edit

# 撤销并使用默认消息
git revert HEAD --no-edit
```

##### 2. 撤销指定提交

```bash
# 撤销指定提交
git revert abc1234

# 撤销多个提交
git revert abc1234 def5678
```

##### 3. 撤销合并提交

```bash
# 撤销合并提交（需要指定父提交）
git revert -m 1 merge-commit
```

##### 4. 不自动提交撤销

```bash
# 撤销但不自动提交
git revert --no-commit abc1234

# 手动提交
git commit -m "撤销之前的提交"
```

### git reset命令

`git reset`命令用于重置当前分支到指定状态。

#### 基本语法

```bash
git reset [选项] <提交>
```

#### 常用选项

- `--soft`：只重置HEAD，不改变暂存区和工作区
- `--mixed`：重置HEAD和暂存区，不改变工作区（默认）
- `--hard`：重置HEAD、暂存区和工作区
- `--merge`：重置HEAD和暂存区，保留工作区的合并状态
- `--keep`：重置HEAD，保留工作区的修改

#### 使用示例

##### 1. 软重置

```bash
# 软重置到上一个提交（保留暂存区和工作区）
git reset --soft HEAD~1

# 软重置到指定提交
git reset --soft abc1234
```

##### 2. 混合重置

```bash
# 混合重置到上一个提交（保留工作区，清空暂存区）
git reset --mixed HEAD~1

# 混合重置（默认行为）
git reset HEAD~1
```

##### 3. 硬重置

```bash
# 硬重置到上一个提交（重置所有内容）
git reset --hard HEAD~1

# 硬重置到指定提交
git reset --hard abc1234

# 警告：硬重置会丢失工作区的修改！
```

##### 4. 保留重置

```bash
# 保留重置（保留工作区的修改）
git reset --keep HEAD~1
```

## 历史重写

### git rebase命令

`git rebase`命令用于重新设置提交基础，可以用来整理提交历史。

#### 基本语法

```bash
git rebase [选项] <基础提交>
```

#### 常用选项

- `-i` 或 `--interactive`：交互式rebase
- `--onto`：将提交重新设置到指定基础
- `--continue`：继续rebase操作
- `--abort`：中止rebase操作
- `--skip`：跳过当前提交

#### 使用示例

##### 1. 交互式rebase

```bash
# 交互式rebase最近3个提交
git rebase -i HEAD~3

# 编辑器中显示如下内容：
pick f7f3f6d 添加新功能
pick 310154e 修复bug
pick a5f4a0d 更新文档

# 可以修改为：
pick f7f3f6d 添加新功能
f 310154e 修复bug
s a5f4a0d 更新文档

# 操作说明：
# p, pick = 使用提交
# r, reword = 使用提交，但修改提交消息
# e, edit = 使用提交，但停止修改
# s, squash = 使用提交，但合并到前一个提交
# f, fixup = 类似squash，但丢弃提交消息
# d, drop = 删除提交
```

##### 2. 合并提交

```bash
# 合并最近的2个提交
git rebase -i HEAD~2

# 在编辑器中将第二个提交改为squash：
pick f7f3f6d 添加新功能
s 310154e 修复bug
```

##### 3. 删除提交

```bash
# 删除指定的提交
git rebase -i HEAD~3

# 在编辑器中将要删除的提交改为drop：
pick f7f3f6d 添加新功能
drop 310154e 修复bug
pick a5f4a0d 更新文档
```

### git commit --amend命令

`git commit --amend`命令用于修改上一次提交。

#### 使用示例

##### 1. 修改提交消息

```bash
# 修改上一次提交的消息
git commit --amend -m "修正提交消息"

# 或者在编辑器中修改
git commit --amend
```

##### 2. 添加遗漏的文件

```bash
# 添加遗漏的文件到上一次提交
git add forgotten-file.txt
git commit --amend --no-edit
```

##### 3. 修改提交内容

```bash
# 修改文件后添加到上一次提交
git modify file.txt
git add file.txt
git commit --amend
```

## 暂存和恢复工作

### git stash命令

`git stash`命令用于暂存当前工作，以便切换分支或处理其他任务。

#### 基本语法

```bash
git stash [选项]
```

#### 常用选项

- `save`：保存当前工作（默认）
- `list`：列出所有暂存
- `pop`：恢复最新的暂存并删除
- `apply`：恢复暂存但不删除
- `drop`：删除指定的暂存
- `clear`：清空所有暂存
- `branch`：从暂存创建新分支

#### 使用示例

##### 1. 基本暂存操作

```bash
# 暂存当前工作
git stash

# 暂存并添加消息
git stash save "修复bug的临时修改"

# 查看暂存列表
git stash list

# 输出示例
stash@{0}: On main: 修复bug的临时修改
stash@{1}: WIP on feature-branch: 添加新功能
```

##### 2. 恢复暂存

```bash
# 恢复最新的暂存并删除
git stash pop

# 恢复指定的暂存并删除
git stash pop stash@{1}

# 恢复暂存但不删除
git stash apply

# 恢复指定的暂存但不删除
git stash apply stash@{1}
```

##### 3. 管理暂存

```bash
# 删除指定的暂存
git stash drop stash@{0}

# 清空所有暂存
git stash clear

# 从暂存创建新分支
git stash branch new-branch stash@{0}
```

##### 4. 暂存特定文件

```bash
# 暂存特定文件
git stash push -m "暂存特定文件" filename.txt

# 暂存未跟踪的文件
git stash -u

# 暂存所有修改（包括未跟踪文件）
git stash -a
```

## 撤销操作选择指南

### 撤销工作区修改

| 场景 | 推荐命令 | 说明 |
|------|---------|------|
| 恢复单个文件 | `git restore filename.txt` | 恢复文件到最新提交状态 |
| 恢复所有文件 | `git restore .` | 恢复所有文件到最新提交状态 |
| 从历史提交恢复 | `git restore --source=HEAD~1 file.txt` | 从指定提交恢复文件 |

### 撤销暂存区修改

| 场景 | 推荐命令 | 说明 |
|------|---------|------|
| 取消暂存单个文件 | `git restore --staged filename.txt` | 从暂存区恢复文件 |
| 取消暂存所有文件 | `git restore --staged .` | 从暂存区恢复所有文件 |

### 撤销提交

| 场景 | 推荐命令 | 说明 |
|------|---------|------|
| 撤销最新提交（安全） | `git revert HEAD` | 创建新提交来撤销 |
| 撤销指定提交（安全） | `git revert <commit-id>` | 创建新提交来撤销 |
| 重置到上一个提交（本地） | `git reset --soft HEAD~1` | 保留暂存区和工作区 |
| 重置到上一个提交（本地） | `git reset --mixed HEAD~1` | 保留工作区，清空暂存区 |
| 重置到上一个提交（危险） | `git reset --hard HEAD~1` | 重置所有内容，丢失修改 |

### 历史重写

| 场景 | 推荐命令 | 说明 |
|------|---------|------|
| 修改上一次提交 | `git commit --amend` | 修改最新提交的消息或内容 |
| 整理提交历史 | `git rebase -i HEAD~n` | 交互式整理提交历史 |
| 合并多个提交 | `git rebase -i` | 使用squash或fixup合并提交 |
| 删除提交 | `git rebase -i` | 使用drop删除提交 |

## 撤销操作最佳实践

### 1. 安全第一

- **备份重要**：重要操作前先备份当前工作
- **确认影响**：了解每个命令的影响范围
- **本地操作**：在本地测试后再应用到远程仓库
- **团队沟通**：重写历史前与团队沟通

### 2. 选择合适的撤销方式

- **已推送的提交**：使用`git revert`而不是`git reset`
- **本地提交**：可以使用`git reset`重置
- **工作区修改**：使用`git restore`恢复
- **暂存区修改**：使用`git restore --staged`取消暂存

### 3. 提交历史管理

- **保持清洁**：定期整理提交历史
- **原子提交**：每个提交只包含一个逻辑变更
- **清晰消息**：使用规范的提交消息
- **合理合并**：使用合适的合并策略

### 4. 工作流程优化

- **频繁暂存**：使用`git stash`暂存临时工作
- **分支切换**：切换分支前暂存或提交当前工作
- **实验性修改**：在临时分支中进行实验性修改
- **定期同步**：定期从主分支同步最新代码

## 常见问题与解决方案

### 1. 误操作导致数据丢失

**问题**：使用`git reset --hard`导致工作区修改丢失。

**解决方案**：
```bash
# 查看reflog找回丢失的提交
git reflog

# 恢复到丢失的提交
git reset --hard HEAD@{1}

# 或者使用
git checkout -b recovery-branch HEAD@{1}
```

### 2. 撤销错误的提交

**问题**：撤销了错误的提交，需要恢复。

**解决方案**：
```bash
# 如果只是reset，可以恢复
git reset --hard ORIG_HEAD

# 如果已经revert，可以再次revert
git revert HEAD
```

### 3. 合并冲突

**问题**：rebase过程中出现合并冲突。

**解决方案**：
```bash
# 解决冲突后继续
git add conflicted-file
git rebase --continue

# 或者跳过当前提交
git rebase --skip

# 或者中止rebase
git rebase --abort
```

### 4. 暂存操作问题

**问题**：暂存的工作无法恢复。

**解决方案**：
```bash
# 查看暂存列表
git stash list

# 尝试恢复暂存
git stash apply stash@{n}

# 如果恢复失败，创建分支恢复
git stash branch recovery-branch stash@{n}
```

## 总结

撤销与回退操作是Git版本控制中的重要功能。掌握`git restore`、`git revert`、`git reset`、`git rebase`、`git commit --amend`、`git stash`等命令，将帮助您更好地管理项目历史和处理各种撤销场景。

理解每个撤销操作的影响范围和适用场景，遵循最佳实践，将大大提高您的开发效率和代码管理质量。在实际使用中，建议多练习这些命令，熟悉各种选项的使用场景，并养成良好的撤销操作习惯。