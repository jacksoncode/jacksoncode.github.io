# 8.1 df命令详解

## 1. 命令概述

df（disk free）命令是Linux系统中用于显示文件系统的磁盘空间使用情况的重要命令。它可以帮助用户查看各个挂载点的总空间、已用空间、可用空间以及文件系统类型等信息，是系统管理和磁盘监控的基础工具之一。

### 1.1 功能特点
- 显示所有已挂载文件系统的磁盘使用情况
- 支持不同的单位显示（KB、MB、GB等）
- 可以显示inode的使用情况
- 能够以特定格式输出结果，便于脚本处理
- 支持显示文件系统的类型信息
- 可以排除某些文件系统类型
- 提供人性化的输出格式

### 1.2 应用场景
- 检查系统磁盘空间使用情况
- 监控磁盘空间是否即将耗尽
- 确定哪些文件系统占用了最多空间
- 在自动化脚本中检查磁盘空间条件
- 分析系统存储资源的分配情况

## 2. 语法格式

df命令的基本语法格式如下：

```bash
# 基本语法
$ df [选项] [文件或目录...]
```

### 2.1 语法说明
- **df**：命令名称，用于显示磁盘空间使用情况
- **选项**：控制命令输出格式和内容的参数
- **文件或目录**：可选，指定要查询的特定文件或目录所在的文件系统

> **注意**：如果不指定文件或目录，df命令将显示所有已挂载文件系统的信息。

## 3. 常用选项

df命令提供了多种选项来控制输出格式和内容，以下是最常用的选项：

### 3.1 选项列表

| 选项 | 功能说明 |
|------|----------|
| `-a` | 显示所有文件系统，包括大小为0的文件系统 |
| `-h` | 以人类可读的格式显示（如KB、MB、GB） |
| `-H` | 以1000为基数而不是1024显示容量单位 |
| `-T` | 显示文件系统类型 |
| `-i` | 显示inode信息而非块使用情况 |
| `-k` | 以KB为单位显示，默认选项 |
| `-m` | 以MB为单位显示 |
| `-g` | 以GB为单位显示 |
| `-P` | 使用POSIX格式输出，便于脚本处理 |
| `-t <类型>` | 仅显示指定类型的文件系统 |
| `-x <类型>` | 排除指定类型的文件系统 |

### 3.2 选项详细解释

- **`-a`**: 显示所有文件系统，包括那些通常被省略的特殊文件系统，如/proc、/sys等。

- **`-h`**: 以人类可读的格式显示磁盘空间大小，自动将大数字转换为KB、MB、GB等单位，方便阅读。

- **`-H`**: 与`-h`类似，但使用1000作为转换基数（1KB=1000字节），而不是标准的1024（1KB=1024字节）。

- **`-T`**: 在输出中增加一列，显示每个文件系统的类型（如ext4、xfs、tmpfs等）。

- **`-i`**: 显示inode的使用情况，而不是块的使用情况。这对于监控inode是否耗尽非常有用。

- **`-k`**: 以KB为单位显示磁盘空间，这是df命令的默认选项。

- **`-m`**: 以MB为单位显示磁盘空间。

- **`-g`**: 以GB为单位显示磁盘空间。

- **`-P`**: 使用POSIX兼容的格式输出，确保输出在不同系统上保持一致，特别适合在脚本中使用。

- **`-t <类型>`**: 只显示指定类型的文件系统，例如`-t ext4`只会显示ext4类型的文件系统。

- **`-x <类型>`**: 排除指定类型的文件系统，例如`-x tmpfs`会排除所有tmpfs类型的文件系统。

## 4. 常用示例

### 4.1 显示所有文件系统的磁盘使用情况

显示所有已挂载文件系统的磁盘使用情况：

```bash
# 显示所有文件系统的磁盘使用情况
$ df
Filesystem     1K-blocks    Used Available Use% Mounted on
udev             3999888       0   3999888   0% /dev
tmpfs             806836    1084    805752   1% /run
/dev/sda1      491500320 8523956 457554632   2% /
tmpfs            4034168       0   4034168   0% /dev/shm
tmpfs               5120       0      5120   0% /run/lock
tmpfs            4034168       0   4034168   0% /sys/fs/cgroup
/dev/loop0         56832   56832         0 100% /snap/core18/1944
/dev/loop1         62720   62720         0 100% /snap/core20/1026
/dev/sda2         523264    3680    519584   1% /boot/efi
tmpfs             806832       0    806832   0% /run/user/1000
```

### 4.2 以人类可读格式显示

以更易读的格式显示磁盘使用情况：

```bash
# 以人类可读格式显示
$ df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            3.9G     0  3.9G   0% /dev
tmpfs           788M  1.1M  787M   1% /run
/dev/sda1       469G  8.2G  436G   2% /
tmpfs           3.9G     0  3.9G   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           3.9G     0  3.9G   0% /sys/fs/cgroup
/dev/loop0       56M   56M     0 100% /snap/core18/1944
/dev/loop1       61M   61M     0 100% /snap/core20/1026
/dev/sda2       511M  3.6M  508M   1% /boot/efi
tmpfs           788M     0  788M   0% /run/user/1000
```

### 4.3 显示文件系统类型

显示磁盘使用情况并包含文件系统类型信息：

```bash
# 显示文件系统类型
$ df -T
Filesystem     Type     1K-blocks    Used Available Use% Mounted on
udev           devtmpfs   3999888       0   3999888   0% /dev
tmpfs          tmpfs       806836    1084    805752   1% /run
/dev/sda1      ext4     491500320 8523956 457554632   2% /
tmpfs          tmpfs      4034168       0   4034168   0% /dev/shm
tmpfs          tmpfs         5120       0      5120   0% /run/lock
tmpfs          tmpfs      4034168       0   4034168   0% /sys/fs/cgroup
/dev/loop0     squashfs     56832   56832         0 100% /snap/core18/1944
/dev/loop1     squashfs     62720   62720         0 100% /snap/core20/1026
/dev/sda2      vfat        523264    3680    519584   1% /boot/efi
tmpfs          tmpfs       806832       0    806832   0% /run/user/1000
```

### 4.4 显示inode使用情况

显示文件系统的inode使用情况：

```bash
# 显示inode使用情况
$ df -i
Filesystem      Inodes  IUsed   IFree IUse% Mounted on
udev           1004061    418 1003643    1% /dev
tmpfs          1016345    627 1015718    1% /run
/dev/sda1      31207424 167392 31039932    1% /
tmpfs          1016345      1 1016344    1% /dev/shm
tmpfs          1016345      3 1016342    1% /run/lock
tmpfs          1016345     18 1016327    1% /sys/fs/cgroup
/dev/loop0        8713   8713       0 100% /snap/core18/1944
/dev/loop1       10500  10500       0 100% /snap/core20/1026
/dev/sda2             0      0       0     - /boot/efi
tmpfs          1016345     22 1016323    1% /run/user/1000
```

### 4.5 显示特定文件系统类型

只显示ext4类型的文件系统：

```bash
# 只显示ext4类型的文件系统
$ df -t ext4 -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1       469G  8.2G  436G   2% /
```

### 4.6 排除特定文件系统类型

显示所有文件系统，但排除tmpfs类型：

```bash
# 排除tmpfs类型的文件系统
$ df -x tmpfs -h
Filesystem      Size  Used Avail Use% Mounted on
udev            3.9G     0  3.9G   0% /dev
/dev/sda1       469G  8.2G  436G   2% /
/dev/loop0       56M   56M     0 100% /snap/core18/1944
/dev/loop1       61M   61M     0 100% /snap/core20/1026
/dev/sda2       511M  3.6M  508M   1% /boot/efi
```

### 4.7 查看特定目录所在文件系统

查看特定目录所在文件系统的使用情况：

```bash
# 查看/home目录所在文件系统
$ df -h /home
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1       469G  8.2G  436G   2% /
```

### 4.8 组合多个选项使用

结合多个选项，以人类可读格式显示所有文件系统类型和使用情况：

```bash
# 组合多个选项
$ df -hT
Filesystem     Type      Size  Used Avail Use% Mounted on
udev           devtmpfs  3.9G     0  3.9G   0% /dev
tmpfs          tmpfs     788M  1.1M  787M   1% /run
/dev/sda1      ext4      469G  8.2G  436G   2% /
tmpfs          tmpfs     3.9G     0  3.9G   0% /dev/shm
tmpfs          tmpfs     5.0M     0  5.0M   0% /run/lock
tmpfs          tmpfs     3.9G     0  3.9G   0% /sys/fs/cgroup
/dev/loop0     squashfs   56M   56M     0 100% /snap/core18/1944
/dev/loop1     squashfs   61M   61M     0 100% /snap/core20/1026
/dev/sda2      vfat      511M  3.6M  508M   1% /boot/efi
tmpfs          tmpfs     788M     0  788M   0% /run/user/1000
```

### 4.9 以POSIX格式输出

以POSIX兼容格式输出，适合在脚本中使用：

```bash
# 以POSIX格式输出
$ df -P
Filesystem     1024-blocks    Used Available Capacity Mounted on
udev             3999888       0   3999888       0% /dev
tmpfs             806836    1084    805752       1% /run
/dev/sda1      491500320 8523956 457554632       2% /
tmpfs            4034168       0   4034168       0% /dev/shm
tmpfs               5120       0      5120       0% /run/lock
tmpfs            4034168       0   4034168       0% /sys/fs/cgroup
/dev/loop0         56832   56832         0     100% /snap/core18/1944
/dev/loop1         62720   62720         0     100% /snap/core20/1026
/dev/sda2         523264    3680    519584       1% /boot/efi
tmpfs             806832       0    806832       0% /run/user/1000
```

### 4.10 显示所有文件系统，包括特殊文件系统

显示所有文件系统，包括通常被省略的特殊文件系统：

```bash
# 显示所有文件系统
$ df -a
Filesystem     1K-blocks    Used Available Use% Mounted on
sysfs                  0       0         0    - /sys
sysfs                  0       0         0    - /sys
tmpfs             806836    1084    805752   1% /run
...
```

### 4.11 监控磁盘使用率

在脚本中监控磁盘使用率，当超过阈值时发出警告：

```bash
# 简单的磁盘监控脚本片段
THRESHOLD=90

df -h | grep -v tmpfs | grep -v udev | while read line; do
    USAGE=$(echo $line | awk '{print $5}' | sed 's/%//g')
    if [ $USAGE -gt $THRESHOLD ]; then
        echo "警告：磁盘使用率过高 ($USAGE%) - $line"
    fi
done
```

### 4.12 统计特定类型文件系统的总空间

统计所有ext4文件系统的总空间和已用空间：

```bash
# 统计ext4文件系统的总空间和已用空间
echo "Ext4文件系统空间统计："
df -t ext4 -k | tail -n +2 | awk '{total+=$2; used+=$3} END {print "总空间: " total/1024/1024 "GB"; print "已用空间: " used/1024/1024 "GB"}'
```

## 5. 高级用法

### 5.1 创建磁盘空间监控脚本

创建一个定期监控磁盘空间并在使用率超过阈值时发送警告的脚本：

```bash
#!/bin/bash
# 磁盘空间监控脚本

# 配置参数
THRESHOLD=80  # 警告阈值百分比
ADMIN_EMAIL="admin@example.com"
LOG_FILE="/var/log/disk_space.log"

# 创建日志文件
if [ ! -f "$LOG_FILE" ]; then
touch "$LOG_FILE"
echo "磁盘空间监控日志 - $(date)" >> "$LOG_FILE"
fi

# 获取当前日期和时间
CURRENT_TIME=$(date "%Y-%m-%d %H:%M:%S")

# 检查所有文件系统的使用率
echo "[$CURRENT_TIME] 开始磁盘空间检查" >> "$LOG_FILE"

# 初始化警告标志
WARNING=0
WARNING_MSG=""

# 遍历所有文件系统（排除临时文件系统）
df -P | grep -v tmpfs | grep -v udev | while read line; do
    # 提取文件系统信息
    FILESYSTEM=$(echo $line | awk '{print $1}')
    MOUNT_POINT=$(echo $line | awk '{print $6}')
    USAGE=$(echo $line | awk '{print $5}' | sed 's/%//g')
    
    # 记录到日志
    echo "[$CURRENT_TIME] $FILESYSTEM ($MOUNT_POINT): $USAGE%" >> "$LOG_FILE"
    
    # 检查是否超过阈值
    if [ $USAGE -gt $THRESHOLD ]; then
        WARNING=1
        WARNING_MSG="$WARNING_MSG\n$FILESYSTEM ($MOUNT_POINT) 使用率过高: $USAGE%"
    fi
done

# 如果有警告，发送邮件通知
if [ $WARNING -eq 1 ]; then
    SUBJECT="警告：磁盘空间使用率过高"
    BODY="磁盘空间警告 - $(date)\n\n$WARNING_MSG\n\n请及时处理！"
    
    # 记录到日志
    echo "[$CURRENT_TIME] 发现磁盘空间警告：$WARNING_MSG" >> "$LOG_FILE"
    
    # 发送邮件（需要系统已配置邮件服务）
    echo -e "$BODY" | mail -s "$SUBJECT" "$ADMIN_EMAIL"
    
    # 如果没有配置邮件服务，可以输出到标准错误
    if [ $? -ne 0 ]; then
        echo "错误：无法发送邮件通知，请检查邮件配置。"
        echo "$BODY" >&2
    fi
else
    echo "[$CURRENT_TIME] 所有文件系统空间正常" >> "$LOG_FILE"
fi

# 清理旧日志（保留30天）
find "$LOG_FILE" -type f -mtime +30 -delete
```

### 5.2 磁盘空间使用趋势分析

创建一个脚本，记录磁盘空间使用情况并生成简单的趋势报告：

```bash
#!/bin/bash
# 磁盘空间趋势分析脚本

# 配置参数
DATA_FILE="/var/log/disk_space_data.csv"
REPORT_FILE="/var/log/disk_space_report.txt"

# 创建数据文件（如果不存在）
if [ ! -f "$DATA_FILE" ]; then
echo "日期,文件系统,挂载点,总空间(GB),已用空间(GB),使用率(%)" >> "$DATA_FILE"
fi

# 获取当前日期
DATE=$(date "%Y-%m-%d")

# 收集数据并写入文件
df -Ph | grep -v tmpfs | grep -v udev | tail -n +2 | while read line; do
    FILESYSTEM=$(echo $line | awk '{print $1}')
    SIZE=$(echo $line | awk '{print $2}' | sed 's/G//')
    USED=$(echo $line | awk '{print $3}' | sed 's/G//')
    USAGE=$(echo $line | awk '{print $5}' | sed 's/%//')
    MOUNT_POINT=$(echo $line | awk '{print $6}')
    
    echo "$DATE,$FILESYSTEM,$MOUNT_POINT,$SIZE,$USED,$USAGE" >> "$DATA_FILE"
done

# 生成报告
echo "磁盘空间使用趋势报告 - $(date)" > "$REPORT_FILE"
echo "=" >> "$REPORT_FILE"

# 分析每个文件系统的趋势
duplicate_filesystems=()

# 遍历数据文件中的所有唯一文件系统
cat "$DATA_FILE" | tail -n +2 | cut -d',' -f2 | sort | uniq | while read fs; do
    # 避免重复处理
    if [[ "${duplicate_filesystems[@]}" =~ "$fs" ]]; then
        continue
    fi
    duplicate_filesystems+=($fs)
    
    echo "\n文件系统: $fs" >> "$REPORT_FILE"
    echo "-" >> "$REPORT_FILE"
    
    # 获取最近7天的数据
    recent_data=$(grep "$fs" "$DATA_FILE" | tail -7)
    
    # 显示最近7天的使用率
    echo "最近7天使用率:" >> "$REPORT_FILE"
    echo "$recent_data" | cut -d',' -f1,5 | while read line; do
        date=$(echo $line | cut -d',' -f1)
        usage=$(echo $line | cut -d',' -f2)
        echo "  $date: $usage%" >> "$REPORT_FILE"
    done
    
    # 计算平均增长率（简单计算）
    first_usage=$(echo "$recent_data" | head -1 | cut -d',' -f5)
    last_usage=$(echo "$recent_data" | tail -1 | cut -d',' -f5)
    days=$(echo "$recent_data" | wc -l)
    
    if [ $days -gt 1 ] && [ $first_usage -gt 0 ]; then
        growth_rate=$(echo "scale=2; ($last_usage - $first_usage) / ($days - 1)" | bc)
        echo "平均日增长率: $growth_rate%" >> "$REPORT_FILE"
        
        # 预测何时达到90%使用率
        if (( $(echo "$growth_rate > 0" | bc -l) )); then
            days_to_90=$(echo "scale=0; (90 - $last_usage) / $growth_rate" | bc)
            if (( $(echo "$days_to_90 > 0" | bc -l) )); then
                prediction_date=$(date -d "$days_to_90 days" +"%Y-%m-%d")
                echo "预测达到90%使用率日期: $prediction_date" >> "$REPORT_FILE"
            fi
        fi
    fi
done

# 输出报告位置
echo "\n报告已生成: $REPORT_FILE"
```

### 5.3 查找占用空间最多的目录

结合df和du命令，找到占用空间最多的目录：

```bash
#!/bin/bash
# 查找占用空间最多的目录脚本

# 配置参数
TOP_N=10  # 显示前N个目录

# 检查参数
if [ $# -ne 1 ]; then
    echo "用法: $0 <挂载点>"
    exit 1
fi

MOUNT_POINT="$1"

# 检查挂载点是否存在
df -P "$MOUNT_POINT" > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "错误：挂载点 $MOUNT_POINT 不存在或无法访问。"
    exit 1
fi

# 显示挂载点的磁盘使用情况
echo "挂载点 $MOUNT_POINT 的磁盘使用情况："
df -h "$MOUNT_POINT"
echo "\n查找占用空间最多的 $TOP_N 个目录..."

# 查找占用空间最多的目录
du -h --max-depth=1 "$MOUNT_POINT" 2>/dev/null | sort -hr | head -$TOP_N | while read line; do
    size=$(echo $line | awk '{print $1}')
    dir=$(echo $line | awk '{print $2}')
    # 计算该目录占总空间的百分比
    total_space=$(df -k "$MOUNT_POINT" | tail -1 | awk '{print $2}')
    dir_size=$(du -k -s "$dir" 2>/dev/null | awk '{print $1}')
    percentage=$(echo "scale=2; $dir_size / $total_space * 100" | bc)
    echo "$size ($percentage%) - $dir"
done

# 建议操作
echo "\n建议："
echo "1. 检查大文件：find $MOUNT_POINT -type f -size +100M | sort -k 5 -n -r"
echo "2. 清理日志文件：ls -lh $MOUNT_POINT/var/log/*.log | sort -k 5 -n -r"
echo "3. 检查临时文件：du -sh $MOUNT_POINT/tmp/*"
echo "4. 考虑扩容：如果使用率超过80%，建议增加磁盘空间"
```

### 5.4 自动清理脚本

创建一个根据磁盘使用率自动清理临时文件和缓存的脚本：

```bash
#!/bin/bash
# 磁盘空间自动清理脚本

# 配置参数
THRESHOLD=85  # 触发清理的阈值百分比
CACHE_DIRS=("/tmp" "/var/tmp" "/var/cache/apt/archives")
LOG_FILE="/var/log/disk_cleanup.log"

# 创建日志文件
if [ ! -f "$LOG_FILE" ]; then
touch "$LOG_FILE"
echo "磁盘清理日志 - $(date)" >> "$LOG_FILE"
fi

# 获取当前日期和时间
CURRENT_TIME=$(date "%Y-%m-%d %H:%M:%S")
echo "\n[$CURRENT_TIME] 开始磁盘空间检查和清理" >> "$LOG_FILE"

# 获取根目录的使用率
ROOT_USAGE=$(df -P / | tail -1 | awk '{print $5}' | sed 's/%//g')
echo "根目录当前使用率: $ROOT_USAGE%" >> "$LOG_FILE"

# 如果使用率超过阈值，进行清理
if [ $ROOT_USAGE -gt $THRESHOLD ]; then
    echo "警告：根目录使用率 ($ROOT_USAGE%) 超过阈值 ($THRESHOLD%)，开始清理..." >> "$LOG_FILE"
    
    # 记录清理前的磁盘使用情况
    df -h / >> "$LOG_FILE"
    
    # 清理临时文件
    echo "\n清理临时文件：" >> "$LOG_FILE"
    for dir in "${CACHE_DIRS[@]}"; do
        if [ -d "$dir" ]; then
            echo "清理 $dir 目录中7天前的文件..." >> "$LOG_FILE"
            # 删除7天前的文件
            find "$dir" -type f -mtime +7 -delete 2>/dev/null
            echo "  已清理 $dir" >> "$LOG_FILE"
        fi
    done
    
    # 清理系统日志
    echo "\n清理系统日志：" >> "$LOG_FILE"
    if [ -f "/etc/logrotate.conf" ]; then
        echo "  运行 logrotate 强制轮转日志..." >> "$LOG_FILE"
        logrotate -f /etc/logrotate.conf 2>> "$LOG_FILE"
    fi
    
    # 清理孤立的包文件（Debian/Ubuntu）
    echo "\n清理包缓存：" >> "$LOG_FILE"
    if command -v apt-get &> /dev/null; then
        echo "  清理 apt 缓存..." >> "$LOG_FILE"
        apt-get clean 2>> "$LOG_FILE"
    fi
    
    # 记录清理后的磁盘使用情况
    echo "\n清理后的磁盘使用情况：" >> "$LOG_FILE"
    df -h / >> "$LOG_FILE"
    
    # 计算释放的空间
    AFTER_USAGE=$(df -P / | tail -1 | awk '{print $5}' | sed 's/%//g')
    SPACE_FREED=$(echo "$ROOT_USAGE - $AFTER_USAGE" | bc)
    echo "清理完成！释放了 $SPACE_FREED% 的空间（从 $ROOT_USAGE% 降至 $AFTER_USAGE%）" >> "$LOG_FILE"
else
    echo "根目录使用率正常 ($ROOT_USAGE%)，低于阈值 ($THRESHOLD%)，无需清理。" >> "$LOG_FILE"
fi

# 输出完成信息
echo "[$CURRENT_TIME] 磁盘空间检查和清理完成" >> "$LOG_FILE"
```

## 6. 常见问题与解决方案

### 6.1 df命令显示的空间与实际使用不符

**问题**：df命令显示磁盘已使用大量空间，但实际查看目录时发现占用空间较小。

**解决方案**：
这种情况通常是因为有已删除的文件仍被进程占用。可以使用lsof命令查找这些文件：

```bash
# 查找已删除但仍被进程占用的文件
$ sudo lsof +L1 | grep deleted
```

找到这些文件后，可以通过重启相关进程或等待进程自然结束来释放空间。

### 6.2 df命令不显示某些文件系统

**问题**：使用df命令时，某些文件系统没有显示出来。

**解决方案**：
使用`-a`选项显示所有文件系统，包括那些通常被省略的特殊文件系统：

```bash
# 显示所有文件系统
$ df -a
```

### 6.3 磁盘空间使用率为100%但找不到大文件

**问题**：df命令显示磁盘使用率为100%，但使用du命令查找大文件时却找不到占用大量空间的文件。

**解决方案**：
这通常是因为有文件被删除但仍被进程锁定。可以使用以下命令找到这些文件：

```bash
# 查找被删除但仍被占用的大文件
$ sudo lsof -nP | grep '(deleted)' | awk '{print $7 " " $9}' | sort -n -r | head -10
```

如果确认是这些文件占用了空间，可以通过重启相关服务或重启系统来释放空间。

### 6.4 df命令输出中文显示乱码

**问题**：在某些系统上，df命令显示的挂载点包含中文时出现乱码。

**解决方案**：
检查并设置正确的语言环境变量：

```bash
# 查看当前语言环境
$ echo $LANG

# 设置为中文UTF-8
$ export LANG=zh_CN.UTF-8
```

如果需要永久设置，可以修改`/etc/locale.conf`文件或`~/.bashrc`文件。

## 7. 实践练习

### 练习1：基本磁盘空间查看

1. 使用df命令以不同单位显示磁盘空间使用情况
2. 查看特定挂载点的使用情况
3. 显示文件系统类型信息

```bash
# 解决方案示例
# 以人类可读格式显示所有文件系统
df -h

# 以MB为单位显示
df -m

# 查看根目录的使用情况
df -h /

# 显示文件系统类型
df -T
```

### 练习2：磁盘空间监控脚本

创建一个简单的磁盘空间监控脚本，定期检查所有文件系统的使用率，并在超过80%时输出警告信息：

```bash
#!/bin/bash
# 简单磁盘监控脚本

# 设置警告阈值
THRESHOLD=80

# 获取当前日期和时间
NOW=$(date "%Y-%m-%d %H:%M:%S")

# 输出标题
cat << EOF
===== 磁盘空间监控报告 =====
时间: $NOW
阈值: $THRESHOLD%
===========================
EOF

# 检查所有文件系统
WARNING_COUNT=0
df -h | grep -v tmpfs | grep -v udev | while read line; do
    # 提取信息
    FILESYSTEM=$(echo $line | awk '{print $1}')
    SIZE=$(echo $line | awk '{print $2}')
    USED=$(echo $line | awk '{print $3}')
    AVAIL=$(echo $line | awk '{print $4}')
    USAGE=$(echo $line | awk '{print $5}' | sed 's/%//g')
    MOUNT=$(echo $line | awk '{print $6}')
    
    # 输出基本信息
    printf "%-20s %-8s %-8s %-8s %-8s %s\n" "$FILESYSTEM" "$SIZE" "$USED" "$AVAIL" "$USAGE%" "$MOUNT"
    
    # 检查是否超过阈值
    if [ $USAGE -gt $THRESHOLD ]; then
        echo "  ⚠️  警告：$MOUNT 使用率 ($USAGE%) 超过阈值 ($THRESHOLD%)"
        WARNING_COUNT=$((WARNING_COUNT+1))
    fi
done

# 输出总结
cat << EOF
===========================
总计警告: $WARNING_COUNT
EOF

# 返回适当的退出码
exit $WARNING_COUNT
```

### 练习3：磁盘空间趋势分析

扩展练习2中的脚本，添加简单的趋势分析功能，记录每次检查的结果并提供使用趋势：

```bash
#!/bin/bash
# 磁盘空间趋势分析脚本

# 配置参数
DATA_FILE="disk_space_history.csv"
THRESHOLD=80

# 创建数据文件（如果不存在）
if [ ! -f "$DATA_FILE" ]; then
echo "日期,时间,文件系统,挂载点,总大小(GB),已用(GB),可用(GB),使用率(%)" >> "$DATA_FILE"
fi

# 获取当前日期和时间
DATE=$(date "%Y-%m-%d")
TIME=$(date "%H:%M:%S")

# 输出标题
cat << EOF
===== 磁盘空间监控与趋势分析 =====
日期: $DATE
时间: $TIME
阈值: $THRESHOLD%
=================================
EOF

# 检查所有文件系统并记录数据
WARNING_COUNT=0
df -h | grep -v tmpfs | grep -v udev | while read line; do
    # 提取信息
    FILESYSTEM=$(echo $line | awk '{print $1}')
    SIZE=$(echo $line | awk '{print $2}' | sed 's/G//')
    USED=$(echo $line | awk '{print $3}' | sed 's/G//')
    AVAIL=$(echo $line | awk '{print $4}' | sed 's/G//')
    USAGE=$(echo $line | awk '{print $5}' | sed 's/%//g')
    MOUNT=$(echo $line | awk '{print $6}')
    
    # 输出基本信息
    printf "%-20s %-8s %-8s %-8s %-8s %s\n" "$FILESYSTEM" "${SIZE}G" "${USED}G" "${AVAIL}G" "$USAGE%" "$MOUNT"
    
    # 检查是否超过阈值
    if [ $USAGE -gt $THRESHOLD ]; then
        echo "  ⚠️  警告：$MOUNT 使用率 ($USAGE%) 超过阈值 ($THRESHOLD%)"
        WARNING_COUNT=$((WARNING_COUNT+1))
    fi
    
    # 记录数据
    echo "$DATE,$TIME,$FILESYSTEM,$MOUNT,$SIZE,$USED,$AVAIL,$USAGE" >> "$DATA_FILE"
done

# 简单趋势分析
if [ -f "$DATA_FILE" ] && [ $(wc -l < "$DATA_FILE") -gt 6 ]; then  # 至少有两次记录
    echo "\n===== 简单趋势分析 ====="
    # 获取唯一的文件系统列表
    FILESYSTEMS=$(tail -n +2 "$DATA_FILE" | cut -d',' -f3 | sort | uniq)
    
    for fs in $FILESYSTEMS; do
        # 获取该文件系统的最近两次记录
        RECORDS=$(grep "$fs" "$DATA_FILE" | tail -2)
        if [ $(echo "$RECORDS" | wc -l) -eq 2 ]; then
            # 提取使用率
            USAGE1=$(echo "$RECORDS" | head -1 | cut -d',' -f8)
            USAGE2=$(echo "$RECORDS" | tail -1 | cut -d',' -f8)
            MOUNT=$(echo "$RECORDS" | head -1 | cut -d',' -f4)
            
            # 计算变化
            CHANGE=$(echo "$USAGE2 - $USAGE1" | bc)
            
            if (( $(echo "$CHANGE > 0" | bc -l) )); then
                echo "$fs ($MOUNT): 使用率增加了 $CHANGE%"
            elif (( $(echo "$CHANGE < 0" | bc -l) )); then
                echo "$fs ($MOUNT): 使用率减少了 $(echo "$CHANGE * -1" | bc)%"
            else
                echo "$fs ($MOUNT): 使用率保持不变 ($USAGE2%)"
            fi
        fi
done
fi

# 输出总结
cat << EOF
=================================
总计警告: $WARNING_COUNT
历史数据已保存至: $DATA_FILE
EOF

# 返回适当的退出码
exit $WARNING_COUNT
```

### 练习4：磁盘空间清理工具

创建一个交互式磁盘空间清理工具，帮助用户识别和清理占用空间大的文件和目录：

```bash
#!/bin/bash
# 交互式磁盘空间清理工具

# 定义颜色
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # 无颜色

# 显示欢迎信息
echo -e "${BLUE}===== 交互式磁盘空间清理工具 =====${NC}"
echo -e "此工具将帮助您识别和清理占用系统空间的文件和目录。\n"

# 显示磁盘使用概览
echo -e "${YELLOW}当前磁盘使用概览：${NC}"
df -h | grep -v tmpfs | grep -v udev

echo -e "\n${BLUE}请选择要清理的挂载点：${NC}"
read -p "输入挂载点 (默认: /): " MOUNT_POINT
MOUNT_POINT=${MOUNT_POINT:-/}

# 检查挂载点是否存在
df -P "$MOUNT_POINT" > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo -e "${RED}错误：挂载点 $MOUNT_POINT 不存在或无法访问。${NC}"
exit 1
fi

# 显示该挂载点的详细信息
echo -e "\n${YELLOW}挂载点 $MOUNT_POINT 的详细信息：${NC}"
df -h "$MOUNT_POINT"

echo -e "\n${BLUE}查找占用空间最多的10个目录...${NC}"
du -h --max-depth=1 "$MOUNT_POINT" 2>/dev/null | sort -hr | head -10

# 交互式清理
echo -e "\n${BLUE}是否要查看大文件？(y/n): ${NC}"
read -p "" RESP
if [ "$RESP" = "y" ] || [ "$RESP" = "Y" ]; then
    echo -e "\n${YELLOW}查找 $MOUNT_POINT 下大于100MB的文件...${NC}"
    find "$MOUNT_POINT" -type f -size +100M 2>/dev/null | xargs du -h | sort -hr | head -10
fi

echo -e "\n${BLUE}是否要清理系统缓存？(y/n): ${NC}"
read -p "" RESP
if [ "$RESP" = "y" ] || [ "$RESP" = "Y" ]; then
    echo -e "\n${YELLOW}清理系统缓存...${NC}"
    # 清理apt缓存（Debian/Ubuntu）
    if command -v apt-get &> /dev/null; then
        echo "清理apt缓存..."
sudo apt-get clean
    fi
    
    # 清理临时文件
    echo "清理7天前的临时文件..."
sudo find /tmp -type f -mtime +7 -delete
    
    echo -e "${GREEN}系统缓存清理完成！${NC}"
fi

echo -e "\n${BLUE}是否要查看清理后的磁盘空间？(y/n): ${NC}"
read -p "" RESP
if [ "$RESP" = "y" ] || [ "$RESP" = "Y" ]; then
    echo -e "\n${YELLOW}清理后的磁盘使用情况：${NC}"
df -h "$MOUNT_POINT"
fi

echo -e "\n${GREEN}磁盘清理工具运行完成！${NC}"
echo -e "${BLUE}======================================${NC}"
```

通过完成以上练习，您将能够熟练掌握df命令的各种用法，并能够在实际工作中应用它来监控和管理Linux系统的磁盘空间。