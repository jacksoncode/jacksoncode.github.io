# 8.2 du命令详解

## 1. 命令概述

du（disk usage）命令是Linux系统中用于估算文件和目录磁盘使用空间的命令行工具。它可以帮助用户快速了解各个文件和目录占用了多少磁盘空间，是系统管理和磁盘空间分析的重要工具。与df命令不同，du命令侧重于显示文件和目录的磁盘使用情况，而df命令则显示整个文件系统的使用情况。

### 1.1 功能特点
- 计算文件和目录的磁盘使用情况
- 支持递归计算目录大小
- 可以按照不同单位显示大小（KB、MB、GB等）
- 能够排除某些文件或目录
- 支持按大小排序显示
- 提供摘要和详细信息显示选项
- 可以显示特定深度的目录大小

### 1.2 应用场景
- 查找占用大量磁盘空间的文件和目录
- 监控目录大小的变化
- 在清理磁盘空间前分析空间占用情况
- 确认备份文件的大小
- 在自动化脚本中检查文件大小条件

## 2. 语法格式

du命令的基本语法格式如下：

```bash
# 基本语法
$ du [选项] [文件或目录...]
```

### 2.1 语法说明
- **du**：命令名称，用于估算文件和目录的磁盘使用空间
- **选项**：控制命令输出格式和内容的参数
- **文件或目录**：指定要检查的文件或目录，如果不指定，则默认为当前目录

> **注意**：du命令默认会递归计算所有子目录的大小，这可能导致在包含大量文件的目录上运行时间较长。

## 3. 常用选项

du命令提供了多种选项来控制输出格式和内容，以下是最常用的选项：

### 3.1 选项列表

| 选项 | 功能说明 |
|------|----------|
| `-a` | 显示所有文件和目录的大小，而不仅仅是目录 |
| `-h` | 以人类可读的格式显示（如KB、MB、GB） |
| `-s` | 仅显示总计，不显示每个子目录或文件的大小 |
| `-c` | 显示所有指定文件的大小总和 |
| `-d <深度>` | 限制目录显示深度 |
| `-k` | 以KB为单位显示，默认选项 |
| `-m` | 以MB为单位显示 |
| `-g` | 以GB为单位显示 |
| `-B <大小>` | 使用指定的块大小（例如KB、MB等） |
| `--max-depth=<深度>` | 同`-d`，限制目录显示深度 |
| `--exclude=<模式>` | 排除与指定模式匹配的文件 |
| `--time` | 显示每个目录中最新文件的修改时间 |
| `--apparent-size` | 显示文件的实际大小，而不是磁盘使用量 |

### 3.2 选项详细解释

- **`-a`**: 显示所有文件和目录的大小，而不仅仅是目录。默认情况下，du只显示目录的大小。

- **`-h`**: 以人类可读的格式显示大小，自动将大数字转换为KB、MB、GB等单位，方便阅读。

- **`-s`**: 仅显示指定目录的总大小，不显示其子目录或文件的大小。

- **`-c`**: 在输出的最后显示所有指定文件和目录的大小总和。

- **`-d <深度>`**: 限制目录显示的深度，只显示指定深度内的目录大小。例如，`-d 1`只显示当前目录下一级子目录的大小。

- **`-k`**: 以KB为单位显示大小，这是du命令的默认选项。

- **`-m`**: 以MB为单位显示大小。

- **`-g`**: 以GB为单位显示大小。

- **`-B <大小>`**: 使用指定的块大小显示，例如`-B MB`将以MB为单位显示。

- **`--max-depth=<深度>`**: 与`-d`选项功能相同，限制目录显示的深度。

- **`--exclude=<模式>`**: 排除与指定模式匹配的文件或目录。可以使用通配符，例如`--exclude="*.log"`排除所有.log文件。

- **`--time`**: 显示每个目录中最新文件的修改时间。

- **`--apparent-size`**: 显示文件的实际大小，而不是磁盘使用量。这对于文本文件等通常会小于磁盘使用量。

## 4. 常用示例

### 4.1 显示当前目录的磁盘使用情况

显示当前目录及其子目录的磁盘使用情况：

```bash
# 显示当前目录的磁盘使用情况
$ du
4       ./documents/reports
8       ./documents
4       ./downloads
20      .
```

### 4.2 以人类可读格式显示

以更易读的格式显示当前目录的磁盘使用情况：

```bash
# 以人类可读格式显示
$ du -h
4.0K    ./documents/reports
8.0K    ./documents
4.0K    ./downloads
20K     .
```

### 4.3 显示特定目录的总大小

显示特定目录的总大小，不显示其子目录：

```bash
# 显示/home/user目录的总大小
$ du -sh /home/user
24G     /home/user
```

### 4.4 显示多个目录的大小并总计

显示多个目录的大小，并在最后显示总和：

```bash
# 显示多个目录的大小并总计
$ du -shc /home /var /tmp
24G     /home
8.5G    /var
128K    /tmp
32G     total
```

### 4.5 限制显示深度

限制目录显示的深度，只显示当前目录下一级子目录的大小：

```bash
# 限制显示深度为1
$ du -hd 1
8.0K    ./documents
4.0K    ./downloads
20K     .
```

### 4.6 显示所有文件和目录的大小

显示所有文件和目录的大小，而不仅仅是目录：

```bash
# 显示所有文件和目录的大小
$ du -ah
4.0K    ./file1.txt
2.0K    ./file2.txt
4.0K    ./documents/reports/report1.pdf
4.0K    ./documents/reports
8.0K    ./documents
4.0K    ./downloads/file.zip
4.0K    ./downloads
20K     .
```

### 4.7 按大小排序显示目录

结合du和sort命令，按大小排序显示目录：

```bash
# 按大小排序显示当前目录下的子目录
$ du -h --max-depth=1 | sort -hr
20K     .
8.0K    ./documents
4.0K    ./downloads
```

### 4.8 排除特定文件或目录

计算目录大小时排除特定类型的文件：

```bash
# 计算/var目录大小，排除log文件
$ du -sh --exclude="*.log" /var
8.2G    /var
```

### 4.9 查找占用空间最大的10个目录

查找系统中占用空间最大的10个目录：

```bash
# 查找占用空间最大的10个目录
$ sudo du -h / --max-depth=2 2>/dev/null | sort -hr | head -10
24G     /home
16G     /usr
8.5G    /var
4.0G    /opt
3.2G    /home/user/Documents
2.8G    /home/user/Downloads
2.5G    /usr/lib
2.0G    /var/lib
1.8G    /usr/share
1.5G    /home/user/Music
```

### 4.10 显示文件的实际大小

显示文件的实际大小，而不是磁盘使用量：

```bash
# 显示文件的实际大小
$ du -h --apparent-size file1.txt
1.5K    file1.txt

# 比较磁盘使用量
$ du -h file1.txt
4.0K    file1.txt
```

### 4.11 显示目录中最新文件的修改时间

显示每个目录中最新文件的修改时间：

```bash
# 显示目录及其最新修改时间
$ du -h --time
4.0K    2023-05-10 14:30    ./documents/reports
8.0K    2023-05-10 14:30    ./documents
4.0K    2023-05-09 10:15    ./downloads
20K     2023-05-10 14:30    .
```

### 4.12 查找特定大小的文件

查找大于100MB的文件：

```bash
# 查找大于100MB的文件
$ find /home -type f -size +100M -exec du -h {} \;
234M    /home/user/Videos/movie.mp4
156M    /home/user/Downloads/software.iso
128M    /home/user/Documents/archive.zip
```

## 5. 高级用法

### 5.1 创建磁盘空间分析报告

创建一个脚本来分析系统磁盘空间使用情况并生成详细报告：

```bash
#!/bin/bash
# 磁盘空间分析报告生成脚本

# 配置参数
REPORT_FILE="disk_usage_report_$(date +%Y%m%d).txt"
TOP_N=15  # 显示前N个大目录
MAX_DEPTH=2  # 分析的目录深度
EXCLUDE_DIRS=("/proc" "/sys" "/dev" "/run" "/mnt" "/media" "/tmp")

# 创建报告文件
echo "磁盘空间分析报告 - $(date)" > "$REPORT_FILE"
echo "==================================" >> "$REPORT_FILE"
echo "报告生成时间: $(date)" >> "$REPORT_FILE"
echo "系统信息: $(uname -a)" >> "$REPORT_FILE"
echo "==================================" >> "$REPORT_FILE"

# 添加文件系统概览
echo -e "\n\n===== 文件系统概览 =====