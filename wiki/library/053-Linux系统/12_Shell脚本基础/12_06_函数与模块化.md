# å‡½æ•°ä¸æ¨¡å—åŒ–

## 1 å‡½æ•°åŸºç¡€

### 1.1 å‡½æ•°å®šä¹‰ä¸è°ƒç”¨

#### 1.1.1 åŸºæœ¬è¯­æ³•

```bash
#!/bin/bash
# å‡½æ•°å®šä¹‰ä¸è°ƒç”¨ç¤ºä¾‹

# æ–¹å¼ä¸€ï¼šä½¿ç”¨functionå…³é”®å­—
function greet_simple() {
    echo "Hello, World!"
}

# æ–¹å¼äºŒï¼šç›´æ¥å®šä¹‰
say_hello() {
    echo "ä½ å¥½ï¼Œä¸–ç•Œï¼"
}

# æ–¹å¼ä¸‰ï¼šå¸¦å‚æ•°çš„å‡½æ•°
welcome_user() {
    local name="$1"
    echo "æ¬¢è¿ï¼Œ$nameï¼"
}

# è°ƒç”¨å‡½æ•°
echo "=== å‡½æ•°è°ƒç”¨ç¤ºä¾‹ ==="
greet_simple
say_hello
welcome_user "å¼ ä¸‰"
```

#### 1.1.2 å‡½æ•°å‚æ•°å¤„ç†

```bash
#!/bin/bash
# å‡½æ•°å‚æ•°å¤„ç†è¯¦è§£

# ä½ç½®å‚æ•°å‡½æ•°
print_user_info() {
    local name="$1"
    local age="$2"
    local city="$3"
    
    echo "ç”¨æˆ·ä¿¡æ¯ï¼š"
    echo "  å§“åï¼š$name"
    echo "  å¹´é¾„ï¼š$age"
    echo "  åŸå¸‚ï¼š$city"
}

# å¯å˜å‚æ•°å‡½æ•°
sum_numbers() {
    local sum=0
    for num in "$@"; do
        if [[ "$num" =~ ^[0-9]+$ ]]; then
            sum=$((sum + num))
        else
            echo "è­¦å‘Šï¼š'$num' ä¸æ˜¯æœ‰æ•ˆæ•°å­—ï¼Œå·²è·³è¿‡"
        fi
    done
    echo $sum
}

# å‚æ•°éªŒè¯å‡½æ•°
create_user() {
    local username="$1"
    local password="$2"
    local shell="${3:-/bin/bash}"
    
    # å‚æ•°éªŒè¯
    if [ -z "$username" ] || [ -z "$password" ]; then
        echo "é”™è¯¯ï¼šç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º"
        return 1
    fi
    
    if ! [[ "$username" =~ ^[a-z_][a-z0-9_-]{0,31}$ ]]; then
        echo "é”™è¯¯ï¼šç”¨æˆ·åæ ¼å¼æ— æ•ˆ"
        return 1
    fi
    
    # åˆ›å»ºç”¨æˆ·
    echo "åˆ›å»ºç”¨æˆ·ï¼š$username"
    echo "  Shellï¼š$shell"
    echo "  å¯†ç ï¼š$(echo "$password" | md5sum | cut -d' ' -f1)"
    
    return 0
}

# ä½¿ç”¨ç¤ºä¾‹
print_user_info "æå››" 28 "åŒ—äº¬"
sum_numbers 10 20 30 40 50
create_user "testuser" "password123" "/bin/zsh"
```

### 1.2 å‡½æ•°è¿”å›å€¼

#### 1.2.1 è¿”å›çŠ¶æ€ç 

```bash
#!/bin/bash
# å‡½æ•°è¿”å›çŠ¶æ€ç ç¤ºä¾‹

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
check_file_exists() {
    local file="$1"
    
    if [ -z "$file" ]; then
        echo "é”™è¯¯ï¼šæœªæä¾›æ–‡ä»¶å"
        return 1
    fi
    
    if [ -f "$file" ]; then
        echo "æ–‡ä»¶å­˜åœ¨ï¼š$file"
        return 0
    else
        echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼š$file"
        return 2
    fi
}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service_status() {
    local service="$1"
    
    if ! command -v systemctl > /dev/null; then
        echo "é”™è¯¯ï¼šsystemctlå‘½ä»¤ä¸å¯ç”¨"
        return 3
    fi
    
    if systemctl is-active --quiet "$service"; then
        echo "æœåŠ¡è¿è¡Œä¸­ï¼š$service"
        return 0
    else
        echo "æœåŠ¡æœªè¿è¡Œï¼š$service"
        return 4
    fi
}

# ä½¿ç”¨å‡½æ•°å¹¶æ£€æŸ¥è¿”å›å€¼
if check_file_exists "/etc/passwd"; then
    echo "æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
fi

if check_service_status "sshd"; then
    echo "SSHæœåŠ¡è¿è¡Œæ­£å¸¸"
else
    echo "SSHæœåŠ¡éœ€è¦æ£€æŸ¥"
fi
```

#### 1.2.2 è¿”å›å­—ç¬¦ä¸²ç»“æœ

```bash
#!/bin/bash
# å‡½æ•°è¿”å›å­—ç¬¦ä¸²ç»“æœç¤ºä¾‹

# è·å–ç³»ç»Ÿä¿¡æ¯
get_system_info() {
    local info=""
    
    info+="æ“ä½œç³»ç»Ÿï¼š$(uname -s)"
    info+="\nå†…æ ¸ç‰ˆæœ¬ï¼š$(uname -r)"
    info+="\nä¸»æœºåï¼š$(hostname)"
    info+="\nCPUä¿¡æ¯ï¼š$(grep 'model name' /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)"
    info+="\nå†…å­˜æ€»é‡ï¼š$(free -h | grep Mem | awk '{print $2}')"
    
    echo "$info"
}

# è·å–ç½‘ç»œé…ç½®
get_network_config() {
    local interface="$1"
    local config=""
    
    if [ -z "$interface" ]; then
        interface=$(ip route | grep default | awk '{print $5}' | head -1)
    fi
    
    if ip addr show "$interface" > /dev/null 2>&1; then
        local ip=$(ip addr show "$interface" | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)
        local mac=$(ip addr show "$interface" | grep 'link/ether' | awk '{print $2}')
        
        config="æ¥å£ï¼š$interface"
        config+="\nIPåœ°å€ï¼š${ip:-æœªé…ç½®}"
        config+="\nMACåœ°å€ï¼š${mac:-æœªè·å–}"
    else
        config="æ¥å£ $interface ä¸å­˜åœ¨"
    fi
    
    echo "$config"
}

# ä½¿ç”¨å‡½æ•°
system_info=$(get_system_info)
network_info=$(get_network_config "eth0")

echo -e "$system_info"
echo
echo -e "$network_info"
```

## 2 é«˜çº§å‡½æ•°ç‰¹æ€§

### 2.1 é€’å½’å‡½æ•°

#### 2.1.1 é˜¶ä¹˜è®¡ç®—

```bash
#!/bin/bash
# é€’å½’å‡½æ•°ç¤ºä¾‹ï¼šé˜¶ä¹˜è®¡ç®—

factorial() {
    local n="$1"
    
    # å‚æ•°éªŒè¯
    if [ -z "$n" ] || ! [[ "$n" =~ ^[0-9]+$ ]]; then
        echo "é”™è¯¯ï¼šè¯·è¾“å…¥éè´Ÿæ•´æ•°"
        return 1
    fi
    
    if [ "$n" -eq 0 ] || [ "$n" -eq 1 ]; then
        echo 1
    else
        local prev=$((n - 1))
        local prev_result=$(factorial "$prev")
        echo $((n * prev_result))
    fi
}

# æµ‹è¯•é˜¶ä¹˜å‡½æ•°
for i in {0..5}; do
    result=$(factorial "$i")
    echo "$i! = $result"
done
```

#### 2.1.2 æ–æ³¢é‚£å¥‘æ•°åˆ—

```bash
#!/bin/bash
# é€’å½’å‡½æ•°ç¤ºä¾‹ï¼šæ–æ³¢é‚£å¥‘æ•°åˆ—

fibonacci() {
    local n="$1"
    
    if [ -z "$n" ] || ! [[ "$n" =~ ^[0-9]+$ ]]; then
        echo "é”™è¯¯ï¼šè¯·è¾“å…¥éè´Ÿæ•´æ•°"
        return 1
    fi
    
    if [ "$n" -eq 0 ]; then
        echo 0
    elif [ "$n" -eq 1 ]; then
        echo 1
    else
        local prev1=$((n - 1))
        local prev2=$((n - 2))
        local fib1=$(fibonacci "$prev1")
        local fib2=$(fibonacci "$prev2")
        echo $((fib1 + fib2))
    fi
}

# ç”Ÿæˆæ–æ³¢é‚£å¥‘æ•°åˆ—
echo "æ–æ³¢é‚£å¥‘æ•°åˆ—å‰10é¡¹ï¼š"
for i in {0..9}; do
    fib=$(fibonacci "$i")
    echo -n "$fib "
done
echo
```

#### 2.1.3 ç›®å½•éå†

```bash
#!/bin/bash
# é€’å½’å‡½æ•°ç¤ºä¾‹ï¼šç›®å½•éå†

list_directory_tree() {
    local dir="$1"
    local indent="${2:-}"
    
    if [ ! -d "$dir" ]; then
        echo "${indent}é”™è¯¯ï¼šç›®å½•ä¸å­˜åœ¨ï¼š$dir"
        return 1
    fi
    
    for item in "$dir"/*; do
        if [ -e "$item" ]; then
            local basename=$(basename "$item")
            if [ -d "$item" ]; then
                echo "${indent}ğŸ“ $basename/"
                list_directory_tree "$item" "  $indent"
            elif [ -f "$item" ]; then
                local size=$(stat -c%s "$item" 2>/dev/null || echo 0)
                local human_size=$(numfmt --to=iec-i --suffix=B "$size" 2>/dev/null || echo "${size}B")
                echo "${indent}ğŸ“„ $basename ($human_size)"
            elif [ -L "$item" ]; then
                local target=$(readlink "$item")
                echo "${indent}ğŸ”— $basename -> $target"
            else
                echo "${indent}â“ $basename"
            fi
        fi
    done
}

# ä½¿ç”¨å‡½æ•°
echo "ç›®å½•ç»“æ„ï¼š"
list_directory_tree "/etc" ""
```

### 2.2 å‡½æ•°ä½œç”¨åŸŸ

#### 2.2.1 å±€éƒ¨å˜é‡ä¸å…¨å±€å˜é‡

```bash
#!/bin/bash
# å‡½æ•°ä½œç”¨åŸŸç¤ºä¾‹

# å…¨å±€å˜é‡
global_var="æˆ‘æ˜¯å…¨å±€å˜é‡"

# ä¿®æ”¹å…¨å±€å˜é‡çš„å‡½æ•°
modify_global() {
    global_var="å‡½æ•°ä¿®æ”¹äº†å…¨å±€å˜é‡"
    echo "å‡½æ•°å†…ï¼š$global_var"
}

# ä½¿ç”¨å±€éƒ¨å˜é‡çš„å‡½æ•°
use_local() {
    local global_var="è¿™æ˜¯å±€éƒ¨å˜é‡ï¼Œä¸å½±å“å…¨å±€"
    echo "å‡½æ•°å†…å±€éƒ¨ï¼š$global_var"
}

# å¤æ‚ä½œç”¨åŸŸç¤ºä¾‹
complex_scope() {
    local local_var="å±€éƒ¨å˜é‡"
    
    # å†…éƒ¨å‡½æ•°
    inner_function() {
        echo "å†…éƒ¨å‡½æ•°å¯ä»¥è®¿é—®ï¼š$local_var"
        echo "å†…éƒ¨å‡½æ•°å¯ä»¥è®¿é—®ï¼š$global_var"
        
        # å®šä¹‰æ–°çš„å±€éƒ¨å˜é‡
        local inner_var="å†…éƒ¨å±€éƒ¨å˜é‡"
        echo "å†…éƒ¨å˜é‡ï¼š$inner_var"
    }
    
    inner_function
    echo "å¤–éƒ¨å‡½æ•°è®¿é—®å†…éƒ¨å˜é‡ï¼š${inner_var:-æœªå®šä¹‰}"
}

# æ¼”ç¤ºä½œç”¨åŸŸ
echo "åˆå§‹ï¼š$global_var"
modify_global
echo "ä¿®æ”¹åï¼š$global_var"
use_local
echo "ä½¿ç”¨å±€éƒ¨å˜é‡åï¼š$global_var"
complex_scope
```

#### 2.2.2 ç¯å¢ƒå˜é‡ä¼ é€’

```bash
#!/bin/bash
# ç¯å¢ƒå˜é‡ä¼ é€’ç¤ºä¾‹

# è®¾ç½®ç¯å¢ƒå˜é‡
export GLOBAL_CONFIG="/etc/myapp/config.conf"

# ä½¿ç”¨ç¯å¢ƒå˜é‡çš„å‡½æ•°
load_config() {
    local config_file="${1:-$GLOBAL_CONFIG}"
    
    if [ -f "$config_file" ]; then
        echo "åŠ è½½é…ç½®æ–‡ä»¶ï¼š$config_file"
        # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„é…ç½®åŠ è½½é€»è¾‘
        return 0
    else
        echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼š$config_file"
        return 1
    fi
}

# å­shellä¸­çš„ç¯å¢ƒå˜é‡
run_in_subshell() {
    (
        # åœ¨å­shellä¸­ä¿®æ”¹ç¯å¢ƒå˜é‡
        export GLOBAL_CONFIG="/tmp/sub_config.conf"
        echo "å­shellä¸­ï¼š$GLOBAL_CONFIG"
        load_config
    )
    
    # çˆ¶shellä¸­çš„ç¯å¢ƒå˜é‡ä¸å˜
    echo "çˆ¶shellä¸­ï¼š$GLOBAL_CONFIG"
}

# ä½¿ç”¨å‡½æ•°
load_config
run_in_subshell
```

## 3 æ¨¡å—åŒ–ç¼–ç¨‹

### 3.1 å‡½æ•°åº“åˆ›å»º

#### 3.1.1 åˆ›å»ºå‡½æ•°åº“æ–‡ä»¶

```bash
# æ–‡ä»¶ï¼šlib/utils.sh
#!/bin/bash
# é€šç”¨å·¥å…·å‡½æ•°åº“

# é¢œè‰²å®šä¹‰
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[0;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly WHITE='\033[0;37m'
readonly NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log() {
    local level="$1"
    shift
    local message="$*"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    case "$level" in
        INFO)
            echo -e "${GREEN}[INFO]${NC} $timestamp - $message"
            ;;
        WARN)
            echo -e "${YELLOW}[WARN]${NC} $timestamp - $message"
            ;;
        ERROR)
            echo -e "${RED}[ERROR]${NC} $timestamp - $message"
            ;;
        DEBUG)
            if [ "${DEBUG:-0}" = "1" ]; then
                echo -e "${BLUE}[DEBUG]${NC} $timestamp - $message"
            fi
            ;;
        *)
            echo -e "${WHITE}[$level]${NC} $timestamp - $message"
            ;;
    esac
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# æ£€æŸ¥æ–‡ä»¶æƒé™
check_file_permissions() {
    local file="$1"
    local required_perms="$2"
    
    if [ ! -f "$file" ]; then
        log ERROR "æ–‡ä»¶ä¸å­˜åœ¨ï¼š$file"
        return 1
    fi
    
    local current_perms=$(stat -c "%a" "$file")
    if [ "$current_perms" = "$required_perms" ]; then
        log INFO "æ–‡ä»¶æƒé™æ­£ç¡®ï¼š$file ($current_perms)"
        return 0
    else
        log WARN "æ–‡ä»¶æƒé™ä¸åŒ¹é…ï¼š$file (å½“å‰: $current_perms, éœ€è¦: $required_perms)"
        return 1
    fi
}

# åˆ›å»ºå¤‡ä»½
create_backup() {
    local source="$1"
    local backup_dir="${2:-./backups}"
    local timestamp=$(date +%Y%m%d_%H%M%S)
    
    if [ ! -e "$source" ]; then
        log ERROR "æºæ–‡ä»¶/ç›®å½•ä¸å­˜åœ¨ï¼š$source"
        return 1
    fi
    
    mkdir -p "$backup_dir"
    
    local basename=$(basename "$source")
    local backup_file="${backup_dir}/${basename}_${timestamp}.tar.gz"
    
    if tar -czf "$backup_file" -C "$(dirname "$source")" "$(basename "$source")" 2>/dev/null; then
        log INFO "å¤‡ä»½åˆ›å»ºæˆåŠŸï¼š$backup_file"
        echo "$backup_file"
        return 0
    else
        log ERROR "å¤‡ä»½åˆ›å»ºå¤±è´¥ï¼š$source"
        return 1
    fi
}

# è·å–ç³»ç»Ÿä¿¡æ¯
get_system_info() {
    local info_file="/tmp/system_info_$$.tmp"
    
    {
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        echo "æ“ä½œç³»ç»Ÿï¼š$(uname -s)"
        echo "å†…æ ¸ç‰ˆæœ¬ï¼š$(uname -r)"
        echo "ä¸»æœºåï¼š$(hostname)"
        echo "CPUæ ¸å¿ƒæ•°ï¼š$(nproc)"
        echo "å†…å­˜æ€»é‡ï¼š$(free -h | grep Mem | awk '{print $2}')"
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -h | grep -E '^/dev/' | awk '{print "  " $1 ": " $3 "/" $2 " (" $5 " ä½¿ç”¨)"}'
        echo "è´Ÿè½½å¹³å‡å€¼ï¼š$(uptime | awk -F'load average:' '{print $2}')"
    } > "$info_file"
    
    cat "$info_file"
    rm -f "$info_file"
}
```

#### 3.1.2 ä½¿ç”¨å‡½æ•°åº“

```bash
#!/bin/bash
# ä½¿ç”¨å‡½æ•°åº“çš„ç¤ºä¾‹è„šæœ¬

# åŠ è½½å‡½æ•°åº“
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/utils.sh" || {
    echo "æ— æ³•åŠ è½½å‡½æ•°åº“"
    exit 1
}

# ä¸»ç¨‹åº
main() {
    log INFO "å¼€å§‹ç³»ç»Ÿæ£€æŸ¥..."
    
    # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    get_system_info
    
    # æ£€æŸ¥é‡è¦æ–‡ä»¶
    check_file_permissions "/etc/passwd" "644"
    check_file_permissions "/etc/shadow" "640"
    
    # åˆ›å»ºå¤‡ä»½
    if [ -d "/etc/nginx" ]; then
        create_backup "/etc/nginx" "/tmp/nginx_backups"
    fi
    
    log INFO "ç³»ç»Ÿæ£€æŸ¥å®Œæˆ"
}

# è°ƒè¯•æ¨¡å¼
if [ "${1:-}" = "--debug" ]; then
    export DEBUG=1
    log DEBUG "è°ƒè¯•æ¨¡å¼å·²å¯ç”¨"
fi

# è¿è¡Œä¸»ç¨‹åº
main "$@"
```

### 3.2 é…ç½®æ–‡ä»¶ç®¡ç†

#### 3.2.1 é…ç½®æ–‡ä»¶æ ¼å¼

```bash
# æ–‡ä»¶ï¼šconfig/app.conf
# åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶

# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_NAME=myapp
DB_USER=appuser
DB_PASS=secretpassword

# æ—¥å¿—é…ç½®
LOG_LEVEL=INFO
LOG_FILE=/var/log/myapp/app.log
LOG_ROTATION=daily

# å¤‡ä»½é…ç½®
BACKUP_ENABLED=true
BACKUP_DIR=/var/backups/myapp
BACKUP_RETENTION_DAYS=30

# ç›‘æ§é…ç½®
MONITOR_ENABLED=true
MONITOR_INTERVAL=300
ALERT_EMAIL=admin@example.com
```

#### 3.2.2 é…ç½®æ–‡ä»¶åŠ è½½å‡½æ•°

```bash
#!/bin/bash
# é…ç½®æ–‡ä»¶ç®¡ç†å‡½æ•°

# åŠ è½½é…ç½®æ–‡ä»¶
load_config() {
    local config_file="$1"
    local prefix="${2:-}"
    
    if [ ! -f "$config_file" ]; then
        echo "é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼š$config_file" >&2
        return 1
    fi
    
    # è¯»å–é…ç½®æ–‡ä»¶
    while IFS='=' read -r key value; do
        # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
        [[ "$key" =~ ^#.*$ ]] && continue
        [[ -z "$key" ]] && continue
        
        # å»é™¤ç©ºæ ¼
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)
        
        # è®¾ç½®å˜é‡
        if [ -n "$prefix" ]; then
            eval "${prefix}_${key}='${value}'"
        else
            eval "${key}='${value}'"
        fi
    done < "$config_file"
    
    return 0
}

# è·å–é…ç½®å€¼
get_config() {
    local key="$1"
    local default="$2"
    local prefix="${3:-}"
    
    local var_name
    if [ -n "$prefix" ]; then
        var_name="${prefix}_${key}"
    else
        var_name="${key}"
    fi
    
    eval echo "\${${var_name}:-$default}"
}

# éªŒè¯é…ç½®
validate_config() {
    local required_vars=("$@")
    local missing_vars=()
    
    for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
            missing_vars+=("$var")
        fi
    done
    
    if [ ${#missing_vars[@]} -gt 0 ]; then
        echo "é”™è¯¯ï¼šç¼ºå°‘å¿…éœ€é…ç½®ï¼š${missing_vars[*]}" >&2
        return 1
    fi
    
    return 0
}

# ä½¿ç”¨ç¤ºä¾‹
main() {
    local config_file="config/app.conf"
    
    # åŠ è½½é…ç½®
    load_config "$config_file"
    
    # éªŒè¯å¿…éœ€é…ç½®
    validate_config "DB_HOST" "DB_NAME" "LOG_LEVEL"
    
    # ä½¿ç”¨é…ç½®å€¼
    echo "æ•°æ®åº“ä¸»æœºï¼š$(get_config "DB_HOST" "localhost")"
    echo "æ—¥å¿—çº§åˆ«ï¼š$(get_config "LOG_LEVEL" "INFO")"
    echo "ç›‘æ§é—´éš”ï¼š$(get_config "MONITOR_INTERVAL" "300")ç§’"
}

# å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi
```

## 4 é”™è¯¯å¤„ç†ä¸è°ƒè¯•

### 4.1 é”™è¯¯å¤„ç†æœºåˆ¶

#### 4.1.1 é”™è¯¯å¤„ç†å‡½æ•°

```bash
#!/bin/bash
# é”™è¯¯å¤„ç†æœºåˆ¶

# è®¾ç½®é”™è¯¯å¤„ç†
set -euo pipefail

# é”™è¯¯å¤„ç†å‡½æ•°
error_handler() {
    local line_number="$1"
    local error_code="$2"
    local script_name="${BASH_SOURCE[1]}"
    
    echo "é”™è¯¯ï¼šè„šæœ¬ '$script_name' åœ¨ç¬¬ $line_number è¡Œå‘ç”Ÿé”™è¯¯ (é€€å‡ºç : $error_code)" >&2
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    if [ -n "${TEMP_FILES:-}" ]; then
        for file in $TEMP_FILES; do
            [ -f "$file" ] && rm -f "$file"
        done
    fi
    
    exit "$error_code"
}

# è®¾ç½®é”™è¯¯é™·é˜±
trap 'error_handler ${LINENO} $?' ERR

# ä¿¡å·å¤„ç†å‡½æ•°
cleanup() {
    echo "æ­£åœ¨æ¸…ç†..."
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    if [ -n "${TEMP_FILES:-}" ]; then
        for file in $TEMP_FILES; do
            [ -f "$file" ] && rm -f "$file"
        done
    fi
    
    # åœæ­¢åå°è¿›ç¨‹
    if [ -n "${BACKGROUND_PIDS:-}" ]; then
        for pid in $BACKGROUND_PIDS; do
            kill -TERM "$pid" 2>/dev/null || true
        done
    fi
    
    echo "æ¸…ç†å®Œæˆ"
}

# è®¾ç½®æ¸…ç†é™·é˜±
trap cleanup EXIT

# ä½¿ç”¨ç¤ºä¾‹
main() {
    local temp_file=$(mktemp)
    TEMP_FILES="$temp_file"
    
    echo "ä¸´æ—¶æ–‡ä»¶ï¼š$temp_file"
    echo "æµ‹è¯•æ•°æ®" > "$temp_file"
    
    # æ¨¡æ‹Ÿé”™è¯¯
    cat "/nonexistent/file"
}

main "$@"
```

### 4.2 è°ƒè¯•æŠ€å·§

#### 4.2.1 è°ƒè¯•å‡½æ•°

```bash
#!/bin/bash
# è°ƒè¯•å·¥å…·å‡½æ•°

# è°ƒè¯•å¼€å…³
DEBUG=${DEBUG:-0}
DEBUG_FILE="/tmp/debug_$(basename "$0").log"

# è°ƒè¯•è¾“å‡ºå‡½æ•°
debug() {
    if [ "$DEBUG" = "1" ]; then
        local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        local script_name=$(basename "$0")
        local line_number="${BASH_LINENO[0]}"
        
        echo "[$timestamp] [$script_name:$line_number] $*" | tee -a "$DEBUG_FILE"
    fi
}

# å‡½æ•°è·Ÿè¸ª
trace_function() {
    if [ "$DEBUG" = "1" ]; then
        local func_name="${FUNCNAME[1]}"
        local args=("$@")
        local arg_str=""
        
        for arg in "${args[@]}"; do
            arg_str+="'$arg' "
        done
        
        debug "è°ƒç”¨å‡½æ•°: $func_name($arg_str)"
    fi
}

# å˜é‡æ£€æŸ¥
check_variable() {
    local var_name="$1"
    local var_value="${!var_name:-æœªå®šä¹‰}"
    
    debug "å˜é‡ $var_name = '$var_value'"
}

# æ€§èƒ½è®¡æ—¶
start_timer() {
    local timer_name="${1:-default}"
    eval "TIMER_START_${timer_name}=\$(date +%s.%N)"
}

end_timer() {
    local timer_name="${1:-default}"
    local start_var="TIMER_START_${timer_name}"
    local start_time=${!start_var:-0}
    
    if [ "$start_time" != "0" ]; then
        local end_time=$(date +%s.%N)
        local duration=$(echo "$end_time - $start_time" | bc -l)
        debug "è®¡æ—¶å™¨ $timer_name: ${duration}s"
        
        # æ¸…ç†å˜é‡
        unset "TIMER_START_${timer_name}"
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
example_function() {
    trace_function "$@"
    
    local param1="$1"
    local param2="$2"
    
    check_variable "param1"
    check_variable "param2"
    
    start_timer "example"
    
    # æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ
    sleep 1
    
    end_timer "example"
    
    echo "å‡½æ•°æ‰§è¡Œå®Œæˆ"
}

# ä¸»ç¨‹åº
main() {
    debug "ç¨‹åºå¼€å§‹æ‰§è¡Œ"
    
    local var1="æµ‹è¯•å˜é‡"
    local var2=42
    
    check_variable "var1"
    check_variable "var2"
    
    example_function "å‚æ•°1" "å‚æ•°2"
    
    debug "ç¨‹åºæ‰§è¡Œå®Œæˆ"
}

# å¦‚æœå¯ç”¨è°ƒè¯•æ¨¡å¼
if [ "${1:-}" = "--debug" ]; then
    export DEBUG=1
    echo "è°ƒè¯•æ¨¡å¼å·²å¯ç”¨ï¼Œæ—¥å¿—æ–‡ä»¶ï¼š$DEBUG_FILE"
fi

main "$@"