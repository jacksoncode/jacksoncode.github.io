# 条件语句

## 1 条件测试基础

### 1.1 test命令

`test`命令用于检查条件，返回0表示真，非0表示假：

```bash
# 基本语法
test 条件表达式
# 或者使用方括号
[ 条件表达式 ]

# 示例
if test -f "/etc/passwd"; then
    echo "文件存在"
fi

# 等价写法
if [ -f "/etc/passwd" ]; then
    echo "文件存在"
fi
```

### 1.2 条件测试类型

| 测试类型 | 说明 | 示例 |
|----------|------|------|
| **文件测试** | 检查文件属性 | `[ -f file ]` |
| **字符串测试** | 比较字符串 | `[ "$a" = "$b" ]` |
| **数值测试** | 比较数字 | `[ $a -eq $b ]` |
| **逻辑测试** | 组合条件 | `[ $a -eq 1 -a $b -eq 2 ]` |

## 2 文件条件测试

### 2.1 文件存在性测试

```bash
#!/bin/bash
# 文件存在性测试示例

filename="$1"

# 检查文件是否存在
if [ -e "$filename" ]; then
    echo "文件或目录存在：$filename"
else
    echo "文件或目录不存在：$filename"
    exit 1
fi

# 检查文件类型
if [ -f "$filename" ]; then
    echo "这是一个普通文件"
elif [ -d "$filename" ]; then
    echo "这是一个目录"
elif [ -L "$filename" ]; then
    echo "这是一个符号链接"
elif [ -b "$filename" ]; then
    echo "这是一个块设备文件"
elif [ -c "$filename" ]; then
    echo "这是一个字符设备文件"
elif [ -p "$filename" ]; then
    echo "这是一个管道文件"
elif [ -S "$filename" ]; then
    echo "这是一个套接字文件"
fi
```

### 2.2 文件权限测试

```bash
#!/bin/bash
# 文件权限测试示例

file="$1"

if [ ! -e "$file" ]; then
    echo "文件不存在：$file"
    exit 1
fi

echo "文件权限信息："
echo "文件：$file"

# 检查各种权限
[ -r "$file" ] && echo "可读 ✓" || echo "可读 ✗"
[ -w "$file" ] && echo "可写 ✓" || echo "可写 ✗"
[ -x "$file" ] && echo "可执行 ✓" || echo "可执行 ✗"
[ -s "$file" ] && echo "非空 ✓" || echo "空文件 ✗"

# 检查文件所有权
[ -O "$file" ] && echo "属于当前用户 ✓" || echo "不属于当前用户 ✗"
[ -G "$file" ] && echo "属于当前用户组 ✓" || echo "不属于当前用户组 ✗"
```

### 2.3 文件比较

```bash
#!/bin/bash
# 文件比较示例

file1="$1"
file2="$2"

# 检查文件是否存在
if [ ! -e "$file1" ] || [ ! -e "$file2" ]; then
    echo "错误：文件不存在"
    exit 1
fi

echo "文件比较结果："

# 比较文件修改时间
if [ "$file1" -nt "$file2" ]; then
    echo "$file1 比 $file2 新"
elif [ "$file1" -ot "$file2" ]; then
    echo "$file1 比 $file2 旧"
else
    echo "$file1 和 $file2 修改时间相同"
fi

# 检查是否为同一个文件
if [ "$file1" -ef "$file2" ]; then
    echo "$file1 和 $file2 是同一个文件"
else
    echo "$file1 和 $file2 是不同的文件"
fi
```

## 3 字符串条件测试

### 3.1 字符串比较

```bash
#!/bin/bash
# 字符串比较示例

str1="$1"
str2="$2"

# 检查参数
if [ $# -lt 2 ]; then
    echo "用法：$0 <字符串1> <字符串2>"
    exit 1
fi

echo "字符串比较结果："
echo "字符串1：'$str1'"
echo "字符串2：'$str2'"

# 相等比较
if [ "$str1" = "$str2" ]; then
    echo "两个字符串相等"
elif [ "$str1" != "$str2" ]; then
    echo "两个字符串不相等"
fi

# 字典序比较
if [[ "$str1" < "$str2" ]]; then
    echo "'$str1' 在字典序上小于 '$str2'"
elif [[ "$str1" > "$str2" ]]; then
    echo "'$str1' 在字典序上大于 '$str2'"
else
    echo "两个字符串在字典序上相等"
fi

# 检查字符串属性
[ -z "$str1" ] && echo "字符串1为空" || echo "字符串1非空"
[ -n "$str1" ] && echo "字符串1非空" || echo "字符串1为空"
```

### 3.2 字符串模式匹配

```bash
#!/bin/bash
# 字符串模式匹配示例

string="Hello, World!"

# 检查字符串开头
if [[ "$string" == Hello* ]]; then
    echo "字符串以'Hello'开头"
fi

# 检查字符串结尾
if [[ "$string" == *World! ]]; then
    echo "字符串以'World!'结尾"
fi

# 检查子字符串
if [[ "$string" == *"lo, Wo"* ]]; then
    echo "字符串包含'lo, Wo'"
fi

# 使用正则表达式
email="user@example.com"
if [[ "$email" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
    echo "$email 是有效的邮箱格式"
fi
```

## 4 数值条件测试

### 4.1 整数比较

```bash
#!/bin/bash
# 整数比较示例

num1="$1"
num2="$2"

# 验证输入是否为数字
if ! [[ "$num1" =~ ^-?[0-9]+$ ]] || ! [[ "$num2" =~ ^-?[0-9]+$ ]]; then
    echo "错误：请输入有效的整数"
    exit 1
fi

echo "数值比较结果："
echo "数字1：$num1"
echo "数字2：$num2"

# 各种比较
if [ "$num1" -eq "$num2" ]; then
    echo "$num1 等于 $num2"
fi

if [ "$num1" -ne "$num2" ]; then
    echo "$num1 不等于 $num2"
fi

if [ "$num1" -lt "$num2" ]; then
    echo "$num1 小于 $num2"
fi

if [ "$num1" -le "$num2" ]; then
    echo "$num1 小于或等于 $num2"
fi

if [ "$num1" -gt "$num2" ]; then
    echo "$num1 大于 $num2"
fi

if [ "$num1" -ge "$num2" ]; then
    echo "$num1 大于或等于 $num2"
fi
```

### 4.2 浮点数比较

```bash
#!/bin/bash
# 浮点数比较示例

num1="$1"
num2="$2"

# 使用bc进行浮点数比较
if (( $(echo "$num1 == $num2" | bc -l) )); then
    echo "$num1 等于 $num2"
fi

if (( $(echo "$num1 < $num2" | bc -l) )); then
    echo "$num1 小于 $num2"
fi

if (( $(echo "$num1 > $num2" | bc -l) )); then
    echo "$num1 大于 $num2"
fi

# 检查数值范围
if (( $(echo "$num1 >= 0 && $num1 <= 100" | bc -l) )); then
    echo "$num1 在0到100之间"
fi
```

## 5 逻辑运算符

### 5.1 逻辑与（-a 或 &&）

```bash
#!/bin/bash
# 逻辑与示例

age=25
income=50000

# 使用 -a（在[ ]中）
if [ "$age" -ge 18 -a "$income" -ge 30000 ]; then
    echo "符合贷款条件"
fi

# 使用 &&（在[[ ]]中）
if [[ "$age" -ge 18 && "$income" -ge 30000 ]]; then
    echo "符合贷款条件"
fi

# 使用多个if语句
if [ "$age" -ge 18 ]; then
    if [ "$income" -ge 30000 ]; then
        echo "符合贷款条件"
    fi
fi
```

### 5.2 逻辑或（-o 或 ||）

```bash
#!/bin/bash
# 逻辑或示例

user_type="admin"
user_group="sudo"

# 使用 -o（在[ ]中）
if [ "$user_type" = "admin" -o "$user_group" = "sudo" ]; then
    echo "用户有管理员权限"
fi

# 使用 ||（在[[ ]]中）
if [[ "$user_type" = "admin" || "$user_group" = "sudo" ]]; then
    echo "用户有管理员权限"
fi
```

### 5.3 逻辑非（!）

```bash
#!/bin/bash
# 逻辑非示例

filename="$1"

# 检查文件不存在
if [ ! -e "$filename" ]; then
    echo "文件不存在：$filename"
    exit 1
fi

# 检查不是目录
if [ ! -d "$filename" ]; then
    echo "$filename 不是目录"
fi

# 检查字符串不匹配
if [[ ! "$filename" =~ \.txt$ ]]; then
    echo "$filename 不是.txt文件"
fi
```

## 6 复合条件语句

### 6.1 嵌套if语句

```bash
#!/bin/bash
# 嵌套if语句示例

filename="$1"

if [ -e "$filename" ]; then
    if [ -f "$filename" ]; then
        if [ -r "$filename" ]; then
            if [ -w "$filename" ]; then
                echo "$filename 是可读写的文件"
            else
                echo "$filename 是只读文件"
            fi
        else
            echo "$filename 不可读"
        fi
    elif [ -d "$filename" ]; then
        echo "$filename 是目录"
    else
        echo "$filename 是特殊文件"
    fi
else
    echo "$filename 不存在"
fi
```

### 6.2 复杂条件组合

```bash
#!/bin/bash
# 复杂条件组合示例

file="$1"
user="$USER"

# 检查多个条件
if [[ -f "$file" && -r "$file" && -s "$file" ]]; then
    echo "$file 是有效的非空可读文件"
    
    # 检查文件所有权
    if [[ -O "$file" ]]; then
        echo "文件属于当前用户"
    elif [[ -G "$file" ]]; then
        echo "文件属于当前用户组"
    else
        echo "文件属于其他用户或组"
    fi
    
    # 检查文件大小
    size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
    if [[ $size -gt 1048576 ]]; then
        echo "文件大于1MB"
    elif [[ $size -gt 1024 ]]; then
        echo "文件大于1KB"
    else
        echo "文件小于1KB"
    fi
fi
```

## 7 case语句详解

### 7.1 基本case语法

```bash
#!/bin/bash
# case语句示例

echo "系统服务管理"
echo "1. 启动服务"
echo "2. 停止服务"
echo "3. 重启服务"
echo "4. 查看状态"
echo "5. 退出"

read -p "请选择操作 [1-5]: " choice

case "$choice" in
    1)
        echo "正在启动服务..."
        systemctl start nginx
        ;;
    2)
        echo "正在停止服务..."
        systemctl stop nginx
        ;;
    3)
        echo "正在重启服务..."
        systemctl restart nginx
        ;;
    4)
        echo "服务状态："
        systemctl status nginx
        ;;
    5)
        echo "退出程序"
        exit 0
        ;;
    *)
        echo "无效选择，请输入1-5之间的数字"
        ;;
esac
```

### 7.2 模式匹配

```bash
#!/bin/bash
# 模式匹配示例

filename="$1"

# 检查文件扩展名
case "$filename" in
    *.tar.gz|*.tgz)
        echo "这是一个gzip压缩的tar包"
        tar -tzf "$filename"
        ;;
    *.tar.bz2|*.tbz2)
        echo "这是一个bzip2压缩的tar包"
        tar -tjf "$filename"
        ;;
    *.zip)
        echo "这是一个zip压缩包"
        unzip -l "$filename"
        ;;
    *.rar)
        echo "这是一个rar压缩包"
        unrar l "$filename"
        ;;
    *.7z)
        echo "这是一个7z压缩包"
        7z l "$filename"
        ;;
    *)
        echo "未知压缩格式"
        file "$filename"
        ;;
esac
```

### 7.3 范围匹配

```bash
#!/bin/bash
# 范围匹配示例

score="$1"

# 验证输入是否为数字
if ! [[ "$score" =~ ^[0-9]+$ ]]; then
    echo "错误：请输入数字"
    exit 1
fi

# 成绩评级
case "$score" in
    100)
        echo "满分！优秀！"
        ;;
    9[0-9])
        echo "优秀 ($score分)"
        ;;
    8[0-9])
        echo "良好 ($score分)"
        ;;
    7[0-9])
        echo "中等 ($score分)"
        ;;
    6[0-9])
        echo "及格 ($score分)"
        ;;
    [0-5][0-9]|[0-9])
        echo "不及格 ($score分)，需要努力！"
        ;;
    *)
        echo "无效分数，请输入0-100之间的数字"
        ;;
esac
```

## 8 条件表达式高级用法

### 8.1 使用[[ ]]的优势

```bash
#!/bin/bash
# [[ ]]的高级用法

string="Hello World"

# 支持模式匹配
if [[ "$string" == Hello* ]]; then
    echo "字符串匹配模式"
fi

# 支持正则表达式
if [[ "$string" =~ ^[Hh]ello ]]; then
    echo "正则表达式匹配"
fi

# 支持逻辑运算符
if [[ "$string" == Hello* && ${#string} -gt 5 ]]; then
    echo "复合条件匹配"
fi

# 不需要转义特殊字符
if [[ "$string" != *"!" ]]; then
    echo "字符串不包含感叹号"
fi
```

### 8.2 条件表达式优化

```bash
#!/bin/bash
# 条件表达式优化示例

# 使用默认值
config_file="${1:-/etc/app.conf}"

# 检查文件存在且可读
if [[ -r "$config_file" ]]; then
    echo "使用配置文件：$config_file"
    source "$config_file"
else
    echo "警告：配置文件不可读，使用默认设置"
fi

# 使用参数验证
port="${2:-8080}"
if [[ "$port" =~ ^[0-9]+$ ]] && [[ $port -ge 1 && $port -le 65535 ]]; then
    echo "使用端口：$port"
else
    echo "错误：无效的端口号"
    exit 1
fi
```

## 9 实战案例：系统监控脚本

```bash
#!/bin/bash
# 系统监控条件检查脚本

# 阈值设置
CPU_THRESHOLD=80
MEMORY_THRESHOLD=85
DISK_THRESHOLD=90
LOAD_THRESHOLD=2.0

# 获取系统信息
cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
memory_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
disk_usage=$(df / | tail -1 | awk '{print $5}' | cut -d'%' -f1)
load_average=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')

# 检查各项资源
alerts=()

# CPU检查
if (( $(echo "$cpu_usage > $CPU_THRESHOLD" | bc -l) )); then
    alerts+=("CPU使用率过高: ${cpu_usage}%")
fi

# 内存检查
if (( $(echo "$memory_usage > $MEMORY_THRESHOLD" | bc -l) )); then
    alerts+=("内存使用率过高: ${memory_usage}%")
fi

# 磁盘检查
if [ "$disk_usage" -gt "$DISK_THRESHOLD" ]; then
    alerts+=("磁盘使用率过高: ${disk_usage}%")
fi

# 负载检查
if (( $(echo "$load_average > $LOAD_THRESHOLD" | bc -l) )); then
    alerts+=("系统负载过高: $load_average")
fi

# 显示结果
if [ ${#alerts[@]} -eq 0 ]; then
    echo "✅ 系统运行正常"
else
    echo "⚠️ 系统警告："
    for alert in "${alerts[@]}"; do
        echo "  - $alert"
    done
fi
```