# 变量与参数

## 1 变量类型详解

### 1.1 用户自定义变量

#### 1.1.1 局部变量

局部变量只在当前Shell会话或脚本中有效：

```bash
#!/bin/bash
# 局部变量示例

local_var="I am local"
function test_local() {
    local local_var="I am inside function"
    echo "函数内：$local_var"
}

test_local
echo "函数外：$local_var"
```

#### 1.1.2 环境变量

环境变量可以被子进程继承：

```bash
#!/bin/bash
# 环境变量示例

# 设置环境变量
export MY_ENV_VAR="Hello from parent"

# 运行子脚本
./child_script.sh

# 在子脚本中可以访问MY_ENV_VAR
```

### 1.2 位置参数变量

#### 1.2.1 参数传递

```bash
#!/bin/bash
# 参数处理示例

# 检查参数数量
if [ $# -eq 0 ]; then
    echo "用法：$0 <参数1> [参数2] ... [参数N]"
    echo "参数说明："
    echo "  参数1: 必需参数"
    echo "  参数2-N: 可选参数"
    exit 1
fi

# 处理位置参数
echo "脚本名称：$0"
echo "第一个参数：$1"
echo "第二个参数：$2"
echo "参数总数：$#"
echo "所有参数：$*"
echo "所有参数（独立）：$@"

# 遍历所有参数
for arg in "$@"; do
    echo "参数：$arg"
done
```

#### 1.2.2 参数默认值

```bash
#!/bin/bash
# 参数默认值示例

# 设置默认值
DEFAULT_NAME="World"
DEFAULT_AGE=25

# 使用参数或默认值
name=${1:-$DEFAULT_NAME}
age=${2:-$DEFAULT_AGE}

echo "姓名：$name"
echo "年龄：$age"
```

### 1.3 特殊变量

#### 1.3.1 状态变量

```bash
#!/bin/bash
# 特殊变量示例

# 执行命令
ls /tmp > /dev/null

# 检查命令执行状态
if [ $? -eq 0 ]; then
    echo "命令执行成功"
else
    echo "命令执行失败"
fi

# 获取进程信息
echo "当前脚本PID：$$"

# 后台执行命令
sleep 10 &
echo "最后一个后台进程PID：$!"
```

#### 1.3.2 数组变量

```bash
#!/bin/bash
# 数组变量示例

# 定义数组
numbers=(1 2 3 4 5)
fruits=("apple" "banana" "orange")

# 访问数组元素
echo "第一个数字：${numbers[0]}"
echo "所有水果：${fruits[@]}"
echo "数组长度：${#fruits[@]}"

# 遍历数组
for fruit in "${fruits[@]}"; do
    echo "水果：$fruit"
done

# 关联数组
declare -A person
person[name]="Alice"
person[age]=30
person[city]="Beijing"

echo "姓名：${person[name]}"
echo "年龄：${person[age]}"
```

## 2 参数处理高级技巧

### 2.1 参数验证

```bash
#!/bin/bash
# 参数验证示例

validate_number() {
    local num="$1"
    if ! [[ "$num" =~ ^[0-9]+$ ]]; then
        echo "错误：$num 不是有效的数字"
        return 1
    fi
    return 0
}

validate_email() {
    local email="$1"
    if ! [[ "$email" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
        echo "错误：$email 不是有效的邮箱地址"
        return 1
    fi
    return 0
}

# 使用验证函数
if [ $# -lt 2 ]; then
    echo "用法：$0 <数字> <邮箱>"
    exit 1
fi

validate_number "$1" || exit 1
validate_email "$2" || exit 1

echo "参数验证通过"
```

### 2.2 长选项处理

```bash
#!/bin/bash
# 长选项处理示例

# 默认值
VERBOSE=false
OUTPUT_FILE=""
INPUT_FILE=""
DEBUG=false

# 解析参数
while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -o|--output)
            OUTPUT_FILE="$2"
            shift 2
            ;;
        -i|--input)
            INPUT_FILE="$2"
            shift 2
            ;;
        -d|--debug)
            DEBUG=true
            shift
            ;;
        -h|--help)
            echo "用法：$0 [选项]"
            echo "选项："
            echo "  -v, --verbose    详细输出"
            echo "  -o, --output     输出文件"
            echo "  -i, --input      输入文件"
            echo "  -d, --debug      调试模式"
            echo "  -h, --help       显示帮助"
            exit 0
            ;;
        *)
            echo "未知选项：$1"
            exit 1
            ;;
    esac
done

# 验证必需参数
if [ -z "$INPUT_FILE" ]; then
    echo "错误：必须指定输入文件"
    exit 1
fi

# 使用参数
echo "输入文件：$INPUT_FILE"
echo "输出文件：$OUTPUT_FILE"
echo "详细模式：$VERBOSE"
echo "调试模式：$DEBUG"
```

### 2.3 配置文件读取

```bash
#!/bin/bash
# 配置文件读取示例

# 配置文件路径
CONFIG_FILE="config.conf"

# 默认值
DB_HOST="localhost"
DB_PORT=3306
DB_USER="root"
DB_PASSWORD=""

# 读取配置文件
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
else
    echo "警告：配置文件不存在，使用默认值"
fi

# 命令行参数优先级高于配置文件
while [[ $# -gt 0 ]]; do
    case $1 in
        --db-host)
            DB_HOST="$2"
            shift 2
            ;;
        --db-port)
            DB_PORT="$2"
            shift 2
            ;;
        --db-user)
            DB_USER="$2"
            shift 2
            ;;
        --db-password)
            DB_PASSWORD="$2"
            shift 2
            ;;
        *)
            echo "未知选项：$1"
            exit 1
            ;;
    esac
done

echo "数据库配置："
echo "主机：$DB_HOST"
echo "端口：$DB_PORT"
echo "用户：$DB_USER"
```

## 3 变量作用域

### 3.1 全局变量与局部变量

```bash
#!/bin/bash
# 变量作用域示例

# 全局变量
global_var="I am global"

function test_scope() {
    # 局部变量
    local local_var="I am local"
    
    # 修改全局变量
    global_var="Modified in function"
    
    echo "函数内 - 局部变量：$local_var"
    echo "函数内 - 全局变量：$global_var"
}

echo "函数外 - 全局变量：$global_var"
test_scope
echo "函数外 - 全局变量：$global_var"
echo "函数外 - 局部变量：$local_var"  # 这将输出空值
```

### 3.2 环境变量传递

```bash
#!/bin/bash
# 环境变量传递示例

# 设置环境变量
export GLOBAL_CONFIG="/etc/myapp"

function set_config() {
    local config_file="$1"
    export APP_CONFIG="$config_file"
    echo "子进程将看到：GLOBAL_CONFIG=$GLOBAL_CONFIG"
    echo "子进程将看到：APP_CONFIG=$APP_CONFIG"
}

# 调用函数
set_config "/home/user/.myapp.conf"

# 运行子脚本
./child_process.sh
```

## 4 字符串处理

### 4.1 字符串操作

```bash
#!/bin/bash
# 字符串处理示例

string="Hello, World!"

# 获取字符串长度
length=${#string}
echo "字符串长度：$length"

# 字符串截取
substring=${string:7:5}  # 从第7个字符开始，取5个字符
echo "子字符串：$substring"

# 字符串替换
new_string=${string/World/Linux}
echo "替换后：$new_string"

# 字符串删除前缀
filename="/home/user/document.txt"
basename=${filename##*/}
echo "文件名：$basename"

# 字符串删除后缀
dirname=${filename%/*}
echo "目录名：$dirname"
```

### 4.2 字符串比较

```bash
#!/bin/bash
# 字符串比较示例

str1="hello"
str2="world"
str3="hello"

# 字符串相等比较
if [ "$str1" = "$str3" ]; then
    echo "str1 和 str3 相等"
fi

# 字符串不相等比较
if [ "$str1" != "$str2" ]; then
    echo "str1 和 str2 不相等"
fi

# 字符串长度比较
if [ -z "$str1" ]; then
    echo "str1 为空字符串"
fi

if [ -n "$str1" ]; then
    echo "str1 不为空"
fi

# 字典序比较
if [[ "$str1" < "$str2" ]]; then
    echo "str1 在 str2 之前"
fi
```

## 5 数值计算

### 5.1 整数运算

```bash
#!/bin/bash
# 整数运算示例

# 使用$(())进行整数运算
a=10
b=3

echo "加法：$((a + b))"
echo "减法：$((a - b))"
echo "乘法：$((a * b))"
echo "除法：$((a / b))"
echo "取模：$((a % b))"

# 自增自减
((a++))
echo "自增后：$a"

((b--))
echo "自减后：$b"

# 复合赋值
((a += 5))
echo "复合加法：$a"
```

### 5.2 浮点运算

```bash
#!/bin/bash
# 浮点运算示例

# 使用bc进行浮点运算
a=10.5
b=3.2

# 基本运算
result=$(echo "$a + $b" | bc)
echo "浮点加法：$result"

# 设置精度
result=$(echo "scale=2; $a / $b" | bc)
echo "浮点除法：$result"

# 复杂运算
result=$(echo "scale=4; sqrt($a*$a + $b*$b)" | bc -l)
echo "勾股定理：$result"
```

## 6 综合示例：参数解析器

```bash
#!/bin/bash
# 高级参数解析器

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 配置变量
CONFIG_FILE=""
VERBOSE=false
DEBUG=false
OUTPUT_DIR="./output"
PARALLEL=false
MAX_THREADS=4

# 帮助信息
show_help() {
    cat << EOF
用法：$0 [选项] <输入文件...>

选项：
    -c, --config FILE    指定配置文件
    -v, --verbose        启用详细输出
    -d, --debug          启用调试模式
    -o, --output DIR     指定输出目录（默认：./output）
    -p, --parallel       启用并行处理
    -t, --threads NUM    设置最大线程数（默认：4）
    -h, --help           显示此帮助信息

示例：
    $0 -v -o /tmp/output file1.txt file2.txt
    $0 --config my.conf --parallel --threads 8 *.log
EOF
}

# 参数验证
validate_inputs() {
    local files=("$@")
    
    if [ ${#files[@]} -eq 0 ]; then
        echo "错误：必须指定至少一个输入文件"
        return 1
    fi
    
    for file in "${files[@]}"; do
        if [ ! -f "$file" ]; then
            echo "错误：文件不存在：$file"
            return 1
        fi
    done
    
    return 0
}

# 解析参数
parse_args() {
    local files=()
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -c|--config)
                CONFIG_FILE="$2"
                shift 2
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -d|--debug)
                DEBUG=true
                shift
                ;;
            -o|--output)
                OUTPUT_DIR="$2"
                shift 2
                ;;
            -p|--parallel)
                PARALLEL=true
                shift
                ;;
            -t|--threads)
                MAX_THREADS="$2"
                shift 2
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -*)
                echo "未知选项：$1"
                show_help
                exit 1
                ;;
            *)
                files+=("$1")
                shift
                ;;
        esac
    done
    
    # 验证输入文件
    validate_inputs "${files[@]}" || exit 1
    
    # 返回文件列表
    echo "${files[@]}"
}

# 主函数
main() {
    echo "解析参数..."
    
    # 解析参数
    input_files=($(parse_args "$@"))
    
    # 显示配置
    echo -e "${GREEN}配置信息：${NC}"
    echo "输入文件：${input_files[@]}"
    echo "输出目录：$OUTPUT_DIR"
    echo "详细模式：$VERBOSE"
    echo "调试模式：$DEBUG"
    echo "并行处理：$PARALLEL"
    echo "最大线程：$MAX_THREADS"
    
    # 创建输出目录
    mkdir -p "$OUTPUT_DIR"
    
    # 处理文件...
    echo "处理完成！"
}

# 运行主函数
main "$@"