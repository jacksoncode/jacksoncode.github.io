# 06_19_ss命令详解

## 1. 命令概述

`ss`（Socket Statistics）是Linux系统中的一个强大的网络工具，用于显示网络套接字的详细统计信息。它是`netstat`命令的现代替代品，提供更快的执行速度和更丰富的功能，特别适合在高负载系统上使用。`ss`命令能够显示TCP、UDP、UNIX和RAW套接字的状态和统计信息。

**主要功能和用途：**
- 显示活动的TCP连接、监听端口和套接字信息
- 提供比netstat更详细的网络连接状态信息
- 支持多种过滤条件，方便查找特定类型的连接
- 显示TCP连接的各种状态指标，如重传、拥塞窗口等
- 提供比netstat更高的性能，尤其是在大量连接的系统上

**典型应用场景：**
- 快速查看系统的网络连接状态和统计信息
- 排查网络连接问题，如连接过多、连接状态异常等
- 监控系统的网络活动和性能
- 分析网络资源使用情况
- 替代netstat命令进行日常网络管理

## 2. 语法格式

`ss`命令的基本语法格式如下：

```bash
ss [选项] [过滤表达式]
```

其中，选项用于控制ss的行为和输出格式，过滤表达式用于筛选特定类型的套接字或连接。

## 3. 选项说明

### 3.1 基本选项

| 选项 | 说明 |
|------|------|
| -h, --help | 显示帮助信息 |
| -V, --version | 显示版本信息 |
| -t, --tcp | 显示TCP套接字 |
| -u, --udp | 显示UDP套接字 |
| -d, --dccp | 显示DCCP套接字 |
| -w, --raw | 显示RAW套接字 |
| -x, --unix | 显示UNIX域套接字 |
| -S, --sctp | 显示SCTP套接字 |
| -l, --listening | 显示监听状态的套接字 |
| -a, --all | 显示所有套接字（监听和非监听） |
| -n, --numeric | 不解析服务名称，显示数字地址和端口 |
| -r, --resolve | 解析主机名和服务名 |
| -p, --processes | 显示套接字所属的进程信息 |
| -e, --extended | 显示扩展信息，包括UID、定时器等 |
| -m, --memory | 显示套接字的内存使用情况 |
| -o, --options | 显示定时器信息 |

### 3.2 过滤选项

| 选项 | 说明 |
|------|------|
| -4, --ipv4 | 仅显示IPv4套接字 |
| -6, --ipv6 | 仅显示IPv6套接字 |
| -0, --packet | 显示PACKET套接字 |
| -f, --family=FAMILY | 指定套接字族（inet, inet6, link, unix） |
| -A, --query=QUERY | 指定查询类型（all, inet, tcp, udp, raw, unix, packet, netlink） |
| -D, --diag=FILE | 将原始TCP套接字信息转储到文件 |
| -F, --filter=FILE | 从文件中读取过滤条件 |

### 3.3 输出格式选项

| 选项 | 说明 |
|------|------|
| -N, --net | 切换到指定的网络命名空间 |
| -Z, --context | 显示套接字的SELinux安全上下文 |
| -b, --bpf | 显示套接字的BPF过滤器信息 |
| -H, --no-header | 不显示头部信息 |
| -O, --oneline | 每行显示一个套接字 |
| --info | 显示TCP内部信息 |
| --tipc | 显示TIPC套接字 |

## 4. 基本用法示例

### 4.1 显示所有TCP连接

```bash
# 显示所有TCP连接
ess -t -a

# 显示所有TCP连接，不解析服务名称
ess -t -a -n

# 显示所有TCP连接，并显示进程信息
ess -t -a -p

# 显示所有TCP连接，包括扩展信息
ess -t -a -e
```

**功能说明：**
显示系统上所有TCP套接字的状态和信息，包括监听和非监听状态的连接。

**参数说明：**
- -t: 显示TCP套接字
- -a: 显示所有套接字（监听和非监听）
- -n: 不解析服务名称，直接显示端口号
- -p: 显示套接字所属的进程信息
- -e: 显示扩展信息，如UID、定时器等

**常见问题与解决方案：**
- 如果没有看到预期的连接，可能需要使用root权限运行ss命令
- 对于大量连接的系统，输出可能会很长，可以使用过滤条件或管道和less命令：`ss -t -a -n | less`

### 4.2 显示监听状态的套接字

```bash
# 显示所有监听状态的套接字
ess -l

# 显示所有监听状态的TCP套接字
ess -t -l

# 显示所有监听状态的UDP套接字
ess -u -l

# 显示所有监听状态的套接字，包括进程信息
ess -l -p

# 显示所有监听状态的套接字，不解析服务名称
ess -l -n
```

**功能说明：**
显示系统上所有处于监听状态的套接字，这些套接字通常是等待接收连接请求的服务。

**参数说明：**
- -l: 显示监听状态的套接字
- -t: 显示TCP套接字
- -u: 显示UDP套接字
- -p: 显示进程信息
- -n: 不解析服务名称

**常见问题与解决方案：**
- 某些服务可能绑定到特定的IP地址，使用`-n`选项可以更清晰地查看绑定地址
- 如果看不到某些进程信息，可能是因为没有足够的权限，可以使用sudo命令

### 4.3 显示UDP套接字

```bash
# 显示所有UDP套接字
ess -u -a

# 显示所有UDP套接字，不解析服务名称
ess -u -a -n

# 显示所有UDP套接字，包括进程信息
ess -u -a -p

# 显示所有监听状态的UDP套接字
ess -u -l
```

**功能说明：**
显示系统上的UDP套接字信息，包括已建立的连接和监听状态的端口。

**参数说明：**
- -u: 显示UDP套接字
- -a: 显示所有套接字
- -n: 不解析服务名称
- -p: 显示进程信息
- -l: 仅显示监听状态的套接字

**常见问题与解决方案：**
- UDP是无连接协议，所以"已建立"状态与TCP的含义不同
- 某些UDP服务可能不会显示为LISTEN状态，而是显示为ESTAB状态

### 4.4 显示UNIX域套接字

```bash
# 显示所有UNIX域套接字
ess -x -a

# 显示所有UNIX域套接字，包括进程信息
ess -x -a -p

# 显示所有监听状态的UNIX域套接字
ess -x -l

# 显示UNIX域套接字的内存使用情况
ess -x -a -m
```

**功能说明：**
显示系统上的UNIX域套接字信息，这些套接字用于本地进程间通信。

**参数说明：**
- -x: 显示UNIX域套接字
- -a: 显示所有套接字
- -p: 显示进程信息
- -l: 仅显示监听状态的套接字
- -m: 显示内存使用情况

**常见问题与解决方案：**
- UNIX域套接字通常用于本地服务之间的通信，如数据库、Web服务器等
- 套接字文件的权限问题可能会影响进程间通信，可以使用`ls -l`检查套接字文件的权限

### 4.5 按状态过滤TCP连接

```bash
# 显示处于ESTABLISHED状态的TCP连接
ess -t state established

# 显示处于TIME-WAIT状态的TCP连接
ess -t state time-wait

# 显示处于LISTEN状态的TCP套接字
ess -t state listening

# 显示处于SYN-SENT状态的TCP连接
ess -t state syn-sent

# 显示多种状态的TCP连接
ess -t state established,time-wait,syn-recv
```

**功能说明：**
根据TCP连接的状态进行过滤，只显示特定状态的连接。

**参数说明：**
- state: 指定要过滤的连接状态
- 常见的TCP状态包括：established、syn-sent、syn-recv、fin-wait-1、fin-wait-2、time-wait、closed、close-wait、last-ack、listen、closing

**常见问题与解决方案：**
- 大量的TIME-WAIT状态连接可能表示系统刚刚处理了大量短连接
- SYN-RECV状态连接过多可能表示系统正在遭受SYN洪水攻击
- 可以使用`ss -s`命令查看各种状态连接的统计信息

### 4.6 显示套接字的内存使用情况

```bash
# 显示TCP套接字的内存使用情况
ess -t -a -m

# 显示UDP套接字的内存使用情况
ess -u -a -m

# 显示所有套接字的内存使用情况
ess -a -m

# 显示内存使用较多的连接
ess -a -m | sort -k 7 -n -r | head -10
```

**功能说明：**
显示套接字的内存使用情况，包括接收缓冲区和发送缓冲区的使用量。

**参数说明：**
- -m: 显示内存使用情况
- 输出中的mem列显示了套接字使用的内存量

**常见问题与解决方案：**
- 内存使用过高的套接字可能表示存在内存泄漏或异常的网络流量
- 可以通过调整系统内核参数来优化套接字的内存使用

### 4.7 显示定时器信息

```bash
# 显示TCP套接字的定时器信息
ess -t -a -o

# 显示处于TIME-WAIT状态的TCP连接及其定时器
ess -t state time-wait -o

# 显示所有套接字的定时器信息
ess -a -o
```

**功能说明：**
显示套接字的定时器信息，包括各种超时设置和剩余时间。

**参数说明：**
- -o: 显示定时器信息
- 对于TCP连接，通常显示的定时器包括：keepalive、timewait、retrans等

**常见问题与解决方案：**
- 定时器信息对于分析连接超时和重传问题非常有用
- 可以通过调整系统内核参数来修改默认的定时器设置

### 4.8 显示套接字统计信息

```bash
# 显示总体套接字统计信息
ess -s

# 显示TCP套接字统计信息
ess -t -s

# 显示UDP套接字统计信息
ess -u -s

# 显示UNIX域套接字统计信息
ess -x -s
```

**功能说明：**
显示系统上各种类型套接字的统计信息，包括各种状态的连接数量。

**参数说明：**
- -s: 显示统计信息

**常见问题与解决方案：**
- 统计信息可以帮助快速了解系统的网络连接状况
- 可以定期收集统计信息，监控网络连接的变化趋势

### 4.9 按地址和端口过滤

```bash
# 显示与特定IP地址相关的连接
ess dst 192.168.1.100

# 显示与特定端口相关的连接
ess dport = :80

# 显示源地址为特定IP的连接
ess src 192.168.1.100

# 显示源端口为特定端口的连接
ess sport = :22

# 组合过滤条件
ess -t state established '( dport = :80 or dport = :443 )' and dst 203.0.113.1
```

**功能说明：**
根据源地址、目标地址、源端口或目标端口过滤套接字信息。

**参数说明：**
- dst: 目标地址
- src: 源地址
- dport: 目标端口
- sport: 源端口
- 过滤表达式支持各种比较操作符和逻辑操作符

**常见问题与解决方案：**
- 端口号前的冒号(:)表示这是一个服务端口
- 过滤表达式需要用引号括起来，尤其是包含空格或特殊字符时
- 可以使用`==`、`!=`、`<`、`>`等比较操作符

### 4.10 显示IPv4和IPv6套接字

```bash
# 仅显示IPv4套接字
ess -4 -a

# 仅显示IPv4 TCP套接字
ess -4 -t -a

# 仅显示IPv6套接字
ess -6 -a

# 仅显示IPv6 TCP套接字
ess -6 -t -a

# 比较IPv4和IPv6的连接数量
ess -4 -s && ss -6 -s
```

**功能说明：**
分别显示IPv4和IPv6协议的套接字信息，适用于双栈网络环境。

**参数说明：**
- -4: 仅显示IPv4套接字
- -6: 仅显示IPv6套接字

**常见问题与解决方案：**
- 在双栈网络环境中，分别查看IPv4和IPv6的连接情况可以帮助诊断协议特定的问题
- 确保系统正确配置了IPv6地址：`ip -6 addr show`

## 5. 高级用法与技巧

### 5.1 复杂过滤表达式

```bash
# 显示所有HTTP和HTTPS连接
ess -t state established '( dport = :80 or dport = :443 )'

# 显示特定IP地址的SSH连接
ess -t state established 'dst 192.168.1.100 and dport = :22'

# 显示特定网段的所有连接
ess -t state established 'dst 192.168.0.0/16'

# 显示除了特定IP地址之外的所有连接
ess -t state established 'not dst 192.168.1.100'

# 显示特定状态且特定端口范围的连接
ess -t state '(established or time-wait)' 'dport >= :10000 and dport <= :20000'
```

**功能说明：**
使用复杂的过滤表达式组合多个条件，精确定位特定类型的连接。

**参数说明：**
- 过滤表达式支持各种逻辑操作符：`and`、`or`、`not`
- 支持比较操作符：`=`、`!=`、`<`、`<=`、`>`、`>=`
- 可以使用括号改变操作符的优先级

**常见问题与解决方案：**
- 复杂的过滤表达式需要用引号括起来
- 对于非常复杂的过滤，可以将表达式保存到文件中，使用`-F`选项加载：`ss -F filter.txt`
- 可以使用`man ip`查看更多关于过滤表达式的语法

### 5.2 结合其他命令进行分析

```bash
# 统计每个IP地址的连接数
ess -t -n state established | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -n -r

# 查找连接数最多的进程
ess -t -p state established | awk '{print $NF}' | sort | uniq -c | sort -n -r | head -10

# 监控连接状态变化
ess -t -s > /tmp/ss_before.txt
sleep 60
ess -t -s > /tmp/ss_after.txt
diff /tmp/ss_before.txt /tmp/ss_after.txt

# 查找异常的TIME-WAIT连接
ess -t state time-wait -o | grep -v 'timer:(timewait:.'"[0-9]\{1,3\}"''

# 分析端口使用情况
ess -l -n | awk '{print $4}' | cut -d: -f2 | sort | uniq -c | sort -n -r | head -20
```

**功能说明：**
将ss命令与其他命令行工具（如awk、sort、uniq、grep等）结合使用，实现更复杂的网络连接分析功能。

**使用场景：**
- 识别连接数最多的IP地址或进程
- 统计特定端口的使用频率
- 监控网络连接状态的变化
- 查找异常的网络连接

**常见问题与解决方案：**
- 对于大量连接的系统，某些命令可能需要较长时间执行
- 可以将常用的分析命令组合保存为shell脚本，方便重复使用
- 注意输出格式的变化，可能需要调整分析命令

### 5.3 网络性能分析

```bash
# 显示TCP连接的重传情况
ess -t -o state established | grep retrans

# 计算重传率
ess -t -o state established | grep -c retrans
RETRAN_COUNT=$(ss -t -o state established | grep -c retrans)
TOTAL_COUNT=$(ss -t state established | wc -l)
RETRAN_RATE=$(echo "scale=4; $RETRAN_COUNT / $TOTAL_COUNT" | bc)
echo "TCP重传率: $RETRAN_RATE"

# 显示TCP连接的内存使用分布
ess -t -a -m | awk '{print $7}' | sort -n | uniq -c

# 查找内存使用最多的连接
ess -t -a -m | sort -k 7 -n -r | head -10

# 分析连接的RTT（往返时间）
ess -t -i state established
```

**功能说明：**
使用ss命令分析网络连接的性能指标，如重传率、内存使用和往返时间等。

**使用场景：**
- 识别网络连接中的性能瓶颈
- 监控网络连接的稳定性
- 优化网络应用的性能

**常见问题与解决方案：**
- 高重传率可能表示网络存在丢包问题
- 内存使用异常的连接可能存在内存泄漏
- RTT（往返时间）过长可能表示网络延迟较高

### 5.4 网络安全分析

```bash
# 查找来自同一IP的大量连接（可能是DoS攻击）
ess -t -n state established | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -n -r | head -5

# 检查是否有异常的监听端口
ess -l -n | grep -v -E ':(22|80|443|53|25) '

# 查找非标准端口上的SSH连接
ess -t -n state established 'dport != :22' | grep 'ssh'

# 监控特定端口的连接尝试
ess -t state syn-recv 'dport = :80' | wc -l

# 检查是否有连接到可疑IP地址的连接
ess -t -n state established | grep '103.235.46.'  # 假设这是一个可疑网段
```

**功能说明：**
使用ss命令进行网络安全分析，识别潜在的安全威胁和异常连接。

**使用场景：**
- 检测可能的DoS（拒绝服务）攻击
- 识别未授权的监听端口
- 发现异常的网络连接模式
- 监控特定端口的连接尝试

**常见问题与解决方案：**
- 大量来自同一IP的连接可能是正常的负载均衡或爬虫行为，需要结合其他信息判断
- 非标准端口上的服务可能是有意配置的，也可能是被攻击者植入的后门
- 对于可疑连接，建议进一步检查相关进程和日志

### 5.5 系统资源监控与优化

```bash
# 创建简单的网络连接监控脚本
#!/bin/bash
# 网络连接监控脚本
LOG_FILE="/var/log/ss_monitor.log"
INTERVAL=60  # 秒

while true; do
    TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
    echo "[$TIMESTAMP] 开始网络连接监控" >> $LOG_FILE
    
    # 记录总体统计信息
    ss -s >> $LOG_FILE
    
    # 记录连接数最多的前10个IP
    echo "\n连接数最多的前10个IP地址:" >> $LOG_FILE
    ss -t -n state established | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -n -r | head -10 >> $LOG_FILE
    
    # 记录监听的TCP端口
    echo "\n监听的TCP端口:" >> $LOG_FILE
    ss -t -l -n | awk '{print $4}' | cut -d: -f2 | sort -n >> $LOG_FILE
    
    echo "\n----------------------------------------" >> $LOG_FILE
    sleep $INTERVAL
done

# TCP连接优化建议生成器
#!/bin/bash
# TCP连接优化建议工具

# 获取当前TCP连接状态统计
TCP_STATS=$(ss -t -s)

# 分析统计信息并生成建议
 echo "TCP连接优化建议："
echo "=============================="

# 检查TIME-WAIT连接数
TIME_WAIT_COUNT=$(echo "$TCP_STATS" | grep -o 'timewait [0-9]*' | awk '{print $2}')
if [ $TIME_WAIT_COUNT -gt 10000 ]; then
    echo "- TIME-WAIT连接数过多 ($TIME_WAIT_COUNT)，建议调整tcp_max_tw_buckets和tcp_tw_recycle参数"
    echo "  临时修改: sysctl -w net.ipv4.tcp_max_tw_buckets=5000 net.ipv4.tcp_tw_recycle=1"
    echo "  永久修改: 在/etc/sysctl.conf中添加相应配置"
fi

# 检查ESTABLISHED连接数
ESTAB_COUNT=$(echo "$TCP_STATS" | grep -o 'estab [0-9]*' | awk '{print $2}')
if [ $ESTAB_COUNT -gt 20000 ]; then
    echo "- ESTABLISHED连接数较多 ($ESTAB_COUNT)，建议调整tcp_max_syn_backlog和somaxconn参数"
    echo "  临时修改: sysctl -w net.ipv4.tcp_max_syn_backlog=4096 net.core.somaxconn=4096"
    echo "  永久修改: 在/etc/sysctl.conf中添加相应配置"
fi

# 检查SYN-RECV连接数
SYN_RECV_COUNT=$(echo "$TCP_STATS" | grep -o 'syn-recv [0-9]*' | awk '{print $2}')
if [ $SYN_RECV_COUNT -gt 1000 ]; then
    echo "- SYN-RECV连接数较多 ($SYN_RECV_COUNT)，可能存在SYN洪水攻击，建议调整tcp_syncookies和tcp_synack_retries参数"
    echo "  临时修改: sysctl -w net.ipv4.tcp_syncookies=1 net.ipv4.tcp_synack_retries=2"
    echo "  永久修改: 在/etc/sysctl.conf中添加相应配置"
fi

echo "=============================="
echo "注意：以上建议仅供参考，请根据实际情况谨慎调整系统参数。"
```

**功能说明：**
创建自定义脚本使用ss命令进行系统网络资源监控和优化，帮助维持系统的网络性能和稳定性。

**使用场景：**
- 长期监控系统的网络连接状态
- 自动检测网络连接异常
- 根据连接状态提供系统优化建议
- 生成网络连接统计报告

**常见问题与解决方案：**
- 监控脚本应使用适当的权限运行，确保能够收集所有必要的信息
- 长期运行的脚本应考虑日志轮换，避免日志文件过大
- 系统参数调整应谨慎进行，建议先在测试环境验证

## 6. 实用技巧与应用场景

### 6.1 网络连接故障排查

**网络连接诊断工具：**

```bash
#!/bin/bash
# 网络连接故障快速诊断工具
# 用法: ./network_connection_diagnostics.sh [选项]

# 显示帮助信息
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "用法: $0 [选项]"
    echo "选项:"
    echo "  --all          运行所有诊断测试"
    echo "  --listening    检查监听端口"
    echo "  --established  检查已建立的连接"
    echo "  --timewait     检查TIME-WAIT连接"
    echo "  --memory       检查内存使用情况"
    echo "  --process      显示进程的网络连接"
    echo "  --port <端口>  检查特定端口的连接"
    exit 0
fi

# 函数：显示分隔线
print_separator() {
    echo "=================================================="
}

# 函数：检查监听端口
check_listening_ports() {
    echo "\n检查监听端口:"
    print_separator()
    ss -t -u -l -n -p | column -t
    print_separator()
    echo "监听的TCP端口数量: $(ss -t -l -n | wc -l)"
    echo "监听的UDP端口数量: $(ss -u -l -n | wc -l)"
}

# 函数：检查已建立的连接
check_established_connections() {
    echo "\n检查已建立的TCP连接:"
    print_separator()
    ss -t -n state established | head -20  # 只显示前20个
    print_separator()
    echo "已建立的TCP连接总数: $(ss -t -n state established | wc -l)"
    
    # 显示连接数最多的前10个IP
    echo "\n连接数最多的前10个IP地址:"
    ss -t -n state established | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -n -r | head -10
}

# 函数：检查TIME-WAIT连接
check_timewait_connections() {
    echo "\n检查TIME-WAIT连接:"
    print_separator()
    ss -t -n state time-wait | head -20  # 只显示前20个
    print_separator()
    echo "TIME-WAIT连接总数: $(ss -t -n state time-wait | wc -l)"
    
    # 计算TIME-WAIT连接占总TCP连接的比例
    TOTAL_TCP=$(ss -t -n state all | wc -l)
    TIME_WAIT_COUNT=$(ss -t -n state time-wait | wc -l)
    if [ $TOTAL_TCP -gt 0 ]; then
        PERCENTAGE=$(echo "scale=2; $TIME_WAIT_COUNT * 100 / $TOTAL_TCP" | bc)
        echo "TIME-WAIT连接占比: $PERCENTAGE%"
    fi
}

# 函数：检查内存使用情况
check_memory_usage() {
    echo "\n检查网络连接的内存使用情况:"
    print_separator()
    ss -t -a -m | head -20  # 只显示前20个
    print_separator()
    
    # 显示内存使用最多的前10个连接
    echo "内存使用最多的前10个连接:"
    ss -t -a -m | sort -k 7 -n -r | head -10
}

# 函数：显示进程的网络连接
check_process_connections() {
    echo "\n检查进程的网络连接:"
    print_separator()
    
    # 提示用户输入进程名或PID
    read -p "请输入进程名或PID: " PROCESS
    
    if [[ $PROCESS =~ ^[0-9]+$ ]]; then
        # 如果输入的是PID
        ss -t -u -a -n -p | grep "pid=$PROCESS"
    else
        # 如果输入的是进程名
        ss -t -u -a -n -p | grep "$PROCESS"
    fi
}

# 函数：检查特定端口的连接
check_specific_port() {
    local PORT=$1
    echo "\n检查端口 $PORT 的连接:"
    print_separator()
    ss -t -u -a -n "dport = :$PORT or sport = :$PORT"
    print_separator()
    echo "TCP端口 $PORT 的连接数: $(ss -t -n "dport = :$PORT or sport = :$PORT" | wc -l)"
    echo "UDP端口 $PORT 的连接数: $(ss -u -n "dport = :$PORT or sport = :$PORT" | wc -l)"
}

# 函数：显示总体统计信息
show_summary() {
    echo "\n网络连接总体统计信息:"
    print_separator()
    ss -s
    print_separator()
}

# 主程序
case "$1" in
    --all)
        show_summary
        check_listening_ports
        check_established_connections
        check_timewait_connections
        check_memory_usage
        ;;
    --listening)
        check_listening_ports
        ;;
    --established)
        check_established_connections
        ;;
    --timewait)
        check_timewait_connections
        ;;
    --memory)
        check_memory_usage
        ;;
    --process)
        check_process_connections
        ;;
    --port)
        if [ -z "$2" ]; then
            echo "错误: 请指定端口号"
            exit 1
        fi
        check_specific_port $2
        ;;
    *)
        show_summary
        echo "\n可用选项: --all, --listening, --established, --timewait, --memory, --process, --port"
        echo "使用 --help 查看详细帮助"
        ;;
esac

# 使用示例:
# ./network_connection_diagnostics.sh --all          # 运行所有诊断测试
# ./network_connection_diagnostics.sh --listening    # 检查监听端口
# ./network_connection_diagnostics.sh --port 80      # 检查端口80的连接
```

**功能说明：**
这个工具使用ss命令快速诊断网络连接问题，包括检查监听端口、已建立的连接、TIME-WAIT连接、内存使用情况等。

**使用场景：**
- 快速排查网络连接问题
- 定期检查系统网络状态
- 监控网络连接变化
- 识别异常的网络连接模式

### 6.2 Web服务器连接监控

**Web服务器连接监控脚本：**

```bash
#!/bin/bash
# Web服务器连接监控脚本
# 监控Web服务器（如Apache、Nginx）的连接状态和性能

# 配置参数
LOG_FILE="/var/log/web_server_connections.log"
INTERVAL=60  # 秒
ALERT_THRESHOLD=1000  # 连接数告警阈值
ALERT_EMAIL="admin@example.com"

# 创建日志文件（如果不存在）
touch $LOG_FILE
chmod 600 $LOG_FILE

# 函数：记录日志
log() {
    echo "[$(date +%Y-%m-%d\ %H:%M:%S)] $1" >> $LOG_FILE
}

# 函数：发送告警邮件
send_alert() {
    local subject="$1"
    local message="$2"
    
    # 实际环境中取消下面一行的注释以启用邮件报警
    # echo "$message" | mail -s "$subject" $ALERT_EMAIL
    
    log "告警: $subject"
    log "$message"
    log "-----------------------------"
}

# 函数：收集Web服务器连接信息
collect_web_connections() {
    # 收集80和443端口的连接信息
    echo "\n===== Web服务器连接状态 =====