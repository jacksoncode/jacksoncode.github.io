# 现代服务管理

## 1 Systemd基础

### 1.1 Systemd简介

Systemd 是Linux系统的初始化系统和服务管理器，取代了传统的SysV init系统。它提供了并行启动、按需启动、服务监控等现代功能。

### 1.2 基本命令

#### 服务管理
```bash
# 启动服务
sudo systemctl start service_name

# 停止服务
sudo systemctl stop service_name

# 重启服务
sudo systemctl restart service_name

# 重新加载配置
sudo systemctl reload service_name

# 查看服务状态
sudo systemctl status service_name

# 启用开机启动
sudo systemctl enable service_name

# 禁用开机启动
sudo systemctl disable service_name

# 查看服务是否启用
sudo systemctl is-enabled service_name

# 查看服务是否运行
sudo systemctl is-active service_name
```

#### 系统管理
```bash
# 关机
sudo systemctl poweroff

# 重启
sudo systemctl reboot

# 挂起
sudo systemctl suspend

# 休眠
sudo systemctl hibernate

# 混合休眠
sudo systemctl hybrid-sleep
```

### 1.3 服务单元文件

#### 基本结构
```ini
[Unit]
Description=My Service
After=network.target
Wants=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/myservice
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=always
RestartSec=5s
User=myuser
Group=mygroup
WorkingDirectory=/opt/myservice
Environment=ENV_VAR=value

[Install]
WantedBy=multi-user.target
```

#### 服务类型
- **simple**：默认类型，ExecStart进程就是主进程
- **forking**：服务启动后会fork子进程，父进程退出
- **oneshot**：一次性服务，执行完就退出
- **dbus**：服务在D-Bus上获取名称
- **notify**：服务启动后发送通知
- **idle**：延迟启动，等系统空闲时启动

## 2 Systemd高级功能

### 2.1 定时器（Timers）

Systemd定时器可以替代传统的cron。

#### 创建定时器
```bash
# 创建服务单元文件
sudo vim /etc/systemd/system/mybackup.service
```

```ini
[Unit]
Description=My Backup Service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/backup.sh
User=backup
```

```bash
# 创建定时器单元文件
sudo vim /etc/systemd/system/mybackup.timer
```

```ini
[Unit]
Description=Run backup daily
Requires=mybackup.service

[Timer]
OnCalendar=daily
OnCalendar=Mon *-*-* 02:00
Persistent=true

[Install]
WantedBy=timers.target
```

#### 管理定时器
```bash
# 启用定时器
sudo systemctl enable mybackup.timer

# 启动定时器
sudo systemctl start mybackup.timer

# 查看定时器状态
sudo systemctl status mybackup.timer

# 查看所有定时器
sudo systemctl list-timers

# 查看定时器日志
sudo journalctl -u mybackup.timer
```

### 2.2 挂载管理

Systemd可以自动管理挂载点。

#### 创建挂载单元
```bash
# 创建挂载单元文件
sudo vim /etc/systemd/system/mnt-data.mount
```

```ini
[Unit]
Description=Mount Data Directory
After=network.target

[Mount]
What=/dev/sdb1
Where=/mnt/data
Type=ext4
Options=defaults,noatime,nodiratime

[Install]
WantedBy=multi-user.target
```

#### 自动挂载
```bash
# 创建自动挂载单元
sudo vim /etc/systemd/system/mnt-data.automount
```

```ini
[Unit]
Description=Automount Data Directory

[Automount]
Where=/mnt/data
TimeoutIdleSec=30

[Install]
WantedBy=multi-user.target
```

### 2.3 目标（Targets）

目标是Systemd中的运行级别概念。

#### 常用目标
```bash
# 查看当前目标
systemctl get-default

# 设置默认目标
sudo systemctl set-default multi-user.target
sudo systemctl set-default graphical.target

# 切换到救援模式
sudo systemctl rescue

# 切换到紧急模式
sudo systemctl emergency
```

#### 自定义目标
```bash
# 创建自定义目标
sudo mkdir /etc/systemd/system/myapp.target.wants
sudo vim /etc/systemd/system/myapp.target
```

```ini
[Unit]
Description=My Application Target
Requires=multi-user.target
After=multi-user.target

[Install]
WantedBy=multi-user.target
```

## 3 日志管理

### 3.1 Journalctl使用

Systemd使用journalctl管理日志。

#### 基本用法
```bash
# 查看所有日志
sudo journalctl

# 查看最近的日志
sudo journalctl -f  # 实时跟踪
sudo journalctl -n 50  # 最近50行

# 查看特定服务的日志
sudo journalctl -u service_name

# 查看特定时间段的日志
sudo journalctl --since "2023-01-01 00:00:00"
sudo journalctl --since "1 hour ago"
sudo journalctl --until "2023-01-01 12:00:00"

# 查看特定优先级的日志
sudo journalctl -p err
sudo journalctl -p warning..err
```

#### 高级过滤
```bash
# 按进程ID过滤
sudo journalctl _PID=1234

# 按用户ID过滤
sudo journalctl _UID=1000

# 按单元过滤
sudo journalctl -u nginx.service -u php-fpm.service

# 按可执行文件过滤
sudo journalctl /usr/bin/python3

# 按消息内容过滤
sudo journalctl -g "error"

# JSON输出
sudo journalctl -o json
sudo journalctl -o json-pretty
```

### 3.2 日志持久化

#### 启用持久化日志
```bash
# 创建日志目录
sudo mkdir -p /var/log/journal

# 设置权限
sudo systemd-tmpfiles --create --prefix /var/log/journal

# 重启systemd-journald
sudo systemctl restart systemd-journald

# 验证日志持久化
sudo journalctl --verify
```

#### 日志轮转
```bash
# 查看日志大小
sudo journalctl --disk-usage

# 清理旧日志
sudo journalctl --vacuum-time=1month
sudo journalctl --vacuum-size=1G
sudo journalctl --vacuum-files=10
```

## 4 网络管理

### 4.1 NetworkManager与Systemd

Systemd-networkd是Systemd的网络管理组件。

#### 基本配置
```bash
# 创建网络配置文件
sudo vim /etc/systemd/network/20-wired.network
```

```ini
[Match]
Name=eth0

[Network]
DHCP=yes
# 或者静态配置
# Address=192.168.1.100/24
# Gateway=192.168.1.1
# DNS=8.8.8.8
# DNS=8.8.4.4
```

#### 管理网络
```bash
# 启用systemd-networkd
sudo systemctl enable systemd-networkd
sudo systemctl start systemd-networkd

# 查看网络状态
networkctl status
networkctl status eth0

# 重启网络服务
sudo systemctl restart systemd-networkd
```

### 4.2 网络命名空间

```bash
# 创建网络命名空间
sudo ip netns add mynet

# 在命名空间中运行服务
sudo ip netns exec mynet systemctl start myservice

# 创建服务在特定命名空间运行
sudo vim /etc/systemd/system/myservice.service
```

```ini
[Unit]
Description=My Service in Network Namespace

[Service]
Type=simple
ExecStart=/usr/local/bin/myservice
ExecStartPre=/usr/bin/ip netns add mynet
ExecStopPost=/usr/bin/ip netns del mynet
NetworkNamespacePath=/var/run/netns/mynet
```

## 5 资源管理

### 5.1 资源限制

Systemd可以限制服务的资源使用。

#### CPU限制
```ini
[Service]
# CPU配额（百分比）
CPUQuota=50%

# CPU亲和性
CPUAffinity=0,1

# 内存限制
MemoryLimit=1G

# 任务数限制
TasksMax=100

# 文件描述符限制
LimitNOFILE=65536

# 进程数限制
LimitNPROC=4096
```

#### I/O限制
```ini
[Service]
# I/O调度优先级
IOSchedulingClass=2
IOSchedulingPriority=7

# 块设备I/O限制
BlockIOWeight=500
BlockIODeviceWeight=/dev/sda 1000
BlockIOReadBandwidth=/dev/sda 10M
BlockIOWriteBandwidth=/dev/sda 10M
```

### 5.2 控制组（cgroups）

Systemd使用cgroups进行资源管理。

```bash
# 查看控制组层次
systemd-cgls

# 查看服务的控制组
systemctl show myservice --property=ControlGroup

# 查看资源使用情况
systemd-cgtop

# 设置控制组参数
echo 500 > /sys/fs/cgroup/system.slice/myservice.service/cpu.shares
```

## 6 安全功能

### 6.1 沙箱化

Systemd提供了多种沙箱化选项。

#### 文件系统限制
```ini
[Service]
# 私有临时目录
PrivateTmp=yes

# 私有设备
PrivateDevices=yes

# 保护系统目录
ProtectSystem=strict
ProtectHome=yes

# 只读目录
ReadWritePaths=/var/lib/myservice
ReadOnlyPaths=/usr/share/myservice

# 禁止访问某些目录
InaccessiblePaths=/home /root
```

#### 能力限制
```ini
[Service]
# 移除所有能力
CapabilityBoundingSet=

# 只保留特定能力
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_SETUID CAP_SETGID

# 设置能力环境变量
AmbientCapabilities=CAP_NET_BIND_SERVICE
```

#### 用户和组隔离
```ini
[Service]
# 运行动态用户
DynamicUser=yes

# 设置用户和组
User=myservice
Group=myservice

# 补充组
SupplementaryGroups=myservice
```

### 6.2 命名空间隔离

```ini
[Service]
# 私有网络
PrivateNetwork=yes

# 私有IPC
PrivateIPC=yes

# 新的PID命名空间
PIDFile=/run/myservice.pid

# 限制系统调用
SystemCallFilter=@system-service
SystemCallErrorNumber=EPERM

# 限制系统调用架构
SystemCallArchitectures=native
```

## 7 调试和故障排除

### 7.1 服务调试

```bash
# 查看服务详细信息
sudo systemctl show myservice

# 查看服务依赖关系
sudo systemctl list-dependencies myservice

# 检查服务配置
sudo systemd-analyze verify /etc/systemd/system/myservice.service

# 分析启动时间
sudo systemd-analyze blame
sudo systemd-analyze critical-chain
```

### 7.2 日志调试

```bash
# 查看服务日志
sudo journalctl -u myservice -f

# 查看特定时间段的日志
sudo journalctl -u myservice --since "10 minutes ago"

# 查看服务的所有日志
sudo journalctl -u myservice -b

# 查看内核消息
sudo journalctl -k

# 查看特定优先级的日志
sudo journalctl -p err -u myservice
```

### 7.3 常见问题和解决方案

#### 服务启动失败
```bash
# 检查服务状态
sudo systemctl status myservice

# 查看详细错误
sudo journalctl -u myservice -n 50

# 手动测试服务
sudo /usr/local/bin/myservice

# 检查权限
sudo ls -la /usr/local/bin/myservice
```

#### 依赖问题
```bash
# 查看服务依赖
sudo systemctl list-dependencies myservice

# 检查依赖服务状态
sudo systemctl status dependency.service

# 手动启动依赖服务
sudo systemctl start dependency.service
```

#### 资源限制问题
```bash
# 查看资源限制
sudo systemctl show myservice --property=MemoryMax,CPUQuotaPerSecUSec

# 检查系统资源
free -h
top

# 调整资源限制
sudo systemctl edit myservice
```

## 8 迁移和兼容性

### 8.1 从SysV init迁移

```bash
# 检查旧的init脚本
ls /etc/init.d/

# 创建systemd服务文件
sudo vim /etc/systemd/system/myservice.service

# 禁用旧的init脚本
sudo update-rc.d myservice remove

# 启用新的systemd服务
sudo systemctl enable myservice
```

### 8.2 兼容性处理

```ini
[Unit]
# 提供兼容性
Alias=myservice.service
Also=myservice-watcher.service

[Install]
# 安装到运行级别
WantedBy=multi-user.target
Also=myservice.target
```

### 8.3 传统服务支持

```bash
# 启用传统init脚本支持
sudo systemctl enable systemd-sysv-generator

# 查看生成的服务
systemctl list-unit-files | grep generated
```

这个现代服务管理指南涵盖了Systemd的主要功能和最佳实践，可以帮助管理员更好地管理现代Linux系统。