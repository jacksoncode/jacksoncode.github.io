# 系统调试与跟踪

## 1 系统调用跟踪

### 1.1 strace - 系统调用跟踪器

strace 是一个强大的诊断工具，用于跟踪进程执行时的系统调用和信号。

#### 基本用法
```bash
# 跟踪命令的系统调用
strace ls -la

# 跟踪特定进程
strace -p PID

# 跟踪并保存到文件
strace -o trace.log command

# 显示时间戳
strace -t ls -la
strace -tt ls -la  # 微秒精度
strace -T ls -la   # 显示每个系统调用的耗时
```

#### 高级选项
```bash
# 只跟踪特定系统调用
strace -e trace=open,read,write ls -la
strace -e trace=file ls -la      # 文件相关调用
strace -e trace=network ls -la   # 网络相关调用
strace -e trace=process ls -la   # 进程相关调用

# 跟踪系统调用的参数
strace -v ls -la

# 跟踪子进程
strace -f command

# 统计系统调用
strace -c ls -la

# 限制输出长度
strace -s 1024 ls -la  # 限制字符串显示长度为1024
```

#### 实际应用案例
```bash
# 调试程序启动问题
strace -f -e trace=open,execve ./myprogram

# 分析程序性能瓶颈
strace -c -T -p PID

# 调试文件访问问题
strace -e trace=file -o file_access.log myprogram

# 调试网络连接问题
strace -e trace=network -o network.log curl http://example.com

# 调试权限问题
strace -e trace=openat,access chmod 755 file
```

### 1.2 ltrace - 库函数调用跟踪

ltrace 用于跟踪进程调用的库函数。

#### 基本用法
```bash
# 跟踪库函数调用
ltrace ls -la

# 跟踪特定进程
ltrace -p PID

# 保存到文件
ltrace -o ltrace.log command

# 显示时间戳
ltrace -t command
```

#### 高级选项
```bash
# 只跟踪特定库函数
ltrace -e malloc,free command

# 显示库函数参数
ltrace -v command

# 跟踪系统调用和库函数
ltrace -S command

# 统计库函数调用
ltrace -c command

# 显示库调用耗时
ltrace -T command
```

#### 实际应用案例
```bash
# 调试内存泄漏
ltrace -e malloc,free,realloc myprogram

# 分析库函数使用
ltrace -c -T ./myprogram

# 调试动态链接问题
ltrace -l /lib/x86_64-linux-gnu/libc.so.6 command
```

## 2 性能分析工具

### 2.1 perf - Linux性能分析器

perf 是Linux内核内置的性能分析工具，功能非常强大。

#### 基本用法
```bash
# 统计CPU周期和指令数
perf stat command

# 记录性能数据
perf record command

# 分析记录的数据
perf report

# 实时性能监控
perf top
```

#### 高级选项
```bash
# 分析CPU周期
perf stat -e cycles,instructions ./myprogram

# 分析缓存命中率
perf stat -e cache-references,cache-misses ./myprogram

# 分析分支预测
perf stat -e branches,branch-misses ./myprogram

# 分析内存访问
perf stat -e mem_load_uops_retired.l1_hit,mem_load_uops_retired.l1_miss ./myprogram

# 记录调用栈
perf record -g command

# 分析特定进程
perf record -p PID

# 分析特定CPU
perf record -C 0,1 command

# 设置采样频率
perf record -F 1000 command  # 1000Hz采样
```

#### 实际应用案例
```bash
# 分析程序CPU热点
perf record -g ./myprogram
perf report

# 分析系统整体性能
perf top

# 分析函数调用关系
perf record -g --call-graph dwarf ./myprogram
perf report

# 分析内存访问模式
perf stat -e LLC-loads,LLC-load-misses ./myprogram

# 分析分支预测效率
perf stat -e branches,branch-misses ./myprogram
```

### 2.2 gprof - 程序性能分析

gprof 是GNU profiler，用于分析程序的性能瓶颈。

#### 使用方法
```bash
# 编译时添加-pg选项
gcc -pg -o myprogram myprogram.c

# 运行程序生成gmon.out
./myprogram

# 生成性能报告
gprof myprogram gmon.out > profile.txt

# 只显示前20个函数
gprof myprogram gmon.out | head -n 20
```

#### 实际应用案例
```bash
# 编译带分析的程序
gcc -pg -O2 -o myprogram myprogram.c

# 运行程序
./myprogram

# 生成详细的性能报告
gprof myprogram gmon.out > profile.txt

# 分析调用图
gprof myprogram gmon.out --graph > call_graph.txt
```

### 2.3 Valgrind - 内存调试和性能分析

Valgrind 是一个强大的内存调试和性能分析工具套件。

#### 内存泄漏检测
```bash
# 检测内存泄漏
valgrind --leak-check=full ./myprogram

# 显示详细的内存泄漏信息
valgrind --leak-check=full --show-leak-kinds=all ./myprogram

# 生成XML格式的报告
valgrind --leak-check=full --xml=yes --xml-file=leak.xml ./myprogram
```

#### 内存错误检测
```bash
# 检测内存错误
valgrind ./myprogram

# 检测数组越界
valgrind --tool=memcheck ./myprogram

# 检测使用未初始化的内存
valgrind --track-origins=yes ./myprogram
```

#### 性能分析
```bash
# 使用Callgrind进行性能分析
valgrind --tool=callgrind ./myprogram

# 分析生成的性能数据
kcachegrind callgrind.out.pid

# 记录分支预测信息
valgrind --tool=callgrind --branch-sim=yes ./myprogram
```

#### 实际应用案例
```bash
# 调试内存泄漏
valgrind --leak-check=full --show-leak-kinds=all ./myprogram

# 分析内存使用模式
valgrind --tool=massif ./myprogram
ms_print massif.out.pid

# 检测竞态条件
valgrind --tool=helgrind ./myprogram

# 分析缓存使用
valgrind --tool=cachegrind ./myprogram
cg_annotate cachegrind.out.pid
```

## 3 网络调试工具

### 3.1 tcpdump - 网络数据包分析

tcpdump 是一个强大的网络数据包捕获工具。

#### 基本用法
```bash
# 捕获所有网络接口的数据包
sudo tcpdump -i any

# 捕获特定接口的数据包
sudo tcpdump -i eth0

# 保存捕获的数据包
sudo tcpdump -i eth0 -w capture.pcap

# 读取保存的数据包文件
sudo tcpdump -r capture.pcap
```

#### 高级过滤
```bash
# 捕获特定主机的数据包
sudo tcpdump host 192.168.1.100

# 捕获特定端口的数据包
sudo tcpdump port 80

# 捕获特定协议的数据包
sudo tcpdump tcp
sudo tcpdump udp
sudo tcpdump icmp

# 复杂过滤条件
sudo tcpdump 'tcp port 80 and host 192.168.1.100'

# 捕获HTTP请求
sudo tcpdump -i eth0 'tcp port 80 and (((ip[2:2] - ((ip[0]&0xf)<<2)) - ((tcp[12]&0xf0)>>2)) != 0)'
```

#### 实际应用案例
```bash
# 调试网络连接问题
sudo tcpdump -i eth0 host google.com

# 分析HTTP流量
sudo tcpdump -i eth0 -A 'tcp port 80'

# 捕获DNS查询
sudo tcpdump -i eth0 port 53

# 调试SSH连接
sudo tcpdump -i eth0 port 22

# 分析网络性能
sudo tcpdump -i eth0 -ttt 'tcp port 80' | grep -E '(seq|ack)'
```

### 3.2 Wireshark命令行工具

Wireshark 提供了几个强大的命令行工具。

#### tshark - Wireshark的命令行版本
```bash
# 实时捕获
sudo tshark -i eth0

# 捕获并保存到文件
sudo tshark -i eth0 -w capture.pcap

# 读取文件并显示
sudo tshark -r capture.pcap

# 显示统计信息
sudo tshark -z io,stat,1 -i eth0
```

#### 实际应用案例
```bash
# 分析HTTP请求响应时间
sudo tshark -i eth0 -Y 'http.request or http.response' -T fields -e frame.time -e ip.src -e ip.dst -e http.request.method -e http.response.code

# 统计协议分布
sudo tshark -r capture.pcap -q -z io,phs

# 分析TCP流
sudo tshark -r capture.pcap -q -z follow,tcp,ascii,0
```

## 4 进程和系统调试

### 4.1 gdb - GNU调试器

gdb 是Linux下最强大的调试器。

#### 基本用法
```bash
# 调试程序
gdb ./myprogram

# 调试正在运行的进程
gdb -p PID

# 调试核心转储文件
gdb ./myprogram core
```

#### 常用命令
```bash
# 设置断点
(gdb) break main
(gdb) break myfunction
(gdb) break 42  # 在第42行设置断点

# 运行程序
(gdb) run
(gdb) run arg1 arg2

# 单步执行
(gdb) step    # 进入函数
(gdb) next    # 跳过函数
(gdb) continue # 继续执行

# 查看变量
(gdb) print variable
(gdb) print *pointer
(gdb) print array[0]@10

# 查看调用栈
(gdb) backtrace
(gdb) frame 3  # 切换到第3帧

# 查看内存
(gdb) x/10x $esp  # 查看栈指针处的16进制数据
```

#### 高级调试技巧
```bash
# 调试多线程程序
(gdb) info threads
(gdb) thread 2
(gdb) thread apply all bt

# 调试多进程程序
(gdb) set follow-fork-mode child
(gdb) set detach-on-fork off

# 条件断点
(gdb) break myfunction if x > 10

# 观察点
(gdb) watch variable
(gdb) rwatch variable  # 读观察点
(gdb) awatch variable   # 读写观察点

# 反向调试
(gdb) record
(gdb) reverse-step
(gdb) reverse-continue
```

#### 实际应用案例
```bash
# 调试段错误
gdb ./myprogram core
gdb> where
gdb> print variable

# 调试内存泄漏
gdb ./myprogram
gdb> break malloc
gdb> commands
> backtrace
> continue
> end

# 调试多线程竞态条件
gdb ./myprogram
gdb> set scheduler-locking on
gdb> thread apply all bt
```

### 4.2 lsof - 列出打开的文件

lsof 用于查看进程打开的文件和网络连接。

#### 基本用法
```bash
# 列出所有打开的文件
sudo lsof

# 查看特定进程打开的文件
sudo lsof -p PID

# 查看特定用户打开的文件
sudo lsof -u username

# 查看特定文件被哪些进程使用
sudo lsof /path/to/file
```

#### 高级选项
```bash
# 查看网络连接
sudo lsof -i
sudo lsof -i :80
sudo lsof -i tcp
sudo lsof -i udp

# 查看监听端口
sudo lsof -i -s TCP:LISTEN

# 查看已建立的连接
sudo lsof -i -s TCP:ESTABLISHED

# 查看目录被哪些进程使用
sudo lsof +D /path/to/directory

# 查看当前工作目录
sudo lsof -d cwd

# 查看内存映射文件
sudo lsof -d mem
```

#### 实际应用案例
```bash
# 调试端口占用问题
sudo lsof -i :8080

# 查找删除但仍被占用的文件
sudo lsof | grep deleted

# 调试文件锁定问题
sudo lsof /path/to/file

# 查看进程的网络连接
sudo lsof -p PID -i

# 查找使用特定库的程序
sudo lsof | grep libc.so.6
```

### 4.3 fuser - 文件用户识别

fuser 用于识别使用文件或套接字的进程。

#### 基本用法
```bash
# 查看使用文件的进程
fuser /path/to/file

# 查看使用端口的进程
sudo fuser 80/tcp
sudo fuser 53/udp

# 杀死使用文件的进程
sudo fuser -k /path/to/file

# 显示详细信息
sudo fuser -v /path/to/file
```

#### 实际应用案例
```bash
# 调试设备占用
sudo fuser /dev/sda1

# 调试端口占用
sudo fuser -n tcp 80

# 安全地卸载文件系统
sudo fuser -km /mnt/point
sudo umount /mnt/point

# 查看共享内存使用
sudo fuser -v /dev/shm/*
```

## 5 内核调试

### 5.1 dmesg - 内核消息

dmesg 用于查看和控制内核环形缓冲区。

#### 基本用法
```bash
# 查看内核消息
dmesg

# 查看最近的内核消息
dmesg | tail

# 实时监控内核消息
dmesg -w

# 清除内核消息缓冲区
dmesg -c
```

#### 高级选项
```bash
# 按级别过滤
dmesg -l err,warn
dmesg -l info
dmesg -l debug

# 按设施过滤
dmesg -f daemon,kern
dmesg -f user

# 显示时间戳
dmesg -T
dmesg -t  # 相对时间

# 显示设施级别
dmesg -x
```

#### 实际应用案例
```bash
# 调试硬件问题
dmesg | grep -i error
dmesg | grep -i usb
dmesg | grep -i ethernet

# 查看设备连接
dmesg | grep -i "new device"

# 调试内核模块
dmesg | grep -i module

# 查看系统启动信息
dmesg | grep -i "boot"
```

### 5.2 sysctl - 内核参数

sysctl 用于查看和修改内核参数。

#### 基本用法
```bash
# 查看所有内核参数
sysctl -a

# 查看特定参数
sysctl net.ipv4.ip_forward

# 临时修改参数
sysctl -w net.ipv4.ip_forward=1

# 从文件加载参数
sysctl -p /etc/sysctl.conf
```

#### 常用调试参数
```bash
# 启用IP转发
sysctl -w net.ipv4.ip_forward=1

# 启用SYN Cookies
sysctl -w net.ipv4.tcp_syncookies=1

# 调整文件描述符限制
sysctl -w fs.file-max=100000

# 调整共享内存
sysctl -w kernel.shmmax=268435456

# 启用核心转储
sysctl -w kernel.core_pattern=/tmp/core.%e.%p
ulimit -c unlimited
```

#### 实际应用案例
```bash
# 网络性能调优
sysctl -w net.core.rmem_max=16777216
sysctl -w net.core.wmem_max=16777216
sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
sysctl -w net.ipv4.tcp_wmem="4096 65536 16777216"

# 安全加固
sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1
sysctl -w net.ipv4.conf.all.rp_filter=1
sysctl -w net.ipv4.conf.all.accept_source_route=0

# 调试内核崩溃
sysctl -w kernel.panic=10  # 10秒后自动重启
sysctl -w kernel.sysrq=1   # 启用Magic SysRq键
```

## 6 综合调试案例

### 6.1 程序启动失败调试
```bash
# 1. 检查依赖库
ldd ./myprogram

# 2. 跟踪系统调用
strace ./myprogram

# 3. 查看错误信息
dmesg | tail

# 4. 检查文件权限
ls -la /path/to/myprogram

# 5. 查看SELinux状态
getenforce
sestatus
```

### 6.2 性能问题调试
```bash
# 1. 系统资源监控
top
htop

# 2. 进程性能分析
perf top
perf record -g -p PID

# 3. 内存分析
valgrind --tool=massif ./myprogram

# 4. I/O分析
iotop

# 5. 网络分析
iftop
```

### 6.3 网络问题调试
```bash
# 1. 检查网络配置
ip addr show
ip route show

# 2. 测试连通性
ping gateway
ping 8.8.8.8

# 3. 跟踪路由
mtr google.com

# 4. 抓包分析
sudo tcpdump -i eth0 host problematic.host

# 5. DNS调试
nslookup google.com
dig google.com
```

### 6.4 内存泄漏调试
```bash
# 1. 使用Valgrind检测
valgrind --leak-check=full --show-leak-kinds=all ./myprogram

# 2. 使用mtrace（需要程序支持）
gcc -g -DMALLOC_TRACE myprogram.c -o myprogram
MALLOC_TRACE=mtrace.log ./myprogram
mtrace ./myprogram mtrace.log

# 3. 使用gdb调试
gdb ./myprogram
gdb> break malloc
gdb> commands
> backtrace
> continue
> end

# 4. 系统级内存监控
smem -r
```

## 7 调试最佳实践

### 7.1 调试策略
1. **重现问题**：确保能够稳定重现问题
2. **收集信息**：系统日志、错误消息、配置文件
3. **缩小范围**：确定是配置问题、环境问题还是代码问题
4. **逐步分析**：从表面现象到深层原因
5. **验证假设**：通过测试验证每个假设

### 7.2 调试工具选择
- **系统调用问题**：strace, ltrace
- **性能问题**：perf, Valgrind, gprof
- **内存问题**：Valgrind, gdb
- **网络问题**：tcpdump, Wireshark
- **进程问题**：lsof, fuser, gdb
- **内核问题**：dmesg, sysctl

### 7.3 调试注意事项
- 在测试环境中进行调试
- 备份重要数据和配置
- 记录调试过程和结果
- 了解工具的性能影响
- 注意系统安全和权限

这个系统调试与跟踪指南涵盖了Linux系统调试的主要工具和方法，可以帮助快速定位和解决各种系统问题。