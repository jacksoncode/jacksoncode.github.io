# Linux故障排查清单

## 1 系统启动问题

### 1.1 启动失败排查步骤

#### 步骤1：检查启动信息
```bash
# 查看启动日志
journalctl -b
journalctl -b -1  # 查看上一次启动日志

# 查看系统日志
tail -n 100 /var/log/syslog
tail -n 100 /var/log/messages

# 查看内核日志
dmesg | tail -n 100
```

#### 步骤2：GRUB问题排查
```bash
# 检查GRUB配置
cat /etc/default/grub
grub-mkconfig -o /boot/grub/grub.cfg

# 重新安装GRUB
grub-install /dev/sda
update-grub

# 检查启动分区
fdisk -l
lsblk -f
```

#### 步骤3：文件系统检查
```bash
# 检查文件系统错误
fsck -n /dev/sda1  # 只检查不修复
fsck -y /dev/sda1  # 自动修复

# 检查挂载配置
cat /etc/fstab
mount -a  # 测试挂载
```

### 1.2 启动服务问题

#### 服务状态检查
```bash
# 查看所有服务状态
systemctl list-units --type=service --state=failed

# 查看特定服务状态
systemctl status networking.service
systemctl status ssh.service

# 查看服务日志
journalctl -u networking.service
journalctl -u ssh.service
```

#### 服务故障修复
```bash
# 重新启动失败的服务
systemctl restart networking.service

# 启用服务自启动
systemctl enable networking.service

# 查看服务依赖
systemctl list-dependencies networking.service
```

## 2 网络连接问题

### 2.1 网络配置检查

#### 基本网络检查
```bash
# 检查网络接口
ip addr show
ifconfig -a

# 检查路由表
ip route show
route -n

# 检查DNS配置
cat /etc/resolv.conf
nslookup google.com
dig google.com
```

#### 网络连接测试
```bash
# 测试连通性
ping -c 4 8.8.8.8
ping -c 4 google.com

# 测试端口
nc -zv google.com 80
nc -zv google.com 443
telnet google.com 80

# 跟踪路由
traceroute google.com
mtr google.com
```

### 2.2 网络服务问题

#### 网络服务检查
```bash
# 检查NetworkManager
systemctl status NetworkManager
nmcli device status
nmcli connection show

# 检查网络配置文件
cat /etc/network/interfaces  # Debian/Ubuntu
cat /etc/sysconfig/network-scripts/ifcfg-eth0  # CentOS/RHEL

# 检查netplan配置 (Ubuntu 18.04+)
cat /etc/netplan/*.yaml
netplan apply
```

#### 网络故障修复
```bash
# 重启网络服务
systemctl restart networking  # Debian/Ubuntu
systemctl restart network   # CentOS/RHEL

# 重启NetworkManager
systemctl restart NetworkManager

# 重新获取DHCP
 dhclient -r  # 释放IP
 dhclient     # 重新获取IP

# 清除DNS缓存
systemd-resolve --flush-caches
```

## 3 磁盘空间问题

### 3.1 磁盘空间检查

#### 空间使用情况
```bash
# 查看磁盘使用情况
df -h
df -i  # inode使用情况

# 查看目录大小
du -sh /var/log
du -sh /home/*
du -sh /* 2>/dev/null | sort -hr

# 查找大文件
find / -type f -size +100M -exec ls -lh {} \;
find /var/log -type f -size +10M -exec ls -lh {} \;
```

#### 日志文件检查
```bash
# 查看日志文件大小
ls -lh /var/log/
du -sh /var/log/*

# 查看正在写入的日志
lsof | grep "/var/log"

# 轮转日志
logrotate -f /etc/logrotate.conf
```

### 3.2 磁盘空间清理

#### 清理日志文件
```bash
# 清空日志文件
> /var/log/syslog
> /var/log/auth.log

# 删除旧日志
find /var/log -name "*.log.*" -mtime +30 -delete
find /var/log -name "*.gz" -mtime +30 -delete

# 清理系统日志
journalctl --vacuum-time=7d
journalctl --vacuum-size=100M
```

#### 清理包缓存
```bash
# Debian/Ubuntu
apt-get clean
apt-get autoclean
apt-get autoremove

# CentOS/RHEL
yum clean all
dnf clean all

# 清理旧内核
package-cleanup --oldkernels --count=2
```

#### 清理临时文件
```bash
# 清理临时目录
find /tmp -type f -atime +7 -delete
find /var/tmp -type f -atime +7 -delete

# 清理用户缓存
find /home -name ".cache" -type d -exec du -sh {} \;

# 清理包缓存
rm -rf /var/cache/apt/archives/*
rm -rf /var/cache/yum/*
```

## 4 内存和性能问题

### 4.1 内存使用检查

#### 内存状态检查
```bash
# 查看内存使用
free -h
free -m

# 查看进程内存使用
ps aux --sort=-%mem | head -20

# 查看内存详细信息
cat /proc/meminfo
vmstat 1 5
```

#### 内存泄漏检查
```bash
# 查看内存使用趋势
sar -r 1 10

# 检查缓存和缓冲区
cat /proc/meminfo | grep -E "(Cached|Buffers|Swap)"

# 清理缓存
echo 1 > /proc/sys/vm/drop_caches  # 清理页缓存
echo 2 > /proc/sys/vm/drop_caches  # 清理目录项和inode
echo 3 > /proc/sys/vm/drop_caches  # 清理所有缓存
```

### 4.2 CPU使用检查

#### CPU负载检查
```bash
# 查看CPU使用
top
htop

# 查看CPU信息
cat /proc/cpuinfo
lscpu

# 查看负载平均
uptime
cat /proc/loadavg
```

#### 进程CPU使用
```bash
# 查看CPU使用率最高的进程
ps aux --sort=-%cpu | head -20

# 查看线程信息
ps -eLf | grep process_name

# 查看进程树
pstree -p
htop -t
```

### 4.3 I/O性能检查

#### 磁盘I/O检查
```bash
# 查看磁盘I/O
iostat -x 1 5
iotop

# 查看I/O等待
vmstat 1 5

# 查看磁盘活动
sar -d 1 5
```

#### I/O瓶颈排查
```bash
# 查看I/O使用率最高的进程
iotop -o -d 1

# 查看磁盘队列长度
cat /sys/block/sda/queue/nr_requests

# 查看磁盘错误
dmesg | grep -i "I/O error"
```

## 5 服务问题

### 5.1 服务状态检查

#### 服务基本检查
```bash
# 查看服务状态
systemctl status service_name
service service_name status

# 查看所有服务
systemctl list-units --type=service
service --status-all

# 查看服务日志
journalctl -u service_name
journalctl -u service_name -f  # 实时日志
```

#### 服务依赖检查
```bash
# 查看服务依赖
systemctl list-dependencies service_name

# 查看服务启动顺序
systemctl list-dependencies --before service_name
systemctl list-dependencies --after service_name
```

### 5.2 服务故障修复

#### 服务重启和配置
```bash
# 重启服务
systemctl restart service_name
service service_name restart

# 重新加载配置
systemctl reload service_name

# 启用/禁用服务
systemctl enable service_name
systemctl disable service_name

# 查看服务配置
systemctl cat service_name
```

#### 端口冲突检查
```bash
# 查看端口占用
netstat -tulpn
ss -tulpn
lsof -i :80
lsof -i TCP:80

# 查看服务监听的端口
cat /etc/services | grep service_name
```

## 6 用户和权限问题

### 6.1 用户账户问题

#### 用户账户检查
```bash
# 查看用户信息
cat /etc/passwd
cat /etc/shadow
id username

# 检查用户主目录
ls -la /home/
du -sh /home/*

# 检查用户进程
ps -u username
lsof -u username
```

#### 用户权限检查
```bash
# 检查用户组
groups username

# 检查sudo权限
cat /etc/sudoers
cat /etc/sudoers.d/*

# 检查文件权限
ls -la /home/username/
ls -la /etc/passwd
```

### 6.2 文件权限问题

#### 权限检查
```bash
# 检查文件权限
ls -la filename
stat filename

# 检查目录权限
ls -ld /var/www/
ls -ld /tmp/

# 检查特殊权限
find / -perm -4000 -type f  # SUID
find / -perm -2000 -type f  # SGID
find / -perm -1000 -type d  # Sticky bit
```

#### 权限修复
```bash
# 修复文件权限
chmod 644 filename
chmod 755 directory

# 修复属主和属组
chown user:group filename
chown -R user:group directory

# 修复ACL权限
setfacl -b filename  # 删除ACL
setfacl -m u:user:rwx filename
```

## 7 软件包问题

### 7.1 包管理器问题

#### APT问题排查（Debian/Ubuntu）
```bash
# 更新包列表
apt-get update

# 修复损坏的包
apt-get install -f
apt-get --fix-broken install

# 清理包缓存
apt-get clean
apt-get autoclean

# 检查包状态
dpkg --audit
dpkg --configure -a
```

#### YUM/DNF问题排查（CentOS/RHEL）
```bash
# 清理缓存
yum clean all
dnf clean all

# 重建缓存
yum makecache
dnf makecache

# 检查包完整性
rpm -Va

# 修复包
yum reinstall package_name
dnf reinstall package_name
```

### 7.2 依赖问题

#### 依赖检查
```bash
# 检查包依赖
apt-cache depends package_name
yum deplist package_name

# 检查损坏的依赖
apt-get check
yum check

# 查看包信息
apt-cache show package_name
yum info package_name
```

## 8 日志分析

### 8.1 系统日志检查

#### 重要日志文件
```bash
# 系统日志
tail -f /var/log/syslog
tail -f /var/log/messages

# 认证日志
tail -f /var/log/auth.log
tail -f /var/log/secure

# 内核日志
dmesg -w

# 服务日志
journalctl -f
journalctl -u service_name -f
```

#### 日志分析工具
```bash
# 查看最近的日志
journalctl --since "1 hour ago"
journalctl --since "2024-01-01 00:00:00"

# 按优先级过滤
journalctl -p err
journalctl -p warning

# 按服务过滤
journalctl -u ssh.service
journalctl -u nginx.service
```

### 8.2 应用日志检查

#### Web服务器日志
```bash
# Apache日志
tail -f /var/log/apache2/error.log
tail -f /var/log/apache2/access.log

# Nginx日志
tail -f /var/log/nginx/error.log
tail -f /var/log/nginx/access.log

# 分析访问日志
awk '{print $1}' access.log | sort | uniq -c | sort -nr
```

#### 数据库日志
```bash
# MySQL日志
tail -f /var/log/mysql/error.log
tail -f /var/log/mysql/slow.log

# PostgreSQL日志
tail -f /var/log/postgresql/postgresql-*.log
```

## 9 安全相关问题

### 9.1 系统安全检查

#### 登录检查
```bash
# 查看登录历史
last
last -f /var/log/wtmp

# 查看失败登录
lastb
faillog -a

# 查看当前登录用户
who
w
```

#### 系统完整性检查
```bash
# 检查系统文件
rpm -Va  # RHEL/CentOS
dpkg -V  # Debian/Ubuntu

# 检查SUID/SGID文件
find / -type f \( -perm -4000 -o -perm -2000 \) -ls

# 检查世界可写文件
find / -type f -perm -002 -ls
```

### 9.2 网络安全检查

#### 网络连接检查
```bash
# 查看网络连接
netstat -tulpn
ss -tulpn

# 查看监听端口
lsof -i
lsof -i TCP:80

# 查看防火墙状态
iptables -L -n
ufw status
firewall-cmd --state
```

## 10 性能调优清单

### 10.1 系统性能检查

#### 系统资源检查
```bash
# CPU使用率
top -b -n 1 | head -20
sar -u 1 5

# 内存使用
free -h
vmstat 1 5

# 磁盘I/O
iostat -x 1 5
iotop -o -d 1

# 网络流量
iftop -i eth0
nload
```

#### 性能瓶颈识别
```bash
# 查看负载平均
uptime
cat /proc/loadavg

# 查看进程资源使用
ps aux --sort=-%cpu | head -10
ps aux --sort=-%mem | head -10

# 查看系统调用
strace -p PID
trace -p PID
```

### 10.2 性能优化建议

#### 内核参数调优
```bash
# 查看当前内核参数
sysctl -a
cat /proc/sys/net/ipv4/tcp_fin_timeout

# 临时修改内核参数
sysctl -w net.core.somaxconn=1024

# 永久修改内核参数
echo "net.core.somaxconn = 1024" >> /etc/sysctl.conf
sysctl -p
```

这个故障排查清单涵盖了Linux系统中最常见的问题和排查步骤，可以作为日常运维工作的快速参考。建议根据具体问题选择合适的排查步骤，并结合实际情况进行调整。