# Linux系统优化建议

## 1 内核参数优化

### 1.1 网络性能优化

#### TCP/IP协议栈优化
```bash
# 编辑/etc/sysctl.conf
cat >> /etc/sysctl.conf << 'EOF'
# 网络性能优化
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.core.netdev_max_backlog = 30000
net.core.netdev_budget = 600
net.core.netdev_budget_usecs = 8000

# TCP优化
net.ipv4.tcp_rmem = 4096 262144 16777216
net.ipv4.tcp_wmem = 4096 262144 16777216
net.ipv4.tcp_mem = 786432 1048576 26777216
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_adv_win_scale = -2

# 连接优化
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_max_tw_buckets = 2000000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_keepalive_time = 60
net.ipv4.tcp_keepalive_intvl = 10
net.ipv4.tcp_keepalive_probes = 6
net.ipv4.tcp_syncookies = 1

# 端口范围
net.ipv4.ip_local_port_range = 1024 65535
EOF

# 应用配置
sysctl -p
```

#### 高并发网络优化
```bash
# 高并发服务器优化
cat >> /etc/sysctl.conf << 'EOF'
# 高并发优化
net.core.somaxconn = 65535
net.ipv4.tcp_max_orphans = 65536
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_ecn = 1
net.ipv4.tcp_westwood = 1
net.ipv4.tcp_bic = 1

# 文件描述符限制
fs.file-max = 10000000
fs.nr_open = 10000000
EOF
```

### 1.2 内存管理优化

#### 虚拟内存优化
```bash
# 内存管理优化
cat >> /etc/sysctl.conf << 'EOF'
# 内存优化
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
vm.dirty_expire_centisecs = 500
vm.dirty_writeback_centisecs = 100
vm.vfs_cache_pressure = 50
vm.min_free_kbytes = 65536

# 大页内存支持
vm.nr_hugepages = 512
vm.hugetlb_shm_group = 0
EOF
```

#### 内存分配优化
```bash
# 根据系统内存大小调整
# 8GB内存系统
vm.swappiness = 10
vm.dirty_ratio = 20
vm.dirty_background_ratio = 10

# 16GB+内存系统
vm.swappiness = 1
vm.dirty_ratio = 30
vm.dirty_background_ratio = 15
```

### 1.3 文件系统优化

#### I/O调度器优化
```bash
# 查看当前I/O调度器
cat /sys/block/sda/queue/scheduler

# 临时修改I/O调度器
echo deadline > /sys/block/sda/queue/scheduler
echo noop > /sys/block/sda/queue/scheduler
echo cfq > /sys/block/sda/queue/scheduler

# 永久修改（GRUB配置）
# 编辑/etc/default/grub
GRUB_CMDLINE_LINUX="... elevator=deadline"
update-grub
```

#### 文件系统挂载优化
```bash
# 优化挂载选项
# 编辑/etc/fstab
UUID=xxx / ext4 defaults,noatime,nodiratime,errors=remount-ro 0 1
UUID=xxx /var ext4 defaults,noatime,nodiratime,commit=120 0 2

# 创建文件系统时优化
mkfs.ext4 -m 1 -O extent,flex_bg,sparse_super /dev/sdX
```

## 2 系统服务优化

### 2.1 服务启动优化

#### 禁用不必要的服务
```bash
# 查看所有服务状态
systemctl list-unit-files --type=service

# 禁用不需要的服务
systemctl disable bluetooth.service
systemctl disable cups.service
systemctl disable avahi-daemon.service
systemctl disable ModemManager.service

# 停止服务
systemctl stop bluetooth.service
systemctl stop cups.service
```

#### 服务启动时间优化
```bash
# 分析启动时间
systemd-analyze
systemd-analyze blame
systemd-analyze critical-chain

# 优化启动服务
systemctl disable NetworkManager-wait-online.service
systemctl disable systemd-resolved.service
```

### 2.2 定时任务优化

#### 优化cron任务
```bash
# 查看系统定时任务
ls -la /etc/cron.*/
cat /etc/crontab

# 优化定时任务执行时间
# 避免在高峰期执行资源密集型任务
# 编辑/etc/crontab或用户crontab
0 2 * * * /usr/bin/updatedb  # 凌晨2点更新文件数据库
0 3 * * * /usr/bin/apt-get update  # 凌晨3点更新包列表
```

## 3 网络服务优化

### 3.1 Web服务器优化

#### Nginx性能优化
```bash
# 编辑/etc/nginx/nginx.conf
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 65535;
    use epoll;
    multi_accept on;
}

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 1000;
    reset_timedout_connection on;
    client_body_timeout 10;
    send_timeout 2;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;
}
```

#### Apache性能优化
```bash
# 编辑/etc/apache2/apache2.conf
# MPM配置
<IfModule mpm_prefork_module>
    StartServers 8
    MinSpareServers 5
    MaxSpareServers 20
    ServerLimit 256
    MaxRequestWorkers 256
    MaxConnectionsPerChild 10000
</IfModule>

<IfModule mpm_worker_module>
    StartServers 4
    MinSpareThreads 25
    MaxSpareThreads 75
    ThreadLimit 64
    ThreadsPerChild 25
    MaxRequestWorkers 400
    MaxConnectionsPerChild 10000
</IfModule>

# 启用压缩
LoadModule deflate_module /usr/lib/apache2/modules/mod_deflate.so
LoadModule headers_module /usr/lib/apache2/modules/mod_headers.so

# 缓存配置
LoadModule expires_module /usr/lib/apache2/modules/mod_expires.so
LoadModule cache_module /usr/lib/apache2/modules/mod_cache.so
```

### 3.2 数据库优化

#### MySQL性能优化
```bash
# 编辑/etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
# 连接设置
max_connections = 500
max_user_connections = 400
max_connect_errors = 1000
wait_timeout = 28800
interactive_timeout = 28800

# 查询缓存
query_cache_size = 256M
query_cache_type = 1
query_cache_limit = 2M

# InnoDB设置
innodb_buffer_pool_size = 2G
innodb_log_file_size = 256M
innodb_log_buffer_size = 8M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1

# MyISAM设置
key_buffer_size = 256M
myisam_sort_buffer_size = 64M

# 临时表设置
tmp_table_size = 256M
max_heap_table_size = 256M

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log_queries_not_using_indexes = 1
```

#### PostgreSQL性能优化
```bash
# 编辑/etc/postgresql/*/main/postgresql.conf
# 连接设置
max_connections = 200
superuser_reserved_connections = 3

# 内存设置
shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 4MB
maintenance_work_mem = 512MB
dynamic_shared_memory_type = posix

# WAL设置
wal_buffers = 16MB
wal_writer_delay = 10ms
wal_writer_flush_after = 1MB
checkpoint_timeout = 10min
max_wal_size = 2GB
min_wal_size = 1GB
checkpoint_completion_target = 0.9

# 查询计划器
random_page_cost = 1.1
effective_io_concurrency = 200

# 日志设置
log_destination = 'stderr'
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
```

## 4 系统监控和日志优化

### 4.1 日志轮询优化

#### Logrotate配置优化
```bash
# 编辑/etc/logrotate.conf
# 全局设置
weekly
rotate 52
create
compress
dateext
include /etc/logrotate.d

# 特定服务优化
# /etc/logrotate.d/nginx
/var/log/nginx/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        invoke-rc.d nginx rotate >/dev/null 2>&1
    endscript
}

# /etc/logrotate.d/mysql
/var/log/mysql/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 0640 mysql mysql
    sharedscripts
    postrotate
        test -x /usr/bin/mysqladmin || exit 0
        if [ -z "`ps acx|grep mysqld`" ]; then exit 0; fi
        /usr/bin/mysqladmin flush-logs
    endscript
}
```

### 4.2 监控工具配置

#### 基础监控配置
```bash
# 安装基础监控工具
apt-get install htop iotop nethogs iftop nmon

# 创建监控脚本
# /usr/local/bin/system-monitor.sh
#!/bin/bash
while true; do
    echo "=== System Status ==="
    echo "CPU Usage:"
    top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1
    
    echo "Memory Usage:"
    free -h | grep Mem
    
    echo "Disk Usage:"
    df -h | grep -E '^/dev'
    
    echo "Top Processes:"
    ps aux --sort=-%cpu | head -6
    
    sleep 5
done
```

## 5 安全性优化

### 5.1 SSH安全优化

#### SSH配置优化
```bash
# 编辑/etc/ssh/sshd_config
# 端口和协议
Port 2222
Protocol 2

# 认证设置
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys

# 安全设置
MaxAuthTries 3
MaxSessions 2
LoginGraceTime 30
ClientAliveInterval 300
ClientAliveCountMax 2

# 性能设置
UseDNS no
GSSAPIAuthentication no

# 日志设置
SyslogFacility AUTH
LogLevel VERBOSE

# 限制用户
AllowUsers user1 user2
DenyUsers user3 user4
AllowGroups ssh-users
```

### 5.2 防火墙配置优化

#### iptables优化规则
```bash
# 创建防火墙脚本
# /usr/local/bin/firewall-setup.sh
#!/bin/bash

# 清空现有规则
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# 设置默认策略
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 允许本地回环
iptables -A INPUT -i lo -j ACCEPT

# 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 允许SSH
iptables -A INPUT -p tcp --dport 2222 -j ACCEPT

# 允许HTTP/HTTPS
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 防止SYN洪水攻击
iptables -A INPUT -p tcp --syn -m limit --limit 1/s --limit-burst 3 -j ACCEPT

# 防止Ping洪水攻击
iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT

# 保存规则
iptables-save > /etc/iptables/rules.v4
```

## 6 自动化优化脚本

### 6.1 系统优化脚本

#### 一键优化脚本
```bash
#!/bin/bash
# /usr/local/bin/system-optimize.sh

# 系统优化脚本
echo "Starting system optimization..."

# 备份原始配置
cp /etc/sysctl.conf /etc/sysctl.conf.backup.$(date +%Y%m%d)

# 应用内核参数优化
cat >> /etc/sysctl.conf << 'EOF'
# System optimization parameters
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 262144 16777216
net.ipv4.tcp_wmem = 4096 262144 16777216
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
fs.file-max = 10000000
EOF

sysctl -p

# 优化limits
sed -i '/\* soft nofile/d' /etc/security/limits.conf
sed -i '/\* hard nofile/d' /etc/security/limits.conf
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 优化SSH
sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config
sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# 清理系统
apt-get autoremove -y
apt-get autoclean -y
apt-get clean -y

# 优化日志
sed -i 's/weekly/daily/' /etc/logrotate.conf
sed -i 's/rotate 52/rotate 30/' /etc/logrotate.conf

systemctl restart rsyslog

echo "System optimization completed!"
echo "Please reboot the system to apply all changes."
```

### 6.2 性能监控脚本

#### 性能监控和自动优化
```bash
#!/bin/bash
# /usr/local/bin/performance-monitor.sh

# 性能监控和自动调优

LOG_FILE="/var/log/performance-monitor.log"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

check_cpu_usage() {
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
        log_message "WARNING: High CPU usage: ${CPU_USAGE}%"
        # 可以添加自动优化措施
    fi
}

check_memory_usage() {
    MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.2f", $3/$2 * 100.0}')
    if (( $(echo "$MEMORY_USAGE > 85" | bc -l) )); then
        log_message "WARNING: High memory usage: ${MEMORY_USAGE}%"
        # 清理缓存
        echo 3 > /proc/sys/vm/drop_caches
        log_message "Memory cache cleared"
    fi
}

check_disk_usage() {
    DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | cut -d'%' -f1)
    if [ $DISK_USAGE -gt 80 ]; then
        log_message "WARNING: High disk usage: ${DISK_USAGE}%"
        # 清理日志
        find /var/log -name "*.log" -mtime +7 -delete
        journalctl --vacuum-time=7d
        log_message "Old logs cleaned"
    fi
}

# 主监控循环
while true; do
    check_cpu_usage
    check_memory_usage
    check_disk_usage
    sleep 300  # 每5分钟检查一次
done
```

这些系统优化建议涵盖了内核参数、网络服务、数据库、监控和安全等各个方面。根据具体的应用场景和硬件配置，可以选择性地应用这些优化措施，并通过监控工具持续观察优化效果。