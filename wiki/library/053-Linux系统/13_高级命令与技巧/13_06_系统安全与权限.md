# 系统安全与权限

## 1 Linux权限基础

### 1.1 文件权限详解

#### 1.1.1 权限位解释

Linux文件权限由三组权限位组成，每组包含三个权限：

| 权限位 | 文件权限 | 目录权限 |
|--------|----------|----------|
| r (4) | 读取文件内容 | 列出目录内容 |
| w (2) | 修改文件内容 | 创建/删除目录中的文件 |
| x (1) | 执行文件 | 进入目录 |

#### 1.1.2 权限表示法

```bash
#!/bin/bash
# 权限表示法示例

# 查看文件权限
ls -l /etc/passwd

# 权限位详解
# -rw-r--r-- 1 root root  882 2024-01-15 10:30 /etc/passwd
# ^  ^  ^  ^
# |  |  |  └── 其他用户权限
# |  |  └───── 组用户权限
# |  └─────── 文件所有者权限
# └───────── 文件类型 (-普通文件, d目录, l链接)

# 数字权限表示
# 755 = rwxr-xr-x
# 644 = rw-r--r--
# 600 = rw-------
```

### 1.2 用户和组管理

#### 1.2.1 用户管理命令

```bash
#!/bin/bash
# 用户管理基础命令

# 查看当前用户
whoami
id

# 查看所有用户
cat /etc/passwd
getent passwd

# 查看用户组
groups
id username

# 创建用户
sudo useradd -m -s /bin/bash newuser
sudo passwd newuser

# 修改用户信息
sudo usermod -aG sudo newuser    # 添加到sudo组
sudo usermod -d /home/newhome newuser  # 修改家目录
sudo usermod -s /bin/zsh newuser      # 修改shell

# 删除用户
sudo userdel -r olduser

# 用户管理脚本
USER_MANAGER() {
    local action="$1"
    local username="$2"
    
    case "$action" in
        "create")
            if [ -z "$username" ]; then
                echo "用法: $0 create <用户名>"
                return 1
            fi
            
            if id "$username" >/dev/null 2>&1; then
                echo "用户 $username 已存在"
                return 1
            fi
            
            echo "创建用户 $username..."
            sudo useradd -m -s /bin/bash "$username"
            sudo passwd "$username"
            echo "用户 $username 创建完成"
            ;;
            
        "delete")
            if [ -z "$username" ]; then
                echo "用法: $0 delete <用户名>"
                return 1
            fi
            
            if ! id "$username" >/dev/null 2>&1; then
                echo "用户 $username 不存在"
                return 1
            fi
            
            echo "删除用户 $username..."
            sudo userdel -r "$username"
            echo "用户 $username 删除完成"
            ;;
            
        "list")
            echo "=== 系统用户 ==="
            printf "%-15s %-10s %-20s\n" "用户名" "UID" "Shell"
            printf "%-15s %-10s %-20s\n" "------" "---" "-----"
            awk -F: '$3 >= 1000 && $3 < 65534 {printf "%-15s %-10s %-20s\n", $1, $3, $7}' /etc/passwd
            ;;
            
        *)
            echo "用法: $0 {create|delete|list} [用户名]"
            ;;
    esac
}

# 使用示例
# USER_MANAGER create testuser
# USER_MANAGER list
```

#### 1.2.2 组管理命令

```bash
#!/bin/bash
# 组管理命令

# 查看所有组
cat /etc/group
getent group

# 创建组
sudo groupadd developers

# 添加用户到组
sudo usermod -aG developers username

# 从组中移除用户
sudo gpasswd -d username developers

# 修改组信息
sudo groupmod -n newname oldname

# 删除组
sudo groupdel developers

# 组管理脚本
GROUP_MANAGER() {
    local action="$1"
    local groupname="$2"
    local username="$3"
    
    case "$action" in
        "create")
            if [ -z "$groupname" ]; then
                echo "用法: $0 create <组名>"
                return 1
            fi
            
            if getent group "$groupname" >/dev/null 2>&1; then
                echo "组 $groupname 已存在"
                return 1
            fi
            
            echo "创建组 $groupname..."
            sudo groupadd "$groupname"
            echo "组 $groupname 创建完成"
            ;;
            
        "adduser")
            if [ -z "$groupname" ] || [ -z "$username" ]; then
                echo "用法: $0 adduser <组名> <用户名>"
                return 1
            fi
            
            if ! getent group "$groupname" >/dev/null 2>&1; then
                echo "组 $groupname 不存在"
                return 1
            fi
            
            if ! id "$username" >/dev/null 2>&1; then
                echo "用户 $username 不存在"
                return 1
            fi
            
            echo "将用户 $username 添加到组 $groupname..."
            sudo usermod -aG "$groupname" "$username"
            echo "添加完成"
            ;;
            
        "list")
            echo "=== 系统组 ==="
            printf "%-15s %-10s %-20s\n" "组名" "GID" "成员"
            printf "%-15s %-10s %-20s\n" "----" "---" "----"
            awk -F: '$3 >= 1000 {printf "%-15s %-10s %-20s\n", $1, $3, $4}' /etc/group
            ;;
            
        *)
            echo "用法: $0 {create|adduser|list} [组名] [用户名]"
            ;;
    esac
}

# 使用示例
# GROUP_MANAGER create developers
# GROUP_MANAGER adduser developers username
```

## 2 文件权限管理

### 2.1 chmod命令详解

#### 2.1.1 符号权限法

```bash
#!/bin/bash
# chmod符号权限法

# 添加权限
chmod u+x script.sh        # 给所有者添加执行权限
chmod g+w file.txt         # 给组用户添加写权限
chmod o+r file.txt         # 给其他用户添加读权限
chmod a+r file.txt         # 给所有用户添加读权限

# 移除权限
chmod u-x script.sh        # 移除所有者执行权限
chmod g-w file.txt         # 移除组用户写权限
chmod o-r file.txt         # 移除其他用户读权限

# 设置精确权限
chmod u=rwx,g=rx,o=r file.txt  # 设置精确权限

# 递归修改权限
chmod -R 755 /path/to/directory

# 权限管理脚本
PERMISSION_MANAGER() {
    local file="$1"
    local perms="$2"
    
    if [ -z "$file" ] || [ -z "$perms" ]; then
        echo "用法: $0 <文件> <权限>"
        echo "权限格式: u+r, g-w, 755, 644 等"
        return 1
    fi
    
    if [ ! -e "$file" ]; then
        echo "文件 $file 不存在"
        return 1
    fi
    
    echo "当前权限:"
    ls -l "$file"
    
    echo "修改权限: $perms"
    chmod "$perms" "$file"
    
    echo "新权限:"
    ls -l "$file"
}

# 使用示例
# PERMISSION_MANAGER script.sh u+x
# PERMISSION_MANAGER file.txt 644
```

#### 2.1.2 数字权限法

```bash
#!/bin/bash
# chmod数字权限法

# 常用权限组合
# 755 = rwxr-xr-x (目录和可执行文件)
# 644 = rw-r--r-- (普通文件)
# 600 = rw------- (私有文件)
# 777 = rwxrwxrwx (共享目录)
# 700 = rwx------ (私有目录)

# 设置权限
chmod 755 script.sh
chmod 644 document.txt
chmod 600 private.key
chmod 777 shared_folder

# 权限计算器
PERMISSION_CALCULATOR() {
    local perms="$1"
    
    if [ -z "$perms" ]; then
        echo "用法: $0 <数字权限>"
        echo "示例: $0 755"
        return 1
    fi
    
    # 验证输入
    if ! [[ "$perms" =~ ^[0-7]{3}$ ]]; then
        echo "错误: 权限必须是3位数字 (000-777)"
        return 1
    fi
    
    # 计算权限
    local owner=$(( perms / 100 ))
    local group=$(( (perms / 10) % 10 ))
    local others=$(( perms % 10 ))
    
    # 转换权限位
    get_permission_string() {
        local perm="$1"
        local str=""
        
        [ $(( perm & 4 )) -ne 0 ] && str="${str}r" || str="${str}-"
        [ $(( perm & 2 )) -ne 0 ] && str="${str}w" || str="${str}-"
        [ $(( perm & 1 )) -ne 0 ] && str="${str}x" || str="${str}-"
        
        echo "$str"
    }
    
    local owner_str=$(get_permission_string "$owner")
    local group_str=$(get_permission_string "$group")
    local others_str=$(get_permission_string "$others")
    
    echo "权限 $perms: ${owner_str}${group_str}${others_str}"
    
    # 权限解释
    echo "权限解释:"
    echo "所有者: $owner_str"
    echo "组用户: $group_str"
    echo "其他用户: $others_str"
}

# 使用示例
# PERMISSION_CALCULATOR 755
# PERMISSION_CALCULATOR 644
```

### 2.2 chown和chgrp命令

#### 2.2.1 所有权管理

```bash
#!/bin/bash
# 所有权管理命令

# 修改文件所有者
sudo chown username file.txt

# 修改文件所有者和组
sudo chown username:groupname file.txt

# 只修改组
sudo chgrp groupname file.txt

# 递归修改
sudo chown -R username:groupname /path/to/directory

# 所有权管理脚本
OWNERSHIP_MANAGER() {
    local file="$1"
    local owner="$2"
    local group="${3:-}"
    
    if [ -z "$file" ] || [ -z "$owner" ]; then
        echo "用法: $0 <文件> <所有者> [组]"
        return 1
    fi
    
    if [ ! -e "$file" ]; then
        echo "文件 $file 不存在"
        return 1
    fi
    
    echo "当前所有权:"
    ls -l "$file"
    
    if [ -n "$group" ]; then
        echo "修改所有权: $owner:$group"
        sudo chown "$owner:$group" "$file"
    else
        echo "修改所有者: $owner"
        sudo chown "$owner" "$file"
    fi
    
    echo "新所有权:"
    ls -l "$file"
}

# 使用示例
# OWNERSHIP_MANAGER file.txt username
# OWNERSHIP_MANAGER file.txt username:developers
```

## 3 特殊权限

### 3.1 SUID、SGID和Sticky位

#### 3.1.1 特殊权限详解

```bash
#!/bin/bash
# 特殊权限详解

# SUID (Set User ID)
# 当文件被执行时，进程以文件所有者的身份运行
# 典型应用: /usr/bin/passwd
ls -l /usr/bin/passwd
# -rwsr-xr-x 1 root root 68208 2024-01-15 10:30 /usr/bin/passwd
#    ^ s表示SUID

# SGID (Set Group ID)
# 当文件被执行时，进程以文件所属组的身份运行
# 对目录: 新建文件继承目录的组
chmod g+s directory/

# Sticky位
# 对目录: 只有文件所有者才能删除目录中的文件
# 典型应用: /tmp目录
ls -ld /tmp
# drwxrwxrwt 10 root root 4096 2024-01-15 10:30 /tmp
#         ^ t表示Sticky位

# 设置特殊权限
chmod u+s executable    # 设置SUID
chmod g+s executable    # 设置SGID
chmod +t directory      # 设置Sticky位

# 数字表示法
chmod 4755 executable   # SUID + 755
chmod 2755 executable   # SGID + 755
chmod 1755 directory    # Sticky + 755

# 特殊权限管理脚本
SPECIAL_PERMISSIONS() {
    local file="$1"
    local perm="$2"
    
    if [ -z "$file" ] || [ -z "$perm" ]; then
        echo "用法: $0 <文件> <权限>"
        echo "权限: suid, sgid, sticky"
        return 1
    fi
    
    if [ ! -e "$file" ]; then
        echo "文件 $file 不存在"
        return 1
    fi
    
    echo "当前权限:"
    ls -l "$file"
    
    case "$perm" in
        "suid")
            chmod u+s "$file"
            echo "已设置SUID"
            ;;
        "sgid")
            chmod g+s "$file"
            echo "已设置SGID"
            ;;
        "sticky")
            chmod +t "$file"
            echo "已设置Sticky位"
            ;;
        *)
            echo "无效的权限类型"
            return 1
            ;;
    esac
    
    echo "新权限:"
    ls -l "$file"
}

# 使用示例
# SPECIAL_PERMISSIONS script.sh suid
# SPECIAL_PERMISSIONS shared_dir sticky
```

### 3.2 ACL访问控制列表

#### 3.2.1 ACL基础用法

```bash
#!/bin/bash
# ACL访问控制列表

# 检查文件系统是否支持ACL
mount | grep acl

# 查看ACL权限
getfacl filename

# 设置ACL权限
setfacl -m u:username:rw filename      # 给用户设置权限
setfacl -m g:groupname:r filename      # 给组设置权限
setfacl -m o::r filename               # 给其他用户设置权限
setfacl -m m::rwx filename             # 设置掩码

# 删除ACL权限
setfacl -x u:username filename         # 删除特定用户的ACL
setfacl -b filename                    # 删除所有ACL权限

# 递归设置ACL
setfacl -R -m u:username:rw directory/

# 复制ACL权限
getfacl source | setfacl --set-file=- destination

# ACL管理脚本
ACL_MANAGER() {
    local file="$1"
    local action="$2"
    local target="$3"
    local perms="$4"
    
    if [ -z "$file" ] || [ -z "$action" ]; then
        echo "用法: $0 <文件> <action> [目标] [权限]"
        echo "action: show, add, remove, reset"
        return 1
    fi
    
    case "$action" in
        "show")
            echo "=== ACL权限 ==="
            getfacl "$file"
            ;;
            
        "add")
            if [ -z "$target" ] || [ -z "$perms" ]; then
                echo "用法: $0 <文件> add <用户:权限>"
                echo "示例: $0 file.txt add u:username:rw"
                return 1
            fi
            
            setfacl -m "$target:$perms" "$file"
            echo "ACL权限已添加"
            getfacl "$file"
            ;;
            
        "remove")
            if [ -z "$target" ]; then
                echo "用法: $0 <文件> remove <用户>"
                return 1
            fi
            
            setfacl -x "$target" "$file"
            echo "ACL权限已删除"
            getfacl "$file"
            ;;
            
        "reset")
            setfacl -b "$file"
            echo "所有ACL权限已删除"
            ls -l "$file"
            ;;
            
        *)
            echo "无效的action"
            ;;
    esac
}

# 使用示例
# ACL_MANAGER file.txt show
# ACL_MANAGER file.txt add u:username:rw
# ACL_MANAGER file.txt remove u:username
```

## 4 系统安全工具

### 4.1 sudo权限管理

#### 4.1.1 sudo配置详解

```bash
#!/bin/bash
# sudo权限管理

# 查看sudo权限
sudo -l

# 编辑sudoers文件
sudo visudo

# 基本sudoers配置
# 允许用户执行所有命令
username ALL=(ALL:ALL) ALL

# 允许用户执行特定命令
username ALL=(ALL) /usr/bin/systemctl, /usr/bin/apt

# 允许组执行命令
%admin ALL=(ALL) ALL

# 无密码sudo
username ALL=(ALL) NOPASSWD: ALL

# 限制环境变量
Defaults env_reset
Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# sudo配置管理脚本
SUDO_MANAGER() {
    local username="$1"
    local action="$2"
    
    if [ -z "$username" ] || [ -z "$action" ]; then
        echo "用法: $0 <用户名> <action>"
        echo "action: add, remove, check"
        return 1
    fi
    
    case "$action" in
        "add")
            echo "添加用户 $username 到sudo组..."
            sudo usermod -aG sudo "$username"
            echo "用户 $username 现在可以使用sudo"
            ;;
            
        "remove")
            echo "从sudo组移除用户 $username..."
            sudo gpasswd -d "$username" sudo
            echo "用户 $username 已移除sudo权限"
            ;;
            
        "check")
            echo "检查用户 $username 的sudo权限..."
            sudo -l -U "$username" 2>/dev/null || echo "用户 $username 无sudo权限"
            ;;
            
        *)
            echo "无效的action"
            ;;
    esac
}

# 使用示例
# SUDO_MANAGER username add
# SUDO_MANAGER username check
```

### 4.2 文件完整性检查

#### 4.2.1 文件校验工具

```bash
#!/bin/bash
# 文件完整性检查

# MD5校验
md5sum filename

# SHA256校验
sha256sum filename

# 创建校验文件
md5sum *.txt > checksums.md5
sha256sum *.txt > checksums.sha256

# 验证校验和
md5sum -c checksums.md5
sha256sum -c checksums.sha256

# 文件完整性检查脚本
INTEGRITY_CHECKER() {
    local directory="$1"
    local algorithm="${2:-sha256}"
    
    if [ -z "$directory" ]; then
        echo "用法: $0 <目录> [算法]"
        echo "算法: md5, sha256"
        return 1
    fi
    
    if [ ! -d "$directory" ]; then
        echo "目录 $directory 不存在"
        return 1
    fi
    
    local checksum_file="$directory/checksums.$(date +%Y%m%d_%H%M%S).$algorithm"
    
    echo "创建文件校验和..."
    echo "目录: $directory"
    echo "算法: $algorithm"
    echo "输出文件: $checksum_file"
    echo ""
    
    case "$algorithm" in
        "md5")
            find "$directory" -type f -exec md5sum {} + > "$checksum_file"
            ;;
        "sha256")
            find "$directory" -type f -exec sha256sum {} + > "$checksum_file"
            ;;
        *)
            echo "不支持的算法"
            return 1
            ;;
    esac
    
    echo "校验文件已创建: $checksum_file"
    wc -l "$checksum_file"
}

# 验证完整性
VERIFY_INTEGRITY() {
    local checksum_file="$1"
    
    if [ -z "$checksum_file" ] || [ ! -f "$checksum_file" ]; then
        echo "用法: $0 <校验文件>"
        return 1
    fi
    
    echo "验证文件完整性..."
    
    case "$checksum_file" in
        *.md5)
            md5sum -c "$checksum_file" 2>/dev/null | grep -v "OK$" | head -10
            ;;
        *.sha256)
            sha256sum -c "$checksum_file" 2>/dev/null | grep -v "OK$" | head -10
            ;;
        *)
            echo "不支持的校验文件格式"
            return 1
            ;;
    esac
    
    echo "验证完成"
}

# 使用示例
# INTEGRITY_CHECKER /home/user/documents sha256
# VERIFY_INTEGRITY checksums.sha256
```

### 4.3 系统安全审计

#### 4.3.1 安全审计工具

```bash
#!/bin/bash
# 系统安全审计

# 检查文件权限
find / -type f -perm -4000 2>/dev/null    # 查找SUID文件
find / -type f -perm -2000 2>/dev/null    # 查找SGID文件
find / -type f -perm -6000 2>/dev/null    # 查找SUID和SGID文件

# 检查世界可写文件
find / -type f -perm -002 2>/dev/null     # 世界可写文件
find / -type f -perm -022 2>/dev/null     # 组和其他可写

# 检查空密码用户
awk -F: '($2 == "" || $2 == "*") {print $1}' /etc/shadow

# 检查UID为0的用户
awk -F: '($3 == 0) {print $1}' /etc/passwd

# 安全审计脚本
SECURITY_AUDIT() {
    local output_file="/tmp/security_audit_$(date +%Y%m%d_%H%M%S).txt"
    
    echo "=== 系统安全审计 ==="
    echo "时间: $(date)"
    echo "输出文件: $output_file"
    echo ""
    
    {
        echo "系统安全审计报告"
        echo "=================="
        echo "时间: $(date)"
        echo ""
        
        echo "1. 用户账户审计"
        echo "--------------"
        echo "UID为0的用户:"
        awk -F: '($3 == 0) {print "  " $1}' /etc/passwd
        echo ""
        
        echo "空密码用户:"
        awk -F: '($2 == "" || $2 == "*") {print "  " $1}' /etc/shadow 2>/dev/null || echo "  无"
        echo ""
        
        echo "2. 文件权限审计"
        echo "--------------"
        echo "SUID文件:"
        find / -type f -perm -4000 2>/dev/null | head -10
        echo ""
        
        echo "SGID文件:"
        find / -type f -perm -2000 2>/dev/null | head -10
        echo ""
        
        echo "世界可写文件:"
        find / -type f -perm -002 2>/dev/null | head -10
        echo ""
        
        echo "3. 网络服务审计"
        echo "--------------"
        echo "监听端口:"
        ss -tuln | grep LISTEN
        echo ""
        
        echo "4. 进程审计"
        echo "----------"
        echo "以root运行的进程:"
        ps aux | grep root | head -10
        echo ""
        
        echo "5. 系统信息"
        echo "----------"
        echo "操作系统: $(uname -a)"
        echo "内核版本: $(uname -r)"
        echo "主机名: $(hostname)"
        echo ""
        
    } > "$output_file"
    
    echo "安全审计完成"
    echo "报告已保存到: $output_file"
    wc -l "$output_file"
}

# 实时安全监控
SECURITY_MONITOR() {
    local log_file="/tmp/security_monitor_$(date +%Y%m%d).log"
    
    echo "=== 实时安全监控 ==="
    echo "日志文件: $log_file"
    echo "按Ctrl+C停止"
    
    trap 'echo "监控已停止"; exit 0' INT TERM
    
    while true; do
        local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        
        # 检查新进程
        local new_processes=$(ps aux --sort=-start_time | head -10)
        
        # 检查网络连接
        local new_connections=$(ss -tuln | grep -v "State")
        
        # 记录到日志
        {
            echo "[$timestamp] 进程快照:"
            echo "$new_processes"
            echo ""
            echo "[$timestamp] 网络连接:"
            echo "$new_connections"
            echo "================================"
        } >> "$log_file"
        
        sleep 60
    done
}

# 使用示例
# SECURITY_AUDIT
# SECURITY_MONITOR
```

## 5 防火墙与网络访问控制

### 5.1 iptables基础

#### 5.1.1 iptables规则管理

```bash
#!/bin/bash
# iptables防火墙管理

# 查看当前规则
sudo iptables -L -n -v

# 查看NAT表
sudo iptables -t nat -L -n -v

# 基本规则设置
sudo iptables -A INPUT -i lo -j ACCEPT                    # 允许本地回环
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT  # 允许已建立的连接
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT        # 允许SSH
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT        # 允许HTTP
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT       # 允许HTTPS
sudo iptables -A INPUT -j DROP                            # 拒绝其他所有

# 保存规则
sudo iptables-save > /etc/iptables/rules.v4

# 恢复规则
sudo iptables-restore < /etc/iptables/rules.v4

# 防火墙管理脚本
FIREWALL_MANAGER() {
    local action="$1"
    local port="$2"
    local protocol="${3:-tcp}"
    
    case "$action" in
        "status")
            echo "=== 当前防火墙规则 ==="
            sudo iptables -L -n -v
            ;;
            
        "allow")
            if [ -z "$port" ]; then
                echo "用法: $0 allow <端口> [协议]"
                return 1
            fi
            
            echo "允许 $protocol 端口 $port..."
            sudo iptables -A INPUT -p "$protocol" --dport "$port" -j ACCEPT
            echo "规则已添加"
            ;;
            
        "deny")
            if [ -z "$port" ]; then
                echo "用法: $0 deny <端口> [协议]"
                return 1
            fi
            
            echo "拒绝 $protocol 端口 $port..."
            sudo iptables -A INPUT -p "$protocol" --dport "$port" -j DROP
            echo "规则已添加"
            ;;
            
        "reset")
            echo "重置防火墙规则..."
            sudo iptables -F
            sudo iptables -X
            sudo iptables -t nat -F
            sudo iptables -t nat -X
            echo "防火墙已重置"
            ;;
            
        "save")
            echo "保存防火墙规则..."
            sudo iptables-save > /etc/iptables/rules.v4
            echo "规则已保存"
            ;;
            
        *)
            echo "用法: $0 {status|allow|deny|reset|save} [端口] [协议]"
            ;;
    esac
}

# 使用示例
# FIREWALL_MANAGER status
# FIREWALL_MANAGER allow 22
# FIREWALL_MANAGER save
```

#### 5.1.2 防火墙自动化脚本

```bash
#!/bin/bash
# 防火墙自动化配置

SETUP_FIREWALL() {
    local ssh_port="${1:-22}"
    
    echo "=== 设置基础防火墙 ==="
    echo "SSH端口: $ssh_port"
    echo ""
    
    # 清除现有规则
    sudo iptables -F
    sudo iptables -X
    sudo iptables -t nat -F
    sudo iptables -t nat -X
    
    # 设置默认策略
    sudo iptables -P INPUT DROP
    sudo iptables -P FORWARD DROP
    sudo iptables -P OUTPUT ACCEPT
    
    # 允许本地回环
    sudo iptables -A INPUT -i lo -j ACCEPT
    
    # 允许已建立的连接
    sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
    
    # 允许SSH
    sudo iptables -A INPUT -p tcp --dport "$ssh_port" -j ACCEPT
    
    # 允许HTTP和HTTPS
    sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
    sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
    
    # 允许Ping
    sudo iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
    
    # 记录被拒绝的包
    sudo iptables -A INPUT -j LOG --log-prefix "[FIREWALL-DROP] "
    
    echo "防火墙配置完成"
    echo "当前规则:"
    sudo iptables -L -n -v
    
    # 保存规则
    sudo mkdir -p /etc/iptables
    sudo iptables-save > /etc/iptables/rules.v4
    echo "规则已保存到 /etc/iptables/rules.v4"
}

# 使用示例
# SETUP_FIREWALL 22
```

这些安全工具和权限管理技术为系统管理员提供了全面的系统保护能力，从基础的文件权限到复杂的防火墙配置，都能有效保障系统安全。