# nmon命令详解

## 1 命令概述

nmon（Nigel's Monitor）是一个功能强大的系统性能监控工具，最初由IBM开发，用于AIX系统，后来移植到Linux系统。它可以收集和显示CPU、内存、网络、磁盘、文件系统、NFS、top进程等全面的系统性能信息。

### 1.1 功能特点

- 全面的系统性能监控
- 支持交互式操作和批处理模式
- 可生成详细的性能报告
- 支持多种输出格式（屏幕显示、CSV文件）
- 轻量级，对系统性能影响小
- 支持长时间监控和数据收集
- 内置分析工具

### 1.2 应用场景

- 系统性能基线建立
- 性能瓶颈分析
- 系统容量规划
- 长期性能趋势监控
- 性能调优和优化
- 故障排查和诊断

## 2 语法格式

```bash
nmon [选项]
```

## 3 常用选项

| 选项 | 说明 |
|------|------|
| `-h` | 显示帮助信息 |
| `-f` | 批处理模式，生成数据文件 |
| `-s` | 设置采样间隔（秒） |
| `-c` | 设置采样次数 |
| `-t` | 包含top进程信息 |
| `-r` | 设置报告标题 |
| `-m` | 设置输出目录 |
| `-d` | 设置磁盘统计间隔 |
| `-l` | 设置磁盘延迟阈值 |

## 4 常用示例

### 4.1 交互式使用

**命令示例**：
```bash
nmon
```

**界面说明**：
- 按`c`：显示CPU信息
- 按`m`：显示内存信息
- 按`d`：显示磁盘信息
- 按`n`：显示网络信息
- 按`v`：显示虚拟内存信息
- 按`t`：显示top进程
- 按`q`：退出

### 4.2 批处理模式

**命令示例**：
```bash
# 每30秒采样一次，共采样120次（1小时数据）
nmon -f -s 30 -c 120 -t -m /tmp/nmon_data
```

**输出文件**：
- 生成类似`hostname_YYYYMMDD_HHMM.nmon`的文件
- 包含所有系统性能数据
- 可用于后续分析

### 4.3 实时监控

**命令示例**：
```bash
# 每10秒采样，共采样60次（10分钟数据）
nmon -f -s 10 -c 60 -r "System Monitor" -t
```

### 4.4 指定监控时长

**命令示例**：
```bash
# 监控24小时，每5分钟采样一次
nmon -f -s 300 -c 288 -m /var/log/nmon/
```

## 5 高级用法

### 5.1 系统性能监控脚本

以下是一个基于nmon的系统性能监控脚本：

```bash
#!/bin/bash
# nmon_monitor.sh
# nmon系统性能监控脚本

# 配置参数
NMON_DIR="/var/log/nmon"
RETENTION_DAYS=30
SAMPLE_INTERVAL=60
SAMPLE_COUNT=1440
ALERT_CPU=80
ALERT_MEM=80
ALERT_DISK=90

# 创建目录
mkdir -p $NMON_DIR

# 获取系统信息
get_system_info() {
    echo "=== 系统信息 ==="
    echo "主机名: $(hostname)"
    echo "系统: $(uname -a)"
    echo "CPU核心数: $(nproc)"
    echo "总内存: $(free -h | grep Mem | awk '{print $2}')"
    echo "磁盘空间:"
    df -h | grep -E '^/dev'
}

# 启动nmon监控
start_nmon() {
    local timestamp=$(date +"%Y%m%d_%H%M%S")
    local filename="${NMON_DIR}/$(hostname)_${timestamp}.nmon"
    
    echo "启动nmon监控..."
    echo "输出文件: $filename"
    echo "采样间隔: ${SAMPLE_INTERVAL}秒"
    echo "采样次数: ${SAMPLE_COUNT}"
    
    nmon -f -s $SAMPLE_INTERVAL -c $SAMPLE_COUNT -t -r "System Performance Monitor" -m $NMON_DIR
    
    echo "nmon监控已启动，PID: $!"
}

# 清理旧文件
cleanup_old_files() {
    echo "清理${RETENTION_DAYS}天前的nmon文件..."
    find $NMON_DIR -name "*.nmon" -mtime +$RETENTION_DAYS -delete
    echo "清理完成"
}

# 实时分析
analyze_realtime() {
    echo "=== 实时系统状态 ==="
    
    # CPU使用率
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    echo "CPU使用率: ${cpu_usage}%"
    
    # 内存使用率
    local mem_usage=$(free | grep Mem | awk '{printf("%.2f", $3/$2 * 100.0)}')
    echo "内存使用率: ${mem_usage}%"
    
    # 磁盘使用率
    echo "磁盘使用率:"
    df -h | grep -E '^/dev' | awk '{print $1 ": " $5}'
    
    # 检查告警
    if (( $(echo "$cpu_usage > $ALERT_CPU" | bc -l) )); then
        echo "警告: CPU使用率过高!"
    fi
    
    if (( $(echo "$mem_usage > $ALERT_MEM" | bc -l) )); then
        echo "警告: 内存使用率过高!"
    fi
}

# 生成性能报告
generate_report() {
    local nmon_file=$1
    local report_file="${nmon_file%.nmon}_report.txt"
    
    echo "生成性能报告: $report_file"
    
    # 使用nmon analyser或自定义分析
    cat > $report_file << EOF
# nmon性能报告
文件: $(basename $nmon_file)
生成时间: $(date)

## 系统信息
$(get_system_info)

## 性能摘要
需要手动分析nmon文件获取详细数据

## 建议
- 使用nmon analyser工具分析CSV数据
- 关注CPU、内存、磁盘I/O峰值
- 检查网络流量异常
EOF
}

# 主函数
main() {
    case "$1" in
        "start")
            get_system_info
            start_nmon
            ;;
        "cleanup")
            cleanup_old_files
            ;;
        "analyze")
            analyze_realtime
            ;;
        "report")
            if [ -z "$2" ]; then
                echo "用法: $0 report <nmon_file>"
                exit 1
            fi
            generate_report $2
            ;;
        *)
            echo "用法: $0 {start|cleanup|analyze|report}"
            echo "  start   - 启动nmon监控"
            echo "  cleanup - 清理旧文件"
            echo "  analyze - 实时分析系统状态"
            echo "  report  - 生成性能报告"
            exit 1
            ;;
    esac
}

main "$@"
```

### 5.2 自动化部署

创建systemd服务进行自动化部署：

```bash
# /etc/systemd/system/nmon.service
[Unit]
Description=NMON System Monitor
After=network.target

[Service]
Type=forking
ExecStart=/usr/local/bin/nmon_monitor.sh start
ExecStop=/bin/kill -TERM $MAINPID
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 5.3 数据分析脚本

```bash
#!/bin/bash
# nmon_analyzer.sh
# nmon数据分析脚本

NMON_FILE=$1
OUTPUT_DIR="./analysis"

# 创建输出目录
mkdir -p $OUTPUT_DIR

# 提取CPU数据
echo "分析CPU数据..."
grep "CPU_ALL" $NMON_FILE | awk -F',' '{print $1,$2,$3,$4,$5}' > $OUTPUT_DIR/cpu_data.txt

# 提取内存数据
echo "分析内存数据..."
grep "MEM" $NMON_FILE | awk -F',' '{print $1,$2,$3,$4,$5}' > $OUTPUT_DIR/mem_data.txt

# 提取磁盘数据
echo "分析磁盘数据..."
grep "DISK" $NMON_FILE | awk -F',' '{print $1,$2,$3,$4}' > $OUTPUT_DIR/disk_data.txt

echo "分析完成，结果保存在: $OUTPUT_DIR"
```

## 6 常见问题与解决方案

### 6.1 nmon未安装

**问题**：命令未找到

**解决方案**：
```bash
# Ubuntu/Debian
sudo apt-get install nmon

# CentOS/RHEL
sudo yum install nmon

# 从源码编译
git clone https://github.com/ibm/nmon.git
cd nmon/makefiles
make nmon_linux_x86_64
```

### 6.2 权限问题

**问题**：无法创建输出文件

**解决方案**：
```bash
# 创建目录并设置权限
sudo mkdir -p /var/log/nmon
sudo chmod 755 /var/log/nmon
sudo chown $USER:$USER /var/log/nmon
```

### 6.3 数据文件过大

**问题**：长时间监控产生大文件

**解决方案**：
- 增加采样间隔
- 使用日志轮转
- 定期清理旧文件

### 6.4 时区问题

**问题**：时间戳不正确

**解决方案**：
```bash
# 设置正确的时区
sudo timedatectl set-timezone Asia/Shanghai
```

## 7 总结与注意事项

### 7.1 功能总结

nmon提供了：
- 全面的系统性能监控
- 灵活的采样配置
- 详细的性能数据
- 长期趋势分析能力

### 7.2 使用建议

1. **定期监控**：建立性能基线
2. **合理采样**：平衡数据精度和文件大小
3. **自动化**：使用脚本和服务自动化
4. **数据管理**：定期清理和分析历史数据

### 7.3 最佳实践

- 在高负载期间增加采样频率
- 使用批处理模式进行长期监控
- 结合其他工具进行综合分析
- 建立性能告警机制
- 定期审查和优化监控策略