# ç³»ç»Ÿæ€§èƒ½é—®é¢˜

## 1 CPUæ€§èƒ½é—®é¢˜

### 1.1 CPUä½¿ç”¨ç‡ç›‘æ§

#### 1.1.1 CPUä½¿ç”¨ç‡è¯Šæ–­

```bash
#!/bin/bash
# CPUä½¿ç”¨ç‡è¯Šæ–­

# å®æ—¶CPUç›‘æ§
CPU_MONITOR() {
    local interval="${1:-1}"
    local count="${2:-5}"
    
    echo "=== CPUä½¿ç”¨ç‡ç›‘æ§ ==="
    echo "é—´éš”: ${interval}ç§’"
    echo "æ¬¡æ•°: $count"
    echo ""
    
    # æ£€æŸ¥CPUä¿¡æ¯
    echo "CPUä¿¡æ¯:"
    grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs
    echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
    echo ""
    
    # å®æ—¶ç›‘æ§
    echo "CPUä½¿ç”¨ç‡ç›‘æ§:"
    for ((i=1; i<=count; i++)); do
        local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
        local load_avg=$(uptime | awk -F'load average:' '{print $2}' | cut -d, -f1 | xargs)
        
        printf "æ—¶é—´: %s | CPUä½¿ç”¨ç‡: %5.1f%% | è´Ÿè½½: %s\n" "$(date +%H:%M:%S)" "$cpu_usage" "$load_avg"
        
        if [ $i -lt $count ]; then
            sleep "$interval"
        fi
    done
}

# CPUä½¿ç”¨ç‡åˆ†æ
CPU_USAGE_ANALYSIS() {
    echo "=== CPUä½¿ç”¨ç‡åˆ†æ ==="
    echo "åˆ†ææ—¶é—´: $(date)"
    echo ""
    
    # å½“å‰CPUä½¿ç”¨ç‡
    echo "1. å½“å‰CPUä½¿ç”¨ç‡:"
    local current_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    echo "å½“å‰ä½¿ç”¨ç‡: ${current_usage}%"
    
    if (( $(echo "$current_usage > 80" | bc -l) )); then
        echo "âš ï¸  CPUä½¿ç”¨ç‡è¿‡é«˜ï¼"
    elif (( $(echo "$current_usage > 50" | bc -l) )); then
        echo "âš ï¸  CPUä½¿ç”¨ç‡ä¸­ç­‰"
    else
        echo "âœ… CPUä½¿ç”¨ç‡æ­£å¸¸"
    fi
    echo ""
    
    # è´Ÿè½½å¹³å‡å€¼
    echo "2. ç³»ç»Ÿè´Ÿè½½:"
    uptime | grep -E "load average:"
    
    local load_1min=$(uptime | awk -F'load average:' '{print $2}' | cut -d, -f1 | xargs)
    local cpu_cores=$(nproc)
    
    if (( $(echo "$load_1min > $cpu_cores" | bc -l) )); then
        echo "âš ï¸  è´Ÿè½½è¿‡é«˜ (è¶…è¿‡CPUæ ¸å¿ƒæ•°)"
    else
        echo "âœ… è´Ÿè½½æ­£å¸¸"
    fi
    echo ""
    
    # CPUä½¿ç”¨ç‡æœ€é«˜çš„è¿›ç¨‹
    echo "3. CPUä½¿ç”¨ç‡æœ€é«˜çš„è¿›ç¨‹:"
    ps aux --sort=-%cpu | head -6
    echo ""
    
    # CPUç»Ÿè®¡ä¿¡æ¯
    echo "4. CPUç»Ÿè®¡ä¿¡æ¯:"
    if [ -f /proc/stat ]; then
        grep "^cpu" /proc/stat | head -1
    fi
    echo ""
    
    # ä¸­æ–­ç»Ÿè®¡
    echo "5. ä¸­æ–­ç»Ÿè®¡ (å‰5ä¸ª):"
    if [ -f /proc/interrupts ]; then
        echo "CPU0 ä¸­æ–­ç»Ÿè®¡:"
        head -6 /proc/interrupts
    fi
}

# é«˜CPUä½¿ç”¨ç‡è¿›ç¨‹å¤„ç†
HIGH_CPU_PROCESS_HANDLER() {
    local threshold="${1:-80}"
    
    echo "=== é«˜CPUä½¿ç”¨ç‡è¿›ç¨‹å¤„ç† ==="
    echo "é˜ˆå€¼: ${threshold}%"
    echo ""
    
    # æŸ¥æ‰¾é«˜CPUä½¿ç”¨ç‡è¿›ç¨‹
    echo "æŸ¥æ‰¾é«˜CPUä½¿ç”¨ç‡è¿›ç¨‹..."
    local high_cpu_processes=$(ps aux --sort=-%cpu | awk -v threshold="$threshold" '$3 > threshold {print $0}' | head -10)
    
    if [ -z "$high_cpu_processes" ]; then
        echo "âœ… æœªå‘ç°é«˜CPUä½¿ç”¨ç‡è¿›ç¨‹"
        return 0
    fi
    
    echo "å‘ç°é«˜CPUä½¿ç”¨ç‡è¿›ç¨‹:"
    echo "$high_cpu_processes" | awk '{printf "%8s %8s %10s %s\n", $2, $3, $4, $11}'
    echo ""
    
    # åˆ†æè¿›ç¨‹
    echo "$high_cpu_processes" | while read user pid cpu mem cmd; do
        if [ -z "$pid" ] || [ "$pid" = "PID" ]; then
            continue
        fi
        
        echo "è¿›ç¨‹è¯¦æƒ… (PID: $pid):"
        echo "  å‘½ä»¤: $cmd"
        echo "  CPU: ${cpu}%"
        echo "  å†…å­˜: ${mem}%"
        
        # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
        if [ -f "/proc/$pid/stat" ]; then
            local state=$(awk '{print $3}' "/proc/$pid/stat")
            echo "  çŠ¶æ€: $state"
        fi
        
        # æ£€æŸ¥è¿›ç¨‹å¯åŠ¨æ—¶é—´
        local start_time=$(ps -o lstart= -p "$pid" 2>/dev/null || echo "æœªçŸ¥")
        echo "  å¯åŠ¨æ—¶é—´: $start_time"
        echo ""
    done
    
    # æä¾›å¤„ç†å»ºè®®
    echo "å¤„ç†å»ºè®®:"
    echo "1. åˆ†æè¿›ç¨‹æ˜¯å¦æ­£å¸¸ä¸šåŠ¡è¿›ç¨‹"
    echo "2. è€ƒè™‘ä¼˜åŒ–ç›¸å…³åº”ç”¨ç¨‹åº"
    echo "3. å¿…è¦æ—¶å¯ä»¥ç»ˆæ­¢å¼‚å¸¸è¿›ç¨‹"
    echo "4. æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½å’Œæ€§èƒ½ç“¶é¢ˆ"
}

# ä½¿ç”¨ç¤ºä¾‹
# CPU_MONITOR 2 10
# CPU_USAGE_ANALYSIS
# HIGH_CPU_PROCESS_HANDLER 90
```

#### 1.1.2 CPUæ€§èƒ½ä¼˜åŒ–

```bash
#!/bin/bash
# CPUæ€§èƒ½ä¼˜åŒ–

# CPUé¢‘ç‡è°ƒèŠ‚
CPU_FREQUENCY_OPTIMIZE() {
    echo "=== CPUé¢‘ç‡ä¼˜åŒ– ==="
    echo "ä¼˜åŒ–æ—¶é—´: $(date)"
    echo ""
    
    # æ£€æŸ¥CPUé¢‘ç‡ä¿¡æ¯
    echo "1. å½“å‰CPUé¢‘ç‡ä¿¡æ¯:"
    if [ -d /sys/devices/system/cpu/cpu0/cpufreq ]; then
        echo "CPU0å½“å‰é¢‘ç‡: $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2>/dev/null || echo "æœªçŸ¥")"
        echo "CPU0æœ€å°é¢‘ç‡: $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq 2>/dev/null || echo "æœªçŸ¥")"
        echo "CPU0æœ€å¤§é¢‘ç‡: $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq 2>/dev/null || echo "æœªçŸ¥")"
        echo "CPU0è°ƒèŠ‚å™¨: $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null || echo "æœªçŸ¥")"
    else
        echo "CPUé¢‘ç‡è°ƒèŠ‚ä¸å¯ç”¨"
    fi
    echo ""
    
    # è®¾ç½®CPUæ€§èƒ½æ¨¡å¼
    echo "2. è®¾ç½®CPUæ€§èƒ½æ¨¡å¼..."
    if [ -d /sys/devices/system/cpu ]; then
        # è®¾ç½®ä¸ºæ€§èƒ½æ¨¡å¼
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
            if [ -f "$cpu" ]; then
                echo "performance" | sudo tee "$cpu" >/dev/null 2>&1 || true
            fi
        done
        
        # è®¾ç½®ä¸ºæœ€å¤§é¢‘ç‡
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_max_freq; do
            if [ -f "$cpu" ]; then
                local max_freq=$(cat "${cpu/max_freq/cpuinfo_max_freq}")
                echo "$max_freq" | sudo tee "$cpu" >/dev/null 2>&1 || true
            fi
        done
        
        echo "âœ… CPUæ€§èƒ½æ¨¡å¼å·²è®¾ç½®"
    else
        echo "âŒ CPUé¢‘ç‡è°ƒèŠ‚ä¸å¯ç”¨"
    fi
    echo ""
    
    # CPUäº²å’Œæ€§ä¼˜åŒ–
    echo "3. CPUäº²å’Œæ€§ä¼˜åŒ–..."
    local cpu_cores=$(nproc)
    echo "CPUæ ¸å¿ƒæ•°: $cpu_cores"
    
    # è®¾ç½®ä¸­æ–­äº²å’Œæ€§
    if [ -d /proc/irq ]; then
        for irq in /proc/irq/*/; do
            if [ -f "$irq/smp_affinity" ]; then
                # è®¾ç½®ä¸­æ–­åˆ°æ‰€æœ‰CPU
                local affinity_mask=$(printf "%x" $(( (1 << cpu_cores) - 1 )))
                echo "$affinity_mask" | sudo tee "$irq/smp_affinity" >/dev/null 2>&1 || true
            fi
        done
        echo "âœ… ä¸­æ–­äº²å’Œæ€§å·²ä¼˜åŒ–"
    fi
}

# CPUè´Ÿè½½å‡è¡¡
CPU_LOAD_BALANCE() {
    echo "=== CPUè´Ÿè½½å‡è¡¡ ==="
    echo "å‡è¡¡æ—¶é—´: $(date)"
    echo ""
    
    # æ£€æŸ¥CPUè´Ÿè½½
    echo "1. å½“å‰CPUè´Ÿè½½åˆ†å¸ƒ:"
    if [ -f /proc/stat ]; then
        grep "^cpu[0-9]" /proc/stat | head -8
    fi
    echo ""
    
    # è¿›ç¨‹CPUäº²å’Œæ€§æ£€æŸ¥
    echo "2. é«˜CPUä½¿ç”¨ç‡è¿›ç¨‹äº²å’Œæ€§:"
    ps aux --sort=-%cpu | head -6 | while read user pid cpu mem cmd; do
        if [ "$pid" != "PID" ] && [ -n "$pid" ]; then
            local affinity=$(taskset -cp "$pid" 2>/dev/null | cut -d: -f2 | xargs || echo "æœªçŸ¥")
            printf "PID: %-6s CPUäº²å’Œæ€§: %s å‘½ä»¤: %s\n" "$pid" "$affinity" "$cmd"
        fi
    done
    echo ""
    
    # è´Ÿè½½å‡è¡¡ä¼˜åŒ–
    echo "3. è´Ÿè½½å‡è¡¡ä¼˜åŒ–..."
    local cpu_cores=$(nproc)
    
    # è·å–é«˜CPUä½¿ç”¨ç‡è¿›ç¨‹
    ps aux --sort=-%cpu | head -6 | while read user pid cpu mem cmd; do
        if [ "$pid" != "PID" ] && [ -n "$pid" ]; then
            # è·³è¿‡ç³»ç»Ÿè¿›ç¨‹
            if [[ "$cmd" =~ ^\[.*\]$ ]]; then
                continue
            fi
            
            # è®¾ç½®è¿›ç¨‹åˆ°ä¸åŒCPU
            local target_cpu=$(( pid % cpu_cores ))
            taskset -cp "$target_cpu" "$pid" >/dev/null 2>&1 || true
            echo "  PID $pid å·²åˆ†é…åˆ°CPU $target_cpu"
        fi
    done
    
    echo "âœ… CPUè´Ÿè½½å‡è¡¡ä¼˜åŒ–å®Œæˆ"
}

# CPUç›‘æ§å’ŒæŠ¥è­¦
CPU_MONITOR_ALERT() {
    local threshold="${1:-80}"
    local check_interval="${2:-30}"
    local alert_count="${3:-3}"
    
    echo "=== CPUç›‘æ§å’ŒæŠ¥è­¦ ==="
    echo "é˜ˆå€¼: ${threshold}%"
    echo "æ£€æŸ¥é—´éš”: ${check_interval}ç§’"
    echo "æŠ¥è­¦æ¬¡æ•°: $alert_count"
    echo ""
    echo "æŒ‰ Ctrl+C åœæ­¢ç›‘æ§"
    echo ""
    
    local high_cpu_count=0
    local log_file="/var/log/cpu_monitor.log"
    
    while true; do
        local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
        local current_time=$(date "+%Y-%m-%d %H:%M:%S")
        
        if (( $(echo "$cpu_usage > $threshold" | bc -l) )); then
            high_cpu_count=$((high_cpu_count + 1))
            echo "âš ï¸  [$current_time] CPUä½¿ç”¨ç‡è¿‡é«˜: ${cpu_usage}% (ç¬¬${high_cpu_count}æ¬¡)"
            
            # è®°å½•æ—¥å¿—
            echo "[$current_time] CPUä½¿ç”¨ç‡è¿‡é«˜: ${cpu_usage}%" >> "$log_file"
            
            # å¦‚æœè¶…è¿‡æŠ¥è­¦æ¬¡æ•°ï¼Œæ‰§è¡Œå¤„ç†
            if [ $high_cpu_count -ge $alert_count ]; then
                echo "ğŸ”¥  CPUä½¿ç”¨ç‡æŒç»­è¿‡é«˜ï¼Œæ‰§è¡Œå¤„ç†..."
                
                # è·å–é«˜CPUè¿›ç¨‹
                local high_cpu_process=$(ps aux --sort=-%cpu | awk 'NR==2{print $2":"$3":"$11}')
                echo "é«˜CPUè¿›ç¨‹: $high_cpu_process"
                
                # å‘é€é€šçŸ¥
                if command -v notify-send >/dev/null 2>&1; then
                    notify-send "CPUæŠ¥è­¦" "CPUä½¿ç”¨ç‡: ${cpu_usage}%" -u critical
                fi
                
                # é‡ç½®è®¡æ•°
                high_cpu_count=0
            fi
        else
            high_cpu_count=0
            echo "âœ… [$current_time] CPUä½¿ç”¨ç‡æ­£å¸¸: ${cpu_usage}%"
        fi
        
        sleep "$check_interval"
    done
}

# ä½¿ç”¨ç¤ºä¾‹
# CPU_FREQUENCY_OPTIMIZE
# CPU_LOAD_BALANCE
# CPU_MONITOR_ALERT 85 60 5
```

## 2 å†…å­˜æ€§èƒ½é—®é¢˜

### 2.1 å†…å­˜ä½¿ç”¨ç‡ç›‘æ§

#### 2.1.1 å†…å­˜ä½¿ç”¨ç‡è¯Šæ–­

```bash
#!/bin/bash
# å†…å­˜ä½¿ç”¨ç‡è¯Šæ–­

# å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§
MEMORY_MONITOR() {
    local interval="${1:-1}"
    local count="${2:-5}"
    
    echo "=== å†…å­˜ä½¿ç”¨ç‡ç›‘æ§ ==="
    echo "é—´éš”: ${interval}ç§’"
    echo "æ¬¡æ•°: $count"
    echo ""
    
    # å†…å­˜ä¿¡æ¯
    echo "å†…å­˜ä¿¡æ¯:"
    free -h | grep -E "(Mem|Swap)"
    echo ""
    
    # å®æ—¶ç›‘æ§
    echo "å†…å­˜ä½¿ç”¨ç‡ç›‘æ§:"
    for ((i=1; i<=count; i++)); do
        local mem_info=$(free | grep "Mem:")
        local total=$(echo "$mem_info" | awk '{print $2}')
        local used=$(echo "$mem_info" | awk '{print $3}')
        local free=$(echo "$mem_info" | awk '{print $4}')
        local usage_percent=$(echo "scale=1; $used * 100 / $total" | bc)
        
        local swap_info=$(free | grep "Swap:")
        local swap_total=$(echo "$swap_info" | awk '{print $2}')
        local swap_used=$(echo "$swap_info" | awk '{print $3}')
        local swap_percent=0
        
        if [ "$swap_total" -gt 0 ]; then
            swap_percent=$(echo "scale=1; $swap_used * 100 / $swap_total" | bc)
        fi
        
        printf "æ—¶é—´: %s | å†…å­˜ä½¿ç”¨: %5.1f%% | äº¤æ¢åˆ†åŒº: %5.1f%%\n" "$(date +%H:%M:%S)" "$usage_percent" "$swap_percent"
        
        if [ $i -lt $count ]; then
            sleep "$interval"
        fi
    done
}

# å†…å­˜ä½¿ç”¨ç‡åˆ†æ
MEMORY_USAGE_ANALYSIS() {
    echo "=== å†…å­˜ä½¿ç”¨ç‡åˆ†æ ==="
    echo "åˆ†ææ—¶é—´: $(date)"
    echo ""
    
    # å†…å­˜æ€»ä½“ä½¿ç”¨æƒ…å†µ
    echo "1. å†…å­˜æ€»ä½“ä½¿ç”¨æƒ…å†µ:"
    free -h
    echo ""
    
    # å†…å­˜ä½¿ç”¨ç‡è®¡ç®—
    local mem_info=$(free | grep "Mem:")
    local total=$(echo "$mem_info" | awk '{print $2}')
    local used=$(echo "$mem_info" | awk '{print $3}')
    local cached=$(echo "$mem_info" | awk '{print $6}')
    local buffers=$(echo "$mem_info" | awk '{print $5}')
    local usage_percent=$(echo "scale=1; $used * 100 / $total" | bc)
    local real_used=$(echo "$used - $cached - $buffers" | bc)
    local real_percent=$(echo "scale=1; $real_used * 100 / $total" | bc)
    
    echo "2. å†…å­˜ä½¿ç”¨ç‡åˆ†æ:"
    echo "æ€»å†…å­˜: $(echo "$total" | awk '{print $1/1024/1024}')GB"
    echo "å·²ä½¿ç”¨: $(echo "$used" | awk '{print $1/1024/1024}')GB ($usage_percent%)"
    echo "å®é™…ä½¿ç”¨: $(echo "$real_used" | awk '{print $1/1024/1024}')GB ($real_percent%)"
    echo "ç¼“å­˜: $(echo "$cached" | awk '{print $1/1024/1024}')GB"
    echo "ç¼“å†²åŒº: $(echo "$buffers" | awk '{print $1/1024/1024}')GB"
    echo ""
    
    if (( $(echo "$usage_percent > 80" | bc -l) )); then
        echo "âš ï¸  å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼"
    elif (( $(echo "$usage_percent > 60" | bc -l) )); then
        echo "âš ï¸  å†…å­˜ä½¿ç”¨ç‡ä¸­ç­‰"
    else
        echo "âœ… å†…å­˜ä½¿ç”¨ç‡æ­£å¸¸"
    fi
    echo ""
    
    # å†…å­˜ä½¿ç”¨ç‡æœ€é«˜çš„è¿›ç¨‹
    echo "3. å†…å­˜ä½¿ç”¨ç‡æœ€é«˜çš„è¿›ç¨‹:"
    ps aux --sort=-%mem | head -6
    echo ""
    
    # äº¤æ¢åˆ†åŒºä½¿ç”¨æƒ…å†µ
    echo "4. äº¤æ¢åˆ†åŒºä½¿ç”¨æƒ…å†µ:"
    local swap_info=$(free | grep "Swap:")
    local swap_total=$(echo "$swap_info" | awk '{print $2}')
    local swap_used=$(echo "$swap_info" | awk '{print $3}')
    
    if [ "$swap_total" -gt 0 ]; then
        local swap_percent=$(echo "scale=1; $swap_used * 100 / $swap_total" | bc)
        echo "äº¤æ¢åˆ†åŒºæ€»å¤§å°: $(echo "$swap_total" | awk '{print $1/1024/1024}')GB"
        echo "äº¤æ¢åˆ†åŒºå·²ä½¿ç”¨: $(echo "$swap_used" | awk '{print $1/1024/1024}')GB ($swap_percent%)"
        
        if (( $(echo "$swap_percent > 50" | bc -l) )); then
            echo "âš ï¸  äº¤æ¢åˆ†åŒºä½¿ç”¨ç‡è¿‡é«˜ï¼"
        else
            echo "âœ… äº¤æ¢åˆ†åŒºä½¿ç”¨ç‡æ­£å¸¸"
        fi
    else
        echo "æ— äº¤æ¢åˆ†åŒº"
    fi
    echo ""
    
    # å†…å­˜è¯¦ç»†ä¿¡æ¯
    echo "5. å†…å­˜è¯¦ç»†ä¿¡æ¯:"
    cat /proc/meminfo | head -10
}

# å†…å­˜æ³„æ¼æ£€æµ‹
MEMORY_LEAK_DETECTION() {
    local process_name="$1"
    local check_interval="${2:-30}"
    local check_count="${3:-5}"
    
    echo "=== å†…å­˜æ³„æ¼æ£€æµ‹ ==="
    echo "è¿›ç¨‹: ${process_name:-æ‰€æœ‰è¿›ç¨‹}"
    echo "æ£€æŸ¥é—´éš”: ${check_interval}ç§’"
    echo "æ£€æŸ¥æ¬¡æ•°: $check_count"
    echo ""
    
    if [ -n "$process_name" ]; then
        local pids=$(pgrep "$process_name")
        if [ -z "$pids" ]; then
            echo "âŒ æœªæ‰¾åˆ°è¿›ç¨‹: $process_name"
            return 1
        fi
        
        echo "æ‰¾åˆ°è¿›ç¨‹PID: $pids"
        echo ""
        
        # ç›‘æ§ç‰¹å®šè¿›ç¨‹çš„å†…å­˜ä½¿ç”¨
        for ((i=1; i<=check_count; i++)); do
            echo "ç¬¬ $i æ¬¡æ£€æŸ¥:"
            for pid in $pids; do
                if [ -f "/proc/$pid/status" ]; then
                    local mem_info=$(grep "VmRSS" "/proc/$pid/status" 2>/dev/null || echo "VmRSS: 0 kB")
                    local mem_kb=$(echo "$mem_info" | awk '{print $2}')
                    local mem_mb=$(echo "scale=1; $mem_kb / 1024" | bc)
                    printf "  PID %-6s: %8s MB\n" "$pid" "$mem_mb"
                fi
            done
            
            if [ $i -lt $check_count ]; then
                sleep "$check_interval"
            fi
        done
    else
        # ç›‘æ§æ‰€æœ‰è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨è¶‹åŠ¿
        echo "ç›‘æ§æ‰€æœ‰è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨è¶‹åŠ¿..."
        for ((i=1; i<=check_count; i++)); do
            echo "ç¬¬ $i æ¬¡æ£€æŸ¥:"
            ps aux --sort=-%mem | head -6
            echo ""
            
            if [ $i -lt $check_count ]; then
                sleep "$check_interval"
            fi
        done
    fi
    
    # åˆ†æç»“æœ
    echo "å†…å­˜æ³„æ¼åˆ†æ:"
    echo "1. å¦‚æœè¿›ç¨‹å†…å­˜æŒç»­å¢é•¿ï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼"
    echo "2. å»ºè®®æ£€æŸ¥è¿›ç¨‹çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾"
    echo "3. å¯ä»¥ä½¿ç”¨valgrindç­‰å·¥å…·è¿›è¡Œè¯¦ç»†åˆ†æ"
}

# é«˜å†…å­˜ä½¿ç”¨ç‡è¿›ç¨‹å¤„ç†
HIGH_MEMORY_PROCESS_HANDLER() {
    local threshold="${1:-70}"
    
    echo "=== é«˜å†…å­˜ä½¿ç”¨ç‡è¿›ç¨‹å¤„ç† ==="
    echo "é˜ˆå€¼: ${threshold}%"
    echo ""
    
    # æŸ¥æ‰¾é«˜å†…å­˜ä½¿ç”¨ç‡è¿›ç¨‹
    echo "æŸ¥æ‰¾é«˜å†…å­˜ä½¿ç”¨ç‡è¿›ç¨‹..."
    local high_mem_processes=$(ps aux --sort=-%mem | awk -v threshold="$threshold" '$4 > threshold {print $0}' | head -10)
    
    if [ -z "$high_mem_processes" ]; then
        echo "âœ… æœªå‘ç°é«˜å†…å­˜ä½¿ç”¨ç‡è¿›ç¨‹"
        return 0
    fi
    
    echo "å‘ç°é«˜å†…å­˜ä½¿ç”¨ç‡è¿›ç¨‹:"
    echo "$high_mem_processes" | awk '{printf "%8s %8s %10s %s\n", $2, $4, $5, $11}'
    echo ""
    
    # åˆ†æè¿›ç¨‹
    echo "$high_mem_processes" | while read user pid cpu mem vsz rss cmd; do
        if [ -z "$pid" ] || [ "$pid" = "PID" ]; then
            continue
        fi
        
        echo "è¿›ç¨‹è¯¦æƒ… (PID: $pid):"
        echo "  å‘½ä»¤: $cmd"
        echo "  å†…å­˜: ${mem}%"
        echo "  è™šæ‹Ÿå†…å­˜: $(echo "$vsz" | awk '{print $1/1024}')MB"
        echo "  ç‰©ç†å†…å­˜: $(echo "$rss" | awk '{print $1/1024}')MB"
        
        # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
        if [ -f "/proc/$pid/status" ]; then
            local mem_info=$(grep "VmRSS" "/proc/$pid/status" 2>/dev/null || echo "VmRSS: 0 kB")
            echo "  RSSå†…å­˜: $mem_info"
        fi
        
        echo ""
    done
    
    # æä¾›å¤„ç†å»ºè®®
    echo "å¤„ç†å»ºè®®:"
    echo "1. åˆ†æè¿›ç¨‹æ˜¯å¦æ­£å¸¸ä¸šåŠ¡è¿›ç¨‹"
    echo "2. è€ƒè™‘ä¼˜åŒ–ç›¸å…³åº”ç”¨ç¨‹åºçš„å†…å­˜ä½¿ç”¨"
    echo "3. å¿…è¦æ—¶å¯ä»¥é‡å¯å†…å­˜æ³„æ¼çš„è¿›ç¨‹"
    echo "4. æ£€æŸ¥ç³»ç»Ÿå†…å­˜é…ç½®å’Œé™åˆ¶"
}

# ä½¿ç”¨ç¤ºä¾‹
# MEMORY_MONITOR 2 10
# MEMORY_USAGE_ANALYSIS
# MEMORY_LEAK_DETECTION nginx 60 10
# HIGH_MEMORY_PROCESS_HANDLER 80
```

#### 2.1.2 å†…å­˜æ€§èƒ½ä¼˜åŒ–

```bash
#!/bin/bash
# å†…å­˜æ€§èƒ½ä¼˜åŒ–

# å†…å­˜ç¼“å­˜ä¼˜åŒ–
MEMORY_CACHE_OPTIMIZE() {
    echo "=== å†…å­˜ç¼“å­˜ä¼˜åŒ– ==="
    echo "ä¼˜åŒ–æ—¶é—´: $(date)"
    echo ""
    
    # å½“å‰å†…å­˜ç¼“å­˜çŠ¶æ€
    echo "1. å½“å‰å†…å­˜ç¼“å­˜çŠ¶æ€:"
    free -h
    echo ""
    
    # æ¸…ç†å†…å­˜ç¼“å­˜
    echo "2. æ¸…ç†å†…å­˜ç¼“å­˜..."
    echo "æ¸…ç†å‰å†…å­˜çŠ¶æ€:"
    free -h
    echo ""
    
    # æ¸…ç†é¡µé¢ç¼“å­˜
    echo "æ¸…ç†é¡µé¢ç¼“å­˜..."
    sudo sync
    echo 1 | sudo tee /proc/sys/vm/drop_caches >/dev/null
    
    # æ¸…ç†ç›®å½•é¡¹å’Œinodeç¼“å­˜
    echo "æ¸…ç†ç›®å½•é¡¹å’Œinodeç¼“å­˜..."
    echo 2 | sudo tee /proc/sys/vm/drop_caches >/dev/null
    
    # æ¸…ç†æ‰€æœ‰ç¼“å­˜
    echo "æ¸…ç†æ‰€æœ‰ç¼“å­˜..."
    echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null
    
    echo "æ¸…ç†åå†…å­˜çŠ¶æ€:"
    free -h
    echo ""
    
    # å†…å­˜ç¼“å­˜å‚æ•°ä¼˜åŒ–
    echo "3. å†…å­˜ç¼“å­˜å‚æ•°ä¼˜åŒ–..."
    
    # ä¼˜åŒ–è„é¡µæ¯”ä¾‹
    echo "ä¼˜åŒ–è„é¡µæ¯”ä¾‹..."
    echo 10 | sudo tee /proc/sys/vm/dirty_ratio >/dev/null
    echo 5 | sudo tee /proc/sys/vm/dirty_background_ratio >/dev/null
    
    # ä¼˜åŒ–å†…å­˜å›æ”¶
    echo "ä¼˜åŒ–å†…å­˜å›æ”¶..."
    echo 10 | sudo tee /proc/sys/vm/swappiness >/dev/null
    echo 50 | sudo tee /proc/sys/vm/vfs_cache_pressure >/dev/null
    
    echo "âœ… å†…å­˜ç¼“å­˜ä¼˜åŒ–å®Œæˆ"
}

# äº¤æ¢åˆ†åŒºä¼˜åŒ–
SWAP_OPTIMIZE() {
    echo "=== äº¤æ¢åˆ†åŒºä¼˜åŒ– ==="
    echo "ä¼˜åŒ–æ—¶é—´: $(date)"
    echo ""
    
    # å½“å‰äº¤æ¢åˆ†åŒºçŠ¶æ€
    echo "1. å½“å‰äº¤æ¢åˆ†åŒºçŠ¶æ€:"
    swapon --show
    echo ""
    free -h | grep Swap
    echo ""
    
    # æ£€æŸ¥äº¤æ¢åˆ†åŒºä½¿ç”¨æƒ…å†µ
    local swap_info=$(free | grep "Swap:")
    local swap_total=$(echo "$swap_info" | awk '{print $2}')
    local swap_used=$(echo "$swap_info" | awk '{print $3}')
    
    if [ "$swap_total" -eq 0 ]; then
        echo "âš ï¸  æœªé…ç½®äº¤æ¢åˆ†åŒº"
        echo "å»ºè®®åˆ›å»ºäº¤æ¢åˆ†åŒºæˆ–äº¤æ¢æ–‡ä»¶"
        return 1
    fi
    
    local swap_percent=$(echo "scale=1; $swap_used * 100 / $swap_total" | bc)
    echo "äº¤æ¢åˆ†åŒºä½¿ç”¨ç‡: $swap_percent%"
    echo ""
    
    # ä¼˜åŒ–äº¤æ¢åˆ†åŒºä½¿ç”¨
    echo "2. ä¼˜åŒ–äº¤æ¢åˆ†åŒºä½¿ç”¨..."
    
    # å‡å°‘äº¤æ¢åˆ†åŒºä½¿ç”¨å€¾å‘
    echo "å‡å°‘äº¤æ¢åˆ†åŒºä½¿ç”¨å€¾å‘..."
    echo 10 | sudo tee /proc/sys/vm/swappiness >/dev/null
    
    # æ¸…ç†äº¤æ¢åˆ†åŒºç¼“å­˜
    if [ "$swap_used" -gt 0 ]; then
        echo "æ¸…ç†äº¤æ¢åˆ†åŒºç¼“å­˜..."
        sudo swapoff -a
        sudo swapon -a
        echo "âœ… äº¤æ¢åˆ†åŒºç¼“å­˜å·²æ¸…ç†"
    fi
    
    # æ£€æŸ¥äº¤æ¢åˆ†åŒºä¼˜å…ˆçº§
    echo "3. äº¤æ¢åˆ†åŒºä¼˜å…ˆçº§æ£€æŸ¥..."
    swapon --show | grep -v "NAME" | while read name type size used prio; do
        echo "äº¤æ¢åˆ†åŒº: $name (ä¼˜å…ˆçº§: $prio)"
    done
    echo ""
    
    # ä¼˜åŒ–äº¤æ¢åˆ†åŒºæ€§èƒ½
    echo "4. ä¼˜åŒ–äº¤æ¢åˆ†åŒºæ€§èƒ½..."
    
    # å¯ç”¨äº¤æ¢åˆ†åŒºå‹ç¼©
    if command -v zramctl >/dev/null 2>&1; then
        echo "é…ç½®zramäº¤æ¢åˆ†åŒº..."
        # åˆ›å»ºzramè®¾å¤‡
        sudo modprobe zram num_devices=1
        echo "$(echo "$(free -b | grep Mem | awk '{print $2}') / 4" | bc)" | sudo tee /sys/block/zram0/disksize >/dev/null
        sudo mkswap /dev/zram0
        sudo swapon /dev/zram0
        echo "âœ… zramäº¤æ¢åˆ†åŒºå·²é…ç½®"
    fi
    
    echo "âœ… äº¤æ¢åˆ†åŒºä¼˜åŒ–å®Œæˆ"
}

# å†…å­˜ç¢ç‰‡æ•´ç†
MEMORY_DEFRAGMENTATION() {
    echo "=== å†…å­˜ç¢ç‰‡æ•´ç† ==="
    echo "æ•´ç†æ—¶é—´: $(date)"
    echo ""
    
    # æ£€æŸ¥å†…å­˜ç¢ç‰‡
    echo "1. æ£€æŸ¥å†…å­˜ç¢ç‰‡..."
    if [ -f /proc/buddyinfo ]; then
        echo "å†…å­˜ç¢ç‰‡ä¿¡æ¯:"
        cat /proc/buddyinfo
        echo ""
    fi
    
    # å†…å­˜ç¢ç‰‡æ•´ç†
    echo "2. å†…å­˜ç¢ç‰‡æ•´ç†..."
    
    # æ¸…ç†å†…å­˜ç¼“å­˜
    echo "æ¸…ç†å†…å­˜ç¼“å­˜..."
    sudo sync
    echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null
    
    # å‹ç¼©å†…å­˜
    if command -v zramctl >/dev/null 2>&1; then
        echo "å‹ç¼©å†…å­˜..."
        echo 1 | sudo tee /sys/block/zram0/comp_algorithm >/dev/null 2>/dev/null || true
    fi
    
    # å†…å­˜æ•´ç†
    echo "å†…å­˜æ•´ç†..."
    echo 1 | sudo tee /proc/sys/vm/compact_memory >/dev/null 2>/dev/null || true
    
    # ç­‰å¾…æ•´ç†å®Œæˆ
    sleep 2
    
    # æ£€æŸ¥æ•´ç†ç»“æœ
    echo "3. æ£€æŸ¥æ•´ç†ç»“æœ..."
    free -h
    echo ""
    
    if [ -f /proc/buddyinfo ]; then
        echo "æ•´ç†åçš„å†…å­˜ç¢ç‰‡ä¿¡æ¯:"
        cat /proc/buddyinfo
    fi
    
    echo "âœ… å†…å­˜ç¢ç‰‡æ•´ç†å®Œæˆ"
}

# å†…å­˜ç›‘æ§å’ŒæŠ¥è­¦
MEMORY_MONITOR_ALERT() {
    local threshold="${1:-80}"
    local check_interval="${2:-30}"
    local alert_count="${3:-3}"
    
    echo "=== å†…å­˜ç›‘æ§å’ŒæŠ¥è­¦ ==="
    echo "é˜ˆå€¼: ${threshold}%"
    echo "æ£€æŸ¥é—´éš”: ${check_interval}ç§’"
    echo "æŠ¥è­¦æ¬¡æ•°: $alert_count"
    echo ""
    echo "æŒ‰ Ctrl+C åœæ­¢ç›‘æ§"
    echo ""
    
    local high_mem_count=0
    local log_file="/var/log/memory_monitor.log"
    
    while true; do
        local mem_info=$(free | grep "Mem:")
        local total=$(echo "$mem_info" | awk '{print $2}')
        local used=$(echo "$mem_info" | awk '{print $3}')
        local usage_percent=$(echo "scale=1; $used * 100 / $total" | bc)
        local current_time=$(date "+%Y-%m-%d %H:%M:%S")
        
        if (( $(echo "$usage_percent > $threshold" | bc -l) )); then
            high_mem_count=$((high_mem_count + 1))
            echo "âš ï¸  [$current_time] å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${usage_percent}% (ç¬¬${high_mem_count}æ¬¡)"
            
            # è®°å½•æ—¥å¿—
            echo "[$current_time] å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${usage_percent}%" >> "$log_file"
            
            # å¦‚æœè¶…è¿‡æŠ¥è­¦æ¬¡æ•°ï¼Œæ‰§è¡Œå¤„ç†
            if [ $high_mem_count -ge $alert_count ]; then
                echo "ğŸ”¥  å†…å­˜ä½¿ç”¨ç‡æŒç»­è¿‡é«˜ï¼Œæ‰§è¡Œå¤„ç†..."
                
                # æ¸…ç†å†…å­˜ç¼“å­˜
                echo "æ¸…ç†å†…å­˜ç¼“å­˜..."
                sudo sync
                echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null
                
                # è·å–é«˜å†…å­˜è¿›ç¨‹
                local high_mem_process=$(ps aux --sort=-%mem | awk 'NR==2{print $2":"$4":"$11}')
                echo "é«˜å†…å­˜è¿›ç¨‹: $high_mem_process"
                
                # å‘é€é€šçŸ¥
                if command -v notify-send >/dev/null 2>&1; then
                    notify-send "å†…å­˜æŠ¥è­¦" "å†…å­˜ä½¿ç”¨ç‡: ${usage_percent}%" -u critical
                fi
                
                # é‡ç½®è®¡æ•°
                high_mem_count=0
            fi
        else
            high_mem_count=0
            echo "âœ… [$current_time] å†…å­˜ä½¿ç”¨ç‡æ­£å¸¸: ${usage_percent}%"
        fi
        
        sleep "$check_interval"
    done
}

# ä½¿ç”¨ç¤ºä¾‹
# MEMORY_CACHE_OPTIMIZE
# SWAP_OPTIMIZE
# MEMORY_DEFRAGMENTATION
# MEMORY_MONITOR_ALERT 85 60 5
```

## 3 ç£ç›˜I/Oæ€§èƒ½é—®é¢˜

### 3.1 ç£ç›˜I/Oç›‘æ§

#### 3.1.1 I/Oä½¿ç”¨ç‡è¯Šæ–­

```bash
#!/bin/bash
# ç£ç›˜I/Oä½¿ç”¨ç‡è¯Šæ–­

# I/Oå®æ—¶ç›‘æ§
IO_MONITOR() {
    local interval="${1:-1}"
    local count="${2:-5}"
    
    echo "=== ç£ç›˜I/Oç›‘æ§ ==="
    echo "é—´éš”: ${interval}ç§’"
    echo "æ¬¡æ•°: $count"
    echo ""
    
    # æ£€æŸ¥iostat
    if ! command -v iostat >/dev/null 2>&1; then
        echo "å®‰è£…iostat..."
        sudo apt update && sudo apt install -y sysstat
    fi
    
    # ç£ç›˜ä¿¡æ¯
    echo "ç£ç›˜ä¿¡æ¯:"
    lsblk | grep -E "^sd|^nvme"
    echo ""
    
    # I/Oå®æ—¶ç›‘æ§
    echo "I/Oä½¿ç”¨ç‡ç›‘æ§:"
    for ((i=1; i<=count; i++)); do
        local io_stats=$(iostat -x 1 2 | tail -n +4 | grep -E "^sd|^nvme" | head -1)
        if [ -n "$io_stats" ]; then
            local device=$(echo "$io_stats" | awk '{print $1}')
            local util=$(echo "$io_stats" | awk '{print $NF}')
            local await=$(echo "$io_stats" | awk '{print $9}')
            local svctm=$(echo "$io_stats" | awk '{print $12}')
            
            printf "æ—¶é—´: %s | è®¾å¤‡: %-6s | ä½¿ç”¨ç‡: %5.1f%% | ç­‰å¾…æ—¶é—´: %5.1fms | æœåŠ¡æ—¶é—´: %5.1fms\n" \
                "$(date +%H:%M:%S)" "$device" "$util" "$await" "$svctm"
        else
            echo "æ—¶é—´: $(date +%H:%M:%S) | æ— æ³•è·å–I/Oç»Ÿè®¡ä¿¡æ¯"
        fi
        
        if [ $i -lt $count ]; then
            sleep "$interval"
        fi
    done
}

# I/Oä½¿ç”¨ç‡åˆ†æ
IO_USAGE_ANALYSIS() {
    echo "=== ç£ç›˜I/Oä½¿ç”¨ç‡åˆ†æ ==="
    echo "åˆ†ææ—¶é—´: $(date)"
    echo ""
    
    # ç£ç›˜è®¾å¤‡åˆ—è¡¨
    echo "1. ç£ç›˜è®¾å¤‡åˆ—è¡¨:"
    lsblk | grep -E "^sd|^nvme"
    echo ""
    
    # I/Oç»Ÿè®¡ä¿¡æ¯
    echo "2. I/Oç»Ÿè®¡ä¿¡æ¯:"
    if command -v iostat >/dev/null 2>&1; then
        iostat -x 1 1 | tail -n +4
    else
        echo "iostat å‘½ä»¤ä¸å¯ç”¨"
    fi
    echo ""
    
    # ç£ç›˜ä½¿ç”¨ç‡
    echo "3. ç£ç›˜ä½¿ç”¨ç‡:"
    df -h | grep -E "^/dev/"
    echo ""
    
    # I/Oç­‰å¾…è¿›ç¨‹
    echo "4. I/Oç­‰å¾…è¿›ç¨‹:"
    ps aux | awk '$8 ~ /D/ {print $0}' | head -5
    echo ""
    
    # ç£ç›˜é˜Ÿåˆ—é•¿åº¦
    echo "5. ç£ç›˜é˜Ÿåˆ—é•¿åº¦:"
    if [ -f /sys/block/sda/queue/nr_requests ]; then
        for disk in /sys/block/sd*; do
            if [ -f "$disk/queue/nr_requests" ]; then
                local disk_name=$(basename "$disk")
                local queue_size=$(cat "$disk/queue/nr_requests")
                echo "$disk_name: é˜Ÿåˆ—å¤§å° = $queue_size"
            fi
        done
    fi
    echo ""
    
    # I/Oæ€§èƒ½æŒ‡æ ‡
    echo "6. I/Oæ€§èƒ½æŒ‡æ ‡åˆ†æ:"
    if command -v iostat >/dev/null 2>&1; then
        local io_stats=$(iostat -x 1 2 | tail -n +4 | grep -E "^sd|^nvme" | head -1)
        if [ -n "$io_stats" ]; then
            local util=$(echo "$io_stats" | awk '{print $NF}')
            local await=$(echo "$io_stats" | awk '{print $9}')
            local svctm=$(echo "$io_stats" | awk '{print $12}')
            
            echo "è®¾å¤‡ä½¿ç”¨ç‡: ${util}%"
            echo "å¹³å‡ç­‰å¾…æ—¶é—´: ${await}ms"
            echo "å¹³å‡æœåŠ¡æ—¶é—´: ${svctm}ms"
            
            if (( $(echo "$util > 80" | bc -l) )); then
                echo "âš ï¸  è®¾å¤‡ä½¿ç”¨ç‡è¿‡é«˜ï¼"
            elif (( $(echo "$util > 60" | bc -l) )); then
                echo "âš ï¸  è®¾å¤‡ä½¿ç”¨ç‡ä¸­ç­‰"
            else
                echo "âœ… è®¾å¤‡ä½¿ç”¨ç‡æ­£å¸¸"
            fi
            
            if (( $(echo "$await > 20" | bc -l) )); then
                echo "âš ï¸  I/Oç­‰å¾…æ—¶é—´è¿‡é•¿ï¼"
            else
                echo "âœ… I/Oç­‰å¾…æ—¶é—´æ­£å¸¸"
            fi
        fi
    fi
}

# é«˜I/Oä½¿ç”¨ç‡è¿›ç¨‹å¤„ç†
HIGH_IO_PROCESS_HANDLER() {
    local threshold="${1:-50}"
    
    echo "=== é«˜I/Oä½¿ç”¨ç‡è¿›ç¨‹å¤„ç† ==="
    echo "é˜ˆå€¼: ${threshold}%"
    echo ""
    
    # æŸ¥æ‰¾é«˜I/Oä½¿ç”¨ç‡è¿›ç¨‹
    echo "æŸ¥æ‰¾é«˜I/Oä½¿ç”¨ç‡è¿›ç¨‹..."
    
    if command -v iotop >/dev/null 2>&1; then
        # ä½¿ç”¨iotopè·å–I/Oä¿¡æ¯
        sudo iotop -a -o -d 1 -n 3 2>/dev/null | tail -n +4 | head -10
    else
        echo "iotop å‘½ä»¤ä¸å¯ç”¨ï¼Œå®‰è£…iotop..."
        sudo apt update && sudo apt install -y iotop
    fi
    
    # æŸ¥æ‰¾I/Oç­‰å¾…è¿›ç¨‹
    echo "I/Oç­‰å¾…è¿›ç¨‹:"
    ps aux | awk '$8 ~ /D/ {printf "PID: %-6s çŠ¶æ€: %-2s CPU: %-4s å†…å­˜: %-4s å‘½ä»¤: %s\n", $2, $8, $3, $4, $11}' | head -5
    echo ""
    
    # æä¾›å¤„ç†å»ºè®®
    echo "å¤„ç†å»ºè®®:"
    echo "1. åˆ†æè¿›ç¨‹æ˜¯å¦æ­£å¸¸ä¸šåŠ¡è¿›ç¨‹"
    echo "2. è€ƒè™‘ä¼˜åŒ–ç›¸å…³åº”ç”¨ç¨‹åºçš„I/Oæ“ä½œ"
    echo "3. æ£€æŸ¥ç£ç›˜æ€§èƒ½å’Œå¥åº·çŠ¶å†µ"
    echo "4. è€ƒè™‘ä½¿ç”¨æ›´å¿«çš„å­˜å‚¨è®¾å¤‡"
    echo "5. ä¼˜åŒ–æ–‡ä»¶ç³»ç»Ÿå’ŒI/Oè°ƒåº¦å™¨"
}

# ä½¿ç”¨ç¤ºä¾‹
# IO_MONITOR 2 10
# IO_USAGE_ANALYSIS
# HIGH_IO_PROCESS_HANDLER 70
```

#### 3.1.2 I/Oæ€§èƒ½ä¼˜åŒ–

```bash
#!/bin/bash
# I/Oæ€§èƒ½ä¼˜åŒ–

# I/Oè°ƒåº¦å™¨ä¼˜åŒ–
IO_SCHEDULER_OPTIMIZE() {
    echo "=== I/Oè°ƒåº¦å™¨ä¼˜åŒ– ==="
    echo "ä¼˜åŒ–æ—¶é—´: $(date)"
    echo ""
    
    # æ£€æŸ¥å½“å‰I/Oè°ƒåº¦å™¨
    echo "1. å½“å‰I/Oè°ƒåº¦å™¨:"
    for disk in /sys/block/sd*; do
        if [ -f "$disk/queue/scheduler" ]; then
            local disk_name=$(basename "$disk")
            local scheduler=$(cat "$disk/queue/scheduler" | grep -o '\[.*\]' | tr -d '[]')
            echo "$disk_name: $scheduler"
        fi
    done
    echo ""
    
    # ä¼˜åŒ–I/Oè°ƒåº¦å™¨
    echo "2. ä¼˜åŒ–I/Oè°ƒåº¦å™¨..."
    for disk in /sys/block/sd*; do
        if [ -f "$disk/queue/scheduler" ]; then
            local disk_name=$(basename "$disk")
            
            # æ ¹æ®ç£ç›˜ç±»å‹é€‰æ‹©è°ƒåº¦å™¨
            if [ -f "$disk/queue/rotational" ]; then
                local rotational=$(cat "$disk/queue/rotational")
                if [ "$rotational" = "0" ]; then
                    # SSDä½¿ç”¨noopæˆ–deadline
                    echo "noop" | sudo tee "$disk/queue/scheduler" >/dev/null 2>&1 || true
                    echo "âœ… $disk_name è®¾ç½®ä¸ºnoopè°ƒåº¦å™¨ (SSD)"
                else
                    # HDDä½¿ç”¨cfqæˆ–deadline
                    echo "deadline" | sudo tee "$disk/queue/scheduler" >/dev/null 2>&1 || true
                    echo "âœ… $disk_name è®¾ç½®ä¸ºdeadlineè°ƒåº¦å™¨ (HDD)"
                fi
            fi
        fi
    done
    echo ""
    
    # I/Oè°ƒåº¦å™¨å‚æ•°ä¼˜åŒ–
    echo "3. I/Oè°ƒåº¦å™¨å‚æ•°ä¼˜åŒ–..."
    for disk in /sys/block/sd*; do
        if [ -f "$disk/queue/nr_requests" ]; then
            # å¢åŠ é˜Ÿåˆ—é•¿åº¦
            echo 256 | sudo tee "$disk/queue/nr_requests" >/dev/null 2>&1 || true
        fi
        
        if [ -f "$disk/queue/read_ahead_kb" ]; then
            # ä¼˜åŒ–é¢„è¯»å¤§å°
            echo 128 | sudo tee "$disk/queue/read_ahead_kb" >/dev/null 2>&1 || true
        fi
        
        if [ -f "$disk/queue/rotational" ]; then
            local disk_name=$(basename "$disk")
            echo "âœ… $disk_name å‚æ•°å·²ä¼˜åŒ–"
        fi
    done
    
    echo "âœ… I/Oè°ƒåº¦å™¨ä¼˜åŒ–å®Œæˆ"
}

# æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
FILESYSTEM_OPTIMIZE() {
    local mount_point="$1"
    
    if [ -z "$mount_point" ]; then
        echo "ç”¨æ³•: $0 <æŒ‚è½½ç‚¹>"
        return 1
    fi
    
    echo "=== æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ– ==="
    echo "æŒ‚è½½ç‚¹: $mount_point"
    echo "ä¼˜åŒ–æ—¶é—´: $(date)"
    echo ""
    
    # æ£€æŸ¥æŒ‚è½½ç‚¹
    if ! mountpoint -q "$mount_point"; then
        echo "âŒ $mount_point ä¸æ˜¯æœ‰æ•ˆçš„æŒ‚è½½ç‚¹"
        return 1
    fi
    
    # è·å–è®¾å¤‡ä¿¡æ¯
    local device=$(mount | grep "$mount_point" | awk '{print $1}')
    local fs_type=$(mount | grep "$mount_point" | awk '{print $5}')
    
    echo "è®¾å¤‡: $device"
    echo "æ–‡ä»¶ç³»ç»Ÿç±»å‹: $fs_type"
    echo ""
    
    # æ–‡ä»¶ç³»ç»Ÿç‰¹å®šä¼˜åŒ–
    case "$fs_type" in
        "ext4")
            echo "ä¼˜åŒ–ext4æ–‡ä»¶ç³»ç»Ÿ..."
            # å¯ç”¨å»¶è¿Ÿåˆ†é…
            sudo tune2fs -o journal_data_writeback "$device"
            # ç¦ç”¨è®¿é—®æ—¶é—´æ›´æ–°
            sudo mount -o remount,noatime,nodiratime "$mount_point"
            echo "âœ… ext4æ–‡ä»¶ç³»ç»Ÿå·²ä¼˜åŒ–"
            ;;
        "xfs")
            echo "ä¼˜åŒ–xfsæ–‡ä»¶ç³»ç»Ÿ..."
            # ä¼˜åŒ–æ—¥å¿—
            sudo xfs_admin -L "$(hostname -s)" "$device" 2>/dev/null || true
            echo "âœ… xfsæ–‡ä»¶ç³»ç»Ÿå·²ä¼˜åŒ–"
            ;;
        "btrfs")
            echo "ä¼˜åŒ–btrfsæ–‡ä»¶ç³»ç»Ÿ..."
            # å¯ç”¨å‹ç¼©
            sudo mount -o remount,compress=lzo "$mount_point"
            echo "âœ… btrfsæ–‡ä»¶ç³»ç»Ÿå·²ä¼˜åŒ–"
            ;;
        *)
            echo "ä¸æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿç±»å‹: $fs_type"
            return 1
            ;;
    esac
    
    # é€šç”¨æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
    echo "é€šç”¨æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–..."
    
    # ä¼˜åŒ–æŒ‚è½½é€‰é¡¹
    echo "ä¼˜åŒ–æŒ‚è½½é€‰é¡¹..."
    sudo mount -o remount,noatime,nodiratime,barrier=0 "$mount_point"
    
    echo "âœ… æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–å®Œæˆ"
}

# ç£ç›˜ç¼“å­˜ä¼˜åŒ–
DISK_CACHE_OPTIMIZE() {
    echo "=== ç£ç›˜ç¼“å­˜ä¼˜åŒ– ==="
    echo "ä¼˜åŒ–æ—¶é—´: $(date)"
    echo ""
    
    # å½“å‰ç£ç›˜ç¼“å­˜è®¾ç½®
    echo "1. å½“å‰ç£ç›˜ç¼“å­˜è®¾ç½®:"
    cat /proc/sys/vm/dirty_ratio
    cat /proc/sys/vm/dirty_background_ratio
    cat /proc/sys/vm/dirty_expire_centisecs
    echo ""
    
    # ä¼˜åŒ–ç£ç›˜ç¼“å­˜å‚æ•°
    echo "2. ä¼˜åŒ–ç£ç›˜ç¼“å­˜å‚æ•°..."
    
    # å¢åŠ è„é¡µæ¯”ä¾‹
    echo 20 | sudo tee /proc/sys/vm/dirty_ratio >/dev/null
    echo 10 | sudo tee /proc/sys/vm/dirty_background_ratio >/dev/null
    
    # ä¼˜åŒ–è„é¡µè¿‡æœŸæ—¶é—´
    echo 3000 | sudo tee /proc/sys/vm/dirty_expire_centisecs >/dev/null
    echo 500 | sudo tee /proc/sys/vm/dirty_writeback_centisecs >/dev/null
    
    # ä¼˜åŒ–å†…å­˜å›æ”¶
    echo 5 | sudo tee /proc/sys/vm/vfs_cache_pressure >/dev/null
    echo 10 | sudo tee /proc/sys/vm/swappiness >/dev/null
    
    echo "âœ… ç£ç›˜ç¼“å­˜å‚æ•°å·²ä¼˜åŒ–"
    echo ""
    
    # ç£ç›˜é¢„è¯»ä¼˜åŒ–
    echo "3. ç£ç›˜é¢„è¯»ä¼˜åŒ–..."
    for disk in /sys/block/sd*; do
        if [ -f "$disk/queue/read_ahead_kb" ]; then
            local disk_name=$(basename "$disk")
            local current_size=$(cat "$disk/queue/read_ahead_kb")
            echo "$disk_name å½“å‰é¢„è¯»å¤§å°: ${current_size}KB"
            
            # è®¾ç½®é¢„è¯»å¤§å°
            echo 256 | sudo tee "$disk/queue/read_ahead_kb" >/dev/null
            echo "âœ… $disk_name é¢„è¯»å¤§å°å·²è®¾ç½®ä¸º256KB"
        fi
    done
    
    echo "âœ… ç£ç›˜ç¼“å­˜ä¼˜åŒ–å®Œæˆ"
}

# I/Oæ€§èƒ½æµ‹è¯•
IO_PERFORMANCE_TEST() {
    local test_file="${1:-/tmp/io_test_$$}"
    local test_size="${2:-1G}"
    
    echo "=== I/Oæ€§èƒ½æµ‹è¯• ==="
    echo "æµ‹è¯•æ–‡ä»¶: $test_file"
    echo "æµ‹è¯•å¤§å°: $test_size"
    echo "æµ‹è¯•æ—¶é—´: $(date)"
    echo ""
    
    # æ£€æŸ¥æµ‹è¯•å·¥å…·
    if ! command -v fio >/dev/null 2>&1; then
        echo "å®‰è£…fio..."
        sudo apt update && sudo apt install -y fio
    fi
    
    # é¡ºåºå†™æµ‹è¯•
    echo "1. é¡ºåºå†™æµ‹è¯•..."
    fio --name=seq_write --ioengine=libaio --rw=write --bs=1M --numjobs=1 --size="$test_size" --runtime=30 --group_reporting --filename="$test_file" --direct=1
    echo ""
    
    # é¡ºåºè¯»æµ‹è¯•
    echo "2. é¡ºåºè¯»æµ‹è¯•..."
    fio --name=seq_read --ioengine=libaio --rw=read --bs=1M --numjobs=1 --size="$test_size" --runtime=30 --group_reporting --filename="$test_file" --direct=1
    echo ""
    
    # éšæœºå†™æµ‹è¯•
    echo "3. éšæœºå†™æµ‹è¯•..."
    fio --name=rand_write --ioengine=libaio --rw=randwrite --bs=4k --numjobs=1 --size="$test_size" --runtime=30 --group_reporting --filename="$test_file" --direct=1
    echo ""
    
    # éšæœºè¯»æµ‹è¯•
    echo "4. éšæœºè¯»æµ‹è¯•..."
    fio --name=rand_read --ioengine=libaio --rw=randread --bs=4k --numjobs=1 --size="$test_size" --runtime=30 --group_reporting --filename="$test_file" --direct=1
    echo ""
    
    # æ¸…ç†æµ‹è¯•æ–‡ä»¶
    rm -f "$test_file"
    
    echo "âœ… I/Oæ€§èƒ½æµ‹è¯•å®Œæˆ"
}

# I/Oç›‘æ§å’ŒæŠ¥è­¦
IO_MONITOR_ALERT() {
    local threshold="${1:-70}"
    local check_interval="${2:-30}"
    local alert_count="${3:-3}"
    
    echo "=== I/Oç›‘æ§å’ŒæŠ¥è­¦ ==="
    echo "é˜ˆå€¼: ${threshold}%"
    echo "æ£€æŸ¥é—´éš”: ${check_interval}ç§’"
    echo "æŠ¥è­¦æ¬¡æ•°: $alert_count"
    echo ""
    echo "æŒ‰ Ctrl+C åœæ­¢ç›‘æ§"
    echo ""
    
    local high_io_count=0
    local log_file="/var/log/io_monitor.log"
    
    while true; do
        if command -v iostat >/dev/null 2>&1; then
            local io_stats=$(iostat -x 1 2 | tail -n +4 | grep -E "^sd|^nvme" | head -1)
            if [ -n "$io_stats" ]; then
                local util=$(echo "$io_stats" | awk '{print $NF}')
                local current_time=$(date "+%Y-%m-%d %H:%M:%S")
                
                if (( $(echo "$util > $threshold" | bc -l) )); then
                    high_io_count=$((high_io_count + 1))
                    echo "âš ï¸  [$current_time] I/Oä½¿ç”¨ç‡è¿‡é«˜: ${util}% (ç¬¬${high_io_count}æ¬¡)"
                    
                    # è®°å½•æ—¥å¿—
                    echo "[$current_time] I/Oä½¿ç”¨ç‡è¿‡é«˜: ${util}%" >> "$log_file"
                    
                    # å¦‚æœè¶…è¿‡æŠ¥è­¦æ¬¡æ•°ï¼Œæ‰§è¡Œå¤„ç†
                    if [ $high_io_count -ge $alert_count ]; then
                        echo "ğŸ”¥  I/Oä½¿ç”¨ç‡æŒç»­è¿‡é«˜ï¼Œæ‰§è¡Œå¤„ç†..."
                        
                        # è·å–é«˜I/Oè¿›ç¨‹
                        if command -v iotop >/dev/null 2>&1; then
                            local high_io_process=$(sudo iotop -a -o -d 1 -n 1 2>/dev/null | tail -n +4 | head -1)
                            echo "é«˜I/Oè¿›ç¨‹: $high_io_process"
                        fi
                        
                        # å‘é€é€šçŸ¥
                        if command -v notify-send >/dev/null 2>&1; then
                            notify-send "I/OæŠ¥è­¦" "I/Oä½¿ç”¨ç‡: ${util}%" -u critical
                        fi
                        
                        # é‡ç½®è®¡æ•°
                        high_io_count=0
                    fi
                else
                    high_io_count=0
                    echo "âœ… [$current_time] I/Oä½¿ç”¨ç‡æ­£å¸¸: ${util}%"
                fi
            else
                echo "âŒ æ— æ³•è·å–I/Oç»Ÿè®¡ä¿¡æ¯"
            fi
        else
            echo "âŒ iostat å‘½ä»¤ä¸å¯ç”¨"
        fi
        
        sleep "$check_interval"
    done
}

# ä½¿ç”¨ç¤ºä¾‹
# IO_SCHEDULER_OPTIMIZE
# FILESYSTEM_OPTIMIZE /mnt/data
# DISK_CACHE_OPTIMIZE
# IO_PERFORMANCE_TEST /tmp/test_io
# IO_MONITOR_ALERT 75 60 5
```

è¿™äº›ç³»ç»Ÿæ€§èƒ½é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆæ¶µç›–äº†ä»åŸºç¡€çš„CPUã€å†…å­˜ã€ç£ç›˜I/Oç›‘æ§åˆ°å¤æ‚çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼Œä¸ºç³»ç»Ÿç®¡ç†å‘˜æä¾›äº†å…¨é¢çš„æ€§èƒ½é—®é¢˜å¤„ç†å·¥å…·é›†ã€‚