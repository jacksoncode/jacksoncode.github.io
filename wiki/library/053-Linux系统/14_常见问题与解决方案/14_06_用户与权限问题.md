# ç”¨æˆ·ä¸æƒé™é—®é¢˜

## 1 ç”¨æˆ·ç®¡ç†é—®é¢˜

### 1.1 ç”¨æˆ·è´¦æˆ·é—®é¢˜è¯Šæ–­

#### 1.1.1 ç”¨æˆ·è´¦æˆ·çŠ¶æ€æ£€æŸ¥

```bash
#!/bin/bash
# ç”¨æˆ·è´¦æˆ·çŠ¶æ€æ£€æŸ¥

# ç”¨æˆ·è´¦æˆ·çŠ¶æ€æ£€æŸ¥
USER_ACCOUNT_STATUS_CHECK() {
    local username="$1"
    
    echo "=== ç”¨æˆ·è´¦æˆ·çŠ¶æ€æ£€æŸ¥ ==="
    echo "æ£€æŸ¥æ—¶é—´: $(date)"
    echo ""
    
    if [ -n "$username" ]; then
        echo "æ£€æŸ¥ç”¨æˆ·: $username"
        echo ""
        
        # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        if ! id "$username" >/dev/null 2>&1; then
            echo "âŒ ç”¨æˆ·ä¸å­˜åœ¨: $username"
            return 1
        fi
        
        # ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
        echo "1. ç”¨æˆ·åŸºæœ¬ä¿¡æ¯:"
        id "$username"
        echo ""
        
        # ç”¨æˆ·è´¦æˆ·çŠ¶æ€
        echo "2. ç”¨æˆ·è´¦æˆ·çŠ¶æ€:"
        local user_info=$(getent passwd "$username")
        echo "ç”¨æˆ·ä¿¡æ¯: $user_info"
        
        # æ£€æŸ¥è´¦æˆ·æ˜¯å¦é”å®š
        if command -v passwd >/dev/null 2>&1; then
            local account_status=$(passwd -S "$username" 2>/dev/null | awk '{print $2}')
            echo "è´¦æˆ·çŠ¶æ€: $account_status"
        fi
        echo ""
        
        # ç”¨æˆ·ç»„ä¿¡æ¯
        echo "3. ç”¨æˆ·ç»„ä¿¡æ¯:"
        groups "$username"
        echo ""
        
        # ç”¨æˆ·ä¸»ç›®å½•
        echo "4. ç”¨æˆ·ä¸»ç›®å½•:"
        local home_dir=$(getent passwd "$username" | cut -d: -f6)
        echo "ä¸»ç›®å½•: $home_dir"
        
        if [ -d "$home_dir" ]; then
            echo "ä¸»ç›®å½•å­˜åœ¨"
            echo "æƒé™: $(ls -ld "$home_dir" | awk '{print $1}')"
            echo "å±ä¸»: $(ls -ld "$home_dir" | awk '{print $3":"$4}')"
            echo "å¤§å°: $(du -sh "$home_dir" 2>/dev/null | cut -f1)"
        else
            echo "âš ï¸  ä¸»ç›®å½•ä¸å­˜åœ¨"
        fi
        echo ""
        
        # ç”¨æˆ·shell
        echo "5. ç”¨æˆ·shell:"
        local user_shell=$(getent passwd "$username" | cut -d: -f7)
        echo "Shell: $user_shell"
        
        if [ -f "$user_shell" ]; then
            echo "âœ… Shellå­˜åœ¨"
        else
            echo "âš ï¸  Shellä¸å­˜åœ¨"
        fi
        echo ""
        
        # ç”¨æˆ·ç™»å½•ä¿¡æ¯
        echo "6. ç”¨æˆ·ç™»å½•ä¿¡æ¯:"
        if command -v lastlog >/dev/null 2>&1; then
            lastlog -u "$username"
        fi
        echo ""
        
        # ç”¨æˆ·è¿›ç¨‹
        echo "7. ç”¨æˆ·è¿›ç¨‹:"
        local user_processes=$(pgrep -u "$username" | wc -l)
        echo "è¿›ç¨‹æ•°é‡: $user_processes"
        
        if [ "$user_processes" -gt 0 ]; then
            echo "ç”¨æˆ·è¿›ç¨‹åˆ—è¡¨:"
            ps -u "$username" -o pid,ppid,cmd,%cpu,%mem --no-headers | head -5
        fi
        echo ""
        
        # ç”¨æˆ·èµ„æºé™åˆ¶
        echo "8. ç”¨æˆ·èµ„æºé™åˆ¶:"
        if [ -f "/etc/security/limits.conf" ]; then
            echo "limits.confé…ç½®:"
            grep -E "^$username|^\*" /etc/security/limits.conf | head -5
        fi
        echo ""
        
    else
        # ç³»ç»Ÿçº§ç”¨æˆ·è´¦æˆ·æ£€æŸ¥
        echo "ç³»ç»Ÿçº§ç”¨æˆ·è´¦æˆ·æ£€æŸ¥:"
        echo ""
        
        # ç”¨æˆ·ç»Ÿè®¡
        echo "1. ç”¨æˆ·ç»Ÿè®¡:"
        local total_users=$(getent passwd | wc -l)
        local system_users=$(getent passwd | awk -F: '$3 < 1000' | wc -l)
        local normal_users=$(getent passwd | awk -F: '$3 >= 1000 && $3 < 65534' | wc -l)
        
        echo "æ€»ç”¨æˆ·æ•°: $total_users"
        echo "ç³»ç»Ÿç”¨æˆ·: $system_users"
        echo "æ™®é€šç”¨æˆ·: $normal_users"
        echo ""
        
        # ç‰¹æ®Šè´¦æˆ·æ£€æŸ¥
        echo "2. ç‰¹æ®Šè´¦æˆ·æ£€æŸ¥:"
        echo "æ— å¯†ç è´¦æˆ·:"
        getent shadow | awk -F: '$2 == "" {print $1}' | while read user; do
            echo "âš ï¸  ç”¨æˆ·æ— å¯†ç : $user"
        done
        echo ""
        
        echo "UIDä¸º0çš„è´¦æˆ·:"
        getent passwd | awk -F: '$3 == 0 {print $1}' | while read user; do
            if [ "$user" != "root" ]; then
                echo "âš ï¸  érootç”¨æˆ·UIDä¸º0: $user"
            else
                echo "âœ… rootç”¨æˆ·UIDä¸º0"
            fi
        done
        echo ""
        
        # é”å®šè´¦æˆ·æ£€æŸ¥
        echo "3. é”å®šè´¦æˆ·æ£€æŸ¥:"
        if command -v passwd >/dev/null 2>&1; then
            getent passwd | cut -d: -f1 | while read user; do
                local status=$(passwd -S "$user" 2>/dev/null | awk '{print $2}')
                if [ "$status" = "L" ]; then
                    echo "ğŸ”’ é”å®šç”¨æˆ·: $user"
                fi
            done
        fi
        echo ""
        
        # è¿‡æœŸè´¦æˆ·æ£€æŸ¥
        echo "4. è¿‡æœŸè´¦æˆ·æ£€æŸ¥:"
        getent shadow | while IFS=: read user password last_change min_age max_age warn_inactive expire; do
            if [ "$expire" != "" ] && [ "$expire" != "99999" ]; then
                local current_date=$(date +%s)
                local expire_date=$((expire * 86400))
                if [ $current_date -gt $expire_date ]; then
                    echo "â° è¿‡æœŸç”¨æˆ·: $user (è¿‡æœŸæ—¶é—´: $(date -d @$expire_date))"
                fi
            fi
        done
    fi
}

# ç”¨æˆ·è´¦æˆ·ä¿®å¤
USER_ACCOUNT_REPAIR() {
    local username="$1"
    local repair_type="${2:-basic}"
    
    echo "=== ç”¨æˆ·è´¦æˆ·ä¿®å¤ ==="
    echo "ä¿®å¤æ—¶é—´: $(date)"
    echo "ç”¨æˆ·: $username"
    echo "ä¿®å¤ç±»å‹: $repair_type"
    echo ""
    
    if [ -z "$username" ]; then
        echo "ç”¨æ³•: $0 <ç”¨æˆ·å> [ä¿®å¤ç±»å‹(basic|advanced)]"
        return 1
    fi
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    if ! id "$username" >/dev/null 2>&1; then
        echo "âŒ ç”¨æˆ·ä¸å­˜åœ¨: $username"
        return 1
    fi
    
    # åŸºç¡€ä¿®å¤
    echo "1. åŸºç¡€ä¿®å¤:"
    
    # ä¿®å¤ä¸»ç›®å½•æƒé™
    echo "ä¿®å¤ä¸»ç›®å½•æƒé™..."
    local home_dir=$(getent passwd "$username" | cut -d: -f6)
    if [ -d "$home_dir" ]; then
        sudo chown "$username:$(id -gn "$username")" "$home_dir"
        sudo chmod 755 "$home_dir"
        echo "âœ… ä¸»ç›®å½•æƒé™å·²ä¿®å¤"
    else
        echo "âš ï¸  ä¸»ç›®å½•ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º..."
        sudo mkdir -p "$home_dir"
        sudo chown "$username:$(id -gn "$username")" "$home_dir"
        sudo chmod 755 "$home_dir"
        echo "âœ… ä¸»ç›®å½•å·²åˆ›å»º"
    fi
    echo ""
    
    # ä¿®å¤ç”¨æˆ·ç»„
    echo "ä¿®å¤ç”¨æˆ·ç»„..."
    local primary_group=$(id -gn "$username")
    if [ "$primary_group" = "nogroup" ] || [ "$primary_group" = "nobody" ]; then
        echo "âš ï¸  ç”¨æˆ·ä¸»ç»„å¼‚å¸¸ï¼Œä¿®å¤ä¸ºusersç»„..."
        sudo usermod -g users "$username"
        echo "âœ… ç”¨æˆ·ä¸»ç»„å·²ä¿®å¤"
    else
        echo "âœ… ç”¨æˆ·ä¸»ç»„æ­£å¸¸: $primary_group"
    fi
    echo ""
    
    # ä¿®å¤shell
    echo "ä¿®å¤shell..."
    local user_shell=$(getent passwd "$username" | cut -d: -f7)
    if [ ! -f "$user_shell" ]; then
        echo "âš ï¸  ç”¨æˆ·shellä¸å­˜åœ¨ï¼Œä¿®å¤ä¸º/bin/bash..."
        sudo usermod -s /bin/bash "$username"
        echo "âœ… ç”¨æˆ·shellå·²ä¿®å¤"
    else
        echo "âœ… ç”¨æˆ·shellæ­£å¸¸: $user_shell"
    fi
    echo ""
    
    # é«˜çº§ä¿®å¤
    if [ "$repair_type" = "advanced" ]; then
        echo "2. é«˜çº§ä¿®å¤:"
        
        # è§£é”è´¦æˆ·
        echo "æ£€æŸ¥è´¦æˆ·é”å®šçŠ¶æ€..."
        if command -v passwd >/dev/null 2>&1; then
            local account_status=$(passwd -S "$username" 2>/dev/null | awk '{print $2}')
            if [ "$account_status" = "L" ]; then
                echo "ğŸ”“ è§£é”ç”¨æˆ·è´¦æˆ·..."
                sudo passwd -u "$username"
                echo "âœ… è´¦æˆ·å·²è§£é”"
            else
                echo "âœ… è´¦æˆ·æœªé”å®š"
            fi
        fi
        echo ""
        
        # é‡ç½®å¯†ç è¿‡æœŸç­–ç•¥
        echo "é‡ç½®å¯†ç è¿‡æœŸç­–ç•¥..."
        sudo chage -m 0 -M 99999 -I -1 -E -1 "$username"
        echo "âœ… å¯†ç è¿‡æœŸç­–ç•¥å·²é‡ç½®"
        echo ""
        
        # ä¿®å¤sudoæƒé™
        echo "æ£€æŸ¥sudoæƒé™..."
        if [ -f "/etc/sudoers" ]; then
            if grep -q "^$username" /etc/sudoers; then
                echo "âœ… ç”¨æˆ·å·²é…ç½®sudoæƒé™"
            else
                echo "æ·»åŠ sudoæƒé™..."
                echo "$username ALL=(ALL) NOPASSWD:ALL" | sudo tee -a /etc/sudoers
                echo "âœ… sudoæƒé™å·²æ·»åŠ "
            fi
        fi
        echo ""
        
        # ä¿®å¤èµ„æºé™åˆ¶
        echo "ä¿®å¤èµ„æºé™åˆ¶..."
        local limits_file="/etc/security/limits.d/${username}.conf"
        cat <<EOF | sudo tee "$limits_file" >/dev/null
$username soft nofile 65536
$username hard nofile 65536
$username soft nproc 4096
$username hard nproc 4096
EOF
        echo "âœ… èµ„æºé™åˆ¶å·²é…ç½®"
        echo ""
    fi
    
    # éªŒè¯ä¿®å¤ç»“æœ
    echo "3. éªŒè¯ä¿®å¤ç»“æœ:"
    if id "$username" >/dev/null 2>&1; then
        echo "âœ… ç”¨æˆ·å­˜åœ¨"
        
        local home_dir=$(getent passwd "$username" | cut -d: -f6)
        if [ -d "$home_dir" ]; then
            echo "âœ… ä¸»ç›®å½•å­˜åœ¨"
        else
            echo "âŒ ä¸»ç›®å½•ä¸å­˜åœ¨"
        fi
        
        local user_shell=$(getent passwd "$username" | cut -d: -f7)
        if [ -f "$user_shell" ]; then
            echo "âœ… shellå­˜åœ¨"
        else
            echo "âŒ shellä¸å­˜åœ¨"
        fi
        
        echo "ç”¨æˆ·ä¿®å¤å®Œæˆ"
    else
        echo "âŒ ç”¨æˆ·ä¸å­˜åœ¨"
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
# USER_ACCOUNT_STATUS_CHECK username
# USER_ACCOUNT_REPAIR username advanced
```

#### 1.1.2 ç”¨æˆ·å¯†ç é—®é¢˜å¤„ç†

```bash
#!/bin/bash
# ç”¨æˆ·å¯†ç é—®é¢˜å¤„ç†

# ç”¨æˆ·å¯†ç é—®é¢˜è¯Šæ–­
USER_PASSWORD_DIAGNOSIS() {
    local username="$1"
    
    echo "=== ç”¨æˆ·å¯†ç é—®é¢˜è¯Šæ–­ ==="
    echo "è¯Šæ–­æ—¶é—´: $(date)"
    echo ""
    
    if [ -z "$username" ]; then
        echo "ç”¨æ³•: $0 <ç”¨æˆ·å>"
        return 1
    fi
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    if ! id "$username" >/dev/null 2>&1; then
        echo "âŒ ç”¨æˆ·ä¸å­˜åœ¨: $username"
        return 1
    fi
    
    echo "è¯Šæ–­ç”¨æˆ·: $username"
    echo ""
    
    # å¯†ç çŠ¶æ€æ£€æŸ¥
    echo "1. å¯†ç çŠ¶æ€æ£€æŸ¥:"
    if [ -f "/etc/shadow" ]; then
        local shadow_line=$(getent shadow "$username" 2>/dev/null)
        if [ -n "$shadow_line" ]; then
            local password_field=$(echo "$shadow_line" | cut -d: -f2)
            local last_change=$(echo "$shadow_line" | cut -d: -f3)
            local min_age=$(echo "$shadow_line" | cut -d: -f4)
            local max_age=$(echo "$shadow_line" | cut -d: -f5)
            local warn_period=$(echo "$shadow_line" | cut -d: -f6)
            local inactive_period=$(echo "$shadow_line" | cut -d: -f7)
            local expire_date=$(echo "$shadow_line" | cut -d: -f8)
            
            echo "å¯†ç å­—æ®µ: $([ "$password_field" = "" ] && echo "ç©ºå¯†ç " || echo "å·²è®¾ç½®å¯†ç ")"
            echo "å¯†ç çŠ¶æ€: $([ "$password_field" = "*" ] && echo "é”å®š" || echo "æ­£å¸¸")"
            
            if [ "$password_field" = "!" ] || [[ "$password_field" =~ ^! ]]; then
                echo "ğŸ”’ å¯†ç è¢«é”å®š"
            fi
            
            # å¯†ç è¿‡æœŸä¿¡æ¯
            if [ "$expire_date" != "" ] && [ "$expire_date" != "99999" ]; then
                local current_date=$(date +%s)
                local expire_timestamp=$((expire_date * 86400))
                if [ $current_date -gt $expire_timestamp ]; then
                    echo "â° å¯†ç å·²è¿‡æœŸ (è¿‡æœŸæ—¥æœŸ: $(date -d @$expire_timestamp))"
                else
                    echo "å¯†ç è¿‡æœŸæ—¥æœŸ: $(date -d @$expire_timestamp)"
                fi
            fi
            
            # å¯†ç æœ€åä¿®æ”¹æ—¶é—´
            if [ "$last_change" != "" ] && [ "$last_change" != "0" ]; then
                local last_change_date=$(date -d "1970-01-01 + $last_change days")
                echo "æœ€åä¿®æ”¹: $last_change_date"
            fi
        fi
    fi
    echo ""
    
    # è´¦æˆ·é”å®šçŠ¶æ€
    echo "2. è´¦æˆ·é”å®šçŠ¶æ€:"
    if command -v passwd >/dev/null 2>&1; then
        local passwd_status=$(passwd -S "$username" 2>/dev/null)
        echo "passwdçŠ¶æ€: $passwd_status"
        
        local account_status=$(echo "$passwd_status" | awk '{print $2}')
        case "$account_status" in
            "P")
                echo "âœ… å¯†ç å·²è®¾ç½®"
                ;;
            "L")
                echo "ğŸ”’ è´¦æˆ·å·²é”å®š"
                ;;
            "NP")
                echo "âš ï¸  æ— å¯†ç "
                ;;
            *)
                echo "æœªçŸ¥çŠ¶æ€: $account_status"
                ;;
        esac
    fi
    echo ""
    
    # PAMé…ç½®æ£€æŸ¥
    echo "3. PAMé…ç½®æ£€æŸ¥:"
    local pam_files=("/etc/pam.d/common-auth" "/etc/pam.d/system-auth" "/etc/pam.d/passwd")
    for pam_file in "${pam_files[@]}"; do
        if [ -f "$pam_file" ]; then
            echo "PAMæ–‡ä»¶: $pam_file"
            grep -E "(pam_unix|pam_cracklib|pam_pwquality)" "$pam_file" | head -3
        fi
    done
    echo ""
    
    # å¯†ç ç­–ç•¥æ£€æŸ¥
    echo "4. å¯†ç ç­–ç•¥æ£€æŸ¥:"
    if [ -f "/etc/pam.d/common-password" ]; then
        echo "å¯†ç å¤æ‚åº¦è¦æ±‚:"
        grep -E "(minlen|dcredit|ucredit|ocredit|lcredit)" /etc/pam.d/common-password | head -3
    fi
    
    if [ -f "/etc/security/pwquality.conf" ]; then
        echo "å¯†ç è´¨é‡é…ç½®:"
        grep -v "^#" /etc/security/pwquality.conf | grep -v "^$" | head -5
    fi
    echo ""
    
    # ç™»å½•å¤±è´¥æ£€æŸ¥
    echo "5. ç™»å½•å¤±è´¥æ£€æŸ¥:"
    if [ -f "/var/log/auth.log" ]; then
        echo "æœ€è¿‘5æ¬¡ç™»å½•å¤±è´¥:"
        grep "Failed password.*$username" /var/log/auth.log | tail -5
    elif [ -f "/var/log/secure" ]; then
        echo "æœ€è¿‘5æ¬¡ç™»å½•å¤±è´¥:"
        grep "Failed password.*$username" /var/log/secure | tail -5
    fi
    echo ""
    
    # è´¦æˆ·æ´»åŠ¨
    echo "6. è´¦æˆ·æ´»åŠ¨:"
    echo "æœ€è¿‘ç™»å½•:"
    last "$username" | head -3
    echo ""
    
    # å»ºè®®
    echo "7. å»ºè®®:"
    if [ "$password_field" = "" ]; then
        echo "å»ºè®®: ä¸ºç”¨æˆ·è®¾ç½®å¯†ç "
    elif [ "$password_field" = "!" ] || [[ "$password_field" =~ ^! ]]; then
        echo "å»ºè®®: è§£é”ç”¨æˆ·å¯†ç "
    elif [ "$account_status" = "L" ]; then
        echo "å»ºè®®: è§£é”ç”¨æˆ·è´¦æˆ·"
    fi
}

# ç”¨æˆ·å¯†ç é‡ç½®
USER_PASSWORD_RESET() {
    local username="$1"
    local password_type="${2:-manual}"
    
    echo "=== ç”¨æˆ·å¯†ç é‡ç½® ==="
    echo "é‡ç½®æ—¶é—´: $(date)"
    echo "ç”¨æˆ·: $username"
    echo "å¯†ç ç±»å‹: $password_type"
    echo ""
    
    if [ -z "$username" ]; then
        echo "ç”¨æ³•: $0 <ç”¨æˆ·å> [å¯†ç ç±»å‹(manual|auto|temp)]"
        return 1
    fi
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    if ! id "$username" >/dev/null 2>&1; then
        echo "âŒ ç”¨æˆ·ä¸å­˜åœ¨: $username"
        return 1
    fi
    
    # ç”Ÿæˆå¯†ç 
    local new_password=""
    case "$password_type" in
        "auto")
            new_password=$(openssl rand -base64 12)
            echo "ç”Ÿæˆéšæœºå¯†ç : $new_password"
            ;;
        "temp")
            new_password="TempPass123!"
            echo "ä½¿ç”¨ä¸´æ—¶å¯†ç : $new_password"
            ;;
        "manual")
            echo "è¯·è¾“å…¥æ–°å¯†ç :"
            read -s -p "å¯†ç : " new_password
            echo ""
            read -s -p "ç¡®è®¤å¯†ç : " confirm_password
            echo ""
            
            if [ "$new_password" != "$confirm_password" ]; then
                echo "âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´"
                return 1
            fi
            ;;
        *)
            echo "âŒ æ— æ•ˆçš„å¯†ç ç±»å‹: $password_type"
            return 1
            ;;
    esac
    
    # é‡ç½®å¯†ç 
    echo "é‡ç½®ç”¨æˆ·å¯†ç ..."
    echo "$username:$new_password" | sudo chpasswd
    
    if [ $? -eq 0 ]; then
        echo "âœ… å¯†ç é‡ç½®æˆåŠŸ"
        
        # è§£é”è´¦æˆ·
        if command -v passwd >/dev/null 2>&1; then
            sudo passwd -u "$username" 2>/dev/null || true
            echo "âœ… è´¦æˆ·å·²è§£é”"
        fi
        
        # å¼ºåˆ¶ä¸‹æ¬¡ç™»å½•ä¿®æ”¹å¯†ç 
        if [ "$password_type" = "temp" ]; then
            sudo chage -d 0 "$username"
            echo "âœ… å·²è®¾ç½®ä¸‹æ¬¡ç™»å½•å¼ºåˆ¶ä¿®æ”¹å¯†ç "
        fi
        
        # è®°å½•å¯†ç é‡ç½®æ—¥å¿—
        echo "$(date): ç”¨æˆ· $username å¯†ç è¢«é‡ç½®" | sudo tee -a /var/log/password_reset.log
        
        echo ""
        echo "å¯†ç é‡ç½®å®Œæˆ"
        echo "æ–°å¯†ç : $new_password"
        echo "è¯·å®‰å…¨åœ°å°†å¯†ç ä¼ é€’ç»™ç”¨æˆ·"
        
    else
        echo "âŒ å¯†ç é‡ç½®å¤±è´¥"
        return 1
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
# USER_PASSWORD_DIAGNOSIS username
# USER_PASSWORD_RESET username auto
```

## 2 æƒé™ç®¡ç†é—®é¢˜

### 2.1 æ–‡ä»¶æƒé™é—®é¢˜è¯Šæ–­

#### 2.1.1 æ–‡ä»¶æƒé™é—®é¢˜æ£€æŸ¥

```bash
#!/bin/bash
# æ–‡ä»¶æƒé™é—®é¢˜æ£€æŸ¥

# æ–‡ä»¶æƒé™é—®é¢˜æ£€æŸ¥
FILE_PERMISSION_CHECK() {
    local target_path="$1"
    local check_type="${2:-basic}"
    
    echo "=== æ–‡ä»¶æƒé™é—®é¢˜æ£€æŸ¥ ==="
    echo "æ£€æŸ¥æ—¶é—´: $(date)"
    echo ""
    
    if [ -z "$target_path" ]; then
        echo "ç”¨æ³•: $0 <æ–‡ä»¶/ç›®å½•è·¯å¾„> [æ£€æŸ¥ç±»å‹(basic|detailed|security)]"
        return 1
    fi
    
    if [ ! -e "$target_path" ]; then
        echo "âŒ è·¯å¾„ä¸å­˜åœ¨: $target_path"
        return 1
    fi
    
    echo "æ£€æŸ¥è·¯å¾„: $target_path"
    echo "æ£€æŸ¥ç±»å‹: $check_type"
    echo ""
    
    # åŸºæœ¬æƒé™æ£€æŸ¥
    echo "1. åŸºæœ¬æƒé™ä¿¡æ¯:"
    local file_info=$(ls -ld "$target_path")
    echo "è¯¦ç»†ä¿¡æ¯: $file_info"
    
    local file_perms=$(stat -c "%a" "$target_path")
    local file_owner=$(stat -c "%U" "$target_path")
    local file_group=$(stat -c "%G" "$target_path")
    local file_type=$(stat -c "%F" "$target_path")
    
    echo "æƒé™: $file_perms"
    echo "å±ä¸»: $file_owner"
    echo "å±ç»„: $file_group"
    echo "ç±»å‹: $file_type"
    echo ""
    
    # æƒé™åˆ†æ
    echo "2. æƒé™åˆ†æ:"
    
    # æ£€æŸ¥æ–‡ä»¶æƒé™
    case "$file_type" in
        "regular file")
            # æ™®é€šæ–‡ä»¶æƒé™æ£€æŸ¥
            if [ "$file_perms" -gt 644 ]; then
                echo "âš ï¸  æ–‡ä»¶æƒé™è¿‡äºå®½æ¾ (å»ºè®®: 644)"
            else
                echo "âœ… æ–‡ä»¶æƒé™åˆç†"
            fi
            ;;
        "directory")
            # ç›®å½•æƒé™æ£€æŸ¥
            if [ "$file_perms" -gt 755 ]; then
                echo "âš ï¸  ç›®å½•æƒé™è¿‡äºå®½æ¾ (å»ºè®®: 755)"
            else
                echo "âœ… ç›®å½•æƒé™åˆç†"
            fi
            ;;
        "symbolic link")
            echo "ç¬¦å·é“¾æ¥ï¼Œæ£€æŸ¥ç›®æ ‡æ–‡ä»¶æƒé™..."
            local link_target=$(readlink "$target_path")
            if [ -e "$link_target" ]; then
                FILE_PERMISSION_CHECK "$link_target" "$check_type"
            fi
            ;;
    esac
    
    # æ£€æŸ¥ç‰¹æ®Šæƒé™
    local special_perms=$((file_perms / 1000))
    if [ "$special_perms" -gt 0 ]; then
        echo "ç‰¹æ®Šæƒé™: $special_perms (SUID: $((special_perms & 4 ? 1 : 0)), SGID: $((special_perms & 2 ? 1 : 0)), Sticky: $((special_perms & 1 ? 1 : 0)))"
    fi
    echo ""
    
    # è¯¦ç»†æƒé™æ£€æŸ¥
    if [ "$check_type" = "detailed" ] || [ "$check_type" = "security" ]; then
        echo "3. è¯¦ç»†æƒé™æ£€æŸ¥:"
        
        # æ£€æŸ¥ACLæƒé™
        if command -v getfacl >/dev/null 2>&1; then
            echo "ACLæƒé™:"
            getfacl "$target_path" 2>/dev/null | head -10
            echo ""
        fi
        
        # æ£€æŸ¥æ‰©å±•å±æ€§
        if command -v getfattr >/dev/null 2>&1; then
            echo "æ‰©å±•å±æ€§:"
            getfattr -d "$target_path" 2>/dev/null | head -5
            echo ""
        fi
        
        # æ£€æŸ¥SELinuxä¸Šä¸‹æ–‡
        if command -v getenforce >/dev/null 2>&1; then
            if [ "$(getenforce)" != "Disabled" ]; then
                echo "SELinuxä¸Šä¸‹æ–‡:"
                ls -Z "$target_path" 2>/dev/null
                echo ""
            fi
        fi
        
        # æ£€æŸ¥æ–‡ä»¶æ‰€æœ‰æƒ
        echo "æ‰€æœ‰æƒæ£€æŸ¥:"
        if [ "$file_owner" = "root" ]; then
            echo "âœ… æ–‡ä»¶å±ä¸»ä¸ºroot"
        else
            echo "âš ï¸  æ–‡ä»¶å±ä¸»ä¸æ˜¯root: $file_owner"
        fi
        
        if [ "$file_group" = "root" ]; then
            echo "âœ… æ–‡ä»¶å±ç»„ä¸ºroot"
        else
            echo "âš ï¸  æ–‡ä»¶å±ç»„ä¸æ˜¯root: $file_group"
        fi
        echo ""
    fi
    
    # å®‰å…¨æƒé™æ£€æŸ¥
    if [ "$check_type" = "security" ]; then
        echo "4. å®‰å…¨æƒé™æ£€æŸ¥:"
        
        # æ£€æŸ¥å…¨å±€å¯å†™æ–‡ä»¶
        if [ $((file_perms & 2)) -ne 0 ]; then
            echo "âš ï¸  æ–‡ä»¶å…¨å±€å¯å†™"
        fi
        
        # æ£€æŸ¥å…¨å±€å¯æ‰§è¡Œæ–‡ä»¶
        if [ $((file_perms & 1)) -ne 0 ] && [ "$file_type" = "regular file" ]; then
            echo "âš ï¸  æ–‡ä»¶å…¨å±€å¯æ‰§è¡Œ"
        fi
        
        # æ£€æŸ¥SUID/SGIDä½
        if [ $((file_perms & 4000)) -ne 0 ]; then
            echo "âš ï¸  æ–‡ä»¶è®¾ç½®äº†SUIDä½"
        fi
        
        if [ $((file_perms & 2000)) -ne 0 ]; then
            echo "âš ï¸  æ–‡ä»¶è®¾ç½®äº†SGIDä½"
        fi
        
        # æ£€æŸ¥ç³»ç»Ÿå…³é”®æ–‡ä»¶
        local critical_files=("/etc/passwd" "/etc/shadow" "/etc/sudoers" "/bin" "/sbin" "/usr/bin" "/usr/sbin")
        for critical_file in "${critical_files[@]}"; do
            if [ "$target_path" = "$critical_file" ]; then
                echo "âš ï¸  è¿™æ˜¯ç³»ç»Ÿå…³é”®æ–‡ä»¶: $target_path"
                break
            fi
        done
        echo ""
        
        # æƒé™å»ºè®®
        echo "5. æƒé™å»ºè®®:"
        case "$file_type" in
            "regular file")
                if [ "$file_owner" = "root" ] && [ "$file_group" = "root" ]; then
                    echo "å»ºè®®æƒé™: 644 (rw-r--r--)"
                else
                    echo "å»ºè®®æƒé™: 640 (rw-r-----)"
                fi
                ;;
            "directory")
                if [ "$file_owner" = "root" ] && [ "$file_group" = "root" ]; then
                    echo "å»ºè®®æƒé™: 755 (rwxr-xr-x)"
                else
                    echo "å»ºè®®æƒé™: 750 (rwxr-x---)"
                fi
                ;;
        esac
        echo ""
    fi
    
    # é€’å½’æ£€æŸ¥ç›®å½•
    if [ "$file_type" = "directory" ] && [ "$check_type" = "detailed" ]; then
        echo "6. ç›®å½•å†…å®¹æƒé™æ£€æŸ¥:"
        find "$target_path" -maxdepth 2 -type f -exec ls -l {} \; 2>/dev/null | head -10
        echo ""
    fi
}

# æƒé™æ‰¹é‡ä¿®å¤
FILE_PERMISSION_BATCH_REPAIR() {
    local target_path="$1"
    local repair_type="${2:-standard}"
    
    echo "=== æ–‡ä»¶æƒé™æ‰¹é‡ä¿®å¤ ==="
    echo "ä¿®å¤æ—¶é—´: $(date)"
    echo "ç›®æ ‡è·¯å¾„: $target_path"
    echo "ä¿®å¤ç±»å‹: $repair_type"
    echo ""
    
    if [ -z "$target_path" ]; then
        echo "ç”¨æ³•: $0 <è·¯å¾„> [ä¿®å¤ç±»å‹(standard|secure|custom)]"
        return 1
    fi
    
    if [ ! -e "$target_path" ]; then
        echo "âŒ è·¯å¾„ä¸å­˜åœ¨: $target_path"
        return 1
    fi
    
    # åˆ›å»ºä¿®å¤æ—¥å¿—
    local repair_log="/tmp/permission_repair_$(date +%Y%m%d_%H%M%S).log"
    echo "ä¿®å¤æ—¥å¿—: $repair_log"
    echo ""
    
    # æ ‡å‡†ä¿®å¤
    if [ "$repair_type" = "standard" ]; then
        echo "1. æ ‡å‡†æƒé™ä¿®å¤:"
        
        # ä¿®å¤ç›®å½•æƒé™
        echo "ä¿®å¤ç›®å½•æƒé™ä¸º755..."
        find "$target_path" -type d -exec chmod 755 {} \; 2>/dev/null
        echo "âœ… ç›®å½•æƒé™ä¿®å¤å®Œæˆ"
        echo ""
        
        # ä¿®å¤æ–‡ä»¶æƒé™
        echo "ä¿®å¤æ–‡ä»¶æƒé™ä¸º644..."
        find "$target_path" -type f -exec chmod 644 {} \; 2>/dev/null
        echo "âœ… æ–‡ä»¶æƒé™ä¿®å¤å®Œæˆ"
        echo ""
        
        # ä¿®å¤å¯æ‰§è¡Œæ–‡ä»¶
        echo "ä¿®å¤å¯æ‰§è¡Œæ–‡ä»¶æƒé™ä¸º755..."
        find "$target_path" -type f -executable -exec chmod 755 {} \; 2>/dev/null
        echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶æƒé™ä¿®å¤å®Œæˆ"
        echo ""
        
    # å®‰å…¨ä¿®å¤
    elif [ "$repair_type" = "secure" ]; then
        echo "2. å®‰å…¨æƒé™ä¿®å¤:"
        
        # ä¿®å¤å±ä¸»ä¸ºroot
        echo "ä¿®å¤å±ä¸»ä¸ºroot..."
        find "$target_path" -exec chown root:root {} \; 2>/dev/null
        echo "âœ… å±ä¸»ä¿®å¤å®Œæˆ"
        echo ""
        
        # ä¸¥æ ¼æƒé™è®¾ç½®
        echo "è®¾ç½®ä¸¥æ ¼æƒé™..."
        find "$target_path" -type d -exec chmod 750 {} \; 2>/dev/null
        find "$target_path" -type f -exec chmod 640 {} \; 2>/dev/null
        find "$target_path" -type f -executable -exec chmod 750 {} \; 2>/dev/null
        echo "âœ… ä¸¥æ ¼æƒé™è®¾ç½®å®Œæˆ"
        echo ""
        
        # ç§»é™¤ç‰¹æ®Šæƒé™
        echo "ç§»é™¤ç‰¹æ®Šæƒé™..."
        find "$target_path" -type f -exec chmod u-s,g-s {} \; 2>/dev/null
        echo "âœ… ç‰¹æ®Šæƒé™ç§»é™¤å®Œæˆ"
        echo ""
        
    # è‡ªå®šä¹‰ä¿®å¤
    elif [ "$repair_type" = "custom" ]; then
        echo "3. è‡ªå®šä¹‰æƒé™ä¿®å¤:"
        
        echo "è¯·è¾“å…¥è‡ªå®šä¹‰æƒé™è®¾ç½®:"
        read -p "ç›®å½•æƒé™ (å¦‚: 755): " dir_perms
        read -p "æ–‡ä»¶æƒé™ (å¦‚: 644): " file_perms
        read -p "å¯æ‰§è¡Œæ–‡ä»¶æƒé™ (å¦‚: 755): " exec_perms
        read -p "æ˜¯å¦ä¿®æ”¹å±ä¸» (y/n): " change_owner
        
        if [ "$change_owner" = "y" ]; then
            read -p "æ–°å±ä¸» (å¦‚: root:root): " new_owner
            echo "ä¿®å¤å±ä¸»ä¸º$new_owner..."
            find "$target_path" -exec chown "$new_owner" {} \; 2>/dev/null
            echo "âœ… å±ä¸»ä¿®å¤å®Œæˆ"
            echo ""
        fi
        
        # åº”ç”¨è‡ªå®šä¹‰æƒé™
        if [ -n "$dir_perms" ]; then
            echo "ä¿®å¤ç›®å½•æƒé™ä¸º$dir_perms..."
            find "$target_path" -type d -exec chmod "$dir_perms" {} \; 2>/dev/null
            echo "âœ… ç›®å½•æƒé™ä¿®å¤å®Œæˆ"
        fi
        
        if [ -n "$file_perms" ]; then
            echo "ä¿®å¤æ–‡ä»¶æƒé™ä¸º$file_perms..."
            find "$target_path" -type f -exec chmod "$file_perms" {} \; 2>/dev/null
            echo "âœ… æ–‡ä»¶æƒé™ä¿®å¤å®Œæˆ"
        fi
        
        if [ -n "$exec_perms" ]; then
            echo "ä¿®å¤å¯æ‰§è¡Œæ–‡ä»¶æƒé™ä¸º$exec_perms..."
            find "$target_path" -type f -executable -exec chmod "$exec_perms" {} \; 2>/dev/null
            echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶æƒé™ä¿®å¤å®Œæˆ"
        fi
        echo ""
    fi
    
    # éªŒè¯ä¿®å¤ç»“æœ
    echo "4. éªŒè¯ä¿®å¤ç»“æœ:"
    echo "ä¿®å¤å‰æƒé™ç»Ÿè®¡:"
    find "$target_path" -exec stat -c "%a" {} \; 2>/dev/null | sort | uniq -c | sort -nr
    echo ""
    
    echo "ä¿®å¤åæƒé™ç»Ÿè®¡:"
    find "$target_path" -exec stat -c "%a" {} \; 2>/dev/null | sort | uniq -c | sort -nr
    echo ""
    
    # è®°å½•ä¿®å¤æ—¥å¿—
    echo "æƒé™ä¿®å¤å®Œæˆ" | tee -a "$repair_log"
    echo "ä¿®å¤æ—¶é—´: $(date)" | tee -a "$repair_log"
    echo "ä¿®å¤ç±»å‹: $repair_type" | tee -a "$repair_log"
    echo "ä¿®å¤è·¯å¾„: $target_path" | tee -a "$repair_log"
    
    echo "âœ… æƒé™æ‰¹é‡ä¿®å¤å®Œæˆ"
    echo "è¯¦ç»†æ—¥å¿—: $repair_log"
}

# ä½¿ç”¨ç¤ºä¾‹
# FILE_PERMISSION_CHECK /etc/passwd security
# FILE_PERMISSION_BATCH_REPAIR /home/user standard
```

è¿™äº›ç”¨æˆ·ä¸æƒé™ç®¡ç†é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆæ¶µç›–äº†ç”¨æˆ·è´¦æˆ·ç®¡ç†ã€å¯†ç ç­–ç•¥ã€æ–‡ä»¶æƒé™æ§åˆ¶ç­‰æ ¸å¿ƒå®‰å…¨ç®¡ç†é¢†åŸŸï¼Œä¸ºç³»ç»Ÿç®¡ç†å‘˜æä¾›äº†å…¨é¢çš„æƒé™ç®¡ç†é—®é¢˜å¤„ç†å·¥å…·é›†ã€‚