# df命令详解

## 1. 命令概述

`df`（disk free）命令是Linux/Unix系统中用于显示文件系统磁盘空间使用情况的命令行工具。它可以帮助系统管理员和用户了解各个挂载点的磁盘空间总量、已用空间、可用空间以及使用率等关键信息。

### 1.1 主要功能

- 显示所有文件系统的磁盘空间使用情况
- 以指定单位显示磁盘空间（KB、MB、GB等）
- 显示inode使用情况
- 显示特定文件或目录所在的文件系统信息
- 排除特定类型的文件系统

### 1.2 应用场景

`df`命令在以下场景中特别有用：
- 系统监控和性能优化
- 磁盘空间管理和规划
- 排查磁盘空间不足问题
- 确定文件或目录所在的文件系统
- 验证挂载点和文件系统状态

## 2. 语法格式

`df`命令的基本语法格式如下：

```bash
# 基本语法
$ df [选项] [文件/目录...]
```

其中，
- `选项`：用于控制命令的输出格式和行为
- `文件/目录`：可选参数，用于显示指定文件或目录所在文件系统的信息

## 3. 常用选项

`df`命令支持多种选项来定制输出格式和显示内容。以下是最常用的选项：

| 选项 | 功能描述 |
|------|----------|
| `-a`, `--all` | 显示所有文件系统，包括虚拟文件系统（如/proc）和特殊文件系统 |
| `-h`, `--human-readable` | 以人类可读的格式显示大小（KB、MB、GB等） |
| `-H`, `--si` | 与`-h`类似，但使用1000作为换算单位（而非1024） |
| `-i`, `--inodes` | 显示inode信息而非块使用情况 |
| `-k` | 以KB为单位显示大小（默认单位） |
| `-m` | 以MB为单位显示大小 |
| `-g` | 以GB为单位显示大小 |
| `-T`, `--print-type` | 显示文件系统类型 |
| `-t <type>`, `--type=<type>` | 仅显示指定类型的文件系统 |
| `-x <type>`, `--exclude-type=<type>` | 排除指定类型的文件系统 |
| `--total` | 在输出末尾显示总计信息 |
| `-P`, `--portability` | 使用POSIX兼容的输出格式 |
| `-l`, `--local` | 仅显示本地文件系统 |

## 4. 基本用法

### 4.1 显示所有挂载的文件系统

**功能说明**：显示所有已挂载文件系统的磁盘空间使用情况。

**示例**：

```bash
$ df
Filesystem     1K-blocks      Used Available Use% Mounted on
udev             4028360         0   4028360   0% /dev
tmpfs             811424      1816    809608   1% /run
/dev/sda1       20262484   8540352  10687472  45% /
tmpfs            4057120      3232   4053888   1% /dev/shm
tmpfs               5120         4      5116   1% /run/lock
tmpfs            4057120         0   4057120   0% /sys/fs/cgroup
/dev/sda6       58123296  21656908  33466388  40% /home
tmpfs             811424        20    811404   1% /run/user/1000
```

### 4.2 以人类可读的格式显示

**功能说明**：使用`-h`选项以KB、MB、GB等更容易理解的单位显示磁盘空间。

**示例**：

```bash
$ df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            3.9G     0  3.9G   0% /dev
tmpfs           793M  1.8M  791M   1% /run
/dev/sda1        20G  8.2G   11G  45% /
tmpfs           3.9G  3.2M  3.9G   1% /dev/shm
tmpfs           5.0M  4.0K  5.0M   1% /run/lock
tmpfs           3.9G     0  3.9G   0% /sys/fs/cgroup
/dev/sda6        56G   21G   32G  40% /home
tmpfs           793M   20K  793M   1% /run/user/1000
```

### 4.3 显示inode使用情况

**功能说明**：使用`-i`选项显示文件系统的inode使用情况，而不是块使用情况。

**示例**：

```bash
$ df -i
Filesystem      Inodes  IUsed   IFree IUse% Mounted on
udev           1007090    512 1006578    1% /dev
tmpfs          1014280    738 1013542    1% /run
/dev/sda1      1280000 203845 1076155   17% /
tmpfs          1014280     18 1014262    1% /dev/shm
tmpfs          1014280      6 1014274    1% /run/lock
tmpfs          1014280     17 1014263    1% /sys/fs/cgroup
/dev/sda6      3648512 384237 3264275   11% /home
tmpfs          1014280     47 1014233    1% /run/user/1000
```

### 4.4 显示文件系统类型

**功能说明**：使用`-T`选项显示每个文件系统的类型。

**示例**：

```bash
$ df -T
Filesystem     Type      1K-blocks      Used Available Use% Mounted on
udev           devtmpfs    4028360         0   4028360   0% /dev
tmpfs          tmpfs        811424      1816    809608   1% /run
/dev/sda1      ext4       20262484   8540352  10687472  45% /
tmpfs          tmpfs       4057120      3232   4053888   1% /dev/shm
tmpfs          tmpfs          5120         4      5116   1% /run/lock
tmpfs          tmpfs       4057120         0   4057120   0% /sys/fs/cgroup
/dev/sda6      ext4       58123296  21656908  33466388  40% /home
tmpfs          tmpfs        811424        20    811404   1% /run/user/1000
```

### 4.5 显示特定文件系统类型

**功能说明**：使用`-t`选项仅显示指定类型的文件系统。

**示例**：

```bash
$ df -t ext4
Filesystem     1K-blocks      Used Available Use% Mounted on
/dev/sda1       20262484   8540352  10687472  45% /
/dev/sda6       58123296  21656908  33466388  40% /home
```

### 4.6 排除特定文件系统类型

**功能说明**：使用`-x`选项排除指定类型的文件系统。

**示例**：

```bash
$ df -x tmpfs
Filesystem     1K-blocks      Used Available Use% Mounted on
udev             4028360         0   4028360   0% /dev
/dev/sda1       20262484   8540352  10687472  45% /
/dev/sda6       58123296  21656908  33466388  40% /home
```

### 4.7 显示指定文件或目录所在的文件系统

**功能说明**：在命令后指定文件或目录路径，可以显示该文件或目录所在的文件系统信息。

**示例**：

```bash
$ df -h /home
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda6        56G   21G   32G  40% /home

$ df -h /var/log/syslog
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        20G  8.2G   11G  45% /
```

### 4.8 同时显示多种信息

**功能说明**：可以组合多个选项，同时显示多种信息。

**示例**：

```bash
$ df -hT
Filesystem      Type      Size  Used Avail Use% Mounted on
udev            devtmpfs  3.9G     0  3.9G   0% /dev
tmpfs           tmpfs     793M  1.8M  791M   1% /run
/dev/sda1       ext4       20G  8.2G   11G  45% /
tmpfs           tmpfs     3.9G  3.2M  3.9G   1% /dev/shm
tmpfs           tmpfs     5.0M  4.0K  5.0M   1% /run/lock
tmpfs           tmpfs     3.9G     0  3.9G   0% /sys/fs/cgroup
/dev/sda6       ext4       56G   21G   32G  40% /home
tmpfs           tmpfs     793M   20K  793M   1% /run/user/1000
```

## 5. 高级用法与技巧

### 5.1 监控磁盘空间使用情况

**功能说明**：定期检查磁盘空间使用情况，以便及时发现磁盘空间不足的问题。

**示例**：

```bash
# 创建一个简单的磁盘监控脚本
echo '#!/bin/bash
# 磁盘空间监控脚本
THRESHOLD=90  # 设定告警阈值为90%

# 获取所有挂载点的使用情况
df -h | grep -v tmpfs | grep -v udev | while read line
do
    # 提取挂载点和使用率
    mount_point=$(echo $line | awk '{print $6}')
    usage=$(echo $line | awk '{print $5}' | sed 's/%//')
    
    # 检查使用率是否超过阈值
    if [ $usage -ge $THRESHOLD ]; then
        echo "警告: $mount_point 分区使用率 ($usage%) 超过阈值 ($THRESHOLD%)"
    fi
done' > disk_monitor.sh

# 使脚本可执行
chmod +x disk_monitor.sh

# 执行脚本检查磁盘空间
sudo ./disk_monitor.sh
```

### 5.2 查找占用空间最大的文件和目录

**功能说明**：结合`du`命令和`sort`命令，查找系统中占用空间最大的文件和目录。

**示例**：

```bash
# 查找根目录下占用空间最大的前10个目录
$ du -h / --max-depth=1 2>/dev/null | sort -rh | head -10
20G     /
15G     /home
4.5G    /usr
524M    /var
128M    /boot
32M     /etc
16M     /opt
8.0K    /mnt
8.0K    /media
4.0K    /srv

# 查找某个目录下占用空间最大的前5个文件
$ find /home/user/documents -type f -exec du -h {} + | sort -rh | head -5
2.5G    /home/user/documents/backup.zip
1.8G    /home/user/documents/video.mp4
1.2G    /home/user/documents/photos.tar.gz
850M    /home/user/documents/large_file.iso
680M    /home/user/documents/data.csv
```

### 5.3 导出磁盘空间使用情况报告

**功能说明**：将磁盘空间使用情况导出为CSV格式的报告，便于后续分析和处理。

**示例**：

```bash
# 导出磁盘空间使用情况为CSV格式
echo "Filesystem,Type,Size_KB,Used_KB,Available_KB,Use_Percent,Mounted_On" > disk_report.csv
df -TP | tail -n +2 | awk -F'[[:space:]]+' '{print $1","$2","$3","$4","$5","$6","$7}' >> disk_report.csv

# 查看生成的报告
cat disk_report.csv
```

### 5.4 检查远程挂载的文件系统

**功能说明**：检查远程挂载的文件系统（如NFS、SMB等）的磁盘空间使用情况。

**示例**：

```bash
# 显示所有挂载点，包括远程挂载的文件系统
$ df -hT
Filesystem        Type      Size  Used Avail Use% Mounted on
//server/share    cifs       50G   30G   20G  60% /mnt/remote_share

# 仅显示NFS和CIFS类型的远程文件系统
$ df -t nfs -t cifs -h
Filesystem        Type      Size  Used Avail Use% Mounted on
//server/share    cifs       50G   30G   20G  60% /mnt/remote_share
192.168.1.100:/data nfs       100G   45G   55G  45% /mnt/nfs_share
```

### 5.5 自动清理临时文件

**功能说明**：当磁盘空间不足时，自动清理系统中的临时文件和缓存。

**示例**：

```bash
#!/bin/bash
# 磁盘空间自动清理脚本
THRESHOLD=85  # 设定清理阈值为85%
TMP_DIRS="/tmp /var/tmp /var/cache/apt/archives"

# 检查根分区使用率
root_usage=$(df -h / | grep -v Filesystem | awk '{print $5}' | sed 's/%//')

# 如果使用率超过阈值，清理临时文件
if [ $root_usage -ge $THRESHOLD ]; then
    echo "警告: 根分区使用率 ($root_usage%) 超过阈值 ($THRESHOLD%)，开始清理临时文件..."
    
    # 清理临时目录中的文件（7天以上未访问的文件）
    for dir in $TMP_DIRS; do
        if [ -d $dir ]; then
            echo "清理 $dir 目录中7天以上的文件..."
            find $dir -type f -atime +7 -delete
        fi
    done
    
    # 清理系统日志文件
    echo "清理系统日志文件..."
    journalctl --vacuum-time=7d
    
    # 显示清理后的磁盘空间
    echo "清理完成！当前磁盘空间使用情况："
    df -h /
fi
```

## 6. 实用技巧与应用场景

### 6.1 系统备份前的空间检查

在执行系统备份前，使用`df`命令检查目标备份设备的可用空间，确保有足够的空间存储备份数据：

```bash
# 检查备份设备的可用空间
df -h /backup

# 估算要备份的数据大小
du -sh /home /etc /var | sort -rh
```

### 6.2 监控Web服务器磁盘空间

对于Web服务器，定期检查日志文件目录和网站内容目录的磁盘空间使用情况：

```bash
# 检查Web服务器相关目录的磁盘空间
df -h /var/log/apache2 /var/www

# 查找占用空间最大的日志文件
find /var/log/apache2 -name "*.log" -type f -exec du -h {} + | sort -rh | head -5
```

### 6.3 分析数据库服务器磁盘使用

对于数据库服务器，监控数据文件和日志文件所在分区的磁盘空间：

```bash
# 检查数据库相关分区的磁盘空间
df -h /var/lib/mysql /var/log/mysql

# 查看数据库文件占用情况
find /var/lib/mysql -type d -exec du -sh {} + | sort -rh | head -10
```

### 6.4 创建磁盘空间监控 cron 任务

设置定期执行的cron任务，自动监控磁盘空间并在空间不足时发送警告：

```bash
# 编辑cron任务
crontab -e

# 添加以下行，每天凌晨2点执行磁盘监控脚本
0 2 * * * /path/to/disk_monitor.sh >> /var/log/disk_monitor.log 2>&1
```

### 6.5 排查磁盘空间快速增长问题

当发现磁盘空间快速增长时，可以使用以下命令组合来找出导致空间增长的原因：

```bash
# 1. 首先检查整体磁盘空间使用情况
df -h

# 2. 找出占用空间最大的目录
du -h / --max-depth=1 2>/dev/null | sort -rh | head -20

# 3. 进一步检查可疑目录
cd /path/to/large/dir
du -h --max-depth=1 | sort -rh | head -20

# 4. 查找最近修改的大文件
find / -type f -size +100M -mtime -7 -ls 2>/dev/null

# 5. 检查系统日志是否异常增长
ls -lhS /var/log/*
```

## 7. 常见问题与解决方案

### 7.1 磁盘空间显示不正确

**问题描述**：使用`df`命令显示的磁盘空间使用情况与实际不符。

**解决方案**：

```bash
# 检查是否有被删除但仍被进程占用的文件
lsof | grep deleted

# 如果有，重启相应的进程或等待进程正常结束
# 临时解决方案：使用以下命令强制释放被占用的空间
echo > /proc/{PID}/fd/{FD}

# 重新挂载文件系统以更新统计信息
mount -o remount /mount/point
```

### 7.2 df命令不显示某些文件系统

**问题描述**：某些挂载的文件系统没有在`df`命令的输出中显示。

**解决方案**：

```bash
# 显示所有文件系统，包括虚拟文件系统
df -a

# 检查文件系统是否正确挂载
mount | grep /missing/mount/point

# 检查/etc/fstab文件中的挂载配置
cat /etc/fstab
```

### 7.3 磁盘空间使用率达到100%

**问题描述**：`df`命令显示某个分区的使用率达到或接近100%，导致系统无法正常运行。

**解决方案**：

```bash
# 紧急解决方案：清理临时文件和缓存
sudo apt-get clean  # 清理包缓存
sudo rm -rf /tmp/*  # 清理临时文件

# 找出占用空间最大的目录和文件
du -h / --max-depth=1 2>/dev/null | sort -rh | head -20

# 检查日志文件大小
ls -lhS /var/log/*

# 对于日志文件，可以使用truncate命令清空
sudo truncate -s 0 /var/log/large_log_file.log

# 长期解决方案：考虑增加磁盘空间或迁移部分数据到其他分区
```

### 7.4 inode使用率过高

**问题描述**：虽然磁盘空间还有剩余，但系统提示无法创建新文件，使用`df -i`检查发现inode使用率接近或达到100%。

**解决方案**：

```bash
# 检查inode使用情况
df -i

# 找出大量小文件的目录
find / -xdev -type f | cut -d "=" -f 1 | sort | uniq -c | sort -n | tail -20

# 清理这些小文件（注意：确保这些文件可以删除）
# 例如，清理邮件队列中的大量邮件
sudo rm -f /var/spool/mqueue/*

# 长期解决方案：在创建新分区时增加inode数量，或使用更适合大量小文件的文件系统
```

### 7.5 NFS挂载的文件系统不响应

**问题描述**：使用`df`命令检查NFS挂载的文件系统时，命令可能会卡住或响应缓慢。

**解决方案**：

```bash
# 使用timeout命令限制df的执行时间
timeout 10 df -h

# 检查NFS服务器的连接状态
ping -c 4 nfs_server_ip

sudo showmount -e nfs_server_ip

# 如果NFS服务器不可用，可以强制卸载NFS挂载点
sudo umount -f -l /mnt/nfs_share
```

## 8. 相关命令对比

`df`命令主要用于显示文件系统的磁盘空间使用情况，而在Linux系统中还有其他一些相关命令，它们各有侧重：

| 命令 | 主要功能 | 与df的区别 | 适用场景 |
|------|----------|-----------|----------|
| `df` | 显示文件系统磁盘空间使用情况 | 专注于文件系统级别的空间统计 | 检查磁盘分区空间、监控系统存储状态 |
| `du` | 显示目录或文件的磁盘使用情况 | 专注于文件和目录级别的空间统计 | 查找大文件、分析目录占用空间 |
| `ls` | 列出目录内容和文件信息 | 可以显示单个文件大小，但不提供汇总信息 | 查看文件详情、基本大小信息 |
| `stat` | 显示文件或文件系统的详细信息 | 提供更详细的inode和文件系统信息 | 查看文件的详细元数据 |
| `fdisk` | 磁盘分区工具 | 专注于磁盘分区管理，不提供空间使用情况 | 磁盘分区创建和管理 |
| `parted` | 高级磁盘分区工具 | 支持更大的磁盘和更多分区格式 | 高级磁盘分区管理 |
| `mount` | 挂载文件系统 | 用于挂载和查看挂载点状态 | 文件系统挂载管理 |
| `tune2fs` | 调整ext文件系统参数 | 可以查看和修改文件系统特性 | 文件系统调优和维护 |

### 8.1 df与du命令的对比

`df`和`du`是两个最常用的磁盘空间分析工具，它们有以下主要区别：

1. **统计对象不同**：
   - `df`统计整个文件系统的使用情况
   - `du`统计指定目录或文件的使用情况

2. **统计方式不同**：
   - `df`从文件系统的元数据获取信息，速度较快
   - `du`通过遍历目录树计算每个文件的大小，速度较慢

3. **结果可能不同**：
   - 由于`df`和`du`的统计方式不同，它们的结果可能存在差异
   - 特别是当有文件被删除但仍被进程占用时，`df`会显示这些文件占用的空间，而`du`不会

**示例对比**：

```bash
# 使用df查看根目录所在文件系统的使用情况
$ df -h /
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        20G  8.2G   11G  45% /

# 使用du查看根目录下所有文件和目录的总大小
$ du -sh / --exclude={proc,dev,run,sys,mnt,media,tmp} 2>/dev/null
8.2G    /
```

### 8.2 最佳实践组合

在实际系统管理中，通常会结合使用多个命令来全面了解和管理系统的磁盘空间：

1. **快速磁盘概览**：`df -h`
2. **磁盘空间详细分析**：`df -hT && du -sh /* --exclude={proc,dev,run,sys,mnt,media,tmp} 2>/dev/null | sort -rh`
3. **磁盘健康检查**：`df -h && smartctl -a /dev/sda`
4. **挂载点验证**：`df -h && mount`
5. **磁盘空间监控**：`df -h | awk '$5 > 90 {print "警告: " $6 " 使用率: " $5}'`

## 9. 实践练习

### 9.1 基础练习

1. **查看系统磁盘空间**：
   - 使用`df`命令查看系统中所有文件系统的磁盘空间使用情况
   - 使用`-h`选项以人类可读的格式显示
   - 记录输出结果，并解释每个字段的含义

2. **显示文件系统类型**：
   - 使用`df`命令显示所有文件系统的类型
   - 识别系统中使用了哪些类型的文件系统
   - 尝试仅显示特定类型的文件系统（如ext4）

3. **查看inode使用情况**：
   - 使用`df`命令查看系统中所有文件系统的inode使用情况
   - 理解inode与文件数量的关系
   - 比较inode使用率和空间使用率的区别

### 9.2 中级练习

1. **创建磁盘监控脚本**：
   - 编写一个shell脚本，定期检查系统中所有文件系统的磁盘空间使用情况
   - 当磁盘空间使用率超过设定阈值时，输出警告信息
   - 脚本应支持自定义阈值和监控间隔

   **参考脚本框架**：
   ```bash
   #!/bin/bash
   
   # 默认参数
   THRESHOLD=90  # 默认警告阈值（百分比）
   
   # 显示帮助信息
   show_help() {
       echo "磁盘空间监控脚本"
       echo "用法: $0 [-t 阈值]"
       echo "选项:"
       echo "  -t  警告阈值（百分比），默认为90"
       echo "  -h  显示帮助信息"
   }
   
   # 解析命令行参数
   while getopts "t:h" opt; do
       case $opt in
           t) THRESHOLD=$OPTARG ;;
           h) show_help; exit 0 ;;
           *) show_help; exit 1 ;;
       esac
   done
   
   echo "开始磁盘空间监控（阈值: ${THRESHOLD}%）..."
   
   # 检查所有文件系统
   df -h | grep -v tmpfs | grep -v udev | while read line
do
       # 提取挂载点和使用率
       mount_point=$(echo $line | awk '{print $6}')
       usage=$(echo $line | awk '{print $5}' | sed 's/%//')
       
       # 检查使用率是否超过阈值
       if [ $usage -ge $THRESHOLD ]; then
           echo "警告: $mount_point 分区使用率 ($usage%) 超过阈值 ($THRESHOLD%)"
       fi
done
   
   echo "磁盘空间监控完成！"
   ```

2. **查找大文件和目录**：
   - 使用`df`和`du`命令结合，找出系统中占用空间最大的前10个文件和目录
   - 分析这些大文件和目录是否必要，是否可以清理或移动到其他位置
   - 编写一个脚本自动执行此任务

3. **导出磁盘空间报告**：
   - 编写一个脚本，将磁盘空间使用情况导出为CSV格式的报告
   - 报告应包含文件系统、类型、总大小、已用大小、可用大小、使用率和挂载点等信息
   - 可以添加时间戳和系统信息等元数据

### 9.3 高级练习

1. **自动化磁盘清理方案**：
   - 设计一个完整的自动化磁盘清理方案，包括监控、分析和清理三个步骤
   - 实现基于磁盘使用率的自动清理策略
   - 添加日志记录和报告功能，记录每次清理的详细信息

2. **分布式磁盘空间监控**：
   - 设计一个分布式磁盘空间监控系统，能够同时监控多台服务器的磁盘空间
   - 实现中央管理和告警功能
   - 考虑使用SNMP或其他协议收集远程服务器的磁盘信息

3. **基于Web的磁盘空间可视化**：
   - 开发一个基于Web的磁盘空间可视化工具，能够直观展示磁盘空间使用情况
   - 实现图表展示、历史趋势分析和告警功能
   - 可以使用Python、PHP等语言结合图表库实现

## 10. 总结与展望

`df`命令是Linux系统管理中不可或缺的工具，它提供了关于文件系统磁盘空间使用情况的重要信息。通过`df`命令，系统管理员可以快速了解系统的存储状态，及时发现和解决磁盘空间问题。

### 10.1 命令的主要价值

1. **系统状态监控**：`df`命令是系统状态监控的重要组成部分，可以帮助管理员及时发现磁盘空间不足等问题。

2. **存储资源管理**：通过`df`命令提供的信息，管理员可以更好地规划和管理系统的存储资源。

3. **故障排查工具**：在系统出现问题时，`df`命令是排查磁盘空间相关问题的首选工具之一。

4. **自动化脚本基础**：`df`命令的输出格式稳定、易于解析，使其成为自动化脚本和监控工具的理想数据源。

### 10.2 未来发展方向

随着存储技术的不断发展，`df`命令也在不断演进：

1. **更丰富的输出格式**：未来版本可能会支持更多的数据格式选项，方便与现代监控系统集成。

2. **实时监控功能**：可能会增强实时监控能力，提供磁盘空间变化的实时通知。

3. **云存储支持**：随着云存储的普及，`df`命令可能会扩展支持云存储的监控和管理。

4. **智能预测和分析**：引入智能算法，能够根据历史数据预测磁盘空间使用趋势，提供更主动的管理建议。

5. **可视化输出**：结合图形界面，提供更直观的磁盘空间使用情况可视化展示。

### 10.3 结语

`df`命令虽然简单，但它是Linux系统管理中最常用的工具之一。通过掌握`df`命令的使用和与其他命令的结合，系统管理员可以更有效地监控和管理系统的存储资源，确保系统的稳定运行。

无论是日常系统维护、性能优化还是故障排查，`df`命令都能提供有价值的信息和支持。希望本文的详细介绍和实用示例能够帮助你更好地理解和应用这个强大的工具，提升你的系统管理技能和效率。