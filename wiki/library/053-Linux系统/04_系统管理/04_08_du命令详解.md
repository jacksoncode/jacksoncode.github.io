# du命令详解

## 1. 命令概述

`du`（disk usage）命令是Linux/Unix系统中用于估算和显示文件或目录占用磁盘空间大小的命令行工具。它能够快速计算指定目录或文件所占用的磁盘空间，并以多种格式展示结果，是系统管理员和普通用户管理磁盘空间、查找占用大量空间的文件和目录的重要工具。

### 1.1 主要功能

- 计算指定文件或目录占用的磁盘空间
- 递归计算目录及其子目录的空间占用情况
- 以不同单位（字节、KB、MB、GB等）显示空间大小
- 按大小排序显示文件和目录的空间占用
- 排除特定文件或目录进行计算
- 显示总大小或详细信息

### 1.2 应用场景

`du`命令在以下场景中特别有用：
- 检查磁盘空间使用情况
- 查找占用大量磁盘空间的文件和目录
- 监控磁盘空间增长趋势
- 系统清理和空间优化
- 备份和归档前的空间估算
- 磁盘配额管理

## 2. 语法格式

`du`命令的基本语法格式如下：

```bash
# 基本语法
$ du [选项] [文件或目录...]

# 常见语法示例
$ du
$ du -sh /path/to/directory
$ du -a /path/to/directory
$ du -h --max-depth=1 /path/to/directory
```

如果不指定文件或目录，`du`命令默认会显示当前目录及其子目录的磁盘空间使用情况。如果指定了多个文件或目录，`du`会分别显示每个项目的大小，最后显示总计大小（如果使用了`--total`选项）。

## 3. 常用选项

`du`命令支持多种选项，以下是最常用的选项及其功能：

| 选项 | 功能描述 |
|------|----------|
| `-a`, `--all` | 显示所有文件和目录的大小，而不仅仅是目录 |
| `-B <大小>`, `--block-size=<大小>` | 使用指定的块大小进行计算和显示 |
| `-b`, `--bytes` | 以字节为单位显示大小（不进行自动转换） |
| `-c`, `--total` | 在最后显示所有参数的总计大小 |
| `-d <N>`, `--max-depth=<N>` | 限制递归深度为N层 |
| `-h`, `--human-readable` | 以人类可读的格式显示大小（如K、M、G） |
| `-H`, `--si` | 与`-h`类似，但使用国际单位制（1000而非1024） |
| `-k` | 以KB为单位显示大小（等于`--block-size=1K`） |
| `-m` | 以MB为单位显示大小（等于`--block-size=1M`） |
| `-s`, `--summarize` | 显示每个参数的总计大小，不显示子目录详情 |
| `-t <大小>`, `--threshold=<大小>` | 只显示大小超过指定阈值的项目 |
| `-x`, `--one-file-system` | 跳过不同文件系统上的目录 |
| `--apparent-size` | 显示文件的表观大小，而不是实际占用的磁盘空间 |
| `--exclude=<模式>` | 排除与指定模式匹配的文件 |
| `--max-depth=<N>` | 同`-d`选项 |
| `--time` | 显示每个目录中最新文件的修改时间 |
| `--time-style=<样式>` | 设置时间显示样式（full-iso, long-iso, iso, locale） |
| `--help` | 显示帮助信息 |
| `--version` | 显示版本信息 |

## 4. 基本用法

### 4.1 显示当前目录的磁盘使用情况

**功能说明**：不带任何参数运行`du`命令，显示当前目录及其子目录的磁盘空间使用情况。

**示例**：

```bash
$ du
4       ./dir1
8       ./dir2/subdir
12      ./dir2
20      .
```

输出中，每行的第一个数字表示占用的磁盘空间大小（默认以1024字节为单位），后面的路径表示对应的目录。最后一行显示当前目录的总大小。

### 4.2 以人类可读格式显示大小

**功能说明**：使用`-h`选项以人类可读的格式（如K、M、G）显示磁盘空间大小。

**示例**：

```bash
$ du -h
4.0K    ./dir1
8.0K    ./dir2/subdir
12K     ./dir2
20K     .
```

### 4.3 显示目录的总计大小

**功能说明**：使用`-s`选项只显示目录的总计大小，不显示子目录的详细信息。

**示例**：

```bash
# 显示当前目录的总计大小
$ du -sh
20K     .

# 显示指定目录的总计大小
$ du -sh /path/to/directory
1.2G    /path/to/directory
```

### 4.4 显示所有文件的大小

**功能说明**：使用`-a`选项显示所有文件和目录的大小，而不仅仅是目录。

**示例**：

```bash
$ du -ah
4.0K    ./file1.txt
2.0K    ./file2.txt
4.0K    ./dir1
8.0K    ./dir2/subdir/file3.txt
8.0K    ./dir2/subdir
12K     ./dir2
20K     .
```

### 4.5 限制递归深度

**功能说明**：使用`--max-depth`或`-d`选项限制`du`命令的递归深度。

**示例**：

```bash
# 只显示当前目录下一级目录的大小
$ du -h --max-depth=1
4.0K    ./dir1
12K     ./dir2
20K     .

# 显示当前目录下两级目录的大小
$ du -h --max-depth=2
4.0K    ./dir1
8.0K    ./dir2/subdir
12K     ./dir2
20K     .
```

### 4.6 显示总计大小

**功能说明**：使用`-c`选项在最后显示所有参数的总计大小。

**示例**：

```bash
$ du -ch /path/to/dir1 /path/to/dir2
1.2G    /path/to/dir1
850M    /path/to/dir2
2.0G    total
```

### 4.7 排除特定文件或目录

**功能说明**：使用`--exclude`选项排除与指定模式匹配的文件或目录。

**示例**：

```bash
# 排除所有.txt文件
$ du -ah --exclude="*.txt"
4.0K    ./dir1
8.0K    ./dir2/subdir
12K     ./dir2
20K     .

# 排除多个模式
$ du -ah --exclude={"*.txt", "*.log"}
4.0K    ./dir1
8.0K    ./dir2/subdir
12K     ./dir2
20K     .
```

### 4.8 按大小排序显示

**功能说明**：结合`du`命令和`sort`命令，按大小排序显示文件和目录的空间占用。

**示例**：

```bash
# 按大小从大到小排序显示当前目录下的一级目录
$ du -h --max-depth=1 | sort -hr
20K     .
12K     ./dir2
4.0K    ./dir1

# 查找占用空间最大的前10个目录
$ du -ah /path/to/directory | sort -hr | head -10
2.5G    /path/to/directory
1.2G    /path/to/directory/large_dir1
850M    /path/to/directory/large_dir2
400M    /path/to/directory/large_file.iso
...
```

## 5. 高级用法与技巧

### 5.1 查找占用空间最大的文件和目录

**功能说明**：结合`du`命令和其他工具，快速查找系统中占用空间最大的文件和目录。

**示例与技巧**：

```bash
# 查找当前目录下占用空间最大的前10个目录（包括子目录）
$ du -ah . | sort -hr | head -10

# 查找系统根目录下占用空间最大的目录（需要root权限）
$ sudo du -h / --max-depth=1 | sort -hr | head -10

# 查找特定类型的大文件
$ find /path/to/search -type f -name "*.iso" -exec du -h {} \; | sort -hr | head -5

# 查找超过1GB的文件
$ find /path/to/search -type f -size +1G -exec du -h {} \; | sort -hr

# 仅查找目录，并按大小排序
$ du -h --max-depth=1 /path/to/directory | sort -hr | head -10
```

### 5.2 磁盘空间使用趋势分析

**功能说明**：定期收集磁盘空间使用数据，分析磁盘空间增长趋势。

**示例脚本**：

```bash
#!/bin/bash
# disk_usage_trend.sh - 磁盘空间使用趋势监控脚本

# 配置参数
OUTPUT_DIR="/var/log/disk_usage"
MONITOR_PATHS="/ /home /var /usr"  # 要监控的路径
CHECK_INTERVAL=86400  # 检查间隔（秒）- 每天
HISTORY_DAYS=30  # 保留历史数据的天数

# 创建输出目录
mkdir -p "$OUTPUT_DIR"

# 记录当前日期
CURRENT_DATE=$(date +%Y%m%d)
OUTPUT_FILE="$OUTPUT_DIR/disk_usage_${CURRENT_DATE}.log"

# 记录表头
echo "时间戳,路径,总大小,已用,可用,使用率" > "$OUTPUT_FILE"

# 收集数据
for PATH in $MONITOR_PATHS
do
    # 检查路径是否存在
    if [ -d "$PATH" ]; then
        # 获取磁盘使用情况
        USAGE_INFO=$(df -h "$PATH" | tail -1)
        
        # 提取信息
        TOTAL=$(echo "$USAGE_INFO" | awk '{print $2}')
        USED=$(echo "$USAGE_INFO" | awk '{print $3}')
        AVAIL=$(echo "$USAGE_INFO" | awk '{print $4}')
        USE_PERCENT=$(echo "$USAGE_INFO" | awk '{print $5}' | sed 's/%//g')
        
        # 记录详细目录大小
        DIR_SIZE=$(du -sh "$PATH" 2>/dev/null | awk '{print $1}')
        
        # 写入日志
        TIMESTAMP=$(date +%Y-%m-%d" "%H:%M:%S)
        echo "$TIMESTAMP,$PATH,$TOTAL,$USED,$AVAIL,$USE_PERCENT,$DIR_SIZE" >> "$OUTPUT_FILE"
        
        echo "已记录 $PATH 的磁盘使用情况：总大小=$TOTAL, 已用=$USED, 可用=$AVAIL, 使用率=$USE_PERCENT%"
    else
        echo "警告：路径 $PATH 不存在，跳过监控。"
    fidone

# 清理过期的历史数据
find "$OUTPUT_DIR" -name "disk_usage_*.log" -mtime +$HISTORY_DAYS -delete

echo "磁盘使用情况监控完成！"
echo "日志文件已保存到: $OUTPUT_FILE"
echo "建议定期分析这些数据，以便了解磁盘空间使用趋势。"
```

### 5.3 磁盘空间清理工具

**功能说明**：创建一个简单的磁盘空间清理工具，帮助用户找出并删除不需要的大文件。

**示例脚本**：

```bash
#!/bin/bash
# disk_cleanup.sh - 磁盘空间清理工具

# 配置参数
MIN_SIZE="100M"  # 要查找的最小文件大小
SEARCH_PATH="/home"  # 搜索路径
TEMP_FILE="/tmp/large_files.txt"

# 显示帮助信息
show_help() {
    echo "磁盘空间清理工具"
    echo "用法: $0 [选项]"
    echo "选项:"
    echo "  -p <路径>   设置搜索路径（默认：$SEARCH_PATH）"
    echo "  -s <大小>   设置要查找的最小文件大小（默认：$MIN_SIZE）"
    echo "  -h          显示帮助信息"
    exit 1
}

# 解析命令行参数
while getopts "p:s:h" opt
do
    case "$opt" in
        p) SEARCH_PATH="$OPTARG" ;;
        s) MIN_SIZE="$OPTARG" ;;
        h) show_help ;;
        *) show_help ;;
    esac
done

# 检查搜索路径是否存在
if [ ! -d "$SEARCH_PATH" ]; then
    echo "错误：搜索路径 $SEARCH_PATH 不存在！"
    exit 1
fi

# 查找大文件
echo "正在 $SEARCH_PATH 中查找大于 $MIN_SIZE 的文件..."
find "$SEARCH_PATH" -type f -size +"$MIN_SIZE" -exec du -h {} \; | sort -hr > "$TEMP_FILE"

# 显示结果
FILE_COUNT=$(wc -l < "$TEMP_FILE")

echo "找到 $FILE_COUNT 个大于 $MIN_SIZE 的文件："
cat "$TEMP_FILE"

echo -e "\n总计大文件数量：$FILE_COUNT"

# 提供清理建议
echo -e "\n清理建议："
echo "1. 检查以上文件，确认哪些是不需要的"
echo "2. 对于不需要的文件，可以使用 rm 命令删除"
echo "3. 对于大日志文件，可以考虑压缩或清空"
echo "4. 定期执行此脚本，以保持磁盘空间充足"
echo ""
echo "注意：删除文件前请务必确认文件内容和重要性！"

echo -e "\n是否需要删除其中的某些文件？(y/n)"
read -r DELETE_ANSWER

if [ "$DELETE_ANSWER" = "y" ] || [ "$DELETE_ANSWER" = "Y" ]; then
    echo "请输入要删除的文件路径（输入q退出）："
    while true; do
        read -r FILE_TO_DELETE
        if [ "$FILE_TO_DELETE" = "q" ] || [ "$FILE_TO_DELETE" = "Q" ]; then
            break
        fi
        if [ -f "$FILE_TO_DELETE" ]; then
            echo "确定要删除 $FILE_TO_DELETE 吗？(y/n)"
            read -r CONFIRM
            if [ "$CONFIRM" = "y" ] || [ "$CONFIRM" = "Y" ]; then
                rm -f "$FILE_TO_DELETE"
                if [ $? -eq 0 ]; then
                    echo "文件 $FILE_TO_DELETE 已成功删除！"
                else
                    echo "删除文件 $FILE_TO_DELETE 失败！"
                fi
            fi
        else
            echo "文件 $FILE_TO_DELETE 不存在！"
        fi
    done
fi

# 清理临时文件
rm -f "$TEMP_FILE"

echo "磁盘清理工具执行完毕！"
```

### 5.4 磁盘配额管理

**功能说明**：结合`du`命令和其他工具，实现简单的用户磁盘配额管理。

**示例脚本**：

```bash
#!/bin/bash
# user_quota_check.sh - 用户磁盘配额检查脚本

# 配置参数
USER_HOME_DIRS="/home/*"
QUOTA_LIMIT="50G"  # 默认配额限制
REPORT_FILE="/var/log/user_quota_report.log"
ADMIN_EMAIL="admin@example.com"

# 检查是否安装了必要的命令
du_cmd=$(which du)
sort_cmd=$(which sort)
mail_cmd=$(which mail)

if [ -z "$du_cmd" ] || [ -z "$sort_cmd" ]; then
    echo "错误：找不到必要的命令（du或sort）！"
    exit 1
fi

# 清除旧的报告文件
> "$REPORT_FILE"

# 记录表头
echo "# 用户磁盘配额报告 - $(date)" >> "$REPORT_FILE"
echo "# 配额限制: $QUOTA_LIMIT" >> "$REPORT_FILE"
echo "# 用户名,主目录,已用空间,使用率,状态" >> "$REPORT_FILE"

# 转换配额限制为字节（用于比较）
# 注意：这里简化处理，实际实现可能需要更复杂的单位转换
case "$QUOTA_LIMIT" in
    *G) QUOTA_BYTES=$(echo "$QUOTA_LIMIT" | sed 's/G//') ;;
    *M) QUOTA_BYTES=$(echo "$QUOTA_LIMIT" | sed 's/M//') ;;
    *K) QUOTA_BYTES=$(echo "$QUOTA_LIMIT" | sed 's/K//') ;;
    *) QUOTA_BYTES="$QUOTA_LIMIT" ;;
esac

# 检查每个用户的主目录
for HOME_DIR in $USER_HOME_DIRS
do
    # 跳过非目录
    if [ ! -d "$HOME_DIR" ]; then
        continue
    fi
    
    # 获取用户名
    USER_NAME=$(basename "$HOME_DIR")
    
    # 计算用户主目录的大小
    USER_SIZE_HUMAN=$(du -sh "$HOME_DIR" 2>/dev/null | awk '{print $1}')
    
    # 转换为字节（用于比较）
    # 注意：这里简化处理，实际实现可能需要更复杂的单位转换
    case "$USER_SIZE_HUMAN" in
        *G) USER_SIZE=$(echo "$USER_SIZE_HUMAN" | sed 's/G//') ;;
        *M) USER_SIZE=$(echo "$USER_SIZE_HUMAN" | sed 's/M//') ;;
        *K) USER_SIZE=$(echo "$USER_SIZE_HUMAN" | sed 's/K//') ;;
        *) USER_SIZE="$USER_SIZE_HUMAN" ;;
    esac
    
    # 计算使用率（简化计算）
    USE_PERCENT=$(echo "scale=2; $USER_SIZE * 100 / $QUOTA_BYTES" | bc 2>/dev/null || echo 0)
    
    # 确定状态
    STATUS="正常"
    if (( $(echo "$USE_PERCENT > 90" | bc -l) )); then
        STATUS="警告：即将达到配额限制"
    fi
    if (( $(echo "$USE_PERCENT >= 100" | bc -l) )); then
        STATUS="错误：已超过配额限制"
    fi
    
    # 记录结果
    echo "$USER_NAME,$HOME_DIR,$USER_SIZE_HUMAN,$USE_PERCENT%,$STATUS" >> "$REPORT_FILE"
done

# 按使用空间排序显示结果
echo -e "\n# 按使用空间排序的结果：" >> "$REPORT_FILE"
cat "$REPORT_FILE" | grep -v "^#" | tail -n +2 | sort -t, -k3 -hr >> "$REPORT_FILE"

echo "用户磁盘配额检查完成！"
echo "报告已保存到: $REPORT_FILE"

# 发送警告邮件（如果有用户超过配额）
OVER_QUOTA_COUNT=$(grep -c "已超过配额限制" "$REPORT_FILE")
WARNING_COUNT=$(grep -c "即将达到配额限制" "$REPORT_FILE")

if [ $OVER_QUOTA_COUNT -gt 0 ] || [ $WARNING_COUNT -gt 0 ]; then
    if [ -n "$mail_cmd" ]; then
        SUBJECT="磁盘配额警告：$OVER_QUOTA_COUNT 个用户已超限，$WARNING_COUNT 个用户即将超限"
        BODY="请查看附件中的详细报告，及时处理超限用户。\n\n报告路径：$REPORT_FILE"
        
        echo -e "$BODY" | mail -s "$SUBJECT" "$ADMIN_EMAIL" -a "$REPORT_FILE"
        if [ $? -eq 0 ]; then
            echo "警告邮件已发送至 $ADMIN_EMAIL"
        else
            echo "发送警告邮件失败！"
        fi
    else
        echo "警告：未找到mail命令，无法发送邮件通知！"
    fifi
```

### 5.5 备份空间估算

**功能说明**：使用`du`命令估算备份所需的磁盘空间。

**示例脚本**：

```bash
#!/bin/bash
# backup_size_estimate.sh - 备份空间估算脚本

# 配置参数
BACKUP_SOURCE="/home /etc /var/www"
EXCLUDE_PATTERNS="/home/*/.cache /home/*/.local/share/Trash /var/cache /var/log"
ESTIMATE_FILE="/tmp/backup_estimate.txt"

# 显示帮助信息
show_help() {
    echo "备份空间估算工具"
    echo "用法: $0 [选项]"
    echo "选项:"
    echo "  -s <路径>   设置要备份的源路径（默认：$BACKUP_SOURCE）"
    echo "  -e <模式>   设置要排除的路径模式（多个模式用逗号分隔，默认：$EXCLUDE_PATTERNS）"
    echo "  -o <文件>   设置输出文件（默认：$ESTIMATE_FILE）"
    echo "  -h          显示帮助信息"
    exit 1
}

# 解析命令行参数
while getopts "s:e:o:h" opt
do
    case "$opt" in
        s) BACKUP_SOURCE="$OPTARG" ;;
        e) EXCLUDE_PATTERNS="$OPTARG" ;;
        o) ESTIMATE_FILE="$OPTARG" ;;
        h) show_help ;;
        *) show_help ;;
    esac
done

# 准备排除选项
EXCLUDE_OPTIONS=""
for PATTERN in $EXCLUDE_PATTERNS
do
    EXCLUDE_OPTIONS="$EXCLUDE_OPTIONS --exclude=$PATTERN"
done

# 开始估算
echo "备份空间估算报告 - $(date)" > "$ESTIMATE_FILE"
echo "======================================" >> "$ESTIMATE_FILE"
echo "备份源路径：$BACKUP_SOURCE" >> "$ESTIMATE_FILE"
echo "排除路径：$EXCLUDE_PATTERNS" >> "$ESTIMATE_FILE"
echo "======================================" >> "$ESTIMATE_FILE"
echo "" >> "$ESTIMATE_FILE"

# 估算总大小
echo "正在计算备份所需的总空间..." >> "$ESTIMATE_FILE"
TOTAL_SIZE=$(du -sh $EXCLUDE_OPTIONS $BACKUP_SOURCE 2>/dev/null | sort -hr | awk '{sum+=$1} END {print sum}')

# 详细估算每个路径
echo "各路径空间使用详情：" >> "$ESTIMATE_FILE"
for PATH in $BACKUP_SOURCE
do
    if [ -d "$PATH" ] || [ -f "$PATH" ]; then
        PATH_SIZE=$(du -sh $EXCLUDE_OPTIONS "$PATH" 2>/dev/null | awk '{print $1}')
        echo "- $PATH: $PATH_SIZE" >> "$ESTIMATE_FILE"
    else
        echo "- $PATH: 不存在或无法访问" >> "$ESTIMATE_FILE"
    fidone

# 显示文件类型分布
echo -e "\n文件类型分布：" >> "$ESTIMATE_FILE"
for PATH in $BACKUP_SOURCE
do
    if [ -d "$PATH" ]; then
        find "$PATH" -type f -not -path "$EXCLUDE_PATTERNS" -exec file --mime-type -b {} \; |
        sort | uniq -c | sort -nr | head -10 >> "$ESTIMATE_FILE"
    fidone

# 添加压缩估算
echo -e "\n压缩空间估算（基于经验值）：" >> "$ESTIMATE_FILE"
echo "- 无压缩：约 $TOTAL_SIZE" >> "$ESTIMATE_FILE"
echo "- gzip压缩（标准级别）：约 $(echo "$TOTAL_SIZE" | sed 's/G//')*0.6 G（节省约40%）" >> "$ESTIMATE_FILE"
echo "- bzip2压缩：约 $(echo "$TOTAL_SIZE" | sed 's/G//')*0.5 G（节省约50%）" >> "$ESTIMATE_FILE"
echo "- xz压缩：约 $(echo "$TOTAL_SIZE" | sed 's/G//')*0.4 G（节省约60%）" >> "$ESTIMATE_FILE"

# 添加备份建议
echo -e "\n备份建议：" >> "$ESTIMATE_FILE"
echo "1. 根据估算，建议准备至少 ${TOTAL_SIZE} 的备份空间"
echo "2. 考虑使用压缩备份以节省空间"
echo "3. 定期执行增量备份以减少备份所需空间"
echo "4. 重要数据建议进行多副本备份"
echo "5. 备份前再次确认排除的文件和目录是否合理"

# 完成估算
echo -e "\n估算完成时间：$(date)" >> "$ESTIMATE_FILE"
echo "======================================" >> "$ESTIMATE_FILE"

echo "备份空间估算完成！"
echo "详细报告已保存到: $ESTIMATE_FILE"
echo "建议在执行备份前查看此报告，确保有足够的存储空间。"
```

## 6. 实用技巧与应用场景

### 6.1 系统磁盘空间监控

**功能说明**：定期监控系统各分区的磁盘空间使用情况，及时发现空间不足问题。

**示例与技巧**：

```bash
# 监控系统所有分区的磁盘空间使用情况
$ df -h

# 监控特定目录的空间使用趋势
$ du -sh /var/log/* | sort -hr

# 创建定期监控的cron任务
# 编辑cron任务
crontab -e

# 添加以下行，每天凌晨2点检查磁盘空间并记录
0 2 * * * du -sh /home /var /usr /opt | sort -hr >> /var/log/disk_usage.log

# 添加以下行，当磁盘空间使用率超过90%时发送警告邮件
0 * * * * df -h | awk '$5 > "90%" {print "警告：" $6 " 分区使用率已超过90%"}' | mail -s "磁盘空间警告" admin@example.com
```

### 6.2 Web服务器日志清理

**功能说明**：清理Web服务器（如Apache、Nginx）的日志文件，释放磁盘空间。

**示例与技巧**：

```bash
# 查看Web服务器日志文件大小
$ du -sh /var/log/apache2/* /var/log/nginx/* | sort -hr

# 清理旧日志文件（保留最近30天的日志）
$ find /var/log/apache2 -name "*.log.*" -mtime +30 -delete
$ find /var/log/nginx -name "*.log.*" -mtime +30 -delete

# 压缩旧日志文件（保留日志内容但减少空间占用）
$ find /var/log/apache2 -name "*.log.*" -mtime +7 -exec gzip {} \;
$ find /var/log/nginx -name "*.log.*" -mtime +7 -exec gzip {} \;

# 创建日志清理脚本并设置为cron任务
#!/bin/bash
# web_log_cleanup.sh

LOG_DIRS="/var/log/apache2 /var/log/nginx"
KEEP_DAYS=30
COMPRESS_DAYS=7

for DIR in $LOG_DIRS
do
    if [ -d "$DIR" ]; then
        # 删除超过保留天数的日志文件
        find "$DIR" -name "*.log.*" -mtime +$KEEP_DAYS -delete
        
        # 压缩超过压缩天数但未超过保留天数的日志文件
        find "$DIR" -name "*.log.*" -mtime +$COMPRESS_DAYS -not -name "*.gz" -exec gzip {} \;
    fidone

# 添加到cron任务（每天凌晨1点执行）
# 0 1 * * * /path/to/web_log_cleanup.sh
```

### 6.3 查找重复文件

**功能说明**：结合`du`命令和其他工具，查找系统中的重复文件，以便删除或合并。

**示例与技巧**：

```bash
# 使用find和md5sum查找重复文件
$ find /path/to/search -type f -exec md5sum {} \; | sort | uniq -w 32 -dD

# 查找重复文件并按大小排序（便于优先处理大文件）
$ find /path/to/search -type f -exec md5sum {} \; | sort | uniq -w 32 -d | \
  awk '{print $2}' | xargs du -h | sort -hr

# 一个简单的重复文件查找脚本
#!/bin/bash
# find_duplicate_files.sh

if [ -z "$1" ]; then
    echo "用法: $0 <搜索路径>"
    exit 1
fi

SEARCH_PATH="$1"

# 确保路径存在
if [ ! -d "$SEARCH_PATH" ]; then
    echo "错误：搜索路径 $SEARCH_PATH 不存在！"
    exit 1
fi

# 创建临时文件存储md5sum结果
MD5_FILE=$(mktemp)

# 计算所有文件的md5sum
find "$SEARCH_PATH" -type f -exec md5sum {} \; > "$MD5_FILE"

# 查找重复文件并显示
echo "正在查找重复文件..."
echo "----------------------------------------"
echo "大小		重复次数	文件路径"
echo "----------------------------------------"

# 查找重复的md5值并计算文件大小
sort "$MD5_FILE" | uniq -w 32 -d | awk '{print $1}' | \
while read -r MD5; do
    # 获取所有具有相同md5值的文件
    FILES=$(grep "^$MD5" "$MD5_FILE" | awk '{print $2}')
    FILE_COUNT=$(echo "$FILES" | wc -w)
    
    # 获取第一个文件的大小（其他文件大小应相同）
    FIRST_FILE=$(echo "$FILES" | awk '{print $1}')
    FILE_SIZE=$(du -h "$FIRST_FILE" | awk '{print $1}')
    
    # 显示结果
    echo "$FILE_SIZE	$FILE_COUNT	$FIRST_FILE"
    
    # 显示其他重复文件
    echo "$FILES" | awk '{$1=""; print $0}' | \
    while read -r OTHER_FILES; do
        echo "			$OTHER_FILES"
    donedone

# 清理临时文件
rm -f "$MD5_FILE"

echo "----------------------------------------"
echo "重复文件查找完成！"
echo "提示：删除重复文件前，请确保您了解文件的用途和重要性。"
```

### 6.4 数据库备份空间管理

**功能说明**：管理数据库备份文件，确保有足够的磁盘空间存储备份。

**示例与技巧**：

```bash
# 查看数据库备份目录的空间使用情况
$ du -sh /path/to/backup/* | sort -hr

# 找出最大的10个备份文件
$ du -ah /path/to/backup | sort -hr | head -10

# 创建数据库备份清理脚本
#!/bin/bash
# db_backup_cleanup.sh

BACKUP_DIR="/path/to/backup"
KEEP_DAYS=7  # 保留7天的备份
MAX_SIZE="500G"  # 最大备份目录大小

# 删除超过保留天数的备份
find "$BACKUP_DIR" -type f -name "*.sql.gz" -mtime +$KEEP_DAYS -delete

# 检查备份目录大小
BACKUP_SIZE=$(du -sh "$BACKUP_DIR" | awk '{print $1}')

# 转换为字节以便比较（简化处理）
B_SIZE=$(echo "$BACKUP_SIZE" | sed 's/G//')
MAX_BYTES=$(echo "$MAX_SIZE" | sed 's/G//')

# 如果超过最大大小，删除最旧的备份
while (( $(echo "$B_SIZE > $MAX_BYTES" | bc -l) )); do
    OLDEST_BACKUP=$(find "$BACKUP_DIR" -type f -name "*.sql.gz" -printf "%T+ %p\n" | sort | head -1 | awk '{print $2}')
    if [ -n "$OLDEST_BACKUP" ]; then
        echo "删除最旧的备份文件：$OLDEST_BACKUP"
        rm -f "$OLDEST_BACKUP"
        # 重新计算大小
        BACKUP_SIZE=$(du -sh "$BACKUP_DIR" | awk '{print $1}')
        B_SIZE=$(echo "$BACKUP_SIZE" | sed 's/G//')
    else
        break  # 没有更多备份文件可删除
    fidone

# 添加到cron任务（每天凌晨3点执行）
# 0 3 * * * /path/to/db_backup_cleanup.sh
```

### 6.5 邮件服务器空间管理

**功能说明**：管理邮件服务器的邮件存储目录，防止邮件过多导致磁盘空间不足。

**示例与技巧**：

```bash
# 查看邮件存储目录的空间使用情况
$ du -sh /var/spool/mail/* | sort -hr

# 找出占用空间最多的10个邮箱
$ du -ah /var/spool/mail | sort -hr | head -10

# 查看特定用户的邮件大小分布
$ find /var/spool/mail/username -type f -exec du -h {} \; | sort -hr | head -20

# 创建邮件清理建议脚本
#!/bin/bash
# mail_cleanup.sh

MAIL_DIR="/var/spool/mail"
THRESHOLD="1G"  # 邮箱大小阈值

# 转换阈值为字节以便比较（简化处理）
THRESHOLD_VAL=$(echo "$THRESHOLD" | sed 's/G//')

# 检查每个邮箱的大小
for MAIL_FILE in "$MAIL_DIR"/*
do
    if [ -f "$MAIL_FILE" ]; then
        USER_NAME=$(basename "$MAIL_FILE")
        MAIL_SIZE=$(du -sh "$MAIL_FILE" | awk '{print $1}')
        
        # 转换为字节以便比较（简化处理）
        MAIL_SIZE_VAL=$(echo "$MAIL_SIZE" | sed 's/G//')
        
        # 检查是否超过阈值
        if (( $(echo "$MAIL_SIZE_VAL > $THRESHOLD_VAL" | bc -l) )); then
            echo "警告：用户 $USER_NAME 的邮箱大小 ($MAIL_SIZE) 已超过阈值 ($THRESHOLD)"
            echo "建议采取以下措施："
            echo "1. 通知用户清理邮箱，特别是大邮件和旧邮件"
            echo "2. 考虑为该用户增加邮箱配额"
            echo "3. 检查是否存在垃圾邮件或恶意邮件"
            echo "----------------------------------------"
        fidone

# 查找系统中的大邮件（前20个）
echo "系统中最大的20个邮件文件："
find "$MAIL_DIR" -type f -exec du -h {} \; | sort -hr | head -20

echo "邮件存储检查完成！"
```

## 7. 常见问题与解决方案

### 7.1 du命令显示的大小与df命令不一致

**问题描述**：使用`du`和`df`命令查看同一文件系统的空间使用情况时，结果不一致。

**解决方案**：

```bash
# 理解两个命令的不同：
# du：计算文件和目录实际占用的磁盘空间
# df：显示文件系统的总体空间使用情况

# 检查是否有已删除但仍被进程占用的文件
# 这些文件在df中仍被计数，但在du中不再显示
sudo lsof +L1

# 重启相关进程或重启系统以释放这些空间
sudo systemctl restart <service_name>

# 检查是否有隐藏的挂载点
sudo mount | grep -v '^none'

# 检查文件系统是否有损坏
sudo fsck -n /dev/sdx

# 清理文件系统缓存（临时释放空间）
sudo sync && sudo echo 3 > /proc/sys/vm/drop_caches
```

**原因分析**：
- 已删除但仍被进程占用的文件
- 隐藏的挂载点
- 文件系统损坏
- 磁盘配额设置
- 文件系统缓存

### 7.2 du命令运行缓慢

**问题描述**：`du`命令在计算大型目录的空间使用情况时运行缓慢。

**解决方案**：

```bash
# 限制递归深度以加快速度
$ du -h --max-depth=1 /path/to/directory

# 使用更高效的文件系统特定工具
# 例如，对于ZFS文件系统：
zfs list

# 对于Btrfs文件系统：
btrfs filesystem du -s /path/to/directory

# 使用ncdu工具，它比du更高效且提供交互式界面
sudo apt-get install ncdu
ncdu /path/to/directory

# 避开网络文件系统或挂载点
$ du -h -x /path/to/directory

# 考虑使用并行版本的du命令，如duc或pdu
```

**原因分析**：
- 目录结构复杂，文件数量众多
- 文件系统性能问题
- 网络文件系统（NFS、SMB等）的延迟
- 磁盘I/O性能瓶颈

### 7.3 du命令无法访问某些文件或目录

**问题描述**：运行`du`命令时，出现"Permission denied"错误，无法访问某些文件或目录。

**解决方案**：

```bash
# 使用sudo提升权限
sudo du -h /path/to/directory

# 排除没有权限访问的文件或目录（避免错误信息）
du -h /path/to/directory 2>/dev/null

# 仅显示用户有权限访问的部分
find /path/to/directory -user $USER -exec du -h {} \; | sort -hr

# 以其他用户身份运行
sudo -u <username> du -h /path/to/directory

# 检查文件和目录的权限设置
ls -la /path/to/directory
```

**原因分析**：
- 缺乏足够的权限访问特定文件或目录
- 文件或目录的权限设置限制了访问
- 文件系统挂载时使用了noexec或其他限制选项
- SELinux或AppArmor等安全模块的限制

### 7.4 du命令显示的大小与文件实际大小不符

**问题描述**：`du`命令显示的文件大小与文件的实际大小（通过`ls -l`命令查看）不一致。

**解决方案**：

```bash
# 理解两种大小的区别：
# ls -l：显示文件的表观大小（字节数）
# du：显示文件占用的磁盘空间（按块计算）

# 使用du的--apparent-size选项显示表观大小
du -h --apparent-size /path/to/file

# 检查文件系统的块大小
sudo tune2fs -l /dev/sdx | grep 'Block size'

# 了解稀疏文件的影响
# 稀疏文件的表观大小可能远大于其实际占用的磁盘空间
# 使用ls -s命令查看文件实际占用的块数
ls -ls /path/to/file

# 对于压缩文件系统，du可能显示的是压缩后的大小
```

**原因分析**：
- 文件系统块大小的影响
- 稀疏文件的存在
- 压缩文件系统
- 文件系统元数据占用的空间

### 7.5 无法删除大文件以释放空间

**问题描述**：删除了大文件后，使用`df`命令查看发现磁盘空间并没有释放。

**解决方案**：

```bash
# 检查是否有进程仍在使用已删除的文件
sudo lsof +L1

# 重启相关进程以释放文件占用的空间
sudo systemctl restart <service_name>

# 或者向进程发送SIGUSR1信号（如果进程支持），使其重新打开日志文件
sudo kill -USR1 <pid>

# 检查是否有其他硬链接指向该文件
# 删除所有硬链接才能真正释放空间
find / -samefile /path/to/deleted/file 2>/dev/null

# 对于日志文件，可以尝试清空而不是删除
echo "" > /path/to/logfile

# 如果以上方法都不行，可能需要重启系统
sudo reboot
```

**原因分析**：
- 进程仍在使用已删除的文件
- 文件存在其他硬链接
- 文件系统延迟更新
- 磁盘配额问题

## 8. 相关命令对比

`du`命令是磁盘空间管理的基础工具之一，但在实际系统管理中，通常需要与其他命令结合使用以获取更全面的磁盘空间信息。以下是一些与`du`相关的命令及其主要功能对比：

| 命令 | 主要功能 | 与du的区别 | 适用场景 |
|------|----------|-----------|----------|
| `du` | 估算文件和目录的磁盘空间使用 | 专注于文件和目录级别的空间计算 | 查找大文件和目录、空间使用分析 |
| `df` | 显示文件系统的磁盘空间使用 | 专注于文件系统级别的空间统计 | 监控分区空间、检查文件系统状态 |
| `ls` | 列出目录内容和文件信息 | 可以显示文件大小，但不递归计算 | 快速查看文件大小、基本文件信息 |
| `ncdu` | 交互式磁盘使用分析工具 | 更高效、交互式界面、更友好 | 交互式磁盘空间分析和清理 |
| `find` | 按条件查找文件和目录 | 可以结合-size选项查找大文件 | 查找特定条件的文件、批量操作 |
| `tune2fs` | 调整ext文件系统的参数 | 可以查看文件系统信息和统计 | 文件系统维护和优化 |
| `lsof` | 列出打开的文件和进程 | 可以查找已删除但仍被占用的文件 | 查找文件占用情况、排查资源问题 |
| `quota` | 显示磁盘配额使用情况 | 专注于用户和组的磁盘配额管理 | 多用户环境的磁盘空间管理 |
| `btrfs filesystem du` | Btrfs文件系统的空间计算工具 | 专为Btrfs优化，支持子卷和快照 | Btrfs文件系统的空间分析 |
| `zfs list` | ZFS文件系统的空间统计工具 | 专为ZFS优化，支持数据集和快照 | ZFS文件系统的空间分析 |

### 8.1 du与df命令的对比

`du`和`df`命令都用于显示磁盘空间使用情况，但它们的侧重点和工作原理不同：

**示例对比**：

```bash
# 使用du查看目录空间使用情况
$ du -sh /home
100G    /home

# 使用df查看文件系统空间使用情况
$ df -h /home
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda2       200G  100G  100G  50% /home
```

**主要区别**：
- **工作原理**：`du`通过遍历目录树计算每个文件的大小，而`df`通过读取文件系统的超级块获取整体使用情况
- **关注点**：`du`关注文件和目录级别，`df`关注文件系统级别
- **准确性**：`df`通常显示更准确的文件系统空间使用情况，而`du`可能受权限和文件系统特性的影响
- **性能**：对于大型文件系统，`du`可能比`df`慢很多

### 8.2 最佳实践组合

在实际系统管理中，通常会结合使用多个命令来全面了解和管理磁盘空间：

1. **整体磁盘空间监控**：`df -h`
2. **查找大文件和目录**：`du -ah /path/to/directory | sort -hr | head -20`
3. **磁盘空间趋势分析**：定期运行`du`并记录结果
4. **查找已删除但仍被占用的文件**：`lsof +L1`结合`du`和`df`的差异分析
5. **磁盘空间清理**：结合`find`、`du`和`rm`命令
6. **文件系统维护**：`tune2fs`、`fsck`等命令结合`du`和`df`

## 9. 实践练习

### 9.1 基础练习

1. **熟悉du命令的基本用法**：
   - 使用`du`命令查看当前目录的空间使用情况
   - 使用`du -h`命令以人类可读格式显示结果
   - 使用`du -s`命令只显示目录的总计大小
   - 使用`du -a`命令显示所有文件的大小

2. **查找大文件和目录**：
   - 使用`du`命令查找当前目录下占用空间最大的前10个文件或目录
   - 使用`du`命令查找系统中占用空间最大的目录
   - 比较不同选项对查找速度的影响

3. **限制递归深度和排除特定文件**：
   - 使用`--max-depth`选项限制`du`命令的递归深度
   - 使用`--exclude`选项排除特定类型的文件或目录
   - 练习组合使用这些选项

### 9.2 中级练习

1. **创建磁盘空间监控脚本**：
   - 编写一个shell脚本，定期收集指定目录的磁盘空间使用情况
   - 脚本应支持自定义监控路径、收集间隔和输出格式
   - 实现基本的告警功能，当空间使用率超过阈值时通知管理员

   **参考脚本框架**：
   ```bash
   #!/bin/bash
   
   # 默认参数
   MONITOR_PATH="."
   THRESHOLD=90  # 百分比
   CHECK_INTERVAL=60  # 秒
   LOG_FILE="disk_usage.log"
   
   # 显示帮助信息
   if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
       echo "磁盘空间监控脚本"
       echo "用法: $0 [路径] [阈值] [间隔]"
       echo "示例: $0 /home 90 300"  # 每5分钟监控/home目录，使用率超过90%时告警
       exit 1
   fi
   
   # 设置参数（如果提供）
   if [ -n "$1" ]; then MONITOR_PATH="$1"; fi
   if [ -n "$2" ]; then THRESHOLD="$2"; fi
   if [ -n "$3" ]; then CHECK_INTERVAL="$3"; fi
   
   echo "开始监控 $MONITOR_PATH 的磁盘空间使用情况..."
   echo "阈值: ${THRESHOLD}%"
   echo "检查间隔: ${CHECK_INTERVAL}秒"
   
   while true
   do
       # 获取当前时间
       TIMESTAMP=$(date +%Y-%m-%d" "%H:%M:%S)
       
       # 获取磁盘空间使用情况
       USAGE_INFO=$(df -h "$MONITOR_PATH" | tail -1)
       MOUNT_POINT=$(echo "$USAGE_INFO" | awk '{print $6}')
       USE_PERCENT=$(echo "$USAGE_INFO" | awk '{print $5}' | sed 's/%//g')
       
       # 获取目录大小
       DIR_SIZE=$(du -sh "$MONITOR_PATH" 2>/dev/null | awk '{print $1}')
       
       # 记录到日志
       echo "[$TIMESTAMP] $MOUNT_POINT: 使用率=${USE_PERCENT}%, 目录大小=${DIR_SIZE}" >> "$LOG_FILE"
       
       # 检查是否超过阈值
       if [ "$USE_PERCENT" -gt "$THRESHOLD" ]; then
           echo "警告: $MOUNT_POINT 的磁盘使用率 ($USE_PERCENT%) 已超过阈值 ($THRESHOLD%)!"
           # 这里可以添加发送邮件或其他告警方式
       fi
       
       # 等待下一个检查周期
       sleep $CHECK_INTERVAL
done
   ```

2. **磁盘空间清理工具开发**：
   - 开发一个简单的磁盘空间清理工具，能够找出占用空间大的文件和目录
   - 工具应支持按类型、时间等条件筛选文件
   - 提供清理建议和安全删除功能

3. **文件系统使用分析**：
   - 选择一个目录，分析其文件类型分布和空间占用情况
   - 生成详细的分析报告，包括文件类型、大小分布、最近访问时间等信息
   - 根据分析结果提出空间优化建议

### 9.3 高级练习

1. **分布式磁盘空间监控系统**：
   - 设计一个分布式磁盘空间监控系统，可以同时监控多台服务器的磁盘空间
   - 实现中央数据收集和报告功能
   - 添加可视化界面，直观展示各服务器的磁盘空间使用情况

2. **智能磁盘空间预警系统**：
   - 开发一个智能磁盘空间预警系统，能够预测未来的磁盘空间使用趋势
   - 基于历史数据和增长趋势，提前预警可能的空间不足问题
   - 实现自动清理和空间优化建议功能

3. **企业级磁盘配额管理解决方案**：
   - 设计一个企业级的磁盘配额管理解决方案，支持多用户、多部门的配额管理
   - 实现配额设置、监控、告警和报表功能
   - 考虑与现有企业身份认证系统的集成

## 10. 总结与展望

`du`命令作为Linux系统中最常用的磁盘空间管理工具之一，已经陪伴系统管理员数十年。它提供了简单而强大的功能，使管理员能够轻松了解和管理系统的磁盘空间使用情况。

### 10.1 命令的主要价值

1. **磁盘空间可视化**：`du`命令将抽象的磁盘空间使用情况转化为具体的数值，帮助用户直观了解空间使用状况。

2. **问题定位利器**：在磁盘空间不足时，`du`命令是快速定位问题的首选工具之一。

3. **空间规划基础**：`du`命令提供的数据是进行磁盘空间规划和容量管理的重要基础。

4. **自动化脚本组件**：`du`命令的输出格式稳定、易于解析，使其成为自动化脚本和监控工具的理想组件。

5. **系统优化辅助**：通过`du`命令分析磁盘空间使用情况，可以发现系统优化的机会，提高存储效率。

### 10.2 未来发展方向

随着存储技术的不断发展和系统需求的不断变化，`du`命令也在不断演进：

1. **性能优化**：未来版本可能会进一步提高在大型目录和文件系统上的性能。

2. **新存储技术支持**：更好地支持新型文件系统（如ZFS、Btrfs）和存储技术（如SSD、NVMe）。

3. **智能分析功能**：引入智能算法，能够根据文件类型、访问模式等提供更深入的空间使用分析。

4. **集成与互操作性**：与其他存储管理工具和系统管理平台的更好集成。

5. **可视化界面**：结合图形界面，提供更直观的空间使用可视化展示。

### 10.3 结语

`du`命令虽然简单，但它是Linux系统管理中不可或缺的工具。无论是日常系统维护、空间清理还是容量规划，`du`命令都能提供有价值的信息和支持。

随着存储技术的不断发展，磁盘空间管理的重要性也在不断提升。通过掌握`du`命令的使用和与其他命令的结合，系统管理员可以更有效地管理系统的磁盘空间，确保系统的稳定运行和存储资源的高效利用。

希望本文的详细介绍和实用示例能够帮助您更好地理解和应用`du`命令，提升您的系统管理技能和效率。